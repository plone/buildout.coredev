Repository: plone.volto


Branch: refs/heads/main
Date: 2024-06-16T21:47:52-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/3c2cabcaa785af8efc6759aacf1e7a45a7c64fe6

Avoid runtime dependency on plone.app.upgrade

Files changed:
A news/142.bugfix
M src/plone/volto/bbb.py
M src/plone/volto/patches.py

b'diff --git a/news/142.bugfix b/news/142.bugfix\nnew file mode 100644\nindex 00000000..fdbf2500\n--- /dev/null\n+++ b/news/142.bugfix\n@@ -0,0 +1 @@\n+Remove runtime dependency on plone.app.upgrade. @davisagli\ndiff --git a/src/plone/volto/bbb.py b/src/plone/volto/bbb.py\nindex 906d6ded..a8b30aec 100644\n--- a/src/plone/volto/bbb.py\n+++ b/src/plone/volto/bbb.py\n@@ -1,4 +1,8 @@\n # flake8: noqa\n+from types import ModuleType\n+\n+import sys\n+\n \n try:\n     from plone.base.interfaces import IPloneSiteRoot\n@@ -9,3 +13,26 @@\n     from plone.base.utils import get_installer\n except ImportError:\n     from Products.CMFPlone.utils import get_installer\n+\n+\n+# This was copied from plone.app.upgrade\n+# to avoid a hard dependency on it.\n+def alias_module(name, target):\n+    parts = name.split(".")\n+    i = 0\n+    module = None\n+    while i < len(parts) - 1:\n+        i += 1\n+        module_name = ".".join(parts[:i])\n+        try:\n+            __import__(module_name)\n+        except ImportError:\n+            new_module = ModuleType(module_name)\n+            sys.modules[module_name] = new_module\n+            if module is not None:\n+                setattr(module, parts[i - 1], new_module)\n+        module = sys.modules[module_name]\n+\n+    setattr(module, parts[-1], target)\n+    # also make sure sys.modules is updated\n+    sys.modules[module_name + "." + parts[-1]] = target\ndiff --git a/src/plone/volto/patches.py b/src/plone/volto/patches.py\nindex 589eecd7..24cf4a9c 100644\n--- a/src/plone/volto/patches.py\n+++ b/src/plone/volto/patches.py\n@@ -1,9 +1,9 @@\n-from plone.app.upgrade.utils import alias_module\n from plone.registry.interfaces import IRegistry\n from plone.rest.interfaces import IAPIRequest\n from plone.volto import content\n from plone.volto import interfaces\n from plone.volto import logger\n+from plone.volto.bbb import alias_module\n from plone.volto.interfaces import IVoltoSettings\n from Products.SiteErrorLog.SiteErrorLog import _rate_restrict_burst\n from Products.SiteErrorLog.SiteErrorLog import _rate_restrict_period\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2024-06-17T11:07:09+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.volto/commit/9e3561342eb0d29af96d23da621c5b70c0ea6809

Merge pull request #150 from plone/fix-upgrade-dep

Avoid runtime dependency on plone.app.upgrade

Files changed:
A news/142.bugfix
M src/plone/volto/bbb.py
M src/plone/volto/patches.py

b'diff --git a/news/142.bugfix b/news/142.bugfix\nnew file mode 100644\nindex 00000000..fdbf2500\n--- /dev/null\n+++ b/news/142.bugfix\n@@ -0,0 +1 @@\n+Remove runtime dependency on plone.app.upgrade. @davisagli\ndiff --git a/src/plone/volto/bbb.py b/src/plone/volto/bbb.py\nindex 906d6ded..a8b30aec 100644\n--- a/src/plone/volto/bbb.py\n+++ b/src/plone/volto/bbb.py\n@@ -1,4 +1,8 @@\n # flake8: noqa\n+from types import ModuleType\n+\n+import sys\n+\n \n try:\n     from plone.base.interfaces import IPloneSiteRoot\n@@ -9,3 +13,26 @@\n     from plone.base.utils import get_installer\n except ImportError:\n     from Products.CMFPlone.utils import get_installer\n+\n+\n+# This was copied from plone.app.upgrade\n+# to avoid a hard dependency on it.\n+def alias_module(name, target):\n+    parts = name.split(".")\n+    i = 0\n+    module = None\n+    while i < len(parts) - 1:\n+        i += 1\n+        module_name = ".".join(parts[:i])\n+        try:\n+            __import__(module_name)\n+        except ImportError:\n+            new_module = ModuleType(module_name)\n+            sys.modules[module_name] = new_module\n+            if module is not None:\n+                setattr(module, parts[i - 1], new_module)\n+        module = sys.modules[module_name]\n+\n+    setattr(module, parts[-1], target)\n+    # also make sure sys.modules is updated\n+    sys.modules[module_name + "." + parts[-1]] = target\ndiff --git a/src/plone/volto/patches.py b/src/plone/volto/patches.py\nindex 589eecd7..24cf4a9c 100644\n--- a/src/plone/volto/patches.py\n+++ b/src/plone/volto/patches.py\n@@ -1,9 +1,9 @@\n-from plone.app.upgrade.utils import alias_module\n from plone.registry.interfaces import IRegistry\n from plone.rest.interfaces import IAPIRequest\n from plone.volto import content\n from plone.volto import interfaces\n from plone.volto import logger\n+from plone.volto.bbb import alias_module\n from plone.volto.interfaces import IVoltoSettings\n from Products.SiteErrorLog.SiteErrorLog import _rate_restrict_burst\n from Products.SiteErrorLog.SiteErrorLog import _rate_restrict_period\n'

