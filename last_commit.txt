Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2021-01-18T12:06:35+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/232df3f50d97423ab2027a6ad6771fead222f87b

Remove temp_folder from Zope root if broken.

See https://github.com/plone/Products.CMFPlone/issues/2957

Files changed:
A news/2957.breaking
M plone/app/upgrade/v60/alphas.py
M plone/app/upgrade/v60/configure.zcml

b'diff --git a/news/2957.breaking b/news/2957.breaking\nnew file mode 100644\nindex 00000000..617e73d1\n--- /dev/null\n+++ b/news/2957.breaking\n@@ -0,0 +1,3 @@\n+Remove temp_folder from Zope root if broken.\n+See `issue 2957 <https://github.com/plone/Products.CMFPlone/issues/2957>`_.\n+[maurits]\ndiff --git a/plone/app/upgrade/v60/alphas.py b/plone/app/upgrade/v60/alphas.py\nindex 36b5b051..dc23d0d7 100644\n--- a/plone/app/upgrade/v60/alphas.py\n+++ b/plone/app/upgrade/v60/alphas.py\n@@ -1,13 +1,5 @@\n # -*- coding: utf-8 -*-\n-from BTrees.OOBTree import OOBTree\n-from plone.app.upgrade.utils import cleanUpSkinsTool\n from plone.app.upgrade.utils import loadMigrationProfile\n-from plone.dexterity.interfaces import IDexterityFTI\n-from plone.folder.nogopip import manage_addGopipIndex\n-from plone.registry.interfaces import IRegistry\n-from Products.CMFCore.utils import getToolByName\n-from Products.PlonePAS.tools.memberdata import MemberData\n-from zope.component import getUtility\n \n import logging\n \n@@ -17,5 +9,28 @@\n \n def to60alpha1(context):\n     loadMigrationProfile(context, \'profile-plone.app.upgrade.v60:to60alpha1\')\n-    # portal = getToolByName(context, \'portal_url\').getPortalObject()\n \n+\n+def remove_temp_folder(context):\n+    """Remove temp_folder from Zope root if broken."""\n+    from ZODB.broken import Broken\n+\n+    app = context.unrestrictedTraverse("/")\n+    broken_id = "temp_folder"\n+    if broken_id in app.objectIds():\n+        temp_folder = app.unrestrictedTraverse(broken_id, None)\n+        if not isinstance(temp_folder, Broken):\n+            logger.info("%s is not broken, so we keep it.", broken_id)\n+            return\n+        app._delObject(broken_id)\n+        logger.info("Removed broken %s from Zope root.", broken_id)\n+\n+    # The root Zope object has a dictionary \'_mount_points.\n+    # >>> app._mount_points\n+    # {\'temp_folder\': MountedObject(id=\'temp_folder\')}\n+    if not hasattr(app, "_mount_points"):\n+        return\n+    if broken_id in app._mount_points:\n+        del app._mount_points[broken_id]\n+        app._p_changed = True\n+        logger.info("Removed %s from Zope root _mount_points.", broken_id)\ndiff --git a/plone/app/upgrade/v60/configure.zcml b/plone/app/upgrade/v60/configure.zcml\nindex e25ee8c3..dd9646a9 100644\n--- a/plone/app/upgrade/v60/configure.zcml\n+++ b/plone/app/upgrade/v60/configure.zcml\n@@ -17,6 +17,11 @@\n            handler=".alphas.to60alpha1"\n            />\n \n+      <gs:upgradeStep\n+           title="Remove broken temp_folder / tempstorage / Products.TemporaryStorage"\n+           handler=".alphas.remove_temp_folder"\n+           />\n+\n     </gs:upgradeSteps>\n \n \n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2021-01-20T17:56:42+01:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.upgrade/commit/40aecb1ea616388579b4733069b4253901cac73a

Merge pull request #252 from plone/maurits/remove-tempstorage

Remove temp_folder from Zope root if broken.

Files changed:
A news/2957.breaking
M plone/app/upgrade/v60/alphas.py
M plone/app/upgrade/v60/configure.zcml

b'diff --git a/news/2957.breaking b/news/2957.breaking\nnew file mode 100644\nindex 00000000..617e73d1\n--- /dev/null\n+++ b/news/2957.breaking\n@@ -0,0 +1,3 @@\n+Remove temp_folder from Zope root if broken.\n+See `issue 2957 <https://github.com/plone/Products.CMFPlone/issues/2957>`_.\n+[maurits]\ndiff --git a/plone/app/upgrade/v60/alphas.py b/plone/app/upgrade/v60/alphas.py\nindex 36b5b051..dc23d0d7 100644\n--- a/plone/app/upgrade/v60/alphas.py\n+++ b/plone/app/upgrade/v60/alphas.py\n@@ -1,13 +1,5 @@\n # -*- coding: utf-8 -*-\n-from BTrees.OOBTree import OOBTree\n-from plone.app.upgrade.utils import cleanUpSkinsTool\n from plone.app.upgrade.utils import loadMigrationProfile\n-from plone.dexterity.interfaces import IDexterityFTI\n-from plone.folder.nogopip import manage_addGopipIndex\n-from plone.registry.interfaces import IRegistry\n-from Products.CMFCore.utils import getToolByName\n-from Products.PlonePAS.tools.memberdata import MemberData\n-from zope.component import getUtility\n \n import logging\n \n@@ -17,5 +9,28 @@\n \n def to60alpha1(context):\n     loadMigrationProfile(context, \'profile-plone.app.upgrade.v60:to60alpha1\')\n-    # portal = getToolByName(context, \'portal_url\').getPortalObject()\n \n+\n+def remove_temp_folder(context):\n+    """Remove temp_folder from Zope root if broken."""\n+    from ZODB.broken import Broken\n+\n+    app = context.unrestrictedTraverse("/")\n+    broken_id = "temp_folder"\n+    if broken_id in app.objectIds():\n+        temp_folder = app.unrestrictedTraverse(broken_id, None)\n+        if not isinstance(temp_folder, Broken):\n+            logger.info("%s is not broken, so we keep it.", broken_id)\n+            return\n+        app._delObject(broken_id)\n+        logger.info("Removed broken %s from Zope root.", broken_id)\n+\n+    # The root Zope object has a dictionary \'_mount_points.\n+    # >>> app._mount_points\n+    # {\'temp_folder\': MountedObject(id=\'temp_folder\')}\n+    if not hasattr(app, "_mount_points"):\n+        return\n+    if broken_id in app._mount_points:\n+        del app._mount_points[broken_id]\n+        app._p_changed = True\n+        logger.info("Removed %s from Zope root _mount_points.", broken_id)\ndiff --git a/plone/app/upgrade/v60/configure.zcml b/plone/app/upgrade/v60/configure.zcml\nindex e25ee8c3..dd9646a9 100644\n--- a/plone/app/upgrade/v60/configure.zcml\n+++ b/plone/app/upgrade/v60/configure.zcml\n@@ -17,6 +17,11 @@\n            handler=".alphas.to60alpha1"\n            />\n \n+      <gs:upgradeStep\n+           title="Remove broken temp_folder / tempstorage / Products.TemporaryStorage"\n+           handler=".alphas.remove_temp_folder"\n+           />\n+\n     </gs:upgradeSteps>\n \n \n'

