Repository: plone.app.theming


Branch: refs/heads/master
Date: 2023-12-25T12:07:34+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.theming/commit/54e9141022764e63ef8ed81e0adace5baa2f715d

Traverse to theme resources from the portal. Fix broken theme when rendering accessible content contained in an inaccessible navigation-root. Fixes #142

Files changed:
A news/142.bugfix
M src/plone/app/theming/utils.py

b'diff --git a/news/142.bugfix b/news/142.bugfix\nnew file mode 100644\nindex 00000000..e4eb67be\n--- /dev/null\n+++ b/news/142.bugfix\n@@ -0,0 +1,2 @@\n+Traverse to theme resources from the portal. Fix broken theme when rendering accessible content contained in an inaccessible navigation-root. Fixes #142\n+[pbauer]\ndiff --git a/src/plone/app/theming/utils.py b/src/plone/app/theming/utils.py\nindex 27a9198d..dcba1a4e 100644\n--- a/src/plone/app/theming/utils.py\n+++ b/src/plone/app/theming/utils.py\n@@ -161,13 +161,10 @@ def resolve(self, system_url, public_id, context):\n \n         context = findContext(request)\n         portalState = queryMultiAdapter((context, request), name="plone_portal_state")\n-\n-        if portalState is None:\n-            root = None\n-        else:\n-            root = portalState.navigation_root()\n+        portal = portalState.portal()\n \n         if not system_url.startswith("/"):  # only for relative urls\n+            root = portalState.navigation_root()\n             root_path = root.getPhysicalPath()\n             context_path = context.getPhysicalPath()[len(root_path) :]\n             if len(context_path) == 0:\n@@ -175,7 +172,7 @@ def resolve(self, system_url, public_id, context):\n             else:\n                 system_url = "/{:s}/{:s}".format("/".join(context_path), system_url)\n \n-        response = subrequest(system_url, root=root)\n+        response = subrequest(system_url, root=portal)\n         if response.status != 200:\n             LOGGER.error(f"Couldn\'t resolve {system_url:s}")\n             return None\n'

Repository: plone.app.theming


Branch: refs/heads/master
Date: 2024-01-12T10:14:59+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.theming/commit/4c87b372ac0d55b6a82e7cee4172406d486bec96

Merge pull request #232 from plone/fix_theme_in_inaccessible_navroot

Traverse to theme resources from the portal

Files changed:
A news/142.bugfix
M src/plone/app/theming/utils.py

b'diff --git a/news/142.bugfix b/news/142.bugfix\nnew file mode 100644\nindex 00000000..e4eb67be\n--- /dev/null\n+++ b/news/142.bugfix\n@@ -0,0 +1,2 @@\n+Traverse to theme resources from the portal. Fix broken theme when rendering accessible content contained in an inaccessible navigation-root. Fixes #142\n+[pbauer]\ndiff --git a/src/plone/app/theming/utils.py b/src/plone/app/theming/utils.py\nindex 27a9198d..dcba1a4e 100644\n--- a/src/plone/app/theming/utils.py\n+++ b/src/plone/app/theming/utils.py\n@@ -161,13 +161,10 @@ def resolve(self, system_url, public_id, context):\n \n         context = findContext(request)\n         portalState = queryMultiAdapter((context, request), name="plone_portal_state")\n-\n-        if portalState is None:\n-            root = None\n-        else:\n-            root = portalState.navigation_root()\n+        portal = portalState.portal()\n \n         if not system_url.startswith("/"):  # only for relative urls\n+            root = portalState.navigation_root()\n             root_path = root.getPhysicalPath()\n             context_path = context.getPhysicalPath()[len(root_path) :]\n             if len(context_path) == 0:\n@@ -175,7 +172,7 @@ def resolve(self, system_url, public_id, context):\n             else:\n                 system_url = "/{:s}/{:s}".format("/".join(context_path), system_url)\n \n-        response = subrequest(system_url, root=root)\n+        response = subrequest(system_url, root=portal)\n         if response.status != 200:\n             LOGGER.error(f"Couldn\'t resolve {system_url:s}")\n             return None\n'

