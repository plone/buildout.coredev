Repository: Products.CMFPlone


Branch: refs/heads/6.0.x
Date: 2023-11-29T12:39:52+01:00
Author: Mikel Larreategi (erral) <mlarreategi@codesyntax.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/9c2ec1e3a1490d9df2d6aaae74b1af3b4b525f60

handle parenthesis inside quotes

Files changed:
A news/3879.bugfix
M Products/CMFPlone/browser/search.py
M Products/CMFPlone/tests/testSearch.py

b'diff --git a/Products/CMFPlone/browser/search.py b/Products/CMFPlone/browser/search.py\nindex 108a8f0b54..84503505dd 100644\n--- a/Products/CMFPlone/browser/search.py\n+++ b/Products/CMFPlone/browser/search.py\n@@ -45,10 +45,11 @@ def quote(term):\n     # being parsed as logical query atoms.\n     if term.lower() in ("and", "or", "not"):\n         term = \'"%s"\' % term\n-    return term\n+    return quote_chars(term)\n \n \n def munge_search_term(query):\n+    original_query = query\n     for char in BAD_CHARS:\n         query = query.replace(char, " ")\n \n@@ -67,7 +68,7 @@ def munge_search_term(query):\n \n     r += map(quote, query.strip().split())\n     r = " AND ".join(r)\n-    r = quote_chars(r) + ("*" if r and not r.endswith(\'"\') else "")\n+    r = r + ("*" if r and not original_query.endswith(\'"\') else "")\n     return r\n \n \ndiff --git a/Products/CMFPlone/tests/testSearch.py b/Products/CMFPlone/tests/testSearch.py\nindex 54b43d8861..e1d00b8567 100644\n--- a/Products/CMFPlone/tests/testSearch.py\n+++ b/Products/CMFPlone/tests/testSearch.py\n@@ -364,6 +364,21 @@ def test_munge_search_term(self):\n                 \'" spam ham   "\',\n                 \'"spam ham"\',\n             ),\n+            (\n+                # quoted term with inner parenthesis\n+                \'"spam (ham)"\',\n+                \'"spam (ham)"\',\n+            ),\n+            (\n+                # quoted term with inner parenthesis\n+                \'"spam" (ham)\',\n+                \'"spam" AND "("ham")"*\',\n+            ),\n+            (\n+                # quoted term with inner parenthesis\n+                \'"(spam ham)"\',\n+                \'"(spam ham)"\',\n+            ),\n             (\n                 # mixed cases\n                 "Spam hAm",\ndiff --git a/news/3879.bugfix b/news/3879.bugfix\nnew file mode 100644\nindex 0000000000..2b1cb9b691\n--- /dev/null\n+++ b/news/3879.bugfix\n@@ -0,0 +1,2 @@\n+Handle catalog queries with parenthesis inside quotes\n+[erral]\n'

Repository: Products.CMFPlone


Branch: refs/heads/6.0.x
Date: 2023-12-14T12:19:38+01:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/Products.CMFPlone/commit/a91b86bdbc20376d6ac7933b79209e90ada13af0

Merge pull request #3880 from plone/erral-issue-3879

Handle parenthesis inside quotes

Files changed:
A news/3879.bugfix
M Products/CMFPlone/browser/search.py
M Products/CMFPlone/tests/testSearch.py

b'diff --git a/Products/CMFPlone/browser/search.py b/Products/CMFPlone/browser/search.py\nindex 108a8f0b54..84503505dd 100644\n--- a/Products/CMFPlone/browser/search.py\n+++ b/Products/CMFPlone/browser/search.py\n@@ -45,10 +45,11 @@ def quote(term):\n     # being parsed as logical query atoms.\n     if term.lower() in ("and", "or", "not"):\n         term = \'"%s"\' % term\n-    return term\n+    return quote_chars(term)\n \n \n def munge_search_term(query):\n+    original_query = query\n     for char in BAD_CHARS:\n         query = query.replace(char, " ")\n \n@@ -67,7 +68,7 @@ def munge_search_term(query):\n \n     r += map(quote, query.strip().split())\n     r = " AND ".join(r)\n-    r = quote_chars(r) + ("*" if r and not r.endswith(\'"\') else "")\n+    r = r + ("*" if r and not original_query.endswith(\'"\') else "")\n     return r\n \n \ndiff --git a/Products/CMFPlone/tests/testSearch.py b/Products/CMFPlone/tests/testSearch.py\nindex 54b43d8861..e1d00b8567 100644\n--- a/Products/CMFPlone/tests/testSearch.py\n+++ b/Products/CMFPlone/tests/testSearch.py\n@@ -364,6 +364,21 @@ def test_munge_search_term(self):\n                 \'" spam ham   "\',\n                 \'"spam ham"\',\n             ),\n+            (\n+                # quoted term with inner parenthesis\n+                \'"spam (ham)"\',\n+                \'"spam (ham)"\',\n+            ),\n+            (\n+                # quoted term with inner parenthesis\n+                \'"spam" (ham)\',\n+                \'"spam" AND "("ham")"*\',\n+            ),\n+            (\n+                # quoted term with inner parenthesis\n+                \'"(spam ham)"\',\n+                \'"(spam ham)"\',\n+            ),\n             (\n                 # mixed cases\n                 "Spam hAm",\ndiff --git a/news/3879.bugfix b/news/3879.bugfix\nnew file mode 100644\nindex 0000000000..2b1cb9b691\n--- /dev/null\n+++ b/news/3879.bugfix\n@@ -0,0 +1,2 @@\n+Handle catalog queries with parenthesis inside quotes\n+[erral]\n'

