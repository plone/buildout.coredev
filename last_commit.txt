Repository: plone.namedfile


Branch: refs/heads/master
Date: 2023-06-16T18:07:34+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.namedfile/commit/c0f54ef3354b2aa4141acf7db0442877fb90926d

Fix tests to work with various beautifulsoup4 versions.

Fixes tests in combination with Zope 5.8.3:
https://github.com/plone/buildout.coredev/pull/867#issuecomment-1594898540

Files changed:
A news/867.tests
M plone/namedfile/tests/test_scaling.py

b'diff --git a/news/867.tests b/news/867.tests\nnew file mode 100644\nindex 0000000..1763206\n--- /dev/null\n+++ b/news/867.tests\n@@ -0,0 +1,2 @@\n+Fix tests to work with various ``beautifulsoup4`` versions.\n+[maurits]\ndiff --git a/plone/namedfile/tests/test_scaling.py b/plone/namedfile/tests/test_scaling.py\nindex 4bba8eb..7934763 100644\n--- a/plone/namedfile/tests/test_scaling.py\n+++ b/plone/namedfile/tests/test_scaling.py\n@@ -547,9 +547,17 @@ def testGetPictureTagByName(self, mock_uuid_to_object):\n http://nohost/item/@@images/image-800-....png 800w,\n http://nohost/item/@@images/image-1000-....png 1000w,\n http://nohost/item/@@images/image-1200-....png 1200w"/>\n- <img height="200" loading="lazy" src="http://nohost/item/@@images/image-600-....png" title="foo" width="200"/>\n+ <img...src="http://nohost/item/@@images/image-600-....png".../>\n </picture>"""\n-        self.assertTrue(_ellipsis_match(expected, tag))\n+        self.assertTrue(_ellipsis_match(expected, tag.strip()))\n+\n+        # The exact placement of the img tag attributes can differ, especially\n+        # with different beautifulsoup versions.\n+        # So check here that all attributes are present.\n+        self.assertIn(\'height="200"\', tag)\n+        self.assertIn(\'loading="lazy"\', tag)\n+        self.assertIn(\'title="foo"\', tag)\n+        self.assertIn(\'width="200"\', tag)\n \n     @patch.object(\n         plone.namedfile.scaling,\n@@ -580,9 +588,18 @@ def testGetPictureTagWithAltAndTitle(self, mock_uuid_to_object):\n {base}/@@images/image-800-....png 800w,\n {base}/@@images/image-1000-....png 1000w,\n {base}/@@images/image-1200-....png 1200w"/>\n- <img alt="Alternative text" height="200" loading="lazy" src="{base}/@@images/image-600-....png" title="Custom title" width="200"/>\n+ <img...src="{base}/@@images/image-600-....png".../>\n </picture>"""\n-        self.assertTrue(_ellipsis_match(expected, tag))\n+        self.assertTrue(_ellipsis_match(expected, tag.strip()))\n+\n+        # The exact placement of the img tag attributes can differ, especially\n+        # with different beautifulsoup versions.\n+        # So check here that all attributes are present.\n+        self.assertIn(\'alt="Alternative text"\', tag)\n+        self.assertIn(\'height="200"\', tag)\n+        self.assertIn(\'loading="lazy"\', tag)\n+        self.assertIn(\'title="Custom title"\', tag)\n+        self.assertIn(\'width="200"\', tag)\n \n     @patch.object(\n         plone.namedfile.scaling,\n@@ -601,8 +618,15 @@ def testGetPictureTagWithoutAnyVariants(self, mock_uuid_to_object):\n         ImageScaling._sizes = patch_Img2PictureTag_allowed_scales()\n         mock_uuid_to_object.return_value = self.item\n         tag = self.scaling.picture("image", picture_variant="medium")\n-        expected = """<img src="http://nohost/item/@@images/image-0-....png" title="foo" height="200" width="200" />"""\n-        self.assertTrue(_ellipsis_match(expected, tag))\n+        expected = """<img...src="http://nohost/item/@@images/image-0-....png".../>"""\n+        self.assertTrue(_ellipsis_match(expected, tag.strip()))\n+\n+        # The exact placement of the img tag attributes can differ, especially\n+        # with different beautifulsoup versions.\n+        # So check here that all attributes are present.\n+        self.assertIn(\'height="200"\', tag)\n+        self.assertIn(\'title="foo"\', tag)\n+        self.assertIn(\'width="200"\', tag)\n \n     def testGetUnknownScale(self):\n         foo = self.scaling.scale("image", scale="foo?")\n'

Repository: plone.namedfile


Branch: refs/heads/master
Date: 2023-06-19T09:58:25+02:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.namedfile/commit/4f554b6201ccbeda7f2f0d3fd4edd7ffee212d44

Merge pull request #146 from plone/maurits-fix-tests-with-newer-beautifulsoup

Fix tests to work with various beautifulsoup4 versions.

Files changed:
A news/867.tests
M plone/namedfile/tests/test_scaling.py

b'diff --git a/news/867.tests b/news/867.tests\nnew file mode 100644\nindex 0000000..1763206\n--- /dev/null\n+++ b/news/867.tests\n@@ -0,0 +1,2 @@\n+Fix tests to work with various ``beautifulsoup4`` versions.\n+[maurits]\ndiff --git a/plone/namedfile/tests/test_scaling.py b/plone/namedfile/tests/test_scaling.py\nindex 4bba8eb..7934763 100644\n--- a/plone/namedfile/tests/test_scaling.py\n+++ b/plone/namedfile/tests/test_scaling.py\n@@ -547,9 +547,17 @@ def testGetPictureTagByName(self, mock_uuid_to_object):\n http://nohost/item/@@images/image-800-....png 800w,\n http://nohost/item/@@images/image-1000-....png 1000w,\n http://nohost/item/@@images/image-1200-....png 1200w"/>\n- <img height="200" loading="lazy" src="http://nohost/item/@@images/image-600-....png" title="foo" width="200"/>\n+ <img...src="http://nohost/item/@@images/image-600-....png".../>\n </picture>"""\n-        self.assertTrue(_ellipsis_match(expected, tag))\n+        self.assertTrue(_ellipsis_match(expected, tag.strip()))\n+\n+        # The exact placement of the img tag attributes can differ, especially\n+        # with different beautifulsoup versions.\n+        # So check here that all attributes are present.\n+        self.assertIn(\'height="200"\', tag)\n+        self.assertIn(\'loading="lazy"\', tag)\n+        self.assertIn(\'title="foo"\', tag)\n+        self.assertIn(\'width="200"\', tag)\n \n     @patch.object(\n         plone.namedfile.scaling,\n@@ -580,9 +588,18 @@ def testGetPictureTagWithAltAndTitle(self, mock_uuid_to_object):\n {base}/@@images/image-800-....png 800w,\n {base}/@@images/image-1000-....png 1000w,\n {base}/@@images/image-1200-....png 1200w"/>\n- <img alt="Alternative text" height="200" loading="lazy" src="{base}/@@images/image-600-....png" title="Custom title" width="200"/>\n+ <img...src="{base}/@@images/image-600-....png".../>\n </picture>"""\n-        self.assertTrue(_ellipsis_match(expected, tag))\n+        self.assertTrue(_ellipsis_match(expected, tag.strip()))\n+\n+        # The exact placement of the img tag attributes can differ, especially\n+        # with different beautifulsoup versions.\n+        # So check here that all attributes are present.\n+        self.assertIn(\'alt="Alternative text"\', tag)\n+        self.assertIn(\'height="200"\', tag)\n+        self.assertIn(\'loading="lazy"\', tag)\n+        self.assertIn(\'title="Custom title"\', tag)\n+        self.assertIn(\'width="200"\', tag)\n \n     @patch.object(\n         plone.namedfile.scaling,\n@@ -601,8 +618,15 @@ def testGetPictureTagWithoutAnyVariants(self, mock_uuid_to_object):\n         ImageScaling._sizes = patch_Img2PictureTag_allowed_scales()\n         mock_uuid_to_object.return_value = self.item\n         tag = self.scaling.picture("image", picture_variant="medium")\n-        expected = """<img src="http://nohost/item/@@images/image-0-....png" title="foo" height="200" width="200" />"""\n-        self.assertTrue(_ellipsis_match(expected, tag))\n+        expected = """<img...src="http://nohost/item/@@images/image-0-....png".../>"""\n+        self.assertTrue(_ellipsis_match(expected, tag.strip()))\n+\n+        # The exact placement of the img tag attributes can differ, especially\n+        # with different beautifulsoup versions.\n+        # So check here that all attributes are present.\n+        self.assertIn(\'height="200"\', tag)\n+        self.assertIn(\'title="foo"\', tag)\n+        self.assertIn(\'width="200"\', tag)\n \n     def testGetUnknownScale(self):\n         foo = self.scaling.scale("image", scale="foo?")\n'

