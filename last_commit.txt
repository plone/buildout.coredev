Repository: Products.PortalTransforms


Branch: refs/heads/master
Date: 2022-03-15T13:05:31+01:00
Author: Andrea Cecchi (cekk) <andrea.cecchi85@gmail.com>
Commit: https://github.com/plone/Products.PortalTransforms/commit/47eee976ec9aaf9af7ef049d99f5202e2e6fcfc6

when serializing back to html, use lxml html method

instead of xml method which auto closes tags
and turns \r into &amp;#13; entity.

Files changed:
A news/43.bugfix
M Products/PortalTransforms/tests/output/test_word.html
M Products/PortalTransforms/tests/test_transforms.py
M Products/PortalTransforms/tests/test_xss.py
M Products/PortalTransforms/transforms/safe_html.py

b'diff --git a/Products/PortalTransforms/tests/output/test_word.html b/Products/PortalTransforms/tests/output/test_word.html\nindex 8d98605..b70694f 100644\n--- a/Products/PortalTransforms/tests/output/test_word.html\n+++ b/Products/PortalTransforms/tests/output/test_word.html\n@@ -1,8 +1,8 @@\n-<br/>\n+<br>\n \n \n \n-<p/><div name="Default" align="left" style="  padding: 0.00mm 0.00mm 0.00mm 0.00mm; ">\n+<p></p><div name="Default" align="left" style="  padding: 0.00mm 0.00mm 0.00mm 0.00mm; ">\n \n <p style="text-indent: 0.00mm; text-align: left; line-height: 4.166667mm; color: Black; background-color: White; ">\n how odd: blank named file in directory\ndiff --git a/Products/PortalTransforms/tests/test_transforms.py b/Products/PortalTransforms/tests/test_transforms.py\nindex 9093636..755817c 100644\n--- a/Products/PortalTransforms/tests/test_transforms.py\n+++ b/Products/PortalTransforms/tests/test_transforms.py\n@@ -198,7 +198,7 @@ def test_kill_nasty_tags_which_are_not_valid(self):\n         self.assertTrue(\'script\' in self.settings.nasty_tags)\n         self.assertFalse(\'script\' in self.settings.valid_tags)\n         orig = \'<p><script>foo</script></p>\'\n-        data_out = \'<p/>\'\n+        data_out = \'<p></p>\'\n         data = self.transforms.convertTo(target_mimetype=\'text/x-html-safe\', orig=orig)\n         got = data.getData()\n         self.assertIsInstance(got, self.allowed_types)\n@@ -207,7 +207,7 @@ def test_kill_nasty_tags_which_are_not_valid(self):\n         self.assertTrue(\'h1\' in self.settings.nasty_tags)\n         self.assertFalse(\'h1\' in self.settings.valid_tags)\n         orig = \'<p><h1>foo</h1></p>\'\n-        data_out = \'<p/>\'\n+        data_out = \'<p></p>\'\n         data = self.transforms.convertTo(target_mimetype=\'text/x-html-safe\', orig=orig)\n         got = data.getData()\n         self.assertIsInstance(got, self.allowed_types)\n@@ -215,7 +215,7 @@ def test_kill_nasty_tags_which_are_not_valid(self):\n \n     def test_entityiref_attributes(self):\n         orig = \'<a href="&uuml;">foo</a>\'\n-        data_out = \'<a href="&#xFC;">foo</a>\'\n+        data_out = \'<a href="%C3%BC">foo</a>\'\n         data = self.transforms.convertTo(target_mimetype=\'text/x-html-safe\', orig=orig)\n         got = data.getData()\n         self.assertIsInstance(got, self.allowed_types)\n@@ -245,6 +245,13 @@ def test_charref_data(self):\n         self.assertIsInstance(got, self.allowed_types)\n         self.assertEqual(got, data_out)\n \n+    def test_do_not_autoclose_tags(self):\n+        orig = \'<p></p>\'\n+        data_out = \'<p></p>\'\n+        data = self.transforms.convertTo(target_mimetype=\'text/x-html-safe\', orig=orig)\n+        got = data.getData()\n+        self.assertEqual(got, data_out)\n+\n \n class SafeHtmlTransformsWithScriptTest(TransformTestCase):\n \n@@ -391,7 +398,7 @@ def test_form_with_input_kept(self):\n             \'<form>\'\n             \'<label>Hello</label> \'\n             \'<button name="but">Click here</button> \'\n-            \'<input type="text" value="hi"/> \'\n+            \'<input type="text" value="hi"> \'\n             \'<select name="sel"><option value="1">One</option></select> \'\n             \'<textarea name="text">Stuff</textarea>\'\n             \'</form>\')\ndiff --git a/Products/PortalTransforms/tests/test_xss.py b/Products/PortalTransforms/tests/test_xss.py\nindex f277360..d673696 100644\n--- a/Products/PortalTransforms/tests/test_xss.py\n+++ b/Products/PortalTransforms/tests/test_xss.py\n@@ -31,22 +31,22 @@ def doTest(self, data_in, data_out):  # noqa\n \n     def test_1(self):\n         data_in = """<html><body><img src="javascript:Alert(\'XSS\');" /></body></html>"""  # noqa\n-        data_out = \'<img/>\'\n+        data_out = \'<img>\'\n         self.doTest(data_in, data_out)\n \n     def test_2(self):\n         data_in = """<img src="javascript:Alert(\'XSS\');" />"""\n-        data_out = \'<img/>\'\n+        data_out = \'<img>\'\n         self.doTest(data_in, data_out)\n \n     def test_3(self):\n         data_in = """<html><body><IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;></body></html>"""  # noqa\n-        data_out = \'<img/>\'\n+        data_out = \'<img>\'\n         self.doTest(data_in, data_out)\n \n     def test_4(self):\n         data_in = """<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;>"""  # noqa\n-        data_out = \'<img/>\'\n+        data_out = \'<img>\'\n \n         self.doTest(data_in, data_out)\n \n@@ -54,12 +54,12 @@ def test_5(self):\n         data_in = """<img src="jav\n         asc\n         ript:Alert(\'XSS\');" />"""\n-        data_out = \'<img/>\'\n+        data_out = \'<img>\'\n         self.doTest(data_in, data_out)\n \n     def test_6(self):\n         data_in = """<img src="jav asc ript:Alert(\'XSS\');"/>"""\n-        data_out = \'<img/>\'\n+        data_out = \'<img>\'\n         self.doTest(data_in, data_out)\n \n     def test_7(self):\n@@ -92,14 +92,14 @@ def test_11(self):\n \n     def test_12(self):\n         data_in = """<img src="vbscript:msgbox(\'XSS\')"/>"""\n-        data_out = \'<img/>\'\n+        data_out = \'<img>\'\n         self.doTest(data_in, data_out)\n \n     def test_13(self):\n         data_in = """<img src="vb\n         sc\n         ript:msgbox(\'XSS\')"/>"""\n-        data_out = \'<img/>\'\n+        data_out = \'<img>\'\n         self.doTest(data_in, data_out)\n \n     def test_14(self):\n@@ -137,7 +137,7 @@ def test_19(self):\n         self.doTest(data_in, data_out)\n \n     def test_20(self):\n-        data_in = \'<img src="http://www.headnet.dk/log.jpg"/>\'\n+        data_in = \'<img src="http://www.headnet.dk/log.jpg">\'\n         data_out = data_in\n         self.doTest(data_in, data_out)\n \n@@ -228,9 +228,10 @@ def test_37(self):\n \n     def test_38(self):\n         data_in = """<p><a href="http://T\\\\foo\\\\20111015\\\\bar.msg">FOO</a></p>"""  # noqa\n-        self.doTest(data_in, data_in)\n+        data_out = """<p><a href="http://T%5Cfoo%5C20111015%5Cbar.msg">FOO</a></p>"""\n+        self.doTest(data_in, data_out)\n \n     def test_39(self):\n         data_in = """<a href="&#42;&Ascr;\\xa9"></a>"""\n-        data_out = \'<a href="*&amp;Ascr;&#xA9;"/>\'\n+        data_out = \'<a href="*&amp;Ascr;%C2%A9"></a>\'\n         self.doTest(data_in, data_out)\ndiff --git a/Products/PortalTransforms/transforms/safe_html.py b/Products/PortalTransforms/transforms/safe_html.py\nindex 3152bfa..0f2ef57 100644\n--- a/Products/PortalTransforms/transforms/safe_html.py\n+++ b/Products/PortalTransforms/transforms/safe_html.py\n@@ -2458,9 +2458,10 @@ def strip_outer(s):\n             return \'\'\n         # remove all except body or outer div\n         if six.PY2:\n-            result = etree.tostring(tree, encoding=\'utf-8\').strip()\n+            result = etree.tostring(\n+                tree, encoding=\'utf-8\', method="html").strip()\n         else:\n-            result = etree.tounicode(tree).strip()\n+            result = etree.tounicode(tree, method="html").strip()\n         return strip_outer(result)\n \n \ndiff --git a/news/43.bugfix b/news/43.bugfix\nnew file mode 100644\nindex 0000000..0943e06\n--- /dev/null\n+++ b/news/43.bugfix\n@@ -0,0 +1,2 @@\n+Prevent auto-closed empty tags in safe_html output.\n+[cekk]\n'

Repository: Products.PortalTransforms


Branch: refs/heads/master
Date: 2022-03-15T17:07:58+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.PortalTransforms/commit/c2c70e25824f1097adff8b2f538e0542cd3e16f0

Merge pull request #43 from plone/do_not_autoclose_tags

use html method to avoid autoclosed tags

Files changed:
A news/43.bugfix
M Products/PortalTransforms/tests/output/test_word.html
M Products/PortalTransforms/tests/test_transforms.py
M Products/PortalTransforms/tests/test_xss.py
M Products/PortalTransforms/transforms/safe_html.py

b'diff --git a/Products/PortalTransforms/tests/output/test_word.html b/Products/PortalTransforms/tests/output/test_word.html\nindex 8d98605..b70694f 100644\n--- a/Products/PortalTransforms/tests/output/test_word.html\n+++ b/Products/PortalTransforms/tests/output/test_word.html\n@@ -1,8 +1,8 @@\n-<br/>\n+<br>\n \n \n \n-<p/><div name="Default" align="left" style="  padding: 0.00mm 0.00mm 0.00mm 0.00mm; ">\n+<p></p><div name="Default" align="left" style="  padding: 0.00mm 0.00mm 0.00mm 0.00mm; ">\n \n <p style="text-indent: 0.00mm; text-align: left; line-height: 4.166667mm; color: Black; background-color: White; ">\n how odd: blank named file in directory\ndiff --git a/Products/PortalTransforms/tests/test_transforms.py b/Products/PortalTransforms/tests/test_transforms.py\nindex 9093636..755817c 100644\n--- a/Products/PortalTransforms/tests/test_transforms.py\n+++ b/Products/PortalTransforms/tests/test_transforms.py\n@@ -198,7 +198,7 @@ def test_kill_nasty_tags_which_are_not_valid(self):\n         self.assertTrue(\'script\' in self.settings.nasty_tags)\n         self.assertFalse(\'script\' in self.settings.valid_tags)\n         orig = \'<p><script>foo</script></p>\'\n-        data_out = \'<p/>\'\n+        data_out = \'<p></p>\'\n         data = self.transforms.convertTo(target_mimetype=\'text/x-html-safe\', orig=orig)\n         got = data.getData()\n         self.assertIsInstance(got, self.allowed_types)\n@@ -207,7 +207,7 @@ def test_kill_nasty_tags_which_are_not_valid(self):\n         self.assertTrue(\'h1\' in self.settings.nasty_tags)\n         self.assertFalse(\'h1\' in self.settings.valid_tags)\n         orig = \'<p><h1>foo</h1></p>\'\n-        data_out = \'<p/>\'\n+        data_out = \'<p></p>\'\n         data = self.transforms.convertTo(target_mimetype=\'text/x-html-safe\', orig=orig)\n         got = data.getData()\n         self.assertIsInstance(got, self.allowed_types)\n@@ -215,7 +215,7 @@ def test_kill_nasty_tags_which_are_not_valid(self):\n \n     def test_entityiref_attributes(self):\n         orig = \'<a href="&uuml;">foo</a>\'\n-        data_out = \'<a href="&#xFC;">foo</a>\'\n+        data_out = \'<a href="%C3%BC">foo</a>\'\n         data = self.transforms.convertTo(target_mimetype=\'text/x-html-safe\', orig=orig)\n         got = data.getData()\n         self.assertIsInstance(got, self.allowed_types)\n@@ -245,6 +245,13 @@ def test_charref_data(self):\n         self.assertIsInstance(got, self.allowed_types)\n         self.assertEqual(got, data_out)\n \n+    def test_do_not_autoclose_tags(self):\n+        orig = \'<p></p>\'\n+        data_out = \'<p></p>\'\n+        data = self.transforms.convertTo(target_mimetype=\'text/x-html-safe\', orig=orig)\n+        got = data.getData()\n+        self.assertEqual(got, data_out)\n+\n \n class SafeHtmlTransformsWithScriptTest(TransformTestCase):\n \n@@ -391,7 +398,7 @@ def test_form_with_input_kept(self):\n             \'<form>\'\n             \'<label>Hello</label> \'\n             \'<button name="but">Click here</button> \'\n-            \'<input type="text" value="hi"/> \'\n+            \'<input type="text" value="hi"> \'\n             \'<select name="sel"><option value="1">One</option></select> \'\n             \'<textarea name="text">Stuff</textarea>\'\n             \'</form>\')\ndiff --git a/Products/PortalTransforms/tests/test_xss.py b/Products/PortalTransforms/tests/test_xss.py\nindex f277360..d673696 100644\n--- a/Products/PortalTransforms/tests/test_xss.py\n+++ b/Products/PortalTransforms/tests/test_xss.py\n@@ -31,22 +31,22 @@ def doTest(self, data_in, data_out):  # noqa\n \n     def test_1(self):\n         data_in = """<html><body><img src="javascript:Alert(\'XSS\');" /></body></html>"""  # noqa\n-        data_out = \'<img/>\'\n+        data_out = \'<img>\'\n         self.doTest(data_in, data_out)\n \n     def test_2(self):\n         data_in = """<img src="javascript:Alert(\'XSS\');" />"""\n-        data_out = \'<img/>\'\n+        data_out = \'<img>\'\n         self.doTest(data_in, data_out)\n \n     def test_3(self):\n         data_in = """<html><body><IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;></body></html>"""  # noqa\n-        data_out = \'<img/>\'\n+        data_out = \'<img>\'\n         self.doTest(data_in, data_out)\n \n     def test_4(self):\n         data_in = """<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;>"""  # noqa\n-        data_out = \'<img/>\'\n+        data_out = \'<img>\'\n \n         self.doTest(data_in, data_out)\n \n@@ -54,12 +54,12 @@ def test_5(self):\n         data_in = """<img src="jav\n         asc\n         ript:Alert(\'XSS\');" />"""\n-        data_out = \'<img/>\'\n+        data_out = \'<img>\'\n         self.doTest(data_in, data_out)\n \n     def test_6(self):\n         data_in = """<img src="jav asc ript:Alert(\'XSS\');"/>"""\n-        data_out = \'<img/>\'\n+        data_out = \'<img>\'\n         self.doTest(data_in, data_out)\n \n     def test_7(self):\n@@ -92,14 +92,14 @@ def test_11(self):\n \n     def test_12(self):\n         data_in = """<img src="vbscript:msgbox(\'XSS\')"/>"""\n-        data_out = \'<img/>\'\n+        data_out = \'<img>\'\n         self.doTest(data_in, data_out)\n \n     def test_13(self):\n         data_in = """<img src="vb\n         sc\n         ript:msgbox(\'XSS\')"/>"""\n-        data_out = \'<img/>\'\n+        data_out = \'<img>\'\n         self.doTest(data_in, data_out)\n \n     def test_14(self):\n@@ -137,7 +137,7 @@ def test_19(self):\n         self.doTest(data_in, data_out)\n \n     def test_20(self):\n-        data_in = \'<img src="http://www.headnet.dk/log.jpg"/>\'\n+        data_in = \'<img src="http://www.headnet.dk/log.jpg">\'\n         data_out = data_in\n         self.doTest(data_in, data_out)\n \n@@ -228,9 +228,10 @@ def test_37(self):\n \n     def test_38(self):\n         data_in = """<p><a href="http://T\\\\foo\\\\20111015\\\\bar.msg">FOO</a></p>"""  # noqa\n-        self.doTest(data_in, data_in)\n+        data_out = """<p><a href="http://T%5Cfoo%5C20111015%5Cbar.msg">FOO</a></p>"""\n+        self.doTest(data_in, data_out)\n \n     def test_39(self):\n         data_in = """<a href="&#42;&Ascr;\\xa9"></a>"""\n-        data_out = \'<a href="*&amp;Ascr;&#xA9;"/>\'\n+        data_out = \'<a href="*&amp;Ascr;%C2%A9"></a>\'\n         self.doTest(data_in, data_out)\ndiff --git a/Products/PortalTransforms/transforms/safe_html.py b/Products/PortalTransforms/transforms/safe_html.py\nindex 3152bfa..0f2ef57 100644\n--- a/Products/PortalTransforms/transforms/safe_html.py\n+++ b/Products/PortalTransforms/transforms/safe_html.py\n@@ -2458,9 +2458,10 @@ def strip_outer(s):\n             return \'\'\n         # remove all except body or outer div\n         if six.PY2:\n-            result = etree.tostring(tree, encoding=\'utf-8\').strip()\n+            result = etree.tostring(\n+                tree, encoding=\'utf-8\', method="html").strip()\n         else:\n-            result = etree.tounicode(tree).strip()\n+            result = etree.tounicode(tree, method="html").strip()\n         return strip_outer(result)\n \n \ndiff --git a/news/43.bugfix b/news/43.bugfix\nnew file mode 100644\nindex 0000000..0943e06\n--- /dev/null\n+++ b/news/43.bugfix\n@@ -0,0 +1,2 @@\n+Prevent auto-closed empty tags in safe_html output.\n+[cekk]\n'

