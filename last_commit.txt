Repository: plone.app.upgrade


Branch: refs/heads/2.x
Date: 2022-08-27T12:15:42+02:00
Author: ale-rt (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/85c96b354599e9ea273ee55ab0355127fda3c2cd

Add a timezone property to portal memberdata if it is missing

Backports #296 to Plone 5.2

Files changed:
A news/296.fixed
M plone/app/upgrade/v52/configure.zcml
M plone/app/upgrade/v52/final.py

b'diff --git a/news/296.fixed b/news/296.fixed\nnew file mode 100644\nindex 00000000..b1123ddf\n--- /dev/null\n+++ b/news/296.fixed\n@@ -0,0 +1,3 @@\n+Add a timezone property to portal memberdata if it is missing\n+    \n+Backports #296 to Plone 5.2\ndiff --git a/plone/app/upgrade/v52/configure.zcml b/plone/app/upgrade/v52/configure.zcml\nindex dd44d942..9f689905 100644\n--- a/plone/app/upgrade/v52/configure.zcml\n+++ b/plone/app/upgrade/v52/configure.zcml\n@@ -265,8 +265,8 @@\n         profile="Products.CMFPlone:plone">\n \n         <gs:upgradeStep\n-            title="Miscellaneous upgrades to Plone 5.2.10"\n-            handler="..utils.null_upgrade_step"\n+            title="Add a timezone property to portal memberdata if it is missing."\n+            handler=".final.add_the_timezone_property"\n             />\n \n     </gs:upgradeSteps>\ndiff --git a/plone/app/upgrade/v52/final.py b/plone/app/upgrade/v52/final.py\nindex 78aa1b58..c49cd866 100644\n--- a/plone/app/upgrade/v52/final.py\n+++ b/plone/app/upgrade/v52/final.py\n@@ -267,3 +267,11 @@ def secure_portal_setup_objects(context):\n         return\n     _recursive_strict_permission(context.snapshots)\n     logger.info("Made portal_setup snapshots only available for Manager and Owner.")\n+\n+\n+def add_the_timezone_property(context):\n+    """Ensure that the portal_memberdata tool has the timezone property."""\n+    portal_memberdata = getToolByName(context, "portal_memberdata")\n+    if portal_memberdata.hasProperty("timezone"):\n+        return\n+    portal_memberdata.manage_addProperty("timezone", "", "string")\n'

Repository: plone.app.upgrade


Branch: refs/heads/2.x
Date: 2022-08-29T10:35:15+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/e5fffabf0a351c0d8f4670be2f605bb6c9c9df4a

Merge pull request #297 from plone/296-backport

[5.2] Add a timezone property to portal memberdata if it is missing

Files changed:
A news/296.fixed
M plone/app/upgrade/v52/configure.zcml
M plone/app/upgrade/v52/final.py

b'diff --git a/news/296.fixed b/news/296.fixed\nnew file mode 100644\nindex 00000000..b1123ddf\n--- /dev/null\n+++ b/news/296.fixed\n@@ -0,0 +1,3 @@\n+Add a timezone property to portal memberdata if it is missing\n+    \n+Backports #296 to Plone 5.2\ndiff --git a/plone/app/upgrade/v52/configure.zcml b/plone/app/upgrade/v52/configure.zcml\nindex dd44d942..9f689905 100644\n--- a/plone/app/upgrade/v52/configure.zcml\n+++ b/plone/app/upgrade/v52/configure.zcml\n@@ -265,8 +265,8 @@\n         profile="Products.CMFPlone:plone">\n \n         <gs:upgradeStep\n-            title="Miscellaneous upgrades to Plone 5.2.10"\n-            handler="..utils.null_upgrade_step"\n+            title="Add a timezone property to portal memberdata if it is missing."\n+            handler=".final.add_the_timezone_property"\n             />\n \n     </gs:upgradeSteps>\ndiff --git a/plone/app/upgrade/v52/final.py b/plone/app/upgrade/v52/final.py\nindex 78aa1b58..c49cd866 100644\n--- a/plone/app/upgrade/v52/final.py\n+++ b/plone/app/upgrade/v52/final.py\n@@ -267,3 +267,11 @@ def secure_portal_setup_objects(context):\n         return\n     _recursive_strict_permission(context.snapshots)\n     logger.info("Made portal_setup snapshots only available for Manager and Owner.")\n+\n+\n+def add_the_timezone_property(context):\n+    """Ensure that the portal_memberdata tool has the timezone property."""\n+    portal_memberdata = getToolByName(context, "portal_memberdata")\n+    if portal_memberdata.hasProperty("timezone"):\n+        return\n+    portal_memberdata.manage_addProperty("timezone", "", "string")\n'

