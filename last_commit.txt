Repository: plone.restapi


Branch: refs/heads/7.x.x
Date: 2021-12-29T20:44:44+01:00
Author: Alin Voinea (avoinea) <contact@avoinea.com>
Commit: https://github.com/plone/plone.restapi/commit/90b09deab92767b36ea189139511b0cf45e3b541

7.x.x - Return non-batched vocabularies given a query param b_size=-1 (#1265) (#1305)

* Return non-batched vocabularies given a query param b_size=-1 (#1265)

* Return non-batched vocabularies given a query param not_batched

* Change parameter name to b_size=-1

* Amend changelogg

* Fix tests

Co-authored-by: Víctor Fernández de Alba &lt;sneridagh@gmail.com&gt;

Files changed:
A news/1264.feature
M docs/source/vocabularies.rst
M src/plone/restapi/serializer/vocabularies.py
M src/plone/restapi/tests/test_services_vocabularies.py

b'diff --git a/docs/source/vocabularies.rst b/docs/source/vocabularies.rst\nindex 37a79e39e..d826caf60 100644\n--- a/docs/source/vocabularies.rst\n+++ b/docs/source/vocabularies.rst\n@@ -83,6 +83,8 @@ The token is what should be sent to the server to address that term.\n .. literalinclude:: ../../src/plone/restapi/tests/http-examples/vocabularies_get.resp\n    :language: http\n \n+By default, the vocabularies are batched. However, you can pass ``b_size=-1`` parameter to force the endpoint to return all the terms, not batched response.\n+\n Filter Vocabularies\n ^^^^^^^^^^^^^^^^^^^\n \ndiff --git a/news/1264.feature b/news/1264.feature\nnew file mode 100644\nindex 000000000..1fbea0e0b\n--- /dev/null\n+++ b/news/1264.feature\n@@ -0,0 +1,2 @@\n+Return non-batched vocabularies given a query param ``b_size=-1``\n+[sneridagh]\ndiff --git a/src/plone/restapi/serializer/vocabularies.py b/src/plone/restapi/serializer/vocabularies.py\nindex ce88e23ad..536244168 100644\n--- a/src/plone/restapi/serializer/vocabularies.py\n+++ b/src/plone/restapi/serializer/vocabularies.py\n@@ -30,6 +30,7 @@ def __call__(self, vocabulary_id):\n         vocabulary = self.context\n         title = safe_unicode(self.request.form.get("title", ""))\n         token = self.request.form.get("token", "")\n+        b_size = self.request.form.get("b_size", "")\n \n         terms = []\n         for term in vocabulary:\n@@ -52,9 +53,19 @@ def __call__(self, vocabulary_id):\n                     continue\n                 terms.append(term)\n \n+        serialized_terms = []\n+\n+        # Do not batch parameter is set\n+        if b_size == "-1":\n+            for term in terms:\n+                serializer = getMultiAdapter(\n+                    (term, self.request), interface=ISerializeToJson\n+                )\n+                serialized_terms.append(serializer())\n+            return {"@id": vocabulary_id, "items": serialized_terms}\n+\n         batch = HypermediaBatch(self.request, terms)\n \n-        serialized_terms = []\n         for term in batch:\n             serializer = getMultiAdapter(\n                 (term, self.request), interface=ISerializeToJson\ndiff --git a/src/plone/restapi/tests/test_services_vocabularies.py b/src/plone/restapi/tests/test_services_vocabularies.py\nindex fea8e7d77..4f554f9e0 100644\n--- a/src/plone/restapi/tests/test_services_vocabularies.py\n+++ b/src/plone/restapi/tests/test_services_vocabularies.py\n@@ -38,6 +38,18 @@ def test_vocabulary_factory(context):\n     return TEST_VOCABULARY\n \n \n+TEST_BIG_VOCABULARY = SimpleVocabulary(\n+    [\n+        SimpleTerm(a, token="token{a}".format(a=a), title="Title {a}".format(a=a))\n+        for a in range(100)\n+    ]\n+)\n+\n+\n+def test_big_vocabulary_factory(context):\n+    return TEST_BIG_VOCABULARY\n+\n+\n def test_context_vocabulary_factory(context):\n     return SimpleVocabulary(\n         [\n@@ -294,6 +306,20 @@ def test_context_vocabulary(self):\n             },\n         )\n \n+    def test_big_vocabulary_not_batched(self):\n+        provideUtility(\n+            test_big_vocabulary_factory,\n+            provides=IVocabularyFactory,\n+            name="plone.restapi.tests.test_big_vocabulary",\n+        )\n+        response = self.api_session.get(\n+            "/@vocabularies/plone.restapi.tests.test_big_vocabulary?b_size=-1"\n+        )\n+\n+        self.assertEqual(200, response.status_code)\n+        response = response.json()\n+        self.assertEqual(len(response["items"]), 100)\n+\n     def tearDown(self):\n         self.api_session.close()\n         gsm = getGlobalSiteManager()\n'

