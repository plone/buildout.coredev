Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-02-10T08:18:46+01:00
Author: Víctor Fernández de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/b07a353f5e53620594cd6ca1345e96d73f52d6d8

Add root element to the @breadcrumbs endpoint (#1065)

* Add root element to the @breadcrumbs endpoint

* Remove dangling import

Files changed:
A news/1064.feature
M src/plone/restapi/services/breadcrumbs/get.py
M src/plone/restapi/tests/http-examples/breadcrumbs.resp
M src/plone/restapi/tests/http-examples/expansion_expanded.resp
M src/plone/restapi/tests/http-examples/expansion_expanded_full.resp
M src/plone/restapi/tests/test_services_breadcrumbs.py

b'diff --git a/news/1064.feature b/news/1064.feature\nnew file mode 100644\nindex 000000000..6ba65bb8a\n--- /dev/null\n+++ b/news/1064.feature\n@@ -0,0 +1,2 @@\n+- Add ``root`` element to the @breadcrumbs endpoint\n+  [sneridagh]\ndiff --git a/src/plone/restapi/services/breadcrumbs/get.py b/src/plone/restapi/services/breadcrumbs/get.py\nindex c295d54bd..ba8cf12ba 100644\n--- a/src/plone/restapi/services/breadcrumbs/get.py\n+++ b/src/plone/restapi/services/breadcrumbs/get.py\n@@ -23,6 +23,9 @@ def __call__(self, expand=False):\n         if not expand:\n             return result\n \n+        portal_state = getMultiAdapter(\n+            (self.context, self.request), name="plone_portal_state"\n+        )\n         breadcrumbs_view = getMultiAdapter(\n             (self.context, self.request), name="breadcrumbs_view"\n         )\n@@ -38,6 +41,7 @@ def __call__(self, expand=False):\n             items.append(item)\n \n         result["breadcrumbs"]["items"] = items\n+        result["breadcrumbs"]["root"] = portal_state.navigation_root().absolute_url()\n         return result\n \n \ndiff --git a/src/plone/restapi/tests/http-examples/breadcrumbs.resp b/src/plone/restapi/tests/http-examples/breadcrumbs.resp\nindex 78aebf256..afa342c4e 100644\n--- a/src/plone/restapi/tests/http-examples/breadcrumbs.resp\n+++ b/src/plone/restapi/tests/http-examples/breadcrumbs.resp\n@@ -8,5 +8,6 @@ Content-Type: application/json\n       "@id": "http://localhost:55001/plone/front-page", \n       "title": "Welcome to Plone"\n     }\n-  ]\n+  ], \n+  "root": "http://localhost:55001/plone"\n }\n\\ No newline at end of file\ndiff --git a/src/plone/restapi/tests/http-examples/expansion_expanded.resp b/src/plone/restapi/tests/http-examples/expansion_expanded.resp\nindex f9599d91b..7c05afad3 100644\n--- a/src/plone/restapi/tests/http-examples/expansion_expanded.resp\n+++ b/src/plone/restapi/tests/http-examples/expansion_expanded.resp\n@@ -13,7 +13,8 @@ Content-Type: application/json\n           "@id": "http://localhost:55001/plone/front-page", \n           "title": "Welcome to Plone"\n         }\n-      ]\n+      ], \n+      "root": "http://localhost:55001/plone"\n     }, \n     "contextnavigation": {\n       "@id": "http://localhost:55001/plone/front-page/@contextnavigation"\ndiff --git a/src/plone/restapi/tests/http-examples/expansion_expanded_full.resp b/src/plone/restapi/tests/http-examples/expansion_expanded_full.resp\nindex 8541bf56a..aba9d4da5 100644\n--- a/src/plone/restapi/tests/http-examples/expansion_expanded_full.resp\n+++ b/src/plone/restapi/tests/http-examples/expansion_expanded_full.resp\n@@ -113,7 +113,8 @@ Content-Type: application/json\n           "@id": "http://localhost:55001/plone/front-page", \n           "title": "Welcome to Plone"\n         }\n-      ]\n+      ], \n+      "root": "http://localhost:55001/plone"\n     }, \n     "contextnavigation": {\n       "@id": "http://localhost:55001/plone/front-page/@contextnavigation"\ndiff --git a/src/plone/restapi/tests/test_services_breadcrumbs.py b/src/plone/restapi/tests/test_services_breadcrumbs.py\nindex 962f75586..e8e125ebd 100644\n--- a/src/plone/restapi/tests/test_services_breadcrumbs.py\n+++ b/src/plone/restapi/tests/test_services_breadcrumbs.py\n@@ -5,11 +5,20 @@\n from plone.app.testing import TEST_USER_ID\n from plone.dexterity.utils import createContentInContainer\n from plone.restapi.testing import PLONE_RESTAPI_DX_FUNCTIONAL_TESTING\n+from plone.restapi.testing import PLONE_RESTAPI_DX_PAM_FUNCTIONAL_TESTING\n from plone.restapi.testing import RelativeSession\n+from zope.interface import alsoProvides\n+from plone.restapi.testing import PAM_INSTALLED\n+from plone.app.testing import login\n+\n \n import transaction\n import unittest\n \n+if PAM_INSTALLED:\n+    from plone.app.multilingual.interfaces import IPloneAppMultilingualInstalled  # noqa\n+    from plone.app.multilingual.interfaces import ITranslationManager\n+\n \n class TestServicesBreadcrumbs(unittest.TestCase):\n \n@@ -44,6 +53,7 @@ def test_breadcrumbs(self):\n             response.json(),\n             {\n                 "@id": self.portal_url + u"/folder/doc1/@breadcrumbs",\n+                "root": self.portal_url,\n                 "items": [\n                     {\n                         u"@id": self.portal_url + u"/folder",\n@@ -56,3 +66,62 @@ def test_breadcrumbs(self):\n                 ],\n             },\n         )\n+\n+\n+@unittest.skipUnless(\n+    PAM_INSTALLED, "plone.app.multilingual is installed by default only in Plone 5"\n+)  # NOQA\n+class TestServicesMultilingualBreadcrumbs(unittest.TestCase):\n+\n+    layer = PLONE_RESTAPI_DX_PAM_FUNCTIONAL_TESTING\n+\n+    def setUp(self):\n+        self.portal = self.layer["portal"]\n+        self.portal_url = self.portal.absolute_url()\n+        self.request = self.layer["request"]\n+\n+        self.api_session = RelativeSession(self.portal_url)\n+        self.api_session.headers.update({"Accept": "application/json"})\n+        self.api_session.auth = (SITE_OWNER_NAME, SITE_OWNER_PASSWORD)\n+\n+        alsoProvides(self.layer["request"], IPloneAppMultilingualInstalled)\n+        login(self.portal, SITE_OWNER_NAME)\n+        self.en_content = createContentInContainer(\n+            self.portal["en"], "Document", title=u"Test document"\n+        )\n+        self.es_content = createContentInContainer(\n+            self.portal["es"], "Document", title=u"Test document"\n+        )\n+        ITranslationManager(self.en_content).register_translation("es", self.es_content)\n+        self.folder = createContentInContainer(\n+            self.portal["es"], u"Folder", id=u"folder", title=u"Some Folder"\n+        )\n+        createContentInContainer(\n+            self.folder, u"Document", id=u"doc1", title=u"A document"\n+        )\n+        transaction.commit()\n+\n+    def tearDown(self):\n+        self.api_session.close()\n+\n+    def test_breadcrumbs_multilingual(self):\n+        response = self.api_session.get("/es/folder/doc1/@breadcrumbs")\n+\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(\n+            response.json(),\n+            {\n+                "@id": self.portal_url + u"/es/folder/doc1/@breadcrumbs",\n+                "root": self.portal_url + "/es",\n+                "items": [\n+                    {\n+                        u"@id": self.portal_url + u"/es/folder",\n+                        u"title": u"Some Folder",\n+                    },\n+                    {\n+                        u"@id": self.portal_url + u"/es/folder/doc1",\n+                        u"title": u"A document",\n+                    },\n+                ],\n+            },\n+        )\n'

