Repository: plone.app.layout


Branch: refs/heads/master
Date: 2020-08-12T16:04:18+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.layout/commit/73804f50806fd70f7c705bfcd479cbf03e69d681

Made the error page recognisable again in the body classes.

Instead of `template-index-html` you now get `template-error_message-pt`.
Compatibility note: in Plone 5.1 and earlier, this was `template-default_error_message`.

To get a general idea of what template names and view names can be,
here are some sample combinations from clicking around in the site with an extra print statement:

```
Template name='listing_summary.pt'. View name='summary_view'.
Template name='document.pt'. View name='document_view'.
Template name='event_listing.pt'. View name='event_listing'.
Template name='image.pt'. View name='image_view'.
Template name='error_message.pt'. View name='index.html'.
Template name='login.pt'. View name='login'.
Template name='overview.pt'. View name='overview-controlpanel'.
Template name='actions.pt'. View name='actions-controlpanel'.
Template name='form.pt'. View name='new-action'.
Template name='quickinstaller.pt'. View name='prefs_install_products_form'.
Template name='document.pt'. View name='document_view'.
Template name='layout.pt'. View name='edit'.

```

Files changed:
A news/242.bugfix
M plone/app/layout/globals/layout.py

b'diff --git a/news/242.bugfix b/news/242.bugfix\nnew file mode 100644\nindex 00000000..968dcbd8\n--- /dev/null\n+++ b/news/242.bugfix\n@@ -0,0 +1,4 @@\n+Made the error page recognisable again in the body classes.\n+Instead of ``template-index-html`` you now get ``template-error_message-pt``.\n+Compatibility note: in Plone 5.1 and earlier, this was ``template-default_error_message``.\n+[maurits]\ndiff --git a/plone/app/layout/globals/layout.py b/plone/app/layout/globals/layout.py\nindex c394a28b..ee4512e7 100644\n--- a/plone/app/layout/globals/layout.py\n+++ b/plone/app/layout/globals/layout.py\n@@ -186,6 +186,29 @@ def _toolbar_classes(self):\n             pass\n         return toolbar_classes\n \n+    def _template_name(self, template, view):\n+        """Name of template.\n+\n+        Sometimes it is best to take this from the template, sometimes the view.\n+        Note that neither template nor view are always available.\n+        For example, mosaic passes a view but not a template.\n+        """\n+        view_name = view.__name__ if view else ""\n+        if isinstance(template, TEMPLATE_CLASSES):\n+            # Browser view.  Take the view name.\n+            # But it this is \'index.html\', it may be the error message view.\n+            # It is better to take the template name then.\n+            if view_name != "index.html":\n+                return view_name\n+        # template can be SimpleViewClass, which has no getId.\n+        # Probably caught above with isinstance(template, TEMPLATE_CLASSES),\n+        # but let\'s be careful.\n+        if template and hasattr(template, "getId"):\n+            template_name = template.getId()\n+            if template_name:\n+                return template_name\n+        return view_name\n+\n     def bodyClass(self, template, view):\n         """\n         Returns the CSS class to be used on the body tag.\n@@ -222,15 +245,7 @@ def bodyClass(self, template, view):\n         body_classes = self._toolbar_classes()\n \n         # template class (required)\n-        template_name = ""\n-        if isinstance(template, TEMPLATE_CLASSES):\n-            # Browser view\n-            template_name = view.__name__\n-        elif template is not None:\n-            template_name = template.getId()\n-        elif view:\n-            # E.g. mosaic, which doesn\'t pass a template\n-            template_name = view.__name__\n+        template_name = self._template_name(template, view)\n         if template_name:\n             template_name = normalizer.normalize(template_name)\n             body_classes.add("template-%s" % template_name)\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2020-08-28T09:33:48+02:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.app.layout/commit/99e974a41f7199b0f6d5f6707501feb49a9f787a

Merge pull request #243 from plone/maurits/issue-242-error-template-body-class

Made the error page recognisable again in the body classes.

Files changed:
A news/242.bugfix
M plone/app/layout/globals/layout.py

b'diff --git a/news/242.bugfix b/news/242.bugfix\nnew file mode 100644\nindex 00000000..968dcbd8\n--- /dev/null\n+++ b/news/242.bugfix\n@@ -0,0 +1,4 @@\n+Made the error page recognisable again in the body classes.\n+Instead of ``template-index-html`` you now get ``template-error_message-pt``.\n+Compatibility note: in Plone 5.1 and earlier, this was ``template-default_error_message``.\n+[maurits]\ndiff --git a/plone/app/layout/globals/layout.py b/plone/app/layout/globals/layout.py\nindex c394a28b..ee4512e7 100644\n--- a/plone/app/layout/globals/layout.py\n+++ b/plone/app/layout/globals/layout.py\n@@ -186,6 +186,29 @@ def _toolbar_classes(self):\n             pass\n         return toolbar_classes\n \n+    def _template_name(self, template, view):\n+        """Name of template.\n+\n+        Sometimes it is best to take this from the template, sometimes the view.\n+        Note that neither template nor view are always available.\n+        For example, mosaic passes a view but not a template.\n+        """\n+        view_name = view.__name__ if view else ""\n+        if isinstance(template, TEMPLATE_CLASSES):\n+            # Browser view.  Take the view name.\n+            # But it this is \'index.html\', it may be the error message view.\n+            # It is better to take the template name then.\n+            if view_name != "index.html":\n+                return view_name\n+        # template can be SimpleViewClass, which has no getId.\n+        # Probably caught above with isinstance(template, TEMPLATE_CLASSES),\n+        # but let\'s be careful.\n+        if template and hasattr(template, "getId"):\n+            template_name = template.getId()\n+            if template_name:\n+                return template_name\n+        return view_name\n+\n     def bodyClass(self, template, view):\n         """\n         Returns the CSS class to be used on the body tag.\n@@ -222,15 +245,7 @@ def bodyClass(self, template, view):\n         body_classes = self._toolbar_classes()\n \n         # template class (required)\n-        template_name = ""\n-        if isinstance(template, TEMPLATE_CLASSES):\n-            # Browser view\n-            template_name = view.__name__\n-        elif template is not None:\n-            template_name = template.getId()\n-        elif view:\n-            # E.g. mosaic, which doesn\'t pass a template\n-            template_name = view.__name__\n+        template_name = self._template_name(template, view)\n         if template_name:\n             template_name = normalizer.normalize(template_name)\n             body_classes.add("template-%s" % template_name)\n'

