Repository: mockup


Branch: refs/heads/master
Date: 2020-06-24T14:17:02+02:00
Author: Vincent Fretin (vincentfretin) <vincent.fretin@gmail.com>
Commit: https://github.com/plone/mockup/commit/a7ac0ffe68daefa69ac88a2666551b94148a1ce7

Fix regression with moment relative date not localized

Files changed:
M mockup/patterns/moment/pattern.js

b'diff --git a/mockup/patterns/moment/pattern.js b/mockup/patterns/moment/pattern.js\nindex 3ca09beea..e0afdc124 100644\n--- a/mockup/patterns/moment/pattern.js\n+++ b/mockup/patterns/moment/pattern.js\n@@ -83,10 +83,13 @@\n define([\n   \'jquery\',\n   \'pat-base\',\n+  \'pat-registry\',\n   \'mockup-i18n\',\n   \'moment\'\n-], function($, Base, i18n, moment) {\n+], function($, Base, Registry, i18n, moment) {\n   var currentLanguage = (new i18n()).currentLanguage;\n+  var localeLoaded = false;\n+  var elementsToRender = [];\n \n   // From https://github.com/moment/moment/blob/3147fbc/src/test/moment/format.js#L463-L468\n   var MOMENT_LOCALES =\n@@ -106,6 +109,7 @@ define([\n     if (currentLanguage === LANG_FALLBACK) {\n       // English locale is built-in, no need to load, so let\'s exit early\n       // to avoid computing fallback, which happens at every loaded page\n+      localeLoaded = true;\n       return;\n     }\n \n@@ -116,10 +120,21 @@ define([\n     lang = isLangSupported(lang) ? lang : lang.split(\'-\')[0];\n     lang = isLangSupported(lang) ? lang : LANG_FALLBACK;\n     if (lang === LANG_FALLBACK) {\n+      localeLoaded = true;\n       return;\n     }\n \n-    require([\'moment-url/\' + lang]);\n+    require([\'moment-url/\' + lang], function() {\n+      localeLoaded = true;\n+      for (var i = 0; i < elementsToRender.length; i++) {\n+        var $el = elementsToRender[i];\n+        // $el.data("pattern-moment") needs to be undefined for initBasePattern\n+        // to run again the init (see patternslib/src/core/base.js)\n+        $el.removeData("pattern-moment");\n+        Registry.scan($el, [\'moment\']);\n+      }\n+      elementsToRender = [];\n+    });\n   }\n \n   lazyLoadMomentLocale();\n@@ -170,6 +185,12 @@ define([\n     },\n     init: function() {\n       var self = this;\n+      if (!localeLoaded) {\n+        // The locale has not finished to load yet, we will execute the init\n+        // again once the locale is loaded.\n+        elementsToRender.push(self.$el);\n+        return;\n+      }\n       if (self.options.selector) {\n         self.$el.find(self.options.selector).each(function() {\n           self.convert($(this));\n'

Repository: mockup


Branch: refs/heads/master
Date: 2020-06-24T14:21:10+02:00
Author: Vincent Fretin (vincentfretin) <vincent.fretin@gmail.com>
Commit: https://github.com/plone/mockup/commit/c9f18c91bf8060f31670f33c84da36d11b4d223f

add changelog entry

Files changed:
A news/987.bugfix

b'diff --git a/news/987.bugfix b/news/987.bugfix\nnew file mode 100644\nindex 000000000..2d53370d6\n--- /dev/null\n+++ b/news/987.bugfix\n@@ -0,0 +1,3 @@\n+Fix regression with moment date not localized. This closes\n+https://github.com/plone/Products.CMFPlone/issues/2953\n+[vincentfretin]\n'

Repository: mockup


Branch: refs/heads/master
Date: 2020-06-24T14:49:12+02:00
Author: Vincent Fretin (vincentfretin) <vincent.fretin@gmail.com>
Commit: https://github.com/plone/mockup/commit/3542100f1f61bbe4f8364188a67416cf85ce12b5

Merge pull request #987 from plone/fix-relative-date-translation

Fix regression with moment relative date not localized

Files changed:
A news/987.bugfix
M mockup/patterns/moment/pattern.js

b'diff --git a/mockup/patterns/moment/pattern.js b/mockup/patterns/moment/pattern.js\nindex 3ca09beea..e0afdc124 100644\n--- a/mockup/patterns/moment/pattern.js\n+++ b/mockup/patterns/moment/pattern.js\n@@ -83,10 +83,13 @@\n define([\n   \'jquery\',\n   \'pat-base\',\n+  \'pat-registry\',\n   \'mockup-i18n\',\n   \'moment\'\n-], function($, Base, i18n, moment) {\n+], function($, Base, Registry, i18n, moment) {\n   var currentLanguage = (new i18n()).currentLanguage;\n+  var localeLoaded = false;\n+  var elementsToRender = [];\n \n   // From https://github.com/moment/moment/blob/3147fbc/src/test/moment/format.js#L463-L468\n   var MOMENT_LOCALES =\n@@ -106,6 +109,7 @@ define([\n     if (currentLanguage === LANG_FALLBACK) {\n       // English locale is built-in, no need to load, so let\'s exit early\n       // to avoid computing fallback, which happens at every loaded page\n+      localeLoaded = true;\n       return;\n     }\n \n@@ -116,10 +120,21 @@ define([\n     lang = isLangSupported(lang) ? lang : lang.split(\'-\')[0];\n     lang = isLangSupported(lang) ? lang : LANG_FALLBACK;\n     if (lang === LANG_FALLBACK) {\n+      localeLoaded = true;\n       return;\n     }\n \n-    require([\'moment-url/\' + lang]);\n+    require([\'moment-url/\' + lang], function() {\n+      localeLoaded = true;\n+      for (var i = 0; i < elementsToRender.length; i++) {\n+        var $el = elementsToRender[i];\n+        // $el.data("pattern-moment") needs to be undefined for initBasePattern\n+        // to run again the init (see patternslib/src/core/base.js)\n+        $el.removeData("pattern-moment");\n+        Registry.scan($el, [\'moment\']);\n+      }\n+      elementsToRender = [];\n+    });\n   }\n \n   lazyLoadMomentLocale();\n@@ -170,6 +185,12 @@ define([\n     },\n     init: function() {\n       var self = this;\n+      if (!localeLoaded) {\n+        // The locale has not finished to load yet, we will execute the init\n+        // again once the locale is loaded.\n+        elementsToRender.push(self.$el);\n+        return;\n+      }\n       if (self.options.selector) {\n         self.$el.find(self.options.selector).each(function() {\n           self.convert($(this));\ndiff --git a/news/987.bugfix b/news/987.bugfix\nnew file mode 100644\nindex 000000000..2d53370d6\n--- /dev/null\n+++ b/news/987.bugfix\n@@ -0,0 +1,3 @@\n+Fix regression with moment date not localized. This closes\n+https://github.com/plone/Products.CMFPlone/issues/2953\n+[vincentfretin]\n'

