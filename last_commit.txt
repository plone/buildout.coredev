Repository: plone.volto


Branch: refs/heads/main
Date: 2023-07-12T16:26:43+02:00
Author: Roman (folix-01) <72063601+folix-01@users.noreply.github.com>
Commit: https://github.com/plone/plone.volto/commit/d6fb8441280fb7f00e16857973130750cdf7b871

Use the plone.app.multilingual conditionally (#120)

* Use the plone.app.multilingual conditionally

* make multilingual profile conditional

* make isort happy

---------

Co-authored-by: Jens W. Klein &lt;jk@kleinundpartner.at&gt;

Files changed:
A news/119.bugfix
M src/plone/volto/profiles.zcml
M src/plone/volto/setuphandlers.py

b'diff --git a/news/119.bugfix b/news/119.bugfix\nnew file mode 100644\nindex 00000000..e3f0ff4c\n--- /dev/null\n+++ b/news/119.bugfix\n@@ -0,0 +1,2 @@\n+Use the plone.app.multilingual conditionally so as is not an explicit dependency\n+[@foxtrot-01]\ndiff --git a/src/plone/volto/profiles.zcml b/src/plone/volto/profiles.zcml\nindex 60e759fc..900f54fe 100644\n--- a/src/plone/volto/profiles.zcml\n+++ b/src/plone/volto/profiles.zcml\n@@ -2,6 +2,7 @@\n     xmlns="http://namespaces.zope.org/zope"\n     xmlns:genericsetup="http://namespaces.zope.org/genericsetup"\n     xmlns:i18n="http://namespaces.zope.org/i18n"\n+    xmlns:zcml="http://namespaces.zope.org/i18n"\n     i18n_domain="plone.volto"\n     >\n \n@@ -77,6 +78,7 @@\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       directory="profiles/multilingual"\n       post_handler=".setuphandlers.post_install_multilingual"\n+      zcml:condition="installed plone.app.multilingual"\n       />\n \n   <genericsetup:registerProfile\ndiff --git a/src/plone/volto/setuphandlers.py b/src/plone/volto/setuphandlers.py\nindex 314d9d46..3aa3072d 100644\n--- a/src/plone/volto/setuphandlers.py\n+++ b/src/plone/volto/setuphandlers.py\n@@ -1,8 +1,6 @@\n # -*- coding: utf-8 -*-\n from importlib import import_module\n from plone import api\n-from plone.app.multilingual.browser.setup import SetupMultilingualSite\n-from plone.app.multilingual.setuphandlers import enable_translatable_behavior\n from plone.dexterity.interfaces import IDexterityFTI\n from plone.volto.default_homepage.default import default_home\n from plone.volto.default_homepage.demo import demo_home_page\n@@ -15,9 +13,19 @@\n \n import json\n import logging\n+import pkg_resources\n import transaction\n \n \n+try:\n+    pkg_resources.get_distribution("plone.app.multilingual")\n+    from plone.app.multilingual.browser.setup import SetupMultilingualSite\n+    from plone.app.multilingual.setuphandlers import enable_translatable_behavior\n+\n+    HAS_MULTILINGUAL = True\n+except pkg_resources.DistributionNotFound:\n+    HAS_MULTILINGUAL = False\n+\n PLONE_6 = getattr(import_module("Products.CMFPlone.factory"), "PLONE60MARKER", False)\n \n logger = logging.getLogger("plone.volto")\n@@ -68,12 +76,13 @@ def post_install_multilingual(context):\n \n \n def enable_pam(portal):\n-    # Ensure that portal is portal\n-    portal = api.portal.get()\n-    # Setup the plone.app.multilingual data\n-    sms = SetupMultilingualSite(portal)\n-    sms.setupSite(portal)\n-    enable_translatable_behavior(portal)\n+    if HAS_MULTILINGUAL:\n+        # Ensure that portal is portal\n+        portal = api.portal.get()\n+        # Setup the plone.app.multilingual data\n+        sms = SetupMultilingualSite(portal)\n+        sms.setupSite(portal)\n+        enable_translatable_behavior(portal)\n \n \n def ensure_pam_consistency(portal):\n'

