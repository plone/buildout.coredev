Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2020-04-09T06:03:03+02:00
Author: Thomas Massmann (thomasmassmann) <thomas.massmann@it-spir.it>
Commit: https://github.com/plone/plone.app.upgrade/commit/bf77eadc365d2256abeaefbb4dd183c52649af96

Add upgrade step for 5.2.2 to migrate markdown transform settings.

Files changed:
A news/228.feature
M plone/app/upgrade/v52/configure.zcml
M plone/app/upgrade/v52/final.py
M plone/app/upgrade/v52/tests.py

b'diff --git a/news/228.feature b/news/228.feature\nnew file mode 100644\nindex 00000000..a93976e8\n--- /dev/null\n+++ b/news/228.feature\n@@ -0,0 +1,2 @@\n+Add upgrade step to migrate markdown tranform settings to markup control panel.\n+[thomasmassmann]\ndiff --git a/plone/app/upgrade/v52/configure.zcml b/plone/app/upgrade/v52/configure.zcml\nindex 7d19c988..a17b5f43 100644\n--- a/plone/app/upgrade/v52/configure.zcml\n+++ b/plone/app/upgrade/v52/configure.zcml\n@@ -149,6 +149,11 @@\n             handler=".final.to522"\n             />\n \n+        <gs:upgradeStep\n+            title="Move markdown settings from portal_transforms to Plone registry"\n+            handler=".final.move_markdown_transform_settings_to_registry"\n+            />\n+\n     </gs:upgradeSteps>\n \n </configure>\ndiff --git a/plone/app/upgrade/v52/final.py b/plone/app/upgrade/v52/final.py\nindex 29701a83..06e7e961 100644\n--- a/plone/app/upgrade/v52/final.py\n+++ b/plone/app/upgrade/v52/final.py\n@@ -1,6 +1,9 @@\n # -*- coding: utf-8 -*-\n from plone.app.upgrade.utils import loadMigrationProfile\n from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.interfaces import IMarkupSchema\n+from Products.CMFPlone.utils import safe_unicode\n from zope.component import getUtility\n \n import logging\n@@ -132,3 +135,19 @@ def to521(context):\n def to522(context):\n     """5.2.1 -> 5.2.2"""\n     loadMigrationProfile(context, \'profile-plone.app.upgrade.v52:to522\')\n+\n+\n+def move_markdown_transform_settings_to_registry(context):\n+    """Move markdown settings from portal_transforms to Plone registry.\n+    """\n+    registry = getUtility(IRegistry)\n+    try:\n+        settings = registry.forInterface(IMarkupSchema, prefix=\'plone\')\n+    except KeyError:\n+        # Catch case where markdown_extensions is not yet registered\n+        registry.registerInterface(IMarkupSchema, prefix=\'plone\')\n+        settings = registry.forInterface(IMarkupSchema, prefix=\'plone\')\n+    pt = getToolByName(context, \'portal_transforms\')\n+    extensions = pt.markdown_to_html._config.get(\'enabled_extensions\') or []\n+    extensions = [safe_unicode(ext) for ext in extensions]\n+    settings.markdown_extensions = extensions\ndiff --git a/plone/app/upgrade/v52/tests.py b/plone/app/upgrade/v52/tests.py\nindex 67520c2a..3f49dde4 100644\n--- a/plone/app/upgrade/v52/tests.py\n+++ b/plone/app/upgrade/v52/tests.py\n@@ -3,7 +3,9 @@\n from pkg_resources import get_distribution\n from pkg_resources import parse_version\n from plone.app.testing import PLONE_INTEGRATION_TESTING\n+from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.interfaces import IMarkupSchema\n from zope.component import getUtility\n \n import unittest\n@@ -65,6 +67,36 @@ def test_rebuild_redirections(self):\n         self.assertTupleEqual(storage.get_full(old), redirect)\n \n \n+class UpgradePortalTransforms521to522Test(unittest.TestCase):\n+    layer = PLONE_INTEGRATION_TESTING\n+\n+    def setUp(self):\n+        self.portal = self.layer[\'portal\']\n+        self.request = self.layer[\'request\']\n+        self.pt = self.portal.portal_transforms\n+        registry = getUtility(IRegistry)\n+        self.settings = registry.forInterface(IMarkupSchema, prefix=\'plone\')\n+\n+    def test_migrate_markup_settings(self):\n+        from plone.app.upgrade.v52.final import \\\n+            move_markdown_transform_settings_to_registry\n+        self.pt.markdown_to_html._config[\'enabled_extensions\'] = [\n+            \'markdown.extensions.fenced_code\',\n+            \'markdown.extensions.nl2br\',\n+            \'markdown.extensions.extra\',\n+        ]\n+        move_markdown_transform_settings_to_registry(self.portal)\n+        if getattr(self.settings, \'markdown_extensions\', None):\n+            self.assertEqual(\n+                self.settings.markdown_extensions,\n+                [\n+                    \'markdown.extensions.fenced_code\',\n+                    \'markdown.extensions.nl2br\',\n+                    \'markdown.extensions.extra\',\n+                ]\n+            )\n+\n+\n def test_suite():\n     # Skip these tests on Plone < 5.2a1\n     plone_version = get_distribution(\'Products.CMFPlone\').version\n@@ -74,4 +106,5 @@ def test_suite():\n     suite = unittest.TestSuite()\n     suite.addTest(unittest.makeSuite(UpgradeMemberData51to52Test))\n     suite.addTest(unittest.makeSuite(Various52Test))\n+    suite.addTest(unittest.makeSuite(UpgradePortalTransforms521to522Test))\n     return suite\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2020-04-09T13:15:37+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/9b3f731cbe289fbd1d53af30e9391ac576e6d66b

Merge pull request #229 from plone/228-migrate-markdown-settings

Add upgrade step for 5.2.2 to migrate markdown transform settings.

Files changed:
A news/228.feature
M plone/app/upgrade/v52/configure.zcml
M plone/app/upgrade/v52/final.py
M plone/app/upgrade/v52/tests.py

b'diff --git a/news/228.feature b/news/228.feature\nnew file mode 100644\nindex 00000000..a93976e8\n--- /dev/null\n+++ b/news/228.feature\n@@ -0,0 +1,2 @@\n+Add upgrade step to migrate markdown tranform settings to markup control panel.\n+[thomasmassmann]\ndiff --git a/plone/app/upgrade/v52/configure.zcml b/plone/app/upgrade/v52/configure.zcml\nindex 7d19c988..a17b5f43 100644\n--- a/plone/app/upgrade/v52/configure.zcml\n+++ b/plone/app/upgrade/v52/configure.zcml\n@@ -149,6 +149,11 @@\n             handler=".final.to522"\n             />\n \n+        <gs:upgradeStep\n+            title="Move markdown settings from portal_transforms to Plone registry"\n+            handler=".final.move_markdown_transform_settings_to_registry"\n+            />\n+\n     </gs:upgradeSteps>\n \n </configure>\ndiff --git a/plone/app/upgrade/v52/final.py b/plone/app/upgrade/v52/final.py\nindex 29701a83..06e7e961 100644\n--- a/plone/app/upgrade/v52/final.py\n+++ b/plone/app/upgrade/v52/final.py\n@@ -1,6 +1,9 @@\n # -*- coding: utf-8 -*-\n from plone.app.upgrade.utils import loadMigrationProfile\n from plone.registry.interfaces import IRegistry\n+from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.interfaces import IMarkupSchema\n+from Products.CMFPlone.utils import safe_unicode\n from zope.component import getUtility\n \n import logging\n@@ -132,3 +135,19 @@ def to521(context):\n def to522(context):\n     """5.2.1 -> 5.2.2"""\n     loadMigrationProfile(context, \'profile-plone.app.upgrade.v52:to522\')\n+\n+\n+def move_markdown_transform_settings_to_registry(context):\n+    """Move markdown settings from portal_transforms to Plone registry.\n+    """\n+    registry = getUtility(IRegistry)\n+    try:\n+        settings = registry.forInterface(IMarkupSchema, prefix=\'plone\')\n+    except KeyError:\n+        # Catch case where markdown_extensions is not yet registered\n+        registry.registerInterface(IMarkupSchema, prefix=\'plone\')\n+        settings = registry.forInterface(IMarkupSchema, prefix=\'plone\')\n+    pt = getToolByName(context, \'portal_transforms\')\n+    extensions = pt.markdown_to_html._config.get(\'enabled_extensions\') or []\n+    extensions = [safe_unicode(ext) for ext in extensions]\n+    settings.markdown_extensions = extensions\ndiff --git a/plone/app/upgrade/v52/tests.py b/plone/app/upgrade/v52/tests.py\nindex 67520c2a..3f49dde4 100644\n--- a/plone/app/upgrade/v52/tests.py\n+++ b/plone/app/upgrade/v52/tests.py\n@@ -3,7 +3,9 @@\n from pkg_resources import get_distribution\n from pkg_resources import parse_version\n from plone.app.testing import PLONE_INTEGRATION_TESTING\n+from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n+from Products.CMFPlone.interfaces import IMarkupSchema\n from zope.component import getUtility\n \n import unittest\n@@ -65,6 +67,36 @@ def test_rebuild_redirections(self):\n         self.assertTupleEqual(storage.get_full(old), redirect)\n \n \n+class UpgradePortalTransforms521to522Test(unittest.TestCase):\n+    layer = PLONE_INTEGRATION_TESTING\n+\n+    def setUp(self):\n+        self.portal = self.layer[\'portal\']\n+        self.request = self.layer[\'request\']\n+        self.pt = self.portal.portal_transforms\n+        registry = getUtility(IRegistry)\n+        self.settings = registry.forInterface(IMarkupSchema, prefix=\'plone\')\n+\n+    def test_migrate_markup_settings(self):\n+        from plone.app.upgrade.v52.final import \\\n+            move_markdown_transform_settings_to_registry\n+        self.pt.markdown_to_html._config[\'enabled_extensions\'] = [\n+            \'markdown.extensions.fenced_code\',\n+            \'markdown.extensions.nl2br\',\n+            \'markdown.extensions.extra\',\n+        ]\n+        move_markdown_transform_settings_to_registry(self.portal)\n+        if getattr(self.settings, \'markdown_extensions\', None):\n+            self.assertEqual(\n+                self.settings.markdown_extensions,\n+                [\n+                    \'markdown.extensions.fenced_code\',\n+                    \'markdown.extensions.nl2br\',\n+                    \'markdown.extensions.extra\',\n+                ]\n+            )\n+\n+\n def test_suite():\n     # Skip these tests on Plone < 5.2a1\n     plone_version = get_distribution(\'Products.CMFPlone\').version\n@@ -74,4 +106,5 @@ def test_suite():\n     suite = unittest.TestSuite()\n     suite.addTest(unittest.makeSuite(UpgradeMemberData51to52Test))\n     suite.addTest(unittest.makeSuite(Various52Test))\n+    suite.addTest(unittest.makeSuite(UpgradePortalTransforms521to522Test))\n     return suite\n'

