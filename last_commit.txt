Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2024-03-05T11:03:29+01:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/plone.app.contenttypes/commit/910d27fccf187b0a44c3dfa8259c1fcbed13e86f

Fix folder listing template when `plone.eventlocation` behavior is disabled for Events

Files changed:
A news/679.bugfix
M plone/app/contenttypes/browser/templates/listing.pt
M plone/app/contenttypes/tests/test_folder.py

b'diff --git a/news/679.bugfix b/news/679.bugfix\nnew file mode 100644\nindex 00000000..56ae4847\n--- /dev/null\n+++ b/news/679.bugfix\n@@ -0,0 +1,2 @@\n+Fix folder listing template when `plone.eventlocation` behavior is disabled for Events.\n+[petschki]\ndiff --git a/plone/app/contenttypes/browser/templates/listing.pt b/plone/app/contenttypes/browser/templates/listing.pt\nindex 9e2d7553..25076d62 100644\n--- a/plone/app/contenttypes/browser/templates/listing.pt\n+++ b/plone/app/contenttypes/browser/templates/listing.pt\n@@ -93,7 +93,7 @@\n \n                               <tal:event condition="python:item_is_event">\n                                 <tal:date tal:replace="structure python:view.formatted_date(obj)" />\n-                                <span tal:condition="python:obj.location"\n+                                <span tal:condition="python:obj.location if hasattr(obj, \'location\') else None"\n                                       i18n:translate="label_event_byline_location"\n                                 >\n                             &mdash;\ndiff --git a/plone/app/contenttypes/tests/test_folder.py b/plone/app/contenttypes/tests/test_folder.py\nindex 440eb6c2..47c048f5 100644\n--- a/plone/app/contenttypes/tests/test_folder.py\n+++ b/plone/app/contenttypes/tests/test_folder.py\n@@ -1,3 +1,5 @@\n+from datetime import datetime\n+from datetime import timedelta\n from plone.app.contenttypes.browser.folder import FolderView\n from plone.app.contenttypes.interfaces import IFolder\n from plone.app.contenttypes.testing import (  # noqa\n@@ -232,3 +234,26 @@ def test_list_item_wout_title(self):\n         # And also in tabular view\n         self.browser.open(self.folder_url + "/tabular_view")\n         self.assertIn("doc_wout_title", self.browser.contents)\n+\n+    def test_event_wout_location(self):\n+        # deactivate "plone.eventlocation" from Event behaviors\n+        event_fti = self.portal.portal_types.get("Event")\n+        if not event_fti:\n+            return\n+        event_behaviors = list(event_fti.behaviors)\n+        event_behaviors.remove("plone.eventlocation")\n+        event_fti.behaviors = tuple(event_behaviors)\n+\n+        self.folder.invokeFactory(\n+            "Event",\n+            id="event_wout_location",\n+            title="Event without location",\n+            start=datetime.now() + timedelta(days=1),\n+        )\n+\n+        import transaction\n+\n+        transaction.commit()\n+\n+        self.browser.open(self.folder_url + "/listing_view")\n+        self.assertIn("Event without location", self.browser.contents)\n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2024-03-05T11:03:29+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.contenttypes/commit/590f436b9a19430a602f7cc6698ef854bbdc7054

Update plone/app/contenttypes/browser/templates/listing.pt

Files changed:
M plone/app/contenttypes/browser/templates/listing.pt

b'diff --git a/plone/app/contenttypes/browser/templates/listing.pt b/plone/app/contenttypes/browser/templates/listing.pt\nindex 25076d62..9ad3df22 100644\n--- a/plone/app/contenttypes/browser/templates/listing.pt\n+++ b/plone/app/contenttypes/browser/templates/listing.pt\n@@ -93,7 +93,7 @@\n \n                               <tal:event condition="python:item_is_event">\n                                 <tal:date tal:replace="structure python:view.formatted_date(obj)" />\n-                                <span tal:condition="python:obj.location if hasattr(obj, \'location\') else None"\n+                                <span tal:condition="python:getattr(obj.aq_base, \'location\', None)"\n                                       i18n:translate="label_event_byline_location"\n                                 >\n                             &mdash;\n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2024-03-05T19:10:06+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.contenttypes/commit/8973038dd19c382f02a3bbb5f008e3eb3f76c6eb

Merge pull request #680 from plone/fix-679

Fix folder listing template when `plone.eventlocation` behavior is disabled

Files changed:
A news/679.bugfix
M plone/app/contenttypes/browser/templates/listing.pt
M plone/app/contenttypes/tests/test_folder.py

b'diff --git a/news/679.bugfix b/news/679.bugfix\nnew file mode 100644\nindex 00000000..56ae4847\n--- /dev/null\n+++ b/news/679.bugfix\n@@ -0,0 +1,2 @@\n+Fix folder listing template when `plone.eventlocation` behavior is disabled for Events.\n+[petschki]\ndiff --git a/plone/app/contenttypes/browser/templates/listing.pt b/plone/app/contenttypes/browser/templates/listing.pt\nindex 9e2d7553..9ad3df22 100644\n--- a/plone/app/contenttypes/browser/templates/listing.pt\n+++ b/plone/app/contenttypes/browser/templates/listing.pt\n@@ -93,7 +93,7 @@\n \n                               <tal:event condition="python:item_is_event">\n                                 <tal:date tal:replace="structure python:view.formatted_date(obj)" />\n-                                <span tal:condition="python:obj.location"\n+                                <span tal:condition="python:getattr(obj.aq_base, \'location\', None)"\n                                       i18n:translate="label_event_byline_location"\n                                 >\n                             &mdash;\ndiff --git a/plone/app/contenttypes/tests/test_folder.py b/plone/app/contenttypes/tests/test_folder.py\nindex 440eb6c2..47c048f5 100644\n--- a/plone/app/contenttypes/tests/test_folder.py\n+++ b/plone/app/contenttypes/tests/test_folder.py\n@@ -1,3 +1,5 @@\n+from datetime import datetime\n+from datetime import timedelta\n from plone.app.contenttypes.browser.folder import FolderView\n from plone.app.contenttypes.interfaces import IFolder\n from plone.app.contenttypes.testing import (  # noqa\n@@ -232,3 +234,26 @@ def test_list_item_wout_title(self):\n         # And also in tabular view\n         self.browser.open(self.folder_url + "/tabular_view")\n         self.assertIn("doc_wout_title", self.browser.contents)\n+\n+    def test_event_wout_location(self):\n+        # deactivate "plone.eventlocation" from Event behaviors\n+        event_fti = self.portal.portal_types.get("Event")\n+        if not event_fti:\n+            return\n+        event_behaviors = list(event_fti.behaviors)\n+        event_behaviors.remove("plone.eventlocation")\n+        event_fti.behaviors = tuple(event_behaviors)\n+\n+        self.folder.invokeFactory(\n+            "Event",\n+            id="event_wout_location",\n+            title="Event without location",\n+            start=datetime.now() + timedelta(days=1),\n+        )\n+\n+        import transaction\n+\n+        transaction.commit()\n+\n+        self.browser.open(self.folder_url + "/listing_view")\n+        self.assertIn("Event without location", self.browser.contents)\n'

