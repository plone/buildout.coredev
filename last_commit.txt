Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2022-03-07T17:39:44+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/2c296a9d72b380b21235d93bcf54e25c71fd7750

By default, do not create a tempstorage on Plone 6.

See https://github.com/plone/plone.recipe.zope2instance/issues/180

Files changed:
A news/180.feature
M src/plone/recipe/zope2instance/recipe.py

b'diff --git a/news/180.feature b/news/180.feature\nnew file mode 100644\nindex 0000000..f72dc35\n--- /dev/null\n+++ b/news/180.feature\n@@ -0,0 +1,3 @@\n+By default, do not create a tempstorage on Plone 6.\n+See `issue 180 <https://github.com/plone/plone.recipe.zope2instance/issues/180>`_.\n+[maurits]\ndiff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex 3d3dfda..2bb69c8 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -13,6 +13,7 @@\n #\n ##############################################################################\n \n+from pkg_resources import parse_version\n from plone.recipe.zope2instance import make\n from warnings import warn\n from zc.recipe.egg.egg import Egg\n@@ -698,7 +699,17 @@ def is_rs_option(name):\n         if options.get("storage-wrapper"):\n             storage_snippet = indent(options["storage-wrapper"] % storage_snippet, 4)\n \n-        zodb_tmp_storage = options.get("zodb-temporary-storage", "on")\n+        zodb_tmp_storage = options.get("zodb-temporary-storage")\n+        if zodb_tmp_storage is None:\n+            # What should be the default?\n+            # In Plone 6 we do not want to use the temporary storage anymore.\n+            # See https://github.com/plone/plone.recipe.zope2instance/issues/180\n+            requirements, ws = self.egg.working_set(["plone.recipe.zope2instance"])\n+            cmfplone = ws.by_key.get("products.cmfplone")\n+            if cmfplone and parse_version(cmfplone.version) >= parse_version("6.0.0a1"):\n+                zodb_tmp_storage = "off"\n+            else:\n+                zodb_tmp_storage = "on"\n         if zodb_tmp_storage.lower() in ("off", "false", "0"):\n             # no temporary-storage snippet\n             zodb_tmp_storage = ""\n'

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2022-03-16T22:32:08+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/04bb4cd987506b519913e1eff41bbca3fcaf8a54

Merge pull request #185 from plone/maurits-no-tempstorage-in-plone6

By default, do not create a tempstorage on Plone 6.

Files changed:
A news/180.feature
M src/plone/recipe/zope2instance/recipe.py

b'diff --git a/news/180.feature b/news/180.feature\nnew file mode 100644\nindex 0000000..f72dc35\n--- /dev/null\n+++ b/news/180.feature\n@@ -0,0 +1,3 @@\n+By default, do not create a tempstorage on Plone 6.\n+See `issue 180 <https://github.com/plone/plone.recipe.zope2instance/issues/180>`_.\n+[maurits]\ndiff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex 3d3dfda..2bb69c8 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -13,6 +13,7 @@\n #\n ##############################################################################\n \n+from pkg_resources import parse_version\n from plone.recipe.zope2instance import make\n from warnings import warn\n from zc.recipe.egg.egg import Egg\n@@ -698,7 +699,17 @@ def is_rs_option(name):\n         if options.get("storage-wrapper"):\n             storage_snippet = indent(options["storage-wrapper"] % storage_snippet, 4)\n \n-        zodb_tmp_storage = options.get("zodb-temporary-storage", "on")\n+        zodb_tmp_storage = options.get("zodb-temporary-storage")\n+        if zodb_tmp_storage is None:\n+            # What should be the default?\n+            # In Plone 6 we do not want to use the temporary storage anymore.\n+            # See https://github.com/plone/plone.recipe.zope2instance/issues/180\n+            requirements, ws = self.egg.working_set(["plone.recipe.zope2instance"])\n+            cmfplone = ws.by_key.get("products.cmfplone")\n+            if cmfplone and parse_version(cmfplone.version) >= parse_version("6.0.0a1"):\n+                zodb_tmp_storage = "off"\n+            else:\n+                zodb_tmp_storage = "on"\n         if zodb_tmp_storage.lower() in ("off", "false", "0"):\n             # no temporary-storage snippet\n             zodb_tmp_storage = ""\n'

