Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2021-05-10T17:30:14+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/1eed0f952091b26ed2cae3f92457de8d93da6103

Basic repoze.profile integration

Files changed:
M README.rst
M setup.py
M src/plone/recipe/zope2instance/recipe.py

b'diff --git a/README.rst b/README.rst\nindex f16ce93..8801bda 100644\n--- a/README.rst\n+++ b/README.rst\n@@ -157,7 +157,7 @@ verbose-security\n   implementation). Defaults to `off` (and the C security implementation).\n \n debug-exceptions\n-  WSGI only: set to `on` to disable exception views including\n+  WSGI only: set to ``on`` to disable exception views including\n   ``standard_error_message``. Exceptions other than ``Unauthorized`` or\n   ``ConflictError`` can then travel up into the WSGI stack. Use this option\n   if you want more convenient error debugging offered by WSGI middleware\n@@ -166,6 +166,38 @@ debug-exceptions\n   WSGI documentation <https://zope.readthedocs.io/en/latest/wsgi.html>`_ for\n   examples.\n \n+profile\n+  Set to ``on`` enables `repoze.profile <https://github.com/repoze/repoze.profile>`_.\n+  Defaults to ``off``,\n+  If switched on there are further options prefixed with ``profile_`` to configure it as below.\n+\n+profile_log_filename\n+  Filename of the raw profile data.\n+  Default to ``profile-SECTIONNAME.raw``.\n+  This file contains the raw profile data for further analysis.\n+\n+profile_cachegrind_filename\n+  If the package ``pyprof2calltree`` is installed, another file is written.\n+  It is meant for consumation with any cachegrind compatible application.\n+  Defaults to ``cachegrind.out.SECTIONNAME``.\n+\n+profile_discard_first_request\n+  Defaults to ``true``.\n+  See `repoze.profile docs <https://repozeprofile.readthedocs.io/en/latest/#configuration-via-python>`_ for details.\n+\n+profile_path\n+  Defaults to ``/__profile__``.\n+  The path for through the web access to the last profiled request.\n+\n+profile_flush_at_shutdown\n+  Defaults to ``true``.\n+  See `repoze.profile docs <https://repozeprofile.readthedocs.io/en/latest/#configuration-via-python>`_ for details.\n+\n+profile_unwind\n+  Defaults to ``false``.\n+  See `repoze.profile docs <https://repozeprofile.readthedocs.io/en/latest/#configuration-via-python>`_ for details.\n+\n+\n Direct storage\n --------------\n \ndiff --git a/setup.py b/setup.py\nindex 0e33403..5b8675a 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -53,7 +53,11 @@\n         \'ZEO\',\n         \'waitress >= 1.2.0\',\n         \'Paste\',\n+<<<<<<< HEAD\n         \'python-dotenv\'\n+=======\n+        \'repoze.profile\',\n+>>>>>>> 8f25081... Basic repoze.profile integration\n     ],\n     extras_require={\n         \'test\': [\ndiff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex 8adf7fd..c4a257c 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -798,6 +798,41 @@ def build_wsgi_ini(self):\n         sentry_level = options.get(\'sentry_level\', \'INFO\')\n         sentry_event_level = options.get(\'sentry_event_level\', \'ERROR\')\n         sentry_ignore = options.get(\'sentry_ignore\', \'\')\n+        profile = options.get(\'profile\', \'\').strip() == \'on\'\n+        if profile:\n+            pipeline.append(\'profile\')\n+        default_profile_log_filename = os.path.sep.join(\n+            [\n+                var_dir,\n+                \'log\',\n+                \'profile-{0}.raw\'.format(self.name),\n+            ]\n+        )\n+        profile_log_filename = options.get(\n+            \'profile_log_filename\',\n+            default_profile_log_filename\n+        )\n+        default_profile_log_filename = os.path.sep.join(\n+            [\n+                var_dir,\n+                \'log\',\n+                \'cachegrind.out.{0}\'.format(self.name),\n+            ]\n+        )\n+        profile_cachegrind_filename = options.get(\n+            \'profile_cachegrind_filename\',\n+            default_profile_log_filename\n+        )\n+        profile_discard_first_request = options.get(\n+            \'profile_discard_first_request\',\n+            \'true\'\n+        )\n+        profile_path = options.get(\'profile_path\', \'/__profile__\')\n+        profile_flush_at_shutdown = options.get(\n+            \'profile_flush_at_shutdown\',\n+            \'true\'\n+        )\n+        profile_unwind = options.get(\'profile_unwind\', \'false\')\n \n         if "zope" not in pipeline:\n             pipeline.append(\'zope\')\n@@ -827,8 +862,13 @@ def build_wsgi_ini(self):\n             \'sentry_ignore\': sentry_ignore,\n             \'sentry_level\': sentry_level,\n             \'threads\': options.get(\'threads\', 4),\n+            \'profile_log_filename\': profile_log_filename,\n+            \'profile_cachegrind_filename\': profile_cachegrind_filename,\n+            \'profile_discard_first_request\': profile_discard_first_request,\n+            \'profile_path\': profile_path,\n+            \'profile_flush_at_shutdown\': profile_flush_at_shutdown,\n+            \'profile_unwind\': profile_unwind,\n         }\n-\n         global wsgi_ini_template\n         wsgi_ini_template_path = self.options.get(\'wsgi-ini-template\')\n         if wsgi_ini_template_path:\n@@ -1409,6 +1449,15 @@ def render_file_storage(self, file_storage, blob_storage,\n event_level = %(sentry_event_level)s\n ignorelist = %(sentry_ignore)s\n \n+[filter:profile]\n+use = egg:repoze.profile\n+log_filename = %(profile_log_filename)s\n+cachegrind_filename = %(profile_cachegrind_filename)s\n+discard_first_request = %(profile_discard_first_request)s\n+path = %(profile_path)s\n+flush_at_shutdown = %(profile_flush_at_shutdown)s\n+unwind = %(profile_unwind)s\n+\n [pipeline:main]\n pipeline =\n     %(pipeline)s\n'

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2021-05-10T17:30:14+02:00
Author: Jens Vagelpohl (dataflake) <jens@netz.ooo>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/0146246339d7b8674e65765482d1816a47a64505

Fix syntax error due to merge conflict

Files changed:
M setup.py

b"diff --git a/setup.py b/setup.py\nindex 5b8675a..bda8ed0 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -53,11 +53,8 @@\n         'ZEO',\n         'waitress >= 1.2.0',\n         'Paste',\n-<<<<<<< HEAD\n         'python-dotenv'\n-=======\n         'repoze.profile',\n->>>>>>> 8f25081... Basic repoze.profile integration\n     ],\n     extras_require={\n         'test': [\n"

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2021-05-10T17:30:14+02:00
Author: Jens Vagelpohl (dataflake) <jens@netz.ooo>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/6743490860c0340e2c892aa3124b54589aa38e51

- add missing comma

Files changed:
M setup.py

b"diff --git a/setup.py b/setup.py\nindex bda8ed0..0334816 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -53,7 +53,7 @@\n         'ZEO',\n         'waitress >= 1.2.0',\n         'Paste',\n-        'python-dotenv'\n+        'python-dotenv',\n         'repoze.profile',\n     ],\n     extras_require={\n"

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2021-05-10T17:55:44+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/a8ff5f0b85b7fc91e8b91ac1fb8d32605b86c7b9

add a test and changelog

Files changed:
A news/129.feature
M src/plone/recipe/zope2instance/recipe.py
M src/plone/recipe/zope2instance/tests/wsgi.rst

b'diff --git a/news/129.feature b/news/129.feature\nnew file mode 100644\nindex 0000000..b9e13d6\n--- /dev/null\n+++ b/news/129.feature\n@@ -0,0 +1 @@\n+Add repoze.profile profiling middleware support [jensens]\n\\ No newline at end of file\ndiff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex c4a257c..2c1e89b 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -798,9 +798,13 @@ def build_wsgi_ini(self):\n         sentry_level = options.get(\'sentry_level\', \'INFO\')\n         sentry_event_level = options.get(\'sentry_event_level\', \'ERROR\')\n         sentry_ignore = options.get(\'sentry_ignore\', \'\')\n+\n         profile = options.get(\'profile\', \'\').strip() == \'on\'\n         if profile:\n-            pipeline.append(\'profile\')\n+            if "zope" in pipeline:\n+                pipeline.insert(pipeline.index("zope"), \'profile\')\n+            else:\n+                pipeline.append(\'profile\')\n         default_profile_log_filename = os.path.sep.join(\n             [\n                 var_dir,\ndiff --git a/src/plone/recipe/zope2instance/tests/wsgi.rst b/src/plone/recipe/zope2instance/tests/wsgi.rst\nindex 192e08b..63c39e2 100644\n--- a/src/plone/recipe/zope2instance/tests/wsgi.rst\n+++ b/src/plone/recipe/zope2instance/tests/wsgi.rst\n@@ -469,7 +469,7 @@ The buildout has updated our INI file:\n     level = INFO\n     event_level = ERROR\n     ignorelist =\n-    <BLANKLINE>\n+    ...\n     [pipeline:main]\n     pipeline =\n         translogger\n@@ -522,7 +522,7 @@ The buildout has updated our INI file:\n     level = DEBUG\n     event_level = WARNING\n     ignorelist = waitress.queue foo\n-    <BLANKLINE>\n+    ...\n     [pipeline:main]\n     pipeline =\n         translogger\n@@ -576,4 +576,54 @@ The buildout has updated our INI file and we can see that we have a custom pipel\n     ...\n \n \n+With repoze.profile middleware\n+==============================\n+\n+The recipe can configure custom pipelines in the ``wsgi.ini``::\n+\n+    >>> write(\'buildout.cfg\',\n+    ... \'\'\'\n+    ... [buildout]\n+    ... parts = instance\n+    ... find-links = %(sample_buildout)s/eggs\n+    ...\n+    ... [instance]\n+    ... recipe = plone.recipe.zope2instance\n+    ... eggs =\n+    ... user = me:me\n+    ... profile = on\n+    ... \'\'\' % options)\n+\n+Let\'s run it::\n+\n+    >>> print(system(join(\'bin\', \'buildout\'))),\n+    Uninstalling instance.\n+    Installing instance.\n+    ...\n+\n+The buildout has updated our INI file and we can see that we have a custom pipeline::\n+\n+    >>> wsgi_ini = open(os.path.join(instance, \'etc\', \'wsgi.ini\')).read()\n+    >>> print(wsgi_ini)\n+    [server:main]\n+    ...\n+    [filter:profile]\n+    use = egg:repoze.profile\n+    ...\n+    discard_first_request = true\n+    path = /__profile__\n+    flush_at_shutdown = true\n+    unwind = false\n+    <BLANKLINE>\n+    [pipeline:main]\n+    pipeline =\n+        translogger\n+        egg:Zope#httpexceptions\n+        profile\n+        zope\n+    <BLANKLINE>\n+    [loggers]\n+    ...\n+\n+\n # END OF TEST\n\\ No newline at end of file\n'

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2021-05-10T22:21:42+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/4e9af8d46bc4507c1e718b4436ab5970620b086c

make dependency optional

Files changed:
M README.rst
M setup.py

b"diff --git a/README.rst b/README.rst\nindex 8801bda..196ebb1 100644\n--- a/README.rst\n+++ b/README.rst\n@@ -170,6 +170,7 @@ profile\n   Set to ``on`` enables `repoze.profile <https://github.com/repoze/repoze.profile>`_.\n   Defaults to ``off``,\n   If switched on there are further options prefixed with ``profile_`` to configure it as below.\n+  You will need to add the `repoze.profile` package, either by adding it to your eggs section directly or by using the extra `plone.recipe.zope2instance[profile]`.\n \n profile_log_filename\n   Filename of the raw profile data.\ndiff --git a/setup.py b/setup.py\nindex 0334816..36ee63b 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -54,7 +54,6 @@\n         'waitress >= 1.2.0',\n         'Paste',\n         'python-dotenv',\n-        'repoze.profile',\n     ],\n     extras_require={\n         'test': [\n@@ -63,6 +62,9 @@\n         ],\n         'sentry': [\n             'sentry-sdk',\n+        ],\n+        'profile': [\n+            'repoze.profile',\n         ]\n     },\n     zip_safe=False,\n"

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2021-05-10T23:59:28+02:00
Author: Johannes Raggam (thet) <thetetet@gmail.com>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/614afe4aaddfe26fc09eb65af395513e0c8edc67

Merge pull request #129 from plone/jensens-repoze.profile-integration

Basic repoze.profile integration

Files changed:
A news/129.feature
M README.rst
M setup.py
M src/plone/recipe/zope2instance/recipe.py
M src/plone/recipe/zope2instance/tests/wsgi.rst

b'diff --git a/README.rst b/README.rst\nindex f16ce93..196ebb1 100644\n--- a/README.rst\n+++ b/README.rst\n@@ -157,7 +157,7 @@ verbose-security\n   implementation). Defaults to `off` (and the C security implementation).\n \n debug-exceptions\n-  WSGI only: set to `on` to disable exception views including\n+  WSGI only: set to ``on`` to disable exception views including\n   ``standard_error_message``. Exceptions other than ``Unauthorized`` or\n   ``ConflictError`` can then travel up into the WSGI stack. Use this option\n   if you want more convenient error debugging offered by WSGI middleware\n@@ -166,6 +166,39 @@ debug-exceptions\n   WSGI documentation <https://zope.readthedocs.io/en/latest/wsgi.html>`_ for\n   examples.\n \n+profile\n+  Set to ``on`` enables `repoze.profile <https://github.com/repoze/repoze.profile>`_.\n+  Defaults to ``off``,\n+  If switched on there are further options prefixed with ``profile_`` to configure it as below.\n+  You will need to add the `repoze.profile` package, either by adding it to your eggs section directly or by using the extra `plone.recipe.zope2instance[profile]`.\n+\n+profile_log_filename\n+  Filename of the raw profile data.\n+  Default to ``profile-SECTIONNAME.raw``.\n+  This file contains the raw profile data for further analysis.\n+\n+profile_cachegrind_filename\n+  If the package ``pyprof2calltree`` is installed, another file is written.\n+  It is meant for consumation with any cachegrind compatible application.\n+  Defaults to ``cachegrind.out.SECTIONNAME``.\n+\n+profile_discard_first_request\n+  Defaults to ``true``.\n+  See `repoze.profile docs <https://repozeprofile.readthedocs.io/en/latest/#configuration-via-python>`_ for details.\n+\n+profile_path\n+  Defaults to ``/__profile__``.\n+  The path for through the web access to the last profiled request.\n+\n+profile_flush_at_shutdown\n+  Defaults to ``true``.\n+  See `repoze.profile docs <https://repozeprofile.readthedocs.io/en/latest/#configuration-via-python>`_ for details.\n+\n+profile_unwind\n+  Defaults to ``false``.\n+  See `repoze.profile docs <https://repozeprofile.readthedocs.io/en/latest/#configuration-via-python>`_ for details.\n+\n+\n Direct storage\n --------------\n \ndiff --git a/news/129.feature b/news/129.feature\nnew file mode 100644\nindex 0000000..b9e13d6\n--- /dev/null\n+++ b/news/129.feature\n@@ -0,0 +1 @@\n+Add repoze.profile profiling middleware support [jensens]\n\\ No newline at end of file\ndiff --git a/setup.py b/setup.py\nindex 0e33403..36ee63b 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -53,7 +53,7 @@\n         \'ZEO\',\n         \'waitress >= 1.2.0\',\n         \'Paste\',\n-        \'python-dotenv\'\n+        \'python-dotenv\',\n     ],\n     extras_require={\n         \'test\': [\n@@ -62,6 +62,9 @@\n         ],\n         \'sentry\': [\n             \'sentry-sdk\',\n+        ],\n+        \'profile\': [\n+            \'repoze.profile\',\n         ]\n     },\n     zip_safe=False,\ndiff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex 8adf7fd..2c1e89b 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -799,6 +799,45 @@ def build_wsgi_ini(self):\n         sentry_event_level = options.get(\'sentry_event_level\', \'ERROR\')\n         sentry_ignore = options.get(\'sentry_ignore\', \'\')\n \n+        profile = options.get(\'profile\', \'\').strip() == \'on\'\n+        if profile:\n+            if "zope" in pipeline:\n+                pipeline.insert(pipeline.index("zope"), \'profile\')\n+            else:\n+                pipeline.append(\'profile\')\n+        default_profile_log_filename = os.path.sep.join(\n+            [\n+                var_dir,\n+                \'log\',\n+                \'profile-{0}.raw\'.format(self.name),\n+            ]\n+        )\n+        profile_log_filename = options.get(\n+            \'profile_log_filename\',\n+            default_profile_log_filename\n+        )\n+        default_profile_log_filename = os.path.sep.join(\n+            [\n+                var_dir,\n+                \'log\',\n+                \'cachegrind.out.{0}\'.format(self.name),\n+            ]\n+        )\n+        profile_cachegrind_filename = options.get(\n+            \'profile_cachegrind_filename\',\n+            default_profile_log_filename\n+        )\n+        profile_discard_first_request = options.get(\n+            \'profile_discard_first_request\',\n+            \'true\'\n+        )\n+        profile_path = options.get(\'profile_path\', \'/__profile__\')\n+        profile_flush_at_shutdown = options.get(\n+            \'profile_flush_at_shutdown\',\n+            \'true\'\n+        )\n+        profile_unwind = options.get(\'profile_unwind\', \'false\')\n+\n         if "zope" not in pipeline:\n             pipeline.append(\'zope\')\n \n@@ -827,8 +866,13 @@ def build_wsgi_ini(self):\n             \'sentry_ignore\': sentry_ignore,\n             \'sentry_level\': sentry_level,\n             \'threads\': options.get(\'threads\', 4),\n+            \'profile_log_filename\': profile_log_filename,\n+            \'profile_cachegrind_filename\': profile_cachegrind_filename,\n+            \'profile_discard_first_request\': profile_discard_first_request,\n+            \'profile_path\': profile_path,\n+            \'profile_flush_at_shutdown\': profile_flush_at_shutdown,\n+            \'profile_unwind\': profile_unwind,\n         }\n-\n         global wsgi_ini_template\n         wsgi_ini_template_path = self.options.get(\'wsgi-ini-template\')\n         if wsgi_ini_template_path:\n@@ -1409,6 +1453,15 @@ def render_file_storage(self, file_storage, blob_storage,\n event_level = %(sentry_event_level)s\n ignorelist = %(sentry_ignore)s\n \n+[filter:profile]\n+use = egg:repoze.profile\n+log_filename = %(profile_log_filename)s\n+cachegrind_filename = %(profile_cachegrind_filename)s\n+discard_first_request = %(profile_discard_first_request)s\n+path = %(profile_path)s\n+flush_at_shutdown = %(profile_flush_at_shutdown)s\n+unwind = %(profile_unwind)s\n+\n [pipeline:main]\n pipeline =\n     %(pipeline)s\ndiff --git a/src/plone/recipe/zope2instance/tests/wsgi.rst b/src/plone/recipe/zope2instance/tests/wsgi.rst\nindex 192e08b..63c39e2 100644\n--- a/src/plone/recipe/zope2instance/tests/wsgi.rst\n+++ b/src/plone/recipe/zope2instance/tests/wsgi.rst\n@@ -469,7 +469,7 @@ The buildout has updated our INI file:\n     level = INFO\n     event_level = ERROR\n     ignorelist =\n-    <BLANKLINE>\n+    ...\n     [pipeline:main]\n     pipeline =\n         translogger\n@@ -522,7 +522,7 @@ The buildout has updated our INI file:\n     level = DEBUG\n     event_level = WARNING\n     ignorelist = waitress.queue foo\n-    <BLANKLINE>\n+    ...\n     [pipeline:main]\n     pipeline =\n         translogger\n@@ -576,4 +576,54 @@ The buildout has updated our INI file and we can see that we have a custom pipel\n     ...\n \n \n+With repoze.profile middleware\n+==============================\n+\n+The recipe can configure custom pipelines in the ``wsgi.ini``::\n+\n+    >>> write(\'buildout.cfg\',\n+    ... \'\'\'\n+    ... [buildout]\n+    ... parts = instance\n+    ... find-links = %(sample_buildout)s/eggs\n+    ...\n+    ... [instance]\n+    ... recipe = plone.recipe.zope2instance\n+    ... eggs =\n+    ... user = me:me\n+    ... profile = on\n+    ... \'\'\' % options)\n+\n+Let\'s run it::\n+\n+    >>> print(system(join(\'bin\', \'buildout\'))),\n+    Uninstalling instance.\n+    Installing instance.\n+    ...\n+\n+The buildout has updated our INI file and we can see that we have a custom pipeline::\n+\n+    >>> wsgi_ini = open(os.path.join(instance, \'etc\', \'wsgi.ini\')).read()\n+    >>> print(wsgi_ini)\n+    [server:main]\n+    ...\n+    [filter:profile]\n+    use = egg:repoze.profile\n+    ...\n+    discard_first_request = true\n+    path = /__profile__\n+    flush_at_shutdown = true\n+    unwind = false\n+    <BLANKLINE>\n+    [pipeline:main]\n+    pipeline =\n+        translogger\n+        egg:Zope#httpexceptions\n+        profile\n+        zope\n+    <BLANKLINE>\n+    [loggers]\n+    ...\n+\n+\n # END OF TEST\n\\ No newline at end of file\n'

