Repository: plone.namedfile


Branch: refs/heads/master
Date: 2023-05-15T10:32:29+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.namedfile/commit/56ad2bc07f567b9370b765977cd449646f6d0dff

feat: move code from plone.app.z3cform

This way we break a cyclic dependency between p.namedfile -&gt;
p.schemaeditor -&gt; p.a.z3cform -&gt; p.namedfile.

Files changed:
M plone/namedfile/storages.py
M plone/namedfile/z3c-blobfile.zcml

b'diff --git a/plone/namedfile/storages.py b/plone/namedfile/storages.py\nindex 5626200..6bb4c32 100644\n--- a/plone/namedfile/storages.py\n+++ b/plone/namedfile/storages.py\n@@ -105,3 +105,14 @@ def store(self, pdata, blob):\n         fp = blob.open("w")\n         fp.write(bytes(pdata))\n         fp.close()\n+\n+\n+@implementer(IStorage)\n+class Zope2FileUploadStorable:\n+    def store(self, data, blob):\n+        data.seek(0)\n+        with blob.open("w") as fp:\n+            block = data.read(MAXCHUNKSIZE)\n+            while block:\n+                fp.write(block)\n+                block = data.read(MAXCHUNKSIZE)\ndiff --git a/plone/namedfile/z3c-blobfile.zcml b/plone/namedfile/z3c-blobfile.zcml\nindex 3b2ceb3..69a5312 100644\n--- a/plone/namedfile/z3c-blobfile.zcml\n+++ b/plone/namedfile/z3c-blobfile.zcml\n@@ -56,6 +56,12 @@\n       factory=".storages.PDataStorable"\n       />\n \n+  <utility\n+      factory=".storages.Zope2FileUploadStorable"\n+      provides=".interfaces.IStorage"\n+      name="ZPublisher.HTTPRequest.FileUpload"\n+      />\n+\n   <adapter factory=".copy.BlobFileCopyHook" />\n \n </configure>\n'

Repository: plone.namedfile


Branch: refs/heads/master
Date: 2023-05-15T10:32:29+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.namedfile/commit/25821b0ae966f1f6bc76f756be4b97e2f40d944e

Add news entry

Files changed:
A news/3764.internal

b'diff --git a/news/3764.internal b/news/3764.internal\nnew file mode 100644\nindex 0000000..c03841f\n--- /dev/null\n+++ b/news/3764.internal\n@@ -0,0 +1,3 @@\n+Move code from plone.app.z3cform here here\n+to break a cyclic dependency.\n+[gforcada]\n'

Repository: plone.namedfile


Branch: refs/heads/master
Date: 2023-05-20T13:36:39+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.namedfile/commit/c2b3a34be56db46a4665f49a796d8ca9857b829f

Merge pull request #141 from plone/break-dependency-cycle

Break dependency cycle

Files changed:
A news/3764.internal
M plone/namedfile/storages.py
M plone/namedfile/z3c-blobfile.zcml

b'diff --git a/news/3764.internal b/news/3764.internal\nnew file mode 100644\nindex 0000000..c03841f\n--- /dev/null\n+++ b/news/3764.internal\n@@ -0,0 +1,3 @@\n+Move code from plone.app.z3cform here here\n+to break a cyclic dependency.\n+[gforcada]\ndiff --git a/plone/namedfile/storages.py b/plone/namedfile/storages.py\nindex 5626200..6bb4c32 100644\n--- a/plone/namedfile/storages.py\n+++ b/plone/namedfile/storages.py\n@@ -105,3 +105,14 @@ def store(self, pdata, blob):\n         fp = blob.open("w")\n         fp.write(bytes(pdata))\n         fp.close()\n+\n+\n+@implementer(IStorage)\n+class Zope2FileUploadStorable:\n+    def store(self, data, blob):\n+        data.seek(0)\n+        with blob.open("w") as fp:\n+            block = data.read(MAXCHUNKSIZE)\n+            while block:\n+                fp.write(block)\n+                block = data.read(MAXCHUNKSIZE)\ndiff --git a/plone/namedfile/z3c-blobfile.zcml b/plone/namedfile/z3c-blobfile.zcml\nindex 3b2ceb3..69a5312 100644\n--- a/plone/namedfile/z3c-blobfile.zcml\n+++ b/plone/namedfile/z3c-blobfile.zcml\n@@ -56,6 +56,12 @@\n       factory=".storages.PDataStorable"\n       />\n \n+  <utility\n+      factory=".storages.Zope2FileUploadStorable"\n+      provides=".interfaces.IStorage"\n+      name="ZPublisher.HTTPRequest.FileUpload"\n+      />\n+\n   <adapter factory=".copy.BlobFileCopyHook" />\n \n </configure>\n'

