Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2021-09-13T11:15:55+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/cc907f2bc31fbfa0f0401580eee2c14bfb37d66c

do not override existing settings

- what to add
- which views are allowed

Files changed:
M plone/app/upgrade/v60/alphas.py

b'diff --git a/plone/app/upgrade/v60/alphas.py b/plone/app/upgrade/v60/alphas.py\nindex 859a5a77..455a89d7 100644\n--- a/plone/app/upgrade/v60/alphas.py\n+++ b/plone/app/upgrade/v60/alphas.py\n@@ -39,6 +39,17 @@ def remove_temp_folder(context):\n         logger.info("Removed %s from Zope root _mount_points.", broken_id)\n \n \n+FT_PROPERTIES_TO_KEEP = [\n+    "allow_discussion",\n+    "allowed_content_types",\n+    "default_view",\n+    "filter_content_types",\n+    "global_allow",\n+    "immediate_view",\n+    "view_methods",\n+]\n+\n+\n def change_plone_site_fti(context):\n     pt = getToolByName(context, "portal_types")\n     fti = pt.getTypeInfo("Plone Site")\n@@ -48,9 +59,18 @@ def change_plone_site_fti(context):\n         return\n \n     # ... otherwise we fix it\n+    # keep important settings (often customized ones)\n+    keep = {prop: fti.getProperty(prop) for prop in FT_PROPERTIES_TO_KEEP}\n+\n     del pt["Plone Site"]\n+\n     loadMigrationProfile(context, "profile-plone.app.upgrade.v60:to_dx_site_root")\n \n+    # restore important settings\n+    fti = pt.getTypeInfo("Plone Site")\n+    for prop, value in keep.items():\n+        fti._setPropValue(prop, value)\n+\n \n def make_site_dx(context):\n     """Make the Plone Site a dexterity container"""\n@@ -76,4 +96,4 @@ def make_site_dx(context):\n             portal._setOb(obj_id, obj)\n \n     delattr(portal, "_objects")\n-    portal._p_changed = True\n\\ No newline at end of file\n+    portal._p_changed = True\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2021-09-13T15:01:14+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/a9546d4272173a1219ea8afd351d51da492dc531

Merge pull request #257 from plone/fix-upgrade-dxsiteroot_do-no-override

Do not override existing settings

Files changed:
M plone/app/upgrade/v60/alphas.py

b'diff --git a/plone/app/upgrade/v60/alphas.py b/plone/app/upgrade/v60/alphas.py\nindex 859a5a77..455a89d7 100644\n--- a/plone/app/upgrade/v60/alphas.py\n+++ b/plone/app/upgrade/v60/alphas.py\n@@ -39,6 +39,17 @@ def remove_temp_folder(context):\n         logger.info("Removed %s from Zope root _mount_points.", broken_id)\n \n \n+FT_PROPERTIES_TO_KEEP = [\n+    "allow_discussion",\n+    "allowed_content_types",\n+    "default_view",\n+    "filter_content_types",\n+    "global_allow",\n+    "immediate_view",\n+    "view_methods",\n+]\n+\n+\n def change_plone_site_fti(context):\n     pt = getToolByName(context, "portal_types")\n     fti = pt.getTypeInfo("Plone Site")\n@@ -48,9 +59,18 @@ def change_plone_site_fti(context):\n         return\n \n     # ... otherwise we fix it\n+    # keep important settings (often customized ones)\n+    keep = {prop: fti.getProperty(prop) for prop in FT_PROPERTIES_TO_KEEP}\n+\n     del pt["Plone Site"]\n+\n     loadMigrationProfile(context, "profile-plone.app.upgrade.v60:to_dx_site_root")\n \n+    # restore important settings\n+    fti = pt.getTypeInfo("Plone Site")\n+    for prop, value in keep.items():\n+        fti._setPropValue(prop, value)\n+\n \n def make_site_dx(context):\n     """Make the Plone Site a dexterity container"""\n@@ -76,4 +96,4 @@ def make_site_dx(context):\n             portal._setOb(obj_id, obj)\n \n     delattr(portal, "_objects")\n-    portal._p_changed = True\n\\ No newline at end of file\n+    portal._p_changed = True\n'

