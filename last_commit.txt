Repository: plone.restapi


Branch: refs/heads/main
Date: 2023-09-02T22:12:12-07:00
Author: Andrea Cecchi (cekk) <andrea.cecchi85@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/36e67bd6c50053c71afdc34ff21fe23fdcd848a3

Improve RESOLVEUID_RE regexp to catch also paths generated by Link content-types (#1700)

* Improve regexp to catch also paths generated by Link content-types

* add changelog

Files changed:
A news/1699.bugfix
M src/plone/restapi/serializer/utils.py
M src/plone/restapi/tests/test_resolveuid.py

b'diff --git a/news/1699.bugfix b/news/1699.bugfix\nnew file mode 100644\nindex 000000000..a0bdf39a1\n--- /dev/null\n+++ b/news/1699.bugfix\n@@ -0,0 +1 @@\n+Improve RESOLVEUID_RE regexp to catch also paths generated by Link content-types. @cekk\ndiff --git a/src/plone/restapi/serializer/utils.py b/src/plone/restapi/serializer/utils.py\nindex c2f89e4e2..e0c3bbdef 100644\n--- a/src/plone/restapi/serializer/utils.py\n+++ b/src/plone/restapi/serializer/utils.py\n@@ -8,7 +8,7 @@\n import re\n \n \n-RESOLVEUID_RE = re.compile("^[./]*resolve[Uu]id/([^/]*)/?(.*)$")\n+RESOLVEUID_RE = re.compile("^(?:|.*/)resolve[Uu]id/([^/]*)/?(.*)$")\n \n \n def resolve_uid(path):\ndiff --git a/src/plone/restapi/tests/test_resolveuid.py b/src/plone/restapi/tests/test_resolveuid.py\nindex 404639be8..1e42aa9bf 100644\n--- a/src/plone/restapi/tests/test_resolveuid.py\n+++ b/src/plone/restapi/tests/test_resolveuid.py\n@@ -24,7 +24,6 @@\n \n \n class TestBlocksResolveUIDFunctional(TestCase):\n-\n     layer = PLONE_RESTAPI_BLOCKS_FUNCTIONAL_TESTING\n \n     def setUp(self):\n@@ -698,3 +697,9 @@ def test_resolveuid_with_primary_field_url_keeps_suffix(self):\n             ]["url"],\n             self.doc2.absolute_url() + "/view",\n         )\n+\n+    def test_resolveuid_handle_link_style_formats(self):\n+        uid = IUUID(self.doc2)\n+        blocks = {"aaa": {"@type": "foo", "url": f"/plone/resolveuid/{uid}"}}\n+        value = self.serialize("blocks", blocks)\n+        self.assertEqual(value["aaa"]["url"], self.doc2.absolute_url())\n'

