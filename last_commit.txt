Repository: plone.restapi


Branch: refs/heads/master
Date: 2023-05-27T11:07:00-07:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.restapi/commit/11275deb4bc9488e0c10929bd7c76a1cfd6edc96

Fix possible startup error by loading plone.app.contentrules zcml (#1645)

Fix possible startup error by explicitly loading ``plone.app.contentrules`` zcml.

Also: only load code related to contentrules when this package is available.
Fixes https://github.com/plone/plone.restapi/issues/1644
But reported here at first:
https://community.plone.org/t/plone-6-0-5-soft-released/17490/3?u=mauritsvanrees

Files changed:
A news/1644.bugfix
M src/plone/restapi/serializer/controlpanels/configure.zcml
M src/plone/restapi/services/configure.zcml
M src/plone/restapi/services/controlpanels/configure.zcml
M src/plone/restapi/services/rules/configure.zcml

b'diff --git a/news/1644.bugfix b/news/1644.bugfix\nnew file mode 100644\nindex 000000000..5168ef86b\n--- /dev/null\n+++ b/news/1644.bugfix\n@@ -0,0 +1,3 @@\n+Fix possible startup error by explicitly loading ``plone.app.contentrules`` zcml.\n+Also: only load code related to contentrules when this package is available.\n+[maurits]\ndiff --git a/src/plone/restapi/serializer/controlpanels/configure.zcml b/src/plone/restapi/serializer/controlpanels/configure.zcml\nindex 55072e715..2e80587c0 100644\n--- a/src/plone/restapi/serializer/controlpanels/configure.zcml\n+++ b/src/plone/restapi/serializer/controlpanels/configure.zcml\n@@ -1,11 +1,15 @@\n <configure\n     xmlns="http://namespaces.zope.org/zope"\n+    xmlns:zcml="http://namespaces.zope.org/zcml"\n     i18n_domain="plone.restapi"\n     >\n \n   <adapter factory=".ControlpanelSerializeToJson" />\n   <adapter factory=".ControlpanelSummarySerializeToJson" />\n   <adapter factory=".types.DexterityTypesControlpanelSerializeToJson" />\n-  <adapter factory=".rules.ContentRulesControlpanelSerializeToJson" />\n+  <adapter\n+      factory=".rules.ContentRulesControlpanelSerializeToJson"\n+      zcml:condition="installed plone.app.contentrules"\n+      />\n \n </configure>\ndiff --git a/src/plone/restapi/services/configure.zcml b/src/plone/restapi/services/configure.zcml\nindex 1fd3c0568..fa2888e29 100644\n--- a/src/plone/restapi/services/configure.zcml\n+++ b/src/plone/restapi/services/configure.zcml\n@@ -32,7 +32,6 @@\n   <include package=".registry" />\n   <include package=".relations" />\n   <include package=".roles" />\n-  <include package=".rules" />\n   <include package=".search" />\n   <include package=".system" />\n   <include package=".sources" />\n@@ -63,4 +62,8 @@\n       package=".tiles"\n       zcml:condition="installed plone.tiles"\n       />\n+  <include\n+      package=".rules"\n+      zcml:condition="installed plone.app.contentrules"\n+      />\n </configure>\ndiff --git a/src/plone/restapi/services/controlpanels/configure.zcml b/src/plone/restapi/services/controlpanels/configure.zcml\nindex 9b2ae006d..690490e2a 100644\n--- a/src/plone/restapi/services/controlpanels/configure.zcml\n+++ b/src/plone/restapi/services/controlpanels/configure.zcml\n@@ -60,6 +60,7 @@\n       factory="plone.restapi.controlpanels.rules.ContentRulesControlpanel"\n       provides="plone.restapi.controlpanels.interfaces.IContentRulesControlpanel"\n       name="content-rules"\n+      zcml:condition="installed plone.app.contentrules"\n       />\n \n   <configure zcml:condition="have plone-5">\ndiff --git a/src/plone/restapi/services/rules/configure.zcml b/src/plone/restapi/services/rules/configure.zcml\nindex cf75e59d7..8f4adad68 100644\n--- a/src/plone/restapi/services/rules/configure.zcml\n+++ b/src/plone/restapi/services/rules/configure.zcml\n@@ -3,6 +3,8 @@\n     xmlns:plone="http://namespaces.plone.org/plone"\n     >\n \n+  <include package="plone.app.contentrules" />\n+\n   <plone:service\n       method="GET"\n       factory=".get.ContentRulesGet"\n'

