Repository: plone.restapi


Branch: refs/heads/main
Date: 2023-11-02T11:38:01+01:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.restapi/commit/3b4c81060d9a0ded5bee557e136cfb36860e18d0

jwt_auth plugin extractCredentials: check request content-type (#1728)

Only look for credentials in JSON requests

Files changed:
A news/1728.bugfix
M src/plone/restapi/pas/plugin.py

b'diff --git a/news/1728.bugfix b/news/1728.bugfix\nnew file mode 100644\nindex 0000000000..2b631bb5ee\n--- /dev/null\n+++ b/news/1728.bugfix\n@@ -0,0 +1 @@\n+Fix jwt_auth extractCredentials plugin to only try to read credentials from the request body if there is a `Content-Type: application/json` header. @davisagli\ndiff --git a/src/plone/restapi/pas/plugin.py b/src/plone/restapi/pas/plugin.py\nindex 6e76935f0d..785f1a0b04 100644\n--- a/src/plone/restapi/pas/plugin.py\n+++ b/src/plone/restapi/pas/plugin.py\n@@ -96,13 +96,14 @@ def extractCredentials(self, request):\n         # Prefer any credentials in a JSON POST request under the assumption that any\n         # such requested sent when a JWT token is already in the `Authorization` header\n         # is intended to change or update the logged in user.\n-        try:\n-            creds = deserializer.json_body(request)\n-        except exceptions.DeserializationError:\n-            pass\n-        else:\n-            if "login" in creds and "password" in creds:\n-                return creds\n+        if request.getHeader("Content-Type") == "application/json":\n+            try:\n+                creds = deserializer.json_body(request)\n+            except exceptions.DeserializationError:\n+                pass\n+            else:\n+                if "login" in creds and "password" in creds:\n+                    return creds\n \n         creds = {}\n         auth = request._auth\n'

