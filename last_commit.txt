Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2021-01-12T09:04:01+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.contenttypes/commit/836a96b4736e02e4a3e95da5973161794538832e

Catch AttributeError for getNextPreviousEnabled during migration.

Fixes https://github.com/plone/plone.app.contenttypes/issues/582
Sample error:

```
2021-01-11 21:30:37,748 ERROR   [ATCT.migration:205][waitress-0] Failed migration for object /minaraad/digibib/meetings/20130507-0 (Meeting -&gt; Meeting)
Traceback (most recent call last):
  File "/Users/maurits/shared-eggs/cp27m/Products.contentmigration-2.2.1-py2.7.egg/Products/contentmigration/basemigrator/walker.py", line 194, in migrate
    migrator.migrate()
  File "/Users/maurits/shared-eggs/cp27m/Products.contentmigration-2.2.1-py2.7.egg/Products/contentmigration/basemigrator/migrator.py", line 220, in migrate
    method()
  File "/Users/maurits/shared-eggs/cp27m/plone.app.contenttypes-2.2.1-py2.7.egg/plone/app/contenttypes/migration/migration.py", line 191, in migrate_nextprevious
    if self.old.getNextPreviousEnabled():
AttributeError: 'RequestContainer' object has no attribute 'getNextPreviousEnabled'
```

Files changed:
A news/582.bugfix
M plone/app/contenttypes/migration/migration.py

b'diff --git a/news/582.bugfix b/news/582.bugfix\nnew file mode 100644\nindex 00000000..8281b794\n--- /dev/null\n+++ b/news/582.bugfix\n@@ -0,0 +1,2 @@\n+Catch AttributeError for ``getNextPreviousEnabled`` during migration.\n+[maurits]\ndiff --git a/plone/app/contenttypes/migration/migration.py b/plone/app/contenttypes/migration/migration.py\nindex f547d752..050c75bb 100644\n--- a/plone/app/contenttypes/migration/migration.py\n+++ b/plone/app/contenttypes/migration/migration.py\n@@ -188,9 +188,14 @@ def migrate_leadimage(self):\n         migrate_leadimage(self.old, self.new)\n \n     def migrate_nextprevious(self):\n-        if self.old.getNextPreviousEnabled():\n-            if INextPreviousToggle.providedBy(self.new):\n-                self.new.nextPreviousEnabled = True\n+        try:\n+            enabled = self.old.getNextPreviousEnabled()\n+        except AttributeError:\n+            # The old type may not have this.\n+            # https://github.com/plone/plone.app.contenttypes/issues/582\n+            return\n+        if enabled and INextPreviousToggle.providedBy(self.new):\n+            self.new.nextPreviousEnabled = True\n \n     def last_migrate_comments(self):\n         """Migrate the plone.app.discussion comments.\n'

