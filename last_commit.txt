Repository: plone.app.dexterity


Branch: refs/heads/2.6.x
Date: 2022-05-09T16:28:07+02:00
Author: Peter Holzer (agitator) <peter.holzer@agitator.com>
Commit: https://github.com/plone/plone.app.dexterity/commit/675cc10b1b2045021dd79d58103f13490af9ce73

Don't acquire .language from portal root.

Files changed:
M plone/app/dexterity/behaviors/metadata.py

b"diff --git a/plone/app/dexterity/behaviors/metadata.py b/plone/app/dexterity/behaviors/metadata.py\nindex b4961de..b260783 100644\n--- a/plone/app/dexterity/behaviors/metadata.py\n+++ b/plone/app/dexterity/behaviors/metadata.py\n@@ -44,25 +44,29 @@ def default_language(context):\n     # this new content is being added\n     language = None\n \n-    if context is not None and not IPloneSiteRoot.providedBy(context):\n-        language = context.Language()\n-        if not language:\n+    # Try to get the language from context or parent(s)\n+    while context is not None and not IPloneSiteRoot.providedBy(context):\n+        try:\n+            # Use aq_base so the .language attribute isn't acquired from root\n+            language = context.aq_base.Language()\n+        except AttributeError:  # Accesses .language\n             # If we are here, it means we were editing an object that didn't\n             # have its language set or that the container where we were adding\n             # the new content didn't have a language set. So we check its\n-            # parent, unless we are at site's root, in which case we get site's\n-            # default language\n-            if not IPloneSiteRoot.providedBy(context.aq_parent):\n-                language = context.aq_parent.Language()\n+            # parent.\n+            context = context.__parent__\n+\n+    pl = getToolByName(getSite(), 'portal_languages')\n+    default_language = pl.getDefaultLanguage()\n \n     if not language:\n-        # Finally, if we still don't have a language, then just use site's\n-        # default\n-        pl = getToolByName(getSite(), 'portal_languages')\n-        language = pl.getDefaultLanguage()\n+        language = default_language\n \n-    return language\n+    # Is the language supported/enabled at all?\n+    if language not in pl.getAvailableLanguages():\n+        language = default_language\n \n+    return language\n \n @provider(IFormFieldProvider)\n class IBasic(model.Schema):\n"

Repository: plone.app.dexterity


Branch: refs/heads/2.6.x
Date: 2022-05-09T16:33:59+02:00
Author: Peter Holzer (agitator) <peter.holzer@agitator.com>
Commit: https://github.com/plone/plone.app.dexterity/commit/adb7d35b7c8ea9912c7df16e562925ec6250bf7a

add news

Files changed:
A news/351.bugfix

b"diff --git a/news/351.bugfix b/news/351.bugfix\nnew file mode 100644\nindex 00000000..5eaa1972\n--- /dev/null\n+++ b/news/351.bugfix\n@@ -0,0 +1,3 @@\n+Don't acquire lanuage from portal root default_language for ICategorization.language.\n+Fixes https://github.com/plone/plone.app.dexterity/issues/258\n+[jaroel]\n\\ No newline at end of file\n"

Repository: plone.app.dexterity


Branch: refs/heads/2.6.x
Date: 2022-05-09T18:31:59+02:00
Author: Peter Holzer (agitator) <peter.holzer@agitator.com>
Commit: https://github.com/plone/plone.app.dexterity/commit/0bb52047a010b84210c70ec0c4253e95584da3e8

use getattr

Files changed:
M plone/app/dexterity/behaviors/metadata.py

b"diff --git a/plone/app/dexterity/behaviors/metadata.py b/plone/app/dexterity/behaviors/metadata.py\nindex b260783..c89a9d8 100644\n--- a/plone/app/dexterity/behaviors/metadata.py\n+++ b/plone/app/dexterity/behaviors/metadata.py\n@@ -45,25 +45,24 @@ def default_language(context):\n     language = None\n \n     # Try to get the language from context or parent(s)\n-    while context is not None and not IPloneSiteRoot.providedBy(context):\n-        try:\n-            # Use aq_base so the .language attribute isn't acquired from root\n-            language = context.aq_base.Language()\n-        except AttributeError:  # Accesses .language\n+    while not language and context is not None and not IPloneSiteRoot.providedBy(context):\n+        language = getattr(context.aq_base, 'language', None)\n+\n+        if not language:\n             # If we are here, it means we were editing an object that didn't\n             # have its language set or that the container where we were adding\n             # the new content didn't have a language set. So we check its\n             # parent.\n             context = context.__parent__\n \n-    pl = getToolByName(getSite(), 'portal_languages')\n-    default_language = pl.getDefaultLanguage()\n+    language_tool = getToolByName(getSite(), 'portal_languages')\n+    default_language = language_tool.getDefaultLanguage()\n \n     if not language:\n         language = default_language\n \n     # Is the language supported/enabled at all?\n-    if language not in pl.getAvailableLanguages():\n+    if language not in language_tool.getAvailableLanguages():\n         language = default_language\n \n     return language\n"

Repository: plone.app.dexterity


Branch: refs/heads/2.6.x
Date: 2022-05-09T23:02:03+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.dexterity/commit/83b2e0cba8c14699a4b18cb9eede64d5cd6f0c41

Merge pull request #351 from plone/defaultlanglookup-p5

[5.2] Don't acquire .language from portal root.

Files changed:
A news/351.bugfix
M plone/app/dexterity/behaviors/metadata.py

b"diff --git a/news/351.bugfix b/news/351.bugfix\nnew file mode 100644\nindex 00000000..5eaa1972\n--- /dev/null\n+++ b/news/351.bugfix\n@@ -0,0 +1,3 @@\n+Don't acquire lanuage from portal root default_language for ICategorization.language.\n+Fixes https://github.com/plone/plone.app.dexterity/issues/258\n+[jaroel]\n\\ No newline at end of file\ndiff --git a/plone/app/dexterity/behaviors/metadata.py b/plone/app/dexterity/behaviors/metadata.py\nindex b4961de1..c89a9d84 100644\n--- a/plone/app/dexterity/behaviors/metadata.py\n+++ b/plone/app/dexterity/behaviors/metadata.py\n@@ -44,25 +44,28 @@ def default_language(context):\n     # this new content is being added\n     language = None\n \n-    if context is not None and not IPloneSiteRoot.providedBy(context):\n-        language = context.Language()\n+    # Try to get the language from context or parent(s)\n+    while not language and context is not None and not IPloneSiteRoot.providedBy(context):\n+        language = getattr(context.aq_base, 'language', None)\n+\n         if not language:\n             # If we are here, it means we were editing an object that didn't\n             # have its language set or that the container where we were adding\n             # the new content didn't have a language set. So we check its\n-            # parent, unless we are at site's root, in which case we get site's\n-            # default language\n-            if not IPloneSiteRoot.providedBy(context.aq_parent):\n-                language = context.aq_parent.Language()\n+            # parent.\n+            context = context.__parent__\n+\n+    language_tool = getToolByName(getSite(), 'portal_languages')\n+    default_language = language_tool.getDefaultLanguage()\n \n     if not language:\n-        # Finally, if we still don't have a language, then just use site's\n-        # default\n-        pl = getToolByName(getSite(), 'portal_languages')\n-        language = pl.getDefaultLanguage()\n+        language = default_language\n \n-    return language\n+    # Is the language supported/enabled at all?\n+    if language not in language_tool.getAvailableLanguages():\n+        language = default_language\n \n+    return language\n \n @provider(IFormFieldProvider)\n class IBasic(model.Schema):\n"

