Repository: plone.app.content


Branch: refs/heads/master
Date: 2023-11-22T16:02:03+01:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/plone.app.content/commit/850b8a2409e3e89a613d8c6083ad35456f68a0c2

Try to fix `&amp;amp;` issue

Files changed:
M plone/app/content/browser/vocabulary.py
M plone/app/content/tests/test_widgets.py

b'diff --git a/plone/app/content/browser/vocabulary.py b/plone/app/content/browser/vocabulary.py\nindex 9464947..75d5aad 100644\n--- a/plone/app/content/browser/vocabulary.py\n+++ b/plone/app/content/browser/vocabulary.py\n@@ -260,8 +260,8 @@ def __call__(self):\n         else:\n             items = [\n                 {\n-                    "id": transform.scrub_html(item.value),\n-                    "text": transform.scrub_html(item.title) if item.title else "",\n+                    "id": transform.scrub_html(item.value).replace("&amp;", "&"),\n+                    "text": transform.scrub_html(item.title).replace("&amp;", "&") if item.title else "",\n                 }\n                 for item in results\n             ]\ndiff --git a/plone/app/content/tests/test_widgets.py b/plone/app/content/tests/test_widgets.py\nindex d87b619..df6b818 100644\n--- a/plone/app/content/tests/test_widgets.py\n+++ b/plone/app/content/tests/test_widgets.py\n@@ -269,6 +269,25 @@ def testVocabularyEncoding(self):\n         self.assertEqual(result["text"], test_val)\n         self.assertEqual(result["id"], test_val)\n \n+    def testVocabularyHtmlEntity(self):\n+        """ The vocabulary token should not convert to htmlentities.\n+        See https://github.com/plone/Products.CMFPlone/issues/3874\n+        """\n+        test_val = "Question & Answer"\n+\n+        self.portal.invokeFactory("Document", id="page", title="page")\n+        self.portal.page.subject = (test_val,)\n+        self.portal.page.reindexObject(idxs=["Subject"])\n+        processQueue()\n+\n+        self.request.form["name"] = "plone.app.vocabularies.Keywords"\n+        results = getMultiAdapter((self.portal, self.request), name="getVocabulary")()\n+        results = json.loads(results)\n+        result = results["results"][0]\n+\n+        self.assertEqual(result["text"], test_val)\n+        self.assertEqual(result["id"], test_val)\n+\n     def testVocabularyUnauthorized(self):\n         setRoles(self.portal, TEST_USER_ID, [])\n         view = VocabularyView(self.portal, self.request)\n'

Repository: plone.app.content


Branch: refs/heads/master
Date: 2023-11-22T16:06:50+01:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/plone.app.content/commit/af8bb569db3d65f5cd57132f499b2a417783d1e3

alternative attempt: unescape all entities

Files changed:
M plone/app/content/browser/vocabulary.py
M plone/app/content/tests/test_widgets.py

b'diff --git a/plone/app/content/browser/vocabulary.py b/plone/app/content/browser/vocabulary.py\nindex 75d5aad..7878407 100644\n--- a/plone/app/content/browser/vocabulary.py\n+++ b/plone/app/content/browser/vocabulary.py\n@@ -1,5 +1,6 @@\n from AccessControl import getSecurityManager\n from Acquisition import aq_base\n+from html import unescape\n from logging import getLogger\n from plone.app.content.utils import json_dumps\n from plone.app.content.utils import json_loads\n@@ -260,8 +261,10 @@ def __call__(self):\n         else:\n             items = [\n                 {\n-                    "id": transform.scrub_html(item.value).replace("&amp;", "&"),\n-                    "text": transform.scrub_html(item.title).replace("&amp;", "&") if item.title else "",\n+                    "id": unescape(transform.scrub_html(item.value)),\n+                    "text": unescape(transform.scrub_html(item.title))\n+                    if item.title\n+                    else "",\n                 }\n                 for item in results\n             ]\ndiff --git a/plone/app/content/tests/test_widgets.py b/plone/app/content/tests/test_widgets.py\nindex df6b818..95e662d 100644\n--- a/plone/app/content/tests/test_widgets.py\n+++ b/plone/app/content/tests/test_widgets.py\n@@ -270,7 +270,7 @@ def testVocabularyEncoding(self):\n         self.assertEqual(result["id"], test_val)\n \n     def testVocabularyHtmlEntity(self):\n-        """ The vocabulary token should not convert to htmlentities.\n+        """The vocabulary token should not convert to htmlentities.\n         See https://github.com/plone/Products.CMFPlone/issues/3874\n         """\n         test_val = "Question & Answer"\n'

Repository: plone.app.content


Branch: refs/heads/master
Date: 2023-11-22T16:08:45+01:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/plone.app.content/commit/06adbe30bb8022df4b28a57dcafcf4299c7c7c62

changenote

Files changed:
A news/3874.bugfix

b'diff --git a/news/3874.bugfix b/news/3874.bugfix\nnew file mode 100644\nindex 00000000..4450fb88\n--- /dev/null\n+++ b/news/3874.bugfix\n@@ -0,0 +1,2 @@\n+Fix html escaped entities in vocabulary items.\n+[petschki]\n'

Repository: plone.app.content


Branch: refs/heads/master
Date: 2024-01-31T18:11:46+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.content/commit/fc534010b4c6a4dacb7b3209eccf7eb9f99ff8c9

Merge branch 'master' into petschki-ampersand-issue

Files changed:
M .pre-commit-config.yaml
M CHANGES.rst
M plone/app/content/browser/contents/properties.py
M setup.py

b'diff --git a/.pre-commit-config.yaml b/.pre-commit-config.yaml\nindex 71b1410..09f50c7 100644\n--- a/.pre-commit-config.yaml\n+++ b/.pre-commit-config.yaml\n@@ -12,11 +12,11 @@ repos:\n     -   id: pyupgrade\n         args: [--py38-plus]\n -   repo: https://github.com/pycqa/isort\n-    rev: 5.12.0\n+    rev: 5.13.2\n     hooks:\n     -   id: isort\n -   repo: https://github.com/psf/black\n-    rev: 23.10.1\n+    rev: 23.12.1\n     hooks:\n     -   id: black\n -   repo: https://github.com/collective/zpretty\ndiff --git a/CHANGES.rst b/CHANGES.rst\nindex e9fb640..02a2086 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -8,6 +8,16 @@ Changelog\n \n .. towncrier release notes start\n \n+4.1.1 (2024-01-18)\n+------------------\n+\n+New features:\n+\n+\n+- Change import from deprecated ``plone.app.widgets`` to ``plone.app.z3cform``\n+  [petschki] (#259)\n+\n+\n 4.1.0 (2023-11-03)\n ------------------\n \ndiff --git a/plone/app/content/browser/contents/properties.py b/plone/app/content/browser/contents/properties.py\nindex c51e8a7..4cae70a 100644\n--- a/plone/app/content/browser/contents/properties.py\n+++ b/plone/app/content/browser/contents/properties.py\n@@ -2,7 +2,7 @@\n from plone.app.content.browser.contents import ContentsBaseAction\n from plone.app.content.interfaces import IStructureAction\n from plone.app.dexterity.behaviors.metadata import ICategorization\n-from plone.app.widgets.utils import get_datetime_options\n+from plone.app.z3cform.widgets.datetime import get_date_options\n from plone.base import PloneMessageFactory as _\n from plone.base.defaultpage import check_default_page_via_view\n from Products.CMFCore.interfaces._content import IFolderish\n@@ -38,7 +38,7 @@ def get_options(self):\n                 ),\n                 "template": self.template(\n                     vocabulary_url="%splone.app.vocabularies.Users" % (base_vocabulary),\n-                    pattern_options=json.dumps(get_datetime_options(self.request)),\n+                    pattern_options=json.dumps(get_date_options(self.request)),\n                 ),\n                 "dataUrl": self.context.absolute_url() + "/@@fc-properties",\n             },\ndiff --git a/setup.py b/setup.py\nindex 6108b88..99e9373 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -2,7 +2,7 @@\n from setuptools import setup\n \n \n-version = "4.1.1.dev0"\n+version = "4.1.2.dev0"\n \n setup(\n     name="plone.app.content",\n@@ -55,7 +55,6 @@\n         "plone.app.querystring",\n         "plone.app.uuid",\n         "plone.app.vocabularies>4.1.2",\n-        "plone.app.widgets",\n         "plone.app.z3cform",\n         "plone.autoform",\n         "plone.base",\n'

Repository: plone.app.content


Branch: refs/heads/master
Date: 2024-02-10T00:56:39+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.content/commit/6d76920c3bd17fe2696db8379451c04619926c27

Merge pull request #273 from plone/petschki-ampersand-issue

Fix escaped html entities in vocabulary items

Files changed:
A news/3874.bugfix
M plone/app/content/browser/vocabulary.py
M plone/app/content/tests/test_widgets.py

b'diff --git a/news/3874.bugfix b/news/3874.bugfix\nnew file mode 100644\nindex 00000000..4450fb88\n--- /dev/null\n+++ b/news/3874.bugfix\n@@ -0,0 +1,2 @@\n+Fix html escaped entities in vocabulary items.\n+[petschki]\ndiff --git a/plone/app/content/browser/vocabulary.py b/plone/app/content/browser/vocabulary.py\nindex 9464947e..78784073 100644\n--- a/plone/app/content/browser/vocabulary.py\n+++ b/plone/app/content/browser/vocabulary.py\n@@ -1,5 +1,6 @@\n from AccessControl import getSecurityManager\n from Acquisition import aq_base\n+from html import unescape\n from logging import getLogger\n from plone.app.content.utils import json_dumps\n from plone.app.content.utils import json_loads\n@@ -260,8 +261,10 @@ def __call__(self):\n         else:\n             items = [\n                 {\n-                    "id": transform.scrub_html(item.value),\n-                    "text": transform.scrub_html(item.title) if item.title else "",\n+                    "id": unescape(transform.scrub_html(item.value)),\n+                    "text": unescape(transform.scrub_html(item.title))\n+                    if item.title\n+                    else "",\n                 }\n                 for item in results\n             ]\ndiff --git a/plone/app/content/tests/test_widgets.py b/plone/app/content/tests/test_widgets.py\nindex d87b6193..95e662dd 100644\n--- a/plone/app/content/tests/test_widgets.py\n+++ b/plone/app/content/tests/test_widgets.py\n@@ -269,6 +269,25 @@ def testVocabularyEncoding(self):\n         self.assertEqual(result["text"], test_val)\n         self.assertEqual(result["id"], test_val)\n \n+    def testVocabularyHtmlEntity(self):\n+        """The vocabulary token should not convert to htmlentities.\n+        See https://github.com/plone/Products.CMFPlone/issues/3874\n+        """\n+        test_val = "Question & Answer"\n+\n+        self.portal.invokeFactory("Document", id="page", title="page")\n+        self.portal.page.subject = (test_val,)\n+        self.portal.page.reindexObject(idxs=["Subject"])\n+        processQueue()\n+\n+        self.request.form["name"] = "plone.app.vocabularies.Keywords"\n+        results = getMultiAdapter((self.portal, self.request), name="getVocabulary")()\n+        results = json.loads(results)\n+        result = results["results"][0]\n+\n+        self.assertEqual(result["text"], test_val)\n+        self.assertEqual(result["id"], test_val)\n+\n     def testVocabularyUnauthorized(self):\n         setRoles(self.portal, TEST_USER_ID, [])\n         view = VocabularyView(self.portal, self.request)\n'

