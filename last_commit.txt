Repository: plone.app.dexterity


Branch: refs/heads/master
Date: 2020-10-12T22:04:45+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.dexterity/commit/f1f6df86beb709ed2df3fef5f844273c5beb925b

Fix schema tests by waiting longer so the schema is invalidated.

When a schema is changed twice within the same second, the newest changes do not make it to the schema cache.
So we wait till the next second.
See comments here: https://github.com/plone/plone.app.dexterity/issues/313

Files changed:
M news/313.bugfix
M plone/app/dexterity/tests/editing.rst

b"diff --git a/news/313.bugfix b/news/313.bugfix\nindex eba506f..758cf4e 100644\n--- a/news/313.bugfix\n+++ b/news/313.bugfix\n@@ -1,3 +1,3 @@\n Update tests to fix updated schema cache.\n See https://github.com/plone/plone.dexterity/pull/137\n-[@avoinea]\n+[@avoinea, maurits]\ndiff --git a/plone/app/dexterity/tests/editing.rst b/plone/app/dexterity/tests/editing.rst\nindex bc6e725..b042401 100644\n--- a/plone/app/dexterity/tests/editing.rst\n+++ b/plone/app/dexterity/tests/editing.rst\n@@ -116,11 +116,16 @@ and saved::\n   >>> from plone.i18n.normalizer.interfaces import IIDNormalizer\n   >>> from plone.schemaeditor import interfaces\n   >>> normalizer = component.getUtility(IIDNormalizer)\n+  >>> import time\n   >>> for name, factory in sorted(component.getUtilitiesFor(\n   ...     interfaces.IFieldFactory)):\n   ...     if hasattr(factory, 'protected') and factory.protected(None):\n   ...         continue\n   ...     browser.open(schemaeditor_url)\n+  ...     # If two changes happen in the same second, the schema lookup will find an old schema,\n+  ...     # so we sleep till the next second.\n+  ...     now = time.time()\n+  ...     time.sleep(int(now) + 1 - now)\n   ...     browser.getLink('Add new field').click()\n   ...     browser.getControl('Title').value = name\n   ...     field_id = normalizer.normalize(name).replace('-', '_')\n"

Repository: plone.app.dexterity


Branch: refs/heads/master
Date: 2020-10-13T08:58:37+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.dexterity/commit/d07e50ba25529bdb1f0cfbdc41484a120421f837

Merge pull request #316 from plone/maurits/schema-tests-sleep

Fix schema tests by waiting longer so the schema is invalidated.

Files changed:
M news/313.bugfix
M plone/app/dexterity/tests/editing.rst

b"diff --git a/news/313.bugfix b/news/313.bugfix\nindex eba506f..758cf4e 100644\n--- a/news/313.bugfix\n+++ b/news/313.bugfix\n@@ -1,3 +1,3 @@\n Update tests to fix updated schema cache.\n See https://github.com/plone/plone.dexterity/pull/137\n-[@avoinea]\n+[@avoinea, maurits]\ndiff --git a/plone/app/dexterity/tests/editing.rst b/plone/app/dexterity/tests/editing.rst\nindex bc6e725..b042401 100644\n--- a/plone/app/dexterity/tests/editing.rst\n+++ b/plone/app/dexterity/tests/editing.rst\n@@ -116,11 +116,16 @@ and saved::\n   >>> from plone.i18n.normalizer.interfaces import IIDNormalizer\n   >>> from plone.schemaeditor import interfaces\n   >>> normalizer = component.getUtility(IIDNormalizer)\n+  >>> import time\n   >>> for name, factory in sorted(component.getUtilitiesFor(\n   ...     interfaces.IFieldFactory)):\n   ...     if hasattr(factory, 'protected') and factory.protected(None):\n   ...         continue\n   ...     browser.open(schemaeditor_url)\n+  ...     # If two changes happen in the same second, the schema lookup will find an old schema,\n+  ...     # so we sleep till the next second.\n+  ...     now = time.time()\n+  ...     time.sleep(int(now) + 1 - now)\n   ...     browser.getLink('Add new field').click()\n   ...     browser.getControl('Title').value = name\n   ...     field_id = normalizer.normalize(name).replace('-', '_')\n"

