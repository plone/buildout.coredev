Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2020-08-05T00:51:20+02:00
Author: ale-rt (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/552eb5386687158650345839c171913a7ec1c200

WSGI instances do not fail to start when http-address is equal to a list of ports

Fixes #148

Files changed:
A news/148.bugfix
M src/plone/recipe/zope2instance/recipe.py
M src/plone/recipe/zope2instance/tests/wsgi.txt

b"diff --git a/news/148.bugfix b/news/148.bugfix\nnew file mode 100644\nindex 0000000..ef4e664\n--- /dev/null\n+++ b/news/148.bugfix\n@@ -0,0 +1 @@\n+WSGI instances do not fail to start when http-address is equal to a list of ports [ale-rt]\ndiff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex 2dcdee9..250c90a 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -730,9 +730,12 @@ def build_wsgi_ini(self):\n         listen = options.get('http-address', '0.0.0.0:8080')\n         fast_listen = options.get('http-fast-listen', 'on') or ''\n         fast = 'fast-' if fast_listen.lower() in ('on', 'true') else ''\n-        if ':' not in listen:\n-            listen = '0.0.0.0:{}'.format(listen)\n-\n+        listen = ' '.join(\n+            [\n+                '0.0.0.0:{}'.format(part) if ':' not in part else part\n+                for part in listen.split()\n+            ]\n+        )\n         base_dir = self.buildout['buildout']['directory']\n         var_dir = options.get('var', os.path.join(base_dir, 'var'))\n         default_eventlog = os.path.sep.join(\ndiff --git a/src/plone/recipe/zope2instance/tests/wsgi.txt b/src/plone/recipe/zope2instance/tests/wsgi.txt\nindex 59bdd7b..aace517 100644\n--- a/src/plone/recipe/zope2instance/tests/wsgi.txt\n+++ b/src/plone/recipe/zope2instance/tests/wsgi.txt\n@@ -200,6 +200,35 @@ The buildout has updated our INI file:\n     [app:zope]\n     ...\n \n+You can also specify multiple http-address and/or specify only the port\n+(the host part will be assumed to be 0.0.0.0):\n+\n+    >>> write('buildout.cfg',\n+    ... '''\n+    ... [buildout]\n+    ... parts = instance\n+    ... find-links = %(sample_buildout)s/eggs\n+    ...\n+    ... [instance]\n+    ... recipe = plone.recipe.zope2instance\n+    ... eggs =\n+    ... user = me:me\n+    ... http-address =\n+    ...     localhost:6543\n+    ...     127.0.0.1:6544\n+    ...     8080\n+    ... ''' % options)\n+    >>> _ = system(join('bin', 'buildout'))\n+\n+The buildout has updated our INI file:\n+\n+    >>> wsgi_ini = open(os.path.join(instance, 'etc', 'wsgi.ini')).read()\n+    >>> print(wsgi_ini)\n+    [server:main]\n+    ...\n+    fast-listen = localhost:6543 127.0.0.1:6544 0.0.0.0:8080\n+    ...\n+\n Custom logging\n ==============\n \n"

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2020-08-05T10:16:09+02:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/8b815072af589d5c03c68734e539d5bb361c7d89

Merge pull request #149 from plone/148-bugfix

WSGI instances do not fail to start when http-address is equal to a lâ€¦

Files changed:
A news/148.bugfix
M src/plone/recipe/zope2instance/recipe.py
M src/plone/recipe/zope2instance/tests/wsgi.txt

b"diff --git a/news/148.bugfix b/news/148.bugfix\nnew file mode 100644\nindex 0000000..ef4e664\n--- /dev/null\n+++ b/news/148.bugfix\n@@ -0,0 +1 @@\n+WSGI instances do not fail to start when http-address is equal to a list of ports [ale-rt]\ndiff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex 2dcdee9..250c90a 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -730,9 +730,12 @@ def build_wsgi_ini(self):\n         listen = options.get('http-address', '0.0.0.0:8080')\n         fast_listen = options.get('http-fast-listen', 'on') or ''\n         fast = 'fast-' if fast_listen.lower() in ('on', 'true') else ''\n-        if ':' not in listen:\n-            listen = '0.0.0.0:{}'.format(listen)\n-\n+        listen = ' '.join(\n+            [\n+                '0.0.0.0:{}'.format(part) if ':' not in part else part\n+                for part in listen.split()\n+            ]\n+        )\n         base_dir = self.buildout['buildout']['directory']\n         var_dir = options.get('var', os.path.join(base_dir, 'var'))\n         default_eventlog = os.path.sep.join(\ndiff --git a/src/plone/recipe/zope2instance/tests/wsgi.txt b/src/plone/recipe/zope2instance/tests/wsgi.txt\nindex 59bdd7b..aace517 100644\n--- a/src/plone/recipe/zope2instance/tests/wsgi.txt\n+++ b/src/plone/recipe/zope2instance/tests/wsgi.txt\n@@ -200,6 +200,35 @@ The buildout has updated our INI file:\n     [app:zope]\n     ...\n \n+You can also specify multiple http-address and/or specify only the port\n+(the host part will be assumed to be 0.0.0.0):\n+\n+    >>> write('buildout.cfg',\n+    ... '''\n+    ... [buildout]\n+    ... parts = instance\n+    ... find-links = %(sample_buildout)s/eggs\n+    ...\n+    ... [instance]\n+    ... recipe = plone.recipe.zope2instance\n+    ... eggs =\n+    ... user = me:me\n+    ... http-address =\n+    ...     localhost:6543\n+    ...     127.0.0.1:6544\n+    ...     8080\n+    ... ''' % options)\n+    >>> _ = system(join('bin', 'buildout'))\n+\n+The buildout has updated our INI file:\n+\n+    >>> wsgi_ini = open(os.path.join(instance, 'etc', 'wsgi.ini')).read()\n+    >>> print(wsgi_ini)\n+    [server:main]\n+    ...\n+    fast-listen = localhost:6543 127.0.0.1:6544 0.0.0.0:8080\n+    ...\n+\n Custom logging\n ==============\n \n"

