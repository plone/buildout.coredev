Repository: plone.app.upgrade


Branch: refs/heads/2.x
Date: 2023-01-16T22:16:09+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/f4b222180cc9aa3c35fa7038aab59c9fcda9ab60

Apply weak caching to GET requests of content with application/json.

This is the upgrade step belonging to https://github.com/plone/plone.app.caching/pull/111
See https://github.com/plone/plone.rest/issues/73 for the full story.

Files changed:
A news/73.bugfix
M plone/app/upgrade/v52/configure.zcml
M plone/app/upgrade/v52/final.py

b'diff --git a/news/73.bugfix b/news/73.bugfix\nnew file mode 100644\nindex 00000000..8d0ebe47\n--- /dev/null\n+++ b/news/73.bugfix\n@@ -0,0 +1,3 @@\n+Apply weak caching to GET requests of content with application/json.\n+See `plone.rest issue 73 <https://github.com/plone/plone.rest/issues/73>`_.\n+[maurits]\ndiff --git a/plone/app/upgrade/v52/configure.zcml b/plone/app/upgrade/v52/configure.zcml\nindex 84d848e7..ebb27cc1 100644\n--- a/plone/app/upgrade/v52/configure.zcml\n+++ b/plone/app/upgrade/v52/configure.zcml\n@@ -281,8 +281,8 @@\n         <!-- Plone 5.2.11 -->\n \n         <gs:upgradeStep\n-            title="Miscellaneous upgrades to Plone 5.2.11"\n-            handler="..utils.null_upgrade_step"\n+            title="Add GET application/json for content to weak caching."\n+            handler=".final.add_get_application_json_to_weak_caching"\n             />\n \n     </gs:upgradeSteps>\ndiff --git a/plone/app/upgrade/v52/final.py b/plone/app/upgrade/v52/final.py\nindex c49cd866..cf900c33 100644\n--- a/plone/app/upgrade/v52/final.py\n+++ b/plone/app/upgrade/v52/final.py\n@@ -275,3 +275,34 @@ def add_the_timezone_property(context):\n     if portal_memberdata.hasProperty("timezone"):\n         return\n     portal_memberdata.manage_addProperty("timezone", "", "string")\n+\n+\n+def add_get_application_json_to_weak_caching(context):\n+    """Add GET application/json for content to weak caching.\n+\n+    See https://github.com/plone/plone.rest/issues/73#issuecomment-1384298492\n+    We want to get this in the templateRulesetMapping setting of the registry:\n+\n+        <element key="GET_application_json_">plone.content.folderView</element>\n+    """\n+    registry = getUtility(IRegistry)\n+    try:\n+        from plone.app.caching.interfaces import IPloneCacheSettings\n+    except ImportError:\n+        # plone.app.caching is optional.\n+        return\n+\n+    try:\n+        settings = registry.forInterface(IPloneCacheSettings)\n+    except KeyError:\n+        # It is available, but not activated.  Nothing to do.\n+        return\n+    mapping = settings.templateRulesetMapping\n+    key = "GET_application_json_"\n+    if key in mapping:\n+        # already set, do not change\n+        return\n+    mapping[key] = "plone.content.folderView"\n+    # Note: if we edit templateRulesetMapping, our change will not be persisted,\n+    # because it is a simple dict.  We have to set the entire mapping.\n+    settings.templateRulesetMapping = mapping\n'

Repository: plone.app.upgrade


Branch: refs/heads/2.x
Date: 2023-01-20T16:11:01+01:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.upgrade/commit/e575ef44c5912f4bde083fe0881f7ecbaf6c0fbe

Merge pull request #309 from plone/maurits-json-weak-caching

Apply weak caching to GET requests of content with application/json.

Files changed:
A news/73.bugfix
M plone/app/upgrade/v52/configure.zcml
M plone/app/upgrade/v52/final.py

b'diff --git a/news/73.bugfix b/news/73.bugfix\nnew file mode 100644\nindex 00000000..8d0ebe47\n--- /dev/null\n+++ b/news/73.bugfix\n@@ -0,0 +1,3 @@\n+Apply weak caching to GET requests of content with application/json.\n+See `plone.rest issue 73 <https://github.com/plone/plone.rest/issues/73>`_.\n+[maurits]\ndiff --git a/plone/app/upgrade/v52/configure.zcml b/plone/app/upgrade/v52/configure.zcml\nindex 84d848e7..ebb27cc1 100644\n--- a/plone/app/upgrade/v52/configure.zcml\n+++ b/plone/app/upgrade/v52/configure.zcml\n@@ -281,8 +281,8 @@\n         <!-- Plone 5.2.11 -->\n \n         <gs:upgradeStep\n-            title="Miscellaneous upgrades to Plone 5.2.11"\n-            handler="..utils.null_upgrade_step"\n+            title="Add GET application/json for content to weak caching."\n+            handler=".final.add_get_application_json_to_weak_caching"\n             />\n \n     </gs:upgradeSteps>\ndiff --git a/plone/app/upgrade/v52/final.py b/plone/app/upgrade/v52/final.py\nindex c49cd866..cf900c33 100644\n--- a/plone/app/upgrade/v52/final.py\n+++ b/plone/app/upgrade/v52/final.py\n@@ -275,3 +275,34 @@ def add_the_timezone_property(context):\n     if portal_memberdata.hasProperty("timezone"):\n         return\n     portal_memberdata.manage_addProperty("timezone", "", "string")\n+\n+\n+def add_get_application_json_to_weak_caching(context):\n+    """Add GET application/json for content to weak caching.\n+\n+    See https://github.com/plone/plone.rest/issues/73#issuecomment-1384298492\n+    We want to get this in the templateRulesetMapping setting of the registry:\n+\n+        <element key="GET_application_json_">plone.content.folderView</element>\n+    """\n+    registry = getUtility(IRegistry)\n+    try:\n+        from plone.app.caching.interfaces import IPloneCacheSettings\n+    except ImportError:\n+        # plone.app.caching is optional.\n+        return\n+\n+    try:\n+        settings = registry.forInterface(IPloneCacheSettings)\n+    except KeyError:\n+        # It is available, but not activated.  Nothing to do.\n+        return\n+    mapping = settings.templateRulesetMapping\n+    key = "GET_application_json_"\n+    if key in mapping:\n+        # already set, do not change\n+        return\n+    mapping[key] = "plone.content.folderView"\n+    # Note: if we edit templateRulesetMapping, our change will not be persisted,\n+    # because it is a simple dict.  We have to set the entire mapping.\n+    settings.templateRulesetMapping = mapping\n'

