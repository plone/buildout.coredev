Repository: plone.app.querystring


Branch: refs/heads/master
Date: 2023-08-16T13:34:16-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.app.querystring/commit/26d6e565f874d9104133339e1aef3c45416c11a7

Fix currentUser operation

Files changed:
A news/135.bugfix
M plone/app/querystring/queryparser.py
M plone/app/querystring/tests/testQueryParser.py

b'diff --git a/news/135.bugfix b/news/135.bugfix\nnew file mode 100644\nindex 0000000..20bbce6\n--- /dev/null\n+++ b/news/135.bugfix\n@@ -0,0 +1 @@\n+Fix the currentUser operation when the current user\'s username is different from their user id. @davisagli\ndiff --git a/plone/app/querystring/queryparser.py b/plone/app/querystring/queryparser.py\nindex a4ab776..4ade30e 100644\n--- a/plone/app/querystring/queryparser.py\n+++ b/plone/app/querystring/queryparser.py\n@@ -213,7 +213,7 @@ def _currentUser(context, row):\n     """Current user lookup"""\n     mt = getToolByName(context, "portal_membership")\n     user = mt.getAuthenticatedMember()\n-    return {row.index: {"query": user.getUserName()}}\n+    return {row.index: {"query": user.getId()}}\n \n \n def _showInactive(context, row):\ndiff --git a/plone/app/querystring/tests/testQueryParser.py b/plone/app/querystring/tests/testQueryParser.py\nindex 5074b69..d195218 100644\n--- a/plone/app/querystring/tests/testQueryParser.py\n+++ b/plone/app/querystring/tests/testQueryParser.py\n@@ -116,14 +116,12 @@ class MockNavRoot(MockObject):\n \n \n class MockUser:\n-    def __init__(self, username=None, roles=None):\n-        self.username = "Anonymous User"\n-        if username:\n-            self.username = username\n+    def __init__(self, userid=None, roles=None):\n+        self.userid = userid or "Anonymous User"\n         self.roles = roles or "Anonymous"\n \n-    def getUserName(self):\n-        return self.username\n+    def getId(self):\n+        return self.userid\n \n     def getRoles(self):\n         return self.roles\n@@ -466,7 +464,7 @@ def test__currentUser(self):\n         self.assertEqual(parsed, expected)\n \n         # Logged in user \'admin\'\n-        u = MockUser(username="admin")\n+        u = MockUser(userid="admin")\n         pm = MockPortal_membership(user=u)\n         context = MockSite(portal_membership=pm)\n         data = Row(index="Creator", operator="_currentUser", values=None)\n@@ -486,7 +484,7 @@ def test__showInactive(self):\n         self.assertEqual(parsed, expected)\n \n         # Logged in user \'admin\'\n-        u = MockUser(username="admin", roles=("Manager",))\n+        u = MockUser(userid="admin", roles=("Manager",))\n         pm = MockPortal_membership(user=u)\n         context = MockSite(portal_membership=pm)\n         data = Row(index="show_inactive", operator="_showInactive", values=["Manager"])\n'

Repository: plone.app.querystring


Branch: refs/heads/master
Date: 2023-08-17T09:52:10-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.app.querystring/commit/2a5a5cd8c03582f287a169a276b6f9f5a5d47937

Merge pull request #136 from plone/fix-currentUser

Fix currentUser operation

Files changed:
A news/135.bugfix
M plone/app/querystring/queryparser.py
M plone/app/querystring/tests/testQueryParser.py

b'diff --git a/news/135.bugfix b/news/135.bugfix\nnew file mode 100644\nindex 0000000..20bbce6\n--- /dev/null\n+++ b/news/135.bugfix\n@@ -0,0 +1 @@\n+Fix the currentUser operation when the current user\'s username is different from their user id. @davisagli\ndiff --git a/plone/app/querystring/queryparser.py b/plone/app/querystring/queryparser.py\nindex a4ab776..4ade30e 100644\n--- a/plone/app/querystring/queryparser.py\n+++ b/plone/app/querystring/queryparser.py\n@@ -213,7 +213,7 @@ def _currentUser(context, row):\n     """Current user lookup"""\n     mt = getToolByName(context, "portal_membership")\n     user = mt.getAuthenticatedMember()\n-    return {row.index: {"query": user.getUserName()}}\n+    return {row.index: {"query": user.getId()}}\n \n \n def _showInactive(context, row):\ndiff --git a/plone/app/querystring/tests/testQueryParser.py b/plone/app/querystring/tests/testQueryParser.py\nindex 5074b69..d195218 100644\n--- a/plone/app/querystring/tests/testQueryParser.py\n+++ b/plone/app/querystring/tests/testQueryParser.py\n@@ -116,14 +116,12 @@ class MockNavRoot(MockObject):\n \n \n class MockUser:\n-    def __init__(self, username=None, roles=None):\n-        self.username = "Anonymous User"\n-        if username:\n-            self.username = username\n+    def __init__(self, userid=None, roles=None):\n+        self.userid = userid or "Anonymous User"\n         self.roles = roles or "Anonymous"\n \n-    def getUserName(self):\n-        return self.username\n+    def getId(self):\n+        return self.userid\n \n     def getRoles(self):\n         return self.roles\n@@ -466,7 +464,7 @@ def test__currentUser(self):\n         self.assertEqual(parsed, expected)\n \n         # Logged in user \'admin\'\n-        u = MockUser(username="admin")\n+        u = MockUser(userid="admin")\n         pm = MockPortal_membership(user=u)\n         context = MockSite(portal_membership=pm)\n         data = Row(index="Creator", operator="_currentUser", values=None)\n@@ -486,7 +484,7 @@ def test__showInactive(self):\n         self.assertEqual(parsed, expected)\n \n         # Logged in user \'admin\'\n-        u = MockUser(username="admin", roles=("Manager",))\n+        u = MockUser(userid="admin", roles=("Manager",))\n         pm = MockPortal_membership(user=u)\n         context = MockSite(portal_membership=pm)\n         data = Row(index="show_inactive", operator="_showInactive", values=["Manager"])\n'

