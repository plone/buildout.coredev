Repository: diazo


Branch: refs/heads/master
Date: 2021-03-08T11:18:24+01:00
Author: Alexander Loechel (loechel) <Alexander.Loechel@lmu.de>
Commit: https://github.com/plone/diazo/commit/2c198063f1917e0d5a9b17cff943337e0e30f987

Adjust config files to fix bug with tox4

Files changed:
A docs/_static/.gitkeep
A news/80.bugfix
A news/80.feature
M .travis.yml
M constraints.txt
M docs/quickstart.rst
M lib/diazo/cssrules.py
M lib/diazo/tests/__init__.py
M lib/diazo/tests/test_diazo.py
M lib/diazo/tests/test_wsgi.py
M setup.cfg
M setup.py
M tox.ini

b'diff --git a/.travis.yml b/.travis.yml\nindex 4414058..f9210be 100644\n--- a/.travis.yml\n+++ b/.travis.yml\n@@ -7,10 +7,8 @@ cache:\n dist: xenial\n matrix:\n     include:\n-        - python: "2.7"\n-          env: TOXENV=lint-py2\n         - python: "3.7"\n-          env: TOXENV=lint-py3\n+          env: TOXENV=lint\n         - python: "2.7"\n           env: TOXENV=py27\n         - python: "3.5"\n@@ -21,6 +19,8 @@ matrix:\n           env: TOXENV=py37\n         - python: "3.8"\n           env: TOXENV=py38\n+        - python: "3.9"\n+          env: TOXENV=py39\n \n install:\n     - travis_retry pip install -U -c constraints.txt tox coveralls coverage\ndiff --git a/constraints.txt b/constraints.txt\nindex 64df031..c6ad05a 100644\n--- a/constraints.txt\n+++ b/constraints.txt\n@@ -1,83 +1,3 @@\n # Constrains for testing Diazo / Plone Packages\n # ---------------------------------------------\n \n-# tox (Test invocation tool) + virtualenv:\n-tox==2.7.0\n-virtualenv==15.1.0\n-\n-# coverage and coveralls:\n-coverage==4.4.1\n-coveralls==1.2.0\n-\n-# lint tools (flake8, isort + plugins):\n-flake8==3.4.1\n-flake8-blind-except==0.1.1\n-flake8-coding==1.3.0\n-flake8-commas==0.4.3\n-flake8-debugger==1.4.0\n-flake8-deprecated==1.2.1\n-flake8-html==0.4.0\n-flake8-isort==2.2.1\n-flake8-pep3101==1.1\n-flake8-plone-hasattr==0.2.post0\n-flake8-polyfill==1.0.1\n-flake8-print==2.0.2\n-flake8-quotes==0.11.0\n-flake8-strict==0.1.4\n-flake8-string-format==0.2.3\n-flake8-todo==0.7\n-isort==4.2.15\n-pycodestyle==2.3.1\n-pyflakes==1.5.0\n-\n-# pytest + plugins:\n-pytest==3.2.1\n-pytest-cov==2.5.1\n-pytest-html==1.15.2\n-pytest-metadata==1.5.0\n-pytest-mock==1.6.2\n-pytest-remove-stale-bytecode==3.0\n-\n-# Documentation (Sphinx + plugins)\n-docutils==0.14\n-Sphinx==1.6.3\n-sphinxcontrib-websupport==1.0.1\n-alabaster==0.7.10\n-Pygments==2.2.0\n-\n-# pdbpp debugger:\n-pdbpp==0.9.1\n-\n-# Additional Dependencies:\n-Babel==2.5.0\n-certifi==2017.7.27.1\n-chardet==3.0.4\n-configparser==3.5.0\n-coverage==4.4.1\n-cssselect==1.0.1\n-enum-compat==0.0.2\n-enum34==1.1.6\n-fancycompleter==0.7\n-FormEncode==1.3.1\n-funcsigs==1.0.2\n-future==0.16.0\n-idna==2.6\n-imagesize==0.7.1\n-Jinja2==2.9.6\n-lxml==3.8.0\n-MarkupSafe==1.1.1\n-mccabe==0.6.1\n-mock==2.0.0\n-pbr==3.1.1\n-py==1.4.34\n-pyrepl==0.8.4\n-pytz==2017.2\n-repoze.xmliter==0.6\n-requests==2.18.4\n-six==1.10.0\n-snowballstemmer==1.2.1\n-testfixtures==5.1.1\n-typing==3.6.2\n-urllib3==1.22\n-WebOb==1.7.3\n-wmctrl==0.3\ndiff --git a/docs/_static/.gitkeep b/docs/_static/.gitkeep\nnew file mode 100644\nindex 0000000..e69de29\ndiff --git a/docs/quickstart.rst b/docs/quickstart.rst\nindex df12953..50f02ea 100644\n--- a/docs/quickstart.rst\n+++ b/docs/quickstart.rst\n@@ -50,28 +50,6 @@ To set up the proxy, we will use `Buildout`_.\n     egg = lxml\n \n     [versions]\n-    # Lastest versions as of 2015-04-24\n-    PasteDeploy = 1.5.2\n-    Tempita = 0.5.2\n-    WebOb = 1.4\n-    argparse = 1.3.0\n-    cliff = 1.12.0\n-    cmd2 = 0.6.8\n-    diazo = 1.1.1\n-    experimental.cssselect = 0.3\n-    future = 0.14.3\n-    gearbox = 0.0.7\n-    lxml = 3.4.3\n-    prettytable = 0.7.2\n-    pyparsing = 2.0.3\n-    repoze.xmliter = 0.6\n-    rutter = 0.2\n-    setuptools = 15.1\n-    six = 1.9.0\n-    stevedore = 1.4.0\n-    webobentrypoints = 0.1.0\n-    zc.buildout = 2.3.1\n-    zc.recipe.egg = 2.0.1\n \n 4. Bootstrap the buildout (this is only required once)::\n \ndiff --git a/lib/diazo/cssrules.py b/lib/diazo/cssrules.py\nindex 308f48f..34f55ce 100644\n--- a/lib/diazo/cssrules.py\n+++ b/lib/diazo/cssrules.py\n@@ -12,6 +12,7 @@\n """\n \n from __future__ import absolute_import\n+\n from cssselect import GenericTranslator\n from diazo import utils\n from lxml import etree\ndiff --git a/lib/diazo/tests/__init__.py b/lib/diazo/tests/__init__.py\nindex 6d79b30..d12bc01 100644\n--- a/lib/diazo/tests/__init__.py\n+++ b/lib/diazo/tests/__init__.py\n@@ -2,12 +2,11 @@\n \n \n def alltests():\n+    from . import test_diazo\n+    from . import test_trace\n+    from . import test_wsgi\n+\n     import unittest\n-    from . import (\n-        test_trace,\n-        test_wsgi,\n-        test_diazo,\n-    )\n     modules = [\n         test_trace,\n         test_wsgi,\ndiff --git a/lib/diazo/tests/test_diazo.py b/lib/diazo/tests/test_diazo.py\nindex 6923a2e..3853413 100644\n--- a/lib/diazo/tests/test_diazo.py\n+++ b/lib/diazo/tests/test_diazo.py\n@@ -1,6 +1,7 @@\n # -*- coding: utf-8 -*-\n \n from __future__ import print_function\n+\n from diazo.utils import quote_param\n from formencode.doctest_xml_compare import xml_compare\n from future.builtins import str\ndiff --git a/lib/diazo/tests/test_wsgi.py b/lib/diazo/tests/test_wsgi.py\nindex d5281f7..de522dd 100644\n--- a/lib/diazo/tests/test_wsgi.py\n+++ b/lib/diazo/tests/test_wsgi.py\n@@ -154,12 +154,12 @@ def _testfile(filename):\n class TestXSLTMiddleware(unittest.TestCase):\n \n     def test_transform_filename(self):\n-        import tempfile\n-        import os\n-\n         from diazo.wsgi import XSLTMiddleware\n         from webob import Request\n \n+        import os\n+        import tempfile\n+\n         _, filename = tempfile.mkstemp()\n         with open(filename, \'wb\') as fp:\n             fp.write(XSLT)\n@@ -190,9 +190,8 @@ def application(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_transform_tree(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -220,9 +219,8 @@ def application(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_head_request(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -250,9 +248,8 @@ def application(environ, start_response):\n         self.assertFalse(response.body)\n \n     def test_update_content_length(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -277,9 +274,8 @@ def application(environ, start_response):\n         self.assertEqual(response.headers[\'Content-Length\'], \'178\')\n \n     def test_dont_update_content_length(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -303,9 +299,8 @@ def application(environ, start_response):\n         self.assertEqual(response.headers.get(\'Content-Length\'), None)\n \n     def test_content_length_zero(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -330,9 +325,8 @@ def application(environ, start_response):\n         self.assertEqual(response.headers[\'Content-Length\'], \'0\')\n \n     def test_content_empty(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -360,9 +354,8 @@ def application(environ, start_response):\n         )\n \n     def test_content_range(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -393,9 +386,8 @@ def application(environ, start_response):\n         self.assertFalse(\'Content-Range\' in response.headers)\n \n     def test_no_content_length(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -417,9 +409,8 @@ def application(environ, start_response):\n         self.assertFalse(\'Content-Length\' in response.headers)\n \n     def test_doctype_html(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -443,9 +434,8 @@ def application(environ, start_response):\n         )\n \n     def test_doctype_xhtml(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -469,9 +459,8 @@ def application(environ, start_response):\n         )\n \n     def test_doctype_html5(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -493,9 +482,8 @@ def application(environ, start_response):\n         self.assertTrue(response.body.startswith(b\'<!DOCTYPE html>\\n<html\'))\n \n     def test_ignored_extension(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -525,9 +513,8 @@ def application(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_diazo_off_request_header(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -558,9 +545,8 @@ def application(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_diazo_off_response_header(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application1(environ, start_response):\n@@ -603,9 +589,8 @@ def application2(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_non_html_content_type(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application1(environ, start_response):\n@@ -646,9 +631,8 @@ def application2(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_content_encoding(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application1(environ, start_response):\n@@ -688,9 +672,8 @@ def application2(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_301(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application1(environ, start_response):\n@@ -731,9 +714,8 @@ def application2(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_302(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application1(environ, start_response):\n@@ -774,9 +756,8 @@ def application2(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_304(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application1(environ, start_response):\n@@ -809,9 +790,8 @@ def application2(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_204(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application1(environ, start_response):\n@@ -844,9 +824,8 @@ def application2(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_401(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application1(environ, start_response):\n@@ -887,9 +866,8 @@ def application2(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_html_serialization(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -938,9 +916,8 @@ def application(environ, start_response):\n         self.assertTrue(b\'<br/>\' in response.body)\n \n     def test_environ_param(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -968,9 +945,8 @@ def application(environ, start_response):\n         self.assertTrue(b\'<p>value1</p>\' in response.body)\n \n     def test_params(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\ndiff --git a/news/80.bugfix b/news/80.bugfix\nnew file mode 100644\nindex 0000000..253b417\n--- /dev/null\n+++ b/news/80.bugfix\n@@ -0,0 +1,3 @@\n+- fix #80 Problems with tox4\n+  [loechel]\n+  \n\\ No newline at end of file\ndiff --git a/news/80.feature b/news/80.feature\nnew file mode 100644\nindex 0000000..d38accf\n--- /dev/null\n+++ b/news/80.feature\n@@ -0,0 +1,2 @@\n+- simplify tox and test setup\n+  [loechel]\n\\ No newline at end of file\ndiff --git a/setup.cfg b/setup.cfg\nindex 5fb5620..3dd6572 100644\n--- a/setup.cfg\n+++ b/setup.cfg\n@@ -12,8 +12,6 @@ force_alphabetical_sort = True\n force_single_line = True\n lines_after_imports = 2\n line_length = 200\n-not_skip =\n-    __init__.py\n \n skip =\n     bootstrap.py\ndiff --git a/setup.py b/setup.py\nindex e71b9c0..a855299 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -6,13 +6,13 @@\n \n extras_require = {\n     \'wsgi\': [\n-        \'repoze.xmliter>=0.6\',\n-        \'WebOb>=1.4\',\n+        \'repoze.xmliter\',\n+        \'WebOb\',\n     ],\n     \'test\': [\n         \'formencode\',\n-        \'repoze.xmliter>=0.6\',\n-        \'WebOb>=1.4\',\n+        \'repoze.xmliter\',\n+        \'WebOb\',\n     ],\n }\n \n@@ -50,13 +50,14 @@\n         \'Programming Language :: Python :: 3.6\',\n         \'Programming Language :: Python :: 3.7\',\n         \'Programming Language :: Python :: 3.8\',\n+        \'Programming Language :: Python :: 3.9\',\n         \'Topic :: Internet :: WWW/HTTP\',\n         \'Topic :: Internet :: WWW/HTTP :: WSGI\',\n         \'Topic :: Internet :: WWW/HTTP :: WSGI :: Middleware\',\n         \'Topic :: Text Processing :: Markup :: XML\',\n     ],\n     install_requires=[\n-        \'setuptools\',\n+    #    \'setuptools\',\n         \'lxml\',\n         \'cssselect\',\n         \'future\',\ndiff --git a/tox.ini b/tox.ini\nindex fc515d8..bbe2163 100644\n--- a/tox.ini\n+++ b/tox.ini\n@@ -9,9 +9,10 @@ envlist =\n     py36,\n     py37,\n     py38,\n+    py39,\n     docs,\n-    lint-py2,\n-    lint-py3,\n+    isort,\n+    lint,\n     coverage-report\n \n [testenv]\n@@ -20,7 +21,8 @@ extras =\n     test\n \n commands =\n-    python setup.py test\n+    python -VV\n+    pip list\n     mkdir -p {toxinidir}/reports/coverage {toxinidir}/reports/pytest\n     pytest --cov=lib --cov-report=xml --html={toxinidir}/reports/pytest/report-{envname}.html --self-contained-html lib/diazo/tests {posargs}\n \n@@ -40,7 +42,6 @@ whitelist_externals =\n     mkdir\n \n [testenv:coverage-report]\n-basepython = python2.7\n skip_install = true\n \n deps =\n@@ -58,11 +59,16 @@ commands =\n     coverage xml\n \n [testenv:isort-apply]\n-basepython = python2.7\n skip_install = true\n deps = isort\n commands =\n-    isort --apply --recursive {toxinidir}/lib\n+    isort --apply {toxinidir}/lib setup.py\n+\n+[testenv:isort]\n+skip_install = true\n+deps = isort\n+commands =\n+    isort {toxinidir}/lib setup.py\n \n [lint]\n skip_install = true\n@@ -86,48 +92,42 @@ deps =\n     flake8-string-format\n     flake8-todo\n     flake8_strict\n-    isort\n \n commands =\n-    mkdir -p {toxinidir}/reports/flake8\n-    #isort --check-only --recursive {toxinidir}/src\n-    #- flake8 --format=html --htmldir={toxinidir}/reports/flake8 --doctests src tests setup.py\n+    python -VV\n+    pip list\n+    mkdir -p {toxinidir}/_build/reports/flake8\n+    #- flake8 --format=html --htmldir={toxinidir}/_build/reports/flake8 --doctests src tests setup.py\n     #flake8 src tests setup.py --doctests\n-    isort --check-only --recursive {toxinidir}/lib\n-    - flake8 --format=html --htmldir={toxinidir}/reports/flake8 --doctests lib setup.py\n+    - flake8 --format=html --htmldir={toxinidir}/_build/reports/flake8 --doctests lib setup.py\n     flake8 lib setup.py --doctests\n \n whitelist_externals =\n     mkdir\n \n-[testenv:lint-py2]\n-basepython = python2\n-deps = {[lint]deps}\n-commands = {[lint]commands}\n-\n-[testenv:lint-py3]\n-basepython = python3\n-deps = {[lint]deps}\n-commands = {[lint]commands}\n-\n [testenv:docs]\n-basepython = python2.7\n commands =\n-    sphinx-build -b html -d build/docs/doctrees docs build/docs/html\n+    python -VV\n+    pip list\n+    mkdir -p {toxinidir}/_build/\n+    sphinx-build -b html -d {toxinidir}/_build/docs/doctrees docs {toxinidir}/_build/docs/html\n     # The following line should be enabled if we do have testable code in the docs.\n     #sphinx-build -b doctest docs build/docs/doctrees\n deps =\n     -cconstraints.txt\n     Sphinx\n \n+whitelist_externals =\n+    mkdir\n+\n [testenv:release]\n skip_install = true\n-basepython = python2.7\n \n deps =\n     -cconstraints.txt\n     zest.releaser[recommended]\n \n commands =\n-    python -V\n+    python -VV\n+    pip list\n     fullrelease --no-input -v\n'

Repository: diazo


Branch: refs/heads/master
Date: 2021-03-08T11:24:34+01:00
Author: Alexander Loechel (loechel) <Alexander.Loechel@lmu.de>
Commit: https://github.com/plone/diazo/commit/df74a78c5bf27b0985576eecc73dd1224d9ad57d

change isort settiungs so that it matches previous behaviour

Files changed:
M tox.ini

b'diff --git a/tox.ini b/tox.ini\nindex bbe2163..82e25f1 100644\n--- a/tox.ini\n+++ b/tox.ini\n@@ -62,13 +62,13 @@ commands =\n skip_install = true\n deps = isort\n commands =\n-    isort --apply {toxinidir}/lib setup.py\n+    isort --show-config {toxinidir}/lib setup.py\n \n [testenv:isort]\n skip_install = true\n deps = isort\n commands =\n-    isort {toxinidir}/lib setup.py\n+    isort --show-config --diff {toxinidir}/lib setup.py\n \n [lint]\n skip_install = true\n'

Repository: diazo


Branch: refs/heads/master
Date: 2021-03-08T16:24:40+01:00
Author: Alexander Loechel (loechel) <Alexander.Loechel@lmu.de>
Commit: https://github.com/plone/diazo/commit/e402301dbbee06c22d707261c80c8c5d7e316100

fix isort call

Files changed:
M lib/diazo/tests/__init__.py
M tox.ini

b'diff --git a/lib/diazo/tests/__init__.py b/lib/diazo/tests/__init__.py\nindex d12bc01..c77d1f7 100644\n--- a/lib/diazo/tests/__init__.py\n+++ b/lib/diazo/tests/__init__.py\n@@ -2,9 +2,9 @@\n \n \n def alltests():\n-    from . import test_diazo\n-    from . import test_trace\n-    from . import test_wsgi\n+    from diazo.tests import test_diazo\n+    from diazo.tests import test_trace\n+    from diazo.tests import test_wsgi\n \n     import unittest\n     modules = [\ndiff --git a/tox.ini b/tox.ini\nindex 82e25f1..f10fbdc 100644\n--- a/tox.ini\n+++ b/tox.ini\n@@ -62,13 +62,14 @@ commands =\n skip_install = true\n deps = isort\n commands =\n-    isort --show-config {toxinidir}/lib setup.py\n+    isort {toxinidir}/lib setup.py\n \n [testenv:isort]\n skip_install = true\n deps = isort\n commands =\n-    isort --show-config --diff {toxinidir}/lib setup.py\n+    isort --show-config\n+    isort --check-only --diff {toxinidir}/lib setup.py\n \n [lint]\n skip_install = true\n'

Repository: diazo


Branch: refs/heads/master
Date: 2021-03-08T17:16:13+01:00
Author: Alexander Loechel (loechel) <Alexander.Loechel@lmu.de>
Commit: https://github.com/plone/diazo/commit/b002de6fd397072267c7b9956ddab563444033fb

setup.cfg

Files changed:
M setup.cfg

b'diff --git a/setup.cfg b/setup.cfg\nindex 3dd6572..8df7bd3 100644\n--- a/setup.cfg\n+++ b/setup.cfg\n@@ -13,12 +13,8 @@ force_single_line = True\n lines_after_imports = 2\n line_length = 200\n \n-skip =\n-    bootstrap.py\n-\n [flake8]\n exclude =\n-    bootstrap-buildout.py,\n \n ignore =\n \n@@ -30,9 +26,6 @@ testpaths =\n \n norecursedirs = fixures\n \n-isort_ignore =\n-    bootstrap-buildout.py\n-\n [coverage:run]\n branch = True\n source = lib\n@@ -45,7 +38,5 @@ precision = 2\n [coverage:html]\n directory = reports/coverage\n \n-\n-\n [bdist_wheel]\n universal = 1\n'

Repository: diazo


Branch: refs/heads/master
Date: 2021-03-08T18:36:48+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/diazo/commit/e9ce4482d0a41242127baa1f7fffcf672c2c074c

Merge pull request #81 from plone/tox4

Adjust config files to fix bug with tox4

Files changed:
A docs/_static/.gitkeep
A news/80.bugfix
A news/80.feature
M .travis.yml
M constraints.txt
M docs/quickstart.rst
M lib/diazo/cssrules.py
M lib/diazo/tests/__init__.py
M lib/diazo/tests/test_diazo.py
M lib/diazo/tests/test_wsgi.py
M setup.cfg
M setup.py
M tox.ini

b'diff --git a/.travis.yml b/.travis.yml\nindex 4414058..f9210be 100644\n--- a/.travis.yml\n+++ b/.travis.yml\n@@ -7,10 +7,8 @@ cache:\n dist: xenial\n matrix:\n     include:\n-        - python: "2.7"\n-          env: TOXENV=lint-py2\n         - python: "3.7"\n-          env: TOXENV=lint-py3\n+          env: TOXENV=lint\n         - python: "2.7"\n           env: TOXENV=py27\n         - python: "3.5"\n@@ -21,6 +19,8 @@ matrix:\n           env: TOXENV=py37\n         - python: "3.8"\n           env: TOXENV=py38\n+        - python: "3.9"\n+          env: TOXENV=py39\n \n install:\n     - travis_retry pip install -U -c constraints.txt tox coveralls coverage\ndiff --git a/constraints.txt b/constraints.txt\nindex 64df031..c6ad05a 100644\n--- a/constraints.txt\n+++ b/constraints.txt\n@@ -1,83 +1,3 @@\n # Constrains for testing Diazo / Plone Packages\n # ---------------------------------------------\n \n-# tox (Test invocation tool) + virtualenv:\n-tox==2.7.0\n-virtualenv==15.1.0\n-\n-# coverage and coveralls:\n-coverage==4.4.1\n-coveralls==1.2.0\n-\n-# lint tools (flake8, isort + plugins):\n-flake8==3.4.1\n-flake8-blind-except==0.1.1\n-flake8-coding==1.3.0\n-flake8-commas==0.4.3\n-flake8-debugger==1.4.0\n-flake8-deprecated==1.2.1\n-flake8-html==0.4.0\n-flake8-isort==2.2.1\n-flake8-pep3101==1.1\n-flake8-plone-hasattr==0.2.post0\n-flake8-polyfill==1.0.1\n-flake8-print==2.0.2\n-flake8-quotes==0.11.0\n-flake8-strict==0.1.4\n-flake8-string-format==0.2.3\n-flake8-todo==0.7\n-isort==4.2.15\n-pycodestyle==2.3.1\n-pyflakes==1.5.0\n-\n-# pytest + plugins:\n-pytest==3.2.1\n-pytest-cov==2.5.1\n-pytest-html==1.15.2\n-pytest-metadata==1.5.0\n-pytest-mock==1.6.2\n-pytest-remove-stale-bytecode==3.0\n-\n-# Documentation (Sphinx + plugins)\n-docutils==0.14\n-Sphinx==1.6.3\n-sphinxcontrib-websupport==1.0.1\n-alabaster==0.7.10\n-Pygments==2.2.0\n-\n-# pdbpp debugger:\n-pdbpp==0.9.1\n-\n-# Additional Dependencies:\n-Babel==2.5.0\n-certifi==2017.7.27.1\n-chardet==3.0.4\n-configparser==3.5.0\n-coverage==4.4.1\n-cssselect==1.0.1\n-enum-compat==0.0.2\n-enum34==1.1.6\n-fancycompleter==0.7\n-FormEncode==1.3.1\n-funcsigs==1.0.2\n-future==0.16.0\n-idna==2.6\n-imagesize==0.7.1\n-Jinja2==2.9.6\n-lxml==3.8.0\n-MarkupSafe==1.1.1\n-mccabe==0.6.1\n-mock==2.0.0\n-pbr==3.1.1\n-py==1.4.34\n-pyrepl==0.8.4\n-pytz==2017.2\n-repoze.xmliter==0.6\n-requests==2.18.4\n-six==1.10.0\n-snowballstemmer==1.2.1\n-testfixtures==5.1.1\n-typing==3.6.2\n-urllib3==1.22\n-WebOb==1.7.3\n-wmctrl==0.3\ndiff --git a/docs/_static/.gitkeep b/docs/_static/.gitkeep\nnew file mode 100644\nindex 0000000..e69de29\ndiff --git a/docs/quickstart.rst b/docs/quickstart.rst\nindex df12953..50f02ea 100644\n--- a/docs/quickstart.rst\n+++ b/docs/quickstart.rst\n@@ -50,28 +50,6 @@ To set up the proxy, we will use `Buildout`_.\n     egg = lxml\n \n     [versions]\n-    # Lastest versions as of 2015-04-24\n-    PasteDeploy = 1.5.2\n-    Tempita = 0.5.2\n-    WebOb = 1.4\n-    argparse = 1.3.0\n-    cliff = 1.12.0\n-    cmd2 = 0.6.8\n-    diazo = 1.1.1\n-    experimental.cssselect = 0.3\n-    future = 0.14.3\n-    gearbox = 0.0.7\n-    lxml = 3.4.3\n-    prettytable = 0.7.2\n-    pyparsing = 2.0.3\n-    repoze.xmliter = 0.6\n-    rutter = 0.2\n-    setuptools = 15.1\n-    six = 1.9.0\n-    stevedore = 1.4.0\n-    webobentrypoints = 0.1.0\n-    zc.buildout = 2.3.1\n-    zc.recipe.egg = 2.0.1\n \n 4. Bootstrap the buildout (this is only required once)::\n \ndiff --git a/lib/diazo/cssrules.py b/lib/diazo/cssrules.py\nindex 308f48f..34f55ce 100644\n--- a/lib/diazo/cssrules.py\n+++ b/lib/diazo/cssrules.py\n@@ -12,6 +12,7 @@\n """\n \n from __future__ import absolute_import\n+\n from cssselect import GenericTranslator\n from diazo import utils\n from lxml import etree\ndiff --git a/lib/diazo/tests/__init__.py b/lib/diazo/tests/__init__.py\nindex 6d79b30..c77d1f7 100644\n--- a/lib/diazo/tests/__init__.py\n+++ b/lib/diazo/tests/__init__.py\n@@ -2,12 +2,11 @@\n \n \n def alltests():\n+    from diazo.tests import test_diazo\n+    from diazo.tests import test_trace\n+    from diazo.tests import test_wsgi\n+\n     import unittest\n-    from . import (\n-        test_trace,\n-        test_wsgi,\n-        test_diazo,\n-    )\n     modules = [\n         test_trace,\n         test_wsgi,\ndiff --git a/lib/diazo/tests/test_diazo.py b/lib/diazo/tests/test_diazo.py\nindex 6923a2e..3853413 100644\n--- a/lib/diazo/tests/test_diazo.py\n+++ b/lib/diazo/tests/test_diazo.py\n@@ -1,6 +1,7 @@\n # -*- coding: utf-8 -*-\n \n from __future__ import print_function\n+\n from diazo.utils import quote_param\n from formencode.doctest_xml_compare import xml_compare\n from future.builtins import str\ndiff --git a/lib/diazo/tests/test_wsgi.py b/lib/diazo/tests/test_wsgi.py\nindex d5281f7..de522dd 100644\n--- a/lib/diazo/tests/test_wsgi.py\n+++ b/lib/diazo/tests/test_wsgi.py\n@@ -154,12 +154,12 @@ def _testfile(filename):\n class TestXSLTMiddleware(unittest.TestCase):\n \n     def test_transform_filename(self):\n-        import tempfile\n-        import os\n-\n         from diazo.wsgi import XSLTMiddleware\n         from webob import Request\n \n+        import os\n+        import tempfile\n+\n         _, filename = tempfile.mkstemp()\n         with open(filename, \'wb\') as fp:\n             fp.write(XSLT)\n@@ -190,9 +190,8 @@ def application(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_transform_tree(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -220,9 +219,8 @@ def application(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_head_request(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -250,9 +248,8 @@ def application(environ, start_response):\n         self.assertFalse(response.body)\n \n     def test_update_content_length(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -277,9 +274,8 @@ def application(environ, start_response):\n         self.assertEqual(response.headers[\'Content-Length\'], \'178\')\n \n     def test_dont_update_content_length(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -303,9 +299,8 @@ def application(environ, start_response):\n         self.assertEqual(response.headers.get(\'Content-Length\'), None)\n \n     def test_content_length_zero(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -330,9 +325,8 @@ def application(environ, start_response):\n         self.assertEqual(response.headers[\'Content-Length\'], \'0\')\n \n     def test_content_empty(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -360,9 +354,8 @@ def application(environ, start_response):\n         )\n \n     def test_content_range(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -393,9 +386,8 @@ def application(environ, start_response):\n         self.assertFalse(\'Content-Range\' in response.headers)\n \n     def test_no_content_length(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -417,9 +409,8 @@ def application(environ, start_response):\n         self.assertFalse(\'Content-Length\' in response.headers)\n \n     def test_doctype_html(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -443,9 +434,8 @@ def application(environ, start_response):\n         )\n \n     def test_doctype_xhtml(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -469,9 +459,8 @@ def application(environ, start_response):\n         )\n \n     def test_doctype_html5(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -493,9 +482,8 @@ def application(environ, start_response):\n         self.assertTrue(response.body.startswith(b\'<!DOCTYPE html>\\n<html\'))\n \n     def test_ignored_extension(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -525,9 +513,8 @@ def application(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_diazo_off_request_header(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -558,9 +545,8 @@ def application(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_diazo_off_response_header(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application1(environ, start_response):\n@@ -603,9 +589,8 @@ def application2(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_non_html_content_type(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application1(environ, start_response):\n@@ -646,9 +631,8 @@ def application2(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_content_encoding(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application1(environ, start_response):\n@@ -688,9 +672,8 @@ def application2(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_301(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application1(environ, start_response):\n@@ -731,9 +714,8 @@ def application2(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_302(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application1(environ, start_response):\n@@ -774,9 +756,8 @@ def application2(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_304(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application1(environ, start_response):\n@@ -809,9 +790,8 @@ def application2(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_204(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application1(environ, start_response):\n@@ -844,9 +824,8 @@ def application2(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_401(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application1(environ, start_response):\n@@ -887,9 +866,8 @@ def application2(environ, start_response):\n         self.assertTrue(b\'<title>Transformed</title>\' in response.body)\n \n     def test_html_serialization(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -938,9 +916,8 @@ def application(environ, start_response):\n         self.assertTrue(b\'<br/>\' in response.body)\n \n     def test_environ_param(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\n@@ -968,9 +945,8 @@ def application(environ, start_response):\n         self.assertTrue(b\'<p>value1</p>\' in response.body)\n \n     def test_params(self):\n-        from lxml import etree\n-\n         from diazo.wsgi import XSLTMiddleware\n+        from lxml import etree\n         from webob import Request\n \n         def application(environ, start_response):\ndiff --git a/news/80.bugfix b/news/80.bugfix\nnew file mode 100644\nindex 0000000..253b417\n--- /dev/null\n+++ b/news/80.bugfix\n@@ -0,0 +1,3 @@\n+- fix #80 Problems with tox4\n+  [loechel]\n+  \n\\ No newline at end of file\ndiff --git a/news/80.feature b/news/80.feature\nnew file mode 100644\nindex 0000000..d38accf\n--- /dev/null\n+++ b/news/80.feature\n@@ -0,0 +1,2 @@\n+- simplify tox and test setup\n+  [loechel]\n\\ No newline at end of file\ndiff --git a/setup.cfg b/setup.cfg\nindex 5fb5620..8df7bd3 100644\n--- a/setup.cfg\n+++ b/setup.cfg\n@@ -12,15 +12,9 @@ force_alphabetical_sort = True\n force_single_line = True\n lines_after_imports = 2\n line_length = 200\n-not_skip =\n-    __init__.py\n-\n-skip =\n-    bootstrap.py\n \n [flake8]\n exclude =\n-    bootstrap-buildout.py,\n \n ignore =\n \n@@ -32,9 +26,6 @@ testpaths =\n \n norecursedirs = fixures\n \n-isort_ignore =\n-    bootstrap-buildout.py\n-\n [coverage:run]\n branch = True\n source = lib\n@@ -47,7 +38,5 @@ precision = 2\n [coverage:html]\n directory = reports/coverage\n \n-\n-\n [bdist_wheel]\n universal = 1\ndiff --git a/setup.py b/setup.py\nindex e71b9c0..a855299 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -6,13 +6,13 @@\n \n extras_require = {\n     \'wsgi\': [\n-        \'repoze.xmliter>=0.6\',\n-        \'WebOb>=1.4\',\n+        \'repoze.xmliter\',\n+        \'WebOb\',\n     ],\n     \'test\': [\n         \'formencode\',\n-        \'repoze.xmliter>=0.6\',\n-        \'WebOb>=1.4\',\n+        \'repoze.xmliter\',\n+        \'WebOb\',\n     ],\n }\n \n@@ -50,13 +50,14 @@\n         \'Programming Language :: Python :: 3.6\',\n         \'Programming Language :: Python :: 3.7\',\n         \'Programming Language :: Python :: 3.8\',\n+        \'Programming Language :: Python :: 3.9\',\n         \'Topic :: Internet :: WWW/HTTP\',\n         \'Topic :: Internet :: WWW/HTTP :: WSGI\',\n         \'Topic :: Internet :: WWW/HTTP :: WSGI :: Middleware\',\n         \'Topic :: Text Processing :: Markup :: XML\',\n     ],\n     install_requires=[\n-        \'setuptools\',\n+    #    \'setuptools\',\n         \'lxml\',\n         \'cssselect\',\n         \'future\',\ndiff --git a/tox.ini b/tox.ini\nindex fc515d8..f10fbdc 100644\n--- a/tox.ini\n+++ b/tox.ini\n@@ -9,9 +9,10 @@ envlist =\n     py36,\n     py37,\n     py38,\n+    py39,\n     docs,\n-    lint-py2,\n-    lint-py3,\n+    isort,\n+    lint,\n     coverage-report\n \n [testenv]\n@@ -20,7 +21,8 @@ extras =\n     test\n \n commands =\n-    python setup.py test\n+    python -VV\n+    pip list\n     mkdir -p {toxinidir}/reports/coverage {toxinidir}/reports/pytest\n     pytest --cov=lib --cov-report=xml --html={toxinidir}/reports/pytest/report-{envname}.html --self-contained-html lib/diazo/tests {posargs}\n \n@@ -40,7 +42,6 @@ whitelist_externals =\n     mkdir\n \n [testenv:coverage-report]\n-basepython = python2.7\n skip_install = true\n \n deps =\n@@ -58,11 +59,17 @@ commands =\n     coverage xml\n \n [testenv:isort-apply]\n-basepython = python2.7\n skip_install = true\n deps = isort\n commands =\n-    isort --apply --recursive {toxinidir}/lib\n+    isort {toxinidir}/lib setup.py\n+\n+[testenv:isort]\n+skip_install = true\n+deps = isort\n+commands =\n+    isort --show-config\n+    isort --check-only --diff {toxinidir}/lib setup.py\n \n [lint]\n skip_install = true\n@@ -86,48 +93,42 @@ deps =\n     flake8-string-format\n     flake8-todo\n     flake8_strict\n-    isort\n \n commands =\n-    mkdir -p {toxinidir}/reports/flake8\n-    #isort --check-only --recursive {toxinidir}/src\n-    #- flake8 --format=html --htmldir={toxinidir}/reports/flake8 --doctests src tests setup.py\n+    python -VV\n+    pip list\n+    mkdir -p {toxinidir}/_build/reports/flake8\n+    #- flake8 --format=html --htmldir={toxinidir}/_build/reports/flake8 --doctests src tests setup.py\n     #flake8 src tests setup.py --doctests\n-    isort --check-only --recursive {toxinidir}/lib\n-    - flake8 --format=html --htmldir={toxinidir}/reports/flake8 --doctests lib setup.py\n+    - flake8 --format=html --htmldir={toxinidir}/_build/reports/flake8 --doctests lib setup.py\n     flake8 lib setup.py --doctests\n \n whitelist_externals =\n     mkdir\n \n-[testenv:lint-py2]\n-basepython = python2\n-deps = {[lint]deps}\n-commands = {[lint]commands}\n-\n-[testenv:lint-py3]\n-basepython = python3\n-deps = {[lint]deps}\n-commands = {[lint]commands}\n-\n [testenv:docs]\n-basepython = python2.7\n commands =\n-    sphinx-build -b html -d build/docs/doctrees docs build/docs/html\n+    python -VV\n+    pip list\n+    mkdir -p {toxinidir}/_build/\n+    sphinx-build -b html -d {toxinidir}/_build/docs/doctrees docs {toxinidir}/_build/docs/html\n     # The following line should be enabled if we do have testable code in the docs.\n     #sphinx-build -b doctest docs build/docs/doctrees\n deps =\n     -cconstraints.txt\n     Sphinx\n \n+whitelist_externals =\n+    mkdir\n+\n [testenv:release]\n skip_install = true\n-basepython = python2.7\n \n deps =\n     -cconstraints.txt\n     zest.releaser[recommended]\n \n commands =\n-    python -V\n+    python -VV\n+    pip list\n     fullrelease --no-input -v\n'

