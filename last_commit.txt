Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-02-04T09:17:42+01:00
Author: Andrea Cecchi (cekk) <andrea.cecchi85@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/58e5f2392222db6852cee849c47c0018915b0952

Don't break @navigation with items without review_state (#1060)

* handle items without review_state

* add changelog

* blacked

* fix black

Files changed:
A news/1060.bugfix
M src/plone/restapi/services/navigation/get.py
M src/plone/restapi/tests/test_services_navigation.py

b'diff --git a/news/1060.bugfix b/news/1060.bugfix\nnew file mode 100644\nindex 000000000..35be2150e\n--- /dev/null\n+++ b/news/1060.bugfix\n@@ -0,0 +1 @@\n+Handle missing review_state value in @navigation endpoint for items without a workflow [cekk]\ndiff --git a/src/plone/restapi/services/navigation/get.py b/src/plone/restapi/services/navigation/get.py\nindex 4eba1e2fc..35b8694f6 100644\n--- a/src/plone/restapi/services/navigation/get.py\n+++ b/src/plone/restapi/services/navigation/get.py\n@@ -6,6 +6,7 @@\n from plone.memoize.view import memoize_contextless\n from plone.registry.interfaces import IRegistry\n from plone.restapi.interfaces import IExpandableElement\n+from plone.restapi.serializer.converters import json_compatible\n from plone.restapi.services import Service\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.utils import getFSVersionTuple\n@@ -121,7 +122,7 @@ def navtree(self):\n                 }\n             )\n             if "review_state" in tab:\n-                entry["review_state"] = tab["review_state"]\n+                entry["review_state"] = json_compatible(tab["review_state"])\n             else:\n                 entry["review_state"] = None\n \n@@ -177,7 +178,7 @@ def navtree(self):\n                 "@id": url,\n                 "title": safe_unicode(brain.Title),\n                 "description": safe_unicode(brain.Description),\n-                "review_state": brain.review_state,\n+                "review_state": json_compatible(brain.review_state),\n                 "use_view_action_in_listings": brain.portal_type in types_using_view,\n             }\n \ndiff --git a/src/plone/restapi/tests/test_services_navigation.py b/src/plone/restapi/tests/test_services_navigation.py\nindex 3b8e2c3b9..4b8f7d9b4 100644\n--- a/src/plone/restapi/tests/test_services_navigation.py\n+++ b/src/plone/restapi/tests/test_services_navigation.py\n@@ -65,7 +65,8 @@ def tearDown(self):\n         self.api_session.close()\n \n     @unittest.skipIf(\n-        not PLONE5, "Just Plone 5 currently, tabs in plone 4 does not have review_state"\n+        not PLONE5,\n+        "Just Plone 5 currently, tabs in plone 4 does not have review_state",\n     )\n     def test_navigation_with_no_params_gets_only_top_level(self):\n         response = self.api_session.get("/folder/@navigation")\n@@ -122,7 +123,8 @@ def test_navigation_service(self):\n             u"Third Level Folder",\n         )\n         self.assertEqual(\n-            len(response.json()["items"][1]["items"][0]["items"][0]["items"]), 0\n+            len(response.json()["items"][1]["items"][0]["items"][0]["items"]),\n+            0,\n         )\n \n         response = self.api_session.get(\n@@ -130,7 +132,8 @@ def test_navigation_service(self):\n         )\n \n         self.assertEqual(\n-            len(response.json()["items"][1]["items"][0]["items"][0]["items"]), 1\n+            len(response.json()["items"][1]["items"][0]["items"][0]["items"]),\n+            1,\n         )\n         self.assertEqual(\n             response.json()["items"][1]["items"][0]["items"][0]["items"][0][\n@@ -138,3 +141,26 @@ def test_navigation_service(self):\n             ],  # noqa\n             u"Fourth Level Folder",\n         )\n+\n+    def test_dont_broke_with_contents_without_review_state(self):\n+        createContentInContainer(\n+            self.portal,\n+            u"File",\n+            id=u"example-file",\n+            title=u"Example file",\n+        )\n+        createContentInContainer(\n+            self.folder,\n+            u"File",\n+            id=u"example-file-1",\n+            title=u"Example file 1",\n+        )\n+        transaction.commit()\n+\n+        response = self.api_session.get("/folder/@navigation")\n+        self.assertIsNone(response.json()["items"][3]["review_state"])\n+\n+        response = self.api_session.get(\n+            "/folder/@navigation", params={"expand.navigation.depth": 2}\n+        )\n+        self.assertIsNone(response.json()["items"][1]["items"][3]["review_state"])\n'

