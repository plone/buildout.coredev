Repository: Products.PortalTransforms


Branch: refs/heads/master
Date: 2024-08-05T16:58:51+02:00
Author: Manuel Reinhardt (reinhardt) <reinhardt@syslab.com>
Commit: https://github.com/plone/Products.PortalTransforms/commit/d5c91cfbd96dd5ca83c7c9e1d6ad502ef95e107f

feat: Shortcut in safe_html

Check for signs of html or script, skip further processing if none are found.
Saves processing time for lxml parsing and manipulation.

Files changed:
A news/66.feature
M Products/PortalTransforms/transforms/safe_html.py

b'diff --git a/Products/PortalTransforms/transforms/safe_html.py b/Products/PortalTransforms/transforms/safe_html.py\nindex 787e7e1..fc25179 100644\n--- a/Products/PortalTransforms/transforms/safe_html.py\n+++ b/Products/PortalTransforms/transforms/safe_html.py\n@@ -4,6 +4,7 @@\n from lxml_html_clean import Cleaner\n from plone.base.interfaces import IFilterSchema\n from plone.base.utils import safe_bytes\n+from plone.base.utils import safe_text\n from plone.registry.interfaces import IRegistry\n from Products.PortalTransforms.interfaces import ITransform\n from Products.PortalTransforms.libtransforms.utils import bodyfinder\n@@ -183,6 +184,14 @@ def cleaner_options(self):\n         return options\n \n     def scrub_html(self, orig):\n+        orig_text = safe_text(orig)\n+        # short cut if no html or script is detected\n+        if not orig or not (\n+            hasScript(orig_text)\n+            or "<" in orig_text\n+            or any((entity in orig_text for entity in html5entities.values()))\n+        ):\n+            return orig_text\n         # append html tag to create a dummy parent for the tree\n         html_parser = html.HTMLParser(encoding="utf-8")\n         orig = safe_bytes(orig)\ndiff --git a/news/66.feature b/news/66.feature\nnew file mode 100644\nindex 0000000..c07a4bb\n--- /dev/null\n+++ b/news/66.feature\n@@ -0,0 +1 @@\n+Shortcut in safe_html: Check for signs of html or script, skip further processing if none are found.\n'

Repository: Products.PortalTransforms


Branch: refs/heads/master
Date: 2024-08-05T23:33:38Z
Author: pre-commit-ci[bot] (pre-commit-ci[bot]) <66853113+pre-commit-ci[bot]@users.noreply.github.com>
Commit: https://github.com/plone/Products.PortalTransforms/commit/0bb777712e109418f36174158d9815140aae2e73

[pre-commit.ci] auto fixes from pre-commit.com hooks

for more information, see https://pre-commit.ci

Files changed:
M Products/PortalTransforms/transforms/safe_html.py

b'diff --git a/Products/PortalTransforms/transforms/safe_html.py b/Products/PortalTransforms/transforms/safe_html.py\nindex fc25179..934c529 100644\n--- a/Products/PortalTransforms/transforms/safe_html.py\n+++ b/Products/PortalTransforms/transforms/safe_html.py\n@@ -189,7 +189,7 @@ def scrub_html(self, orig):\n         if not orig or not (\n             hasScript(orig_text)\n             or "<" in orig_text\n-            or any((entity in orig_text for entity in html5entities.values()))\n+            or any(entity in orig_text for entity in html5entities.values())\n         ):\n             return orig_text\n         # append html tag to create a dummy parent for the tree\n'

Repository: Products.PortalTransforms


Branch: refs/heads/master
Date: 2024-08-05T18:35:24-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/Products.PortalTransforms/commit/85d7947fb25e942817663f6fbe9833cee35dd77c

Merge pull request #66 from plone/scrub-shortcut

Shortcut in safe_html

Files changed:
A news/66.feature
M Products/PortalTransforms/transforms/safe_html.py

b'diff --git a/Products/PortalTransforms/transforms/safe_html.py b/Products/PortalTransforms/transforms/safe_html.py\nindex 787e7e1..934c529 100644\n--- a/Products/PortalTransforms/transforms/safe_html.py\n+++ b/Products/PortalTransforms/transforms/safe_html.py\n@@ -4,6 +4,7 @@\n from lxml_html_clean import Cleaner\n from plone.base.interfaces import IFilterSchema\n from plone.base.utils import safe_bytes\n+from plone.base.utils import safe_text\n from plone.registry.interfaces import IRegistry\n from Products.PortalTransforms.interfaces import ITransform\n from Products.PortalTransforms.libtransforms.utils import bodyfinder\n@@ -183,6 +184,14 @@ def cleaner_options(self):\n         return options\n \n     def scrub_html(self, orig):\n+        orig_text = safe_text(orig)\n+        # short cut if no html or script is detected\n+        if not orig or not (\n+            hasScript(orig_text)\n+            or "<" in orig_text\n+            or any(entity in orig_text for entity in html5entities.values())\n+        ):\n+            return orig_text\n         # append html tag to create a dummy parent for the tree\n         html_parser = html.HTMLParser(encoding="utf-8")\n         orig = safe_bytes(orig)\ndiff --git a/news/66.feature b/news/66.feature\nnew file mode 100644\nindex 0000000..c07a4bb\n--- /dev/null\n+++ b/news/66.feature\n@@ -0,0 +1 @@\n+Shortcut in safe_html: Check for signs of html or script, skip further processing if none are found.\n'

