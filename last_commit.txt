Repository: Products.PortalTransforms


Branch: refs/heads/master
Date: 2024-04-24T00:13:06+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.PortalTransforms/commit/df24deff61c2c9af3535cf6ed8308af9622b20b5

Use Cleaner from new package lxml_html_clean.

This was factored out from ``lxml`` in version 5.2.0.
See https://lxml-html-clean.readthedocs.io/

Fixes https://github.com/plone/Products.CMFPlone/issues/3938

Alternatively we could depend on `lxml[html_clean]`, but I think it is cleaner (pun intended) to directly depend on the new package.
Also, this means it is still possible to use an older `lxml` version that does not have the `html_clean` extra, if needed.

Files changed:
A news/3938.bugfix
M Products/PortalTransforms/transforms/safe_html.py
M setup.py

b'diff --git a/Products/PortalTransforms/transforms/safe_html.py b/Products/PortalTransforms/transforms/safe_html.py\nindex 1a50adc..787e7e1 100644\n--- a/Products/PortalTransforms/transforms/safe_html.py\n+++ b/Products/PortalTransforms/transforms/safe_html.py\n@@ -1,7 +1,7 @@\n from html.entities import html5 as html5entities\n from lxml import etree\n from lxml import html\n-from lxml.html.clean import Cleaner\n+from lxml_html_clean import Cleaner\n from plone.base.interfaces import IFilterSchema\n from plone.base.utils import safe_bytes\n from plone.registry.interfaces import IRegistry\ndiff --git a/news/3938.bugfix b/news/3938.bugfix\nnew file mode 100644\nindex 0000000..760f749\n--- /dev/null\n+++ b/news/3938.bugfix\n@@ -0,0 +1,4 @@\n+Use ``Cleaner`` from new package ``lxml_html_clean``.\n+This was factored out from ``lxml`` in version 5.2.0.\n+See https://lxml-html-clean.readthedocs.io/\n+[maurits]\ndiff --git a/setup.py b/setup.py\nindex 30d1ec7..3387f41 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -55,6 +55,7 @@\n         "Products.GenericSetup",\n         "setuptools",\n         "lxml",\n+        "lxml_html_clean",\n         "persistent",\n         "plone.base",\n         "plone.registry",\n'

Repository: Products.PortalTransforms


Branch: refs/heads/master
Date: 2024-04-24T18:16:09+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.PortalTransforms/commit/ad6ddf2f884d66c0e7aaa3e96156d2fec341cf0e

Fix test_xss test_38 to pass on both lxml 4 and 5.

See also this change from two years ago:
https://github.com/plone/Products.PortalTransforms/commit/47eee976ec9aaf9af7ef049d99f5202e2e6fcfc6#diff-efe2731249aad855e92cb1a1095e921edec654ef09fe9c6af8b8094f49acf646L231-R232

Files changed:
M Products/PortalTransforms/tests/test_xss.py

b'diff --git a/Products/PortalTransforms/tests/test_xss.py b/Products/PortalTransforms/tests/test_xss.py\nindex 6f8859d..9c30920 100644\n--- a/Products/PortalTransforms/tests/test_xss.py\n+++ b/Products/PortalTransforms/tests/test_xss.py\n@@ -251,7 +251,12 @@ def test_38(self):\n             """<p><a href="http://T\\\\foo\\\\20111015\\\\bar.msg">FOO</a></p>"""  # noqa\n         )\n         data_out = """<p><a href="http://T%5Cfoo%5C20111015%5Cbar.msg">FOO</a></p>"""\n-        self.doTest(data_in, data_out)\n+        # When we were still using lxml.xml, converting data_in gave data_in as anwer.\n+        # Then we switched to lxml.html, which caused the backslashes to be converted\n+        # into \'%5C\'.  And now when we upgrade from lxml 4 to 5, data_in is again\n+        # unchanged after converting.  So let\'s accept both.\n+        result = self.doConvert(data_in)\n+        self.assertIn(result, (data_in, data_out))\n \n     def test_39(self):\n         data_in = """<a href="&#42;&Ascr;\\xa9"></a>"""\n'

Repository: Products.PortalTransforms


Branch: refs/heads/master
Date: 2024-04-24T20:49:48+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.PortalTransforms/commit/8fe2a57169a0c40bbe51b504f88fc19615098bfa

Merge pull request #62 from plone/maurits-lxml-html-clean-package

Use Cleaner from new package lxml_html_clean.

Files changed:
A news/3938.bugfix
M Products/PortalTransforms/tests/test_xss.py
M Products/PortalTransforms/transforms/safe_html.py
M setup.py

b'diff --git a/Products/PortalTransforms/tests/test_xss.py b/Products/PortalTransforms/tests/test_xss.py\nindex 6f8859d..9c30920 100644\n--- a/Products/PortalTransforms/tests/test_xss.py\n+++ b/Products/PortalTransforms/tests/test_xss.py\n@@ -251,7 +251,12 @@ def test_38(self):\n             """<p><a href="http://T\\\\foo\\\\20111015\\\\bar.msg">FOO</a></p>"""  # noqa\n         )\n         data_out = """<p><a href="http://T%5Cfoo%5C20111015%5Cbar.msg">FOO</a></p>"""\n-        self.doTest(data_in, data_out)\n+        # When we were still using lxml.xml, converting data_in gave data_in as anwer.\n+        # Then we switched to lxml.html, which caused the backslashes to be converted\n+        # into \'%5C\'.  And now when we upgrade from lxml 4 to 5, data_in is again\n+        # unchanged after converting.  So let\'s accept both.\n+        result = self.doConvert(data_in)\n+        self.assertIn(result, (data_in, data_out))\n \n     def test_39(self):\n         data_in = """<a href="&#42;&Ascr;\\xa9"></a>"""\ndiff --git a/Products/PortalTransforms/transforms/safe_html.py b/Products/PortalTransforms/transforms/safe_html.py\nindex 1a50adc..787e7e1 100644\n--- a/Products/PortalTransforms/transforms/safe_html.py\n+++ b/Products/PortalTransforms/transforms/safe_html.py\n@@ -1,7 +1,7 @@\n from html.entities import html5 as html5entities\n from lxml import etree\n from lxml import html\n-from lxml.html.clean import Cleaner\n+from lxml_html_clean import Cleaner\n from plone.base.interfaces import IFilterSchema\n from plone.base.utils import safe_bytes\n from plone.registry.interfaces import IRegistry\ndiff --git a/news/3938.bugfix b/news/3938.bugfix\nnew file mode 100644\nindex 0000000..760f749\n--- /dev/null\n+++ b/news/3938.bugfix\n@@ -0,0 +1,4 @@\n+Use ``Cleaner`` from new package ``lxml_html_clean``.\n+This was factored out from ``lxml`` in version 5.2.0.\n+See https://lxml-html-clean.readthedocs.io/\n+[maurits]\ndiff --git a/setup.py b/setup.py\nindex 30d1ec7..3387f41 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -55,6 +55,7 @@\n         "Products.GenericSetup",\n         "setuptools",\n         "lxml",\n+        "lxml_html_clean",\n         "persistent",\n         "plone.base",\n         "plone.registry",\n'

