Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-26T11:39:03Z
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/4b3cfef6116f8ded1816619c87977a9184932f5a

Allow including js in head section

Files changed:
A news/3931.feature
A plone/app/layout/analytics/view_head.pt
M plone/app/layout/analytics/configure.zcml
M plone/app/layout/analytics/tests/analytics.txt
M plone/app/layout/analytics/view.py

b'diff --git a/news/3931.feature b/news/3931.feature\nnew file mode 100644\nindex 00000000..11d20f5a\n--- /dev/null\n+++ b/news/3931.feature\n@@ -0,0 +1,7 @@\n+3931.feature javascripts in head section\n+----------------------------------------\n+\n+- Add a field webstats_head_js to the Site controlpanel and render it\'s\n+  contents in the head section using IScripts viewlet manager.\n+  [jladage]\n+\ndiff --git a/plone/app/layout/analytics/configure.zcml b/plone/app/layout/analytics/configure.zcml\nindex dc599351..20ff958a 100644\n--- a/plone/app/layout/analytics/configure.zcml\n+++ b/plone/app/layout/analytics/configure.zcml\n@@ -3,6 +3,13 @@\n     xmlns:browser="http://namespaces.zope.org/browser"\n     >\n \n+  <browser:viewlet\n+      name="plone.analytics.head"\n+      manager="plone.app.layout.viewlets.interfaces.IScripts"\n+      class=".view.AnalyticsHeadViewlet"\n+      permission="zope2.View"\n+      />\n+\n   <browser:viewlet\n       name="plone.analytics"\n       manager="plone.app.layout.viewlets.interfaces.IPortalFooter"\ndiff --git a/plone/app/layout/analytics/tests/analytics.txt b/plone/app/layout/analytics/tests/analytics.txt\nindex 4826dda2..fe5c35d7 100644\n--- a/plone/app/layout/analytics/tests/analytics.txt\n+++ b/plone/app/layout/analytics/tests/analytics.txt\n@@ -5,7 +5,7 @@ We need a view on the content.\n     >>> from zope.publisher.browser import BrowserView\n     >>> view = BrowserView(portal, request)\n \n-    >>> from plone.app.layout.viewlets.interfaces import IPortalFooter\n+    >>> from plone.app.layout.viewlets.interfaces import IScripts, IPortalFooter\n     >>> from Products.Five.viewlet.manager import ViewletManager\n     >>> Footer = ViewletManager(\'left\', IPortalFooter)\n \n@@ -48,3 +48,46 @@ Now enter some non-ascii text\n     >>> text = manager.render()\n     >>> site_settings.webstats_js in text\n     True\n+\n+Now create a \n+    >>> Header = ViewletManager(\'left\', IScripts)\n+\n+Now we can instantiate the manager.\n+\n+    >>> manager = Header(portal, request, view)\n+    >>> manager.update()\n+    >>> for viewlet in manager.viewlets:\n+    ...     if viewlet.__name__ == "plone.analytics.head":\n+    ...         analytics = viewlet\n+    ...         break\n+\n+When no analytics (webstats_head_js) code is set up the viewlet will not be rendered:\n+\n+    >>> analytics.webstats_head_js == u""\n+    True\n+    >>> text = manager.render()\n+    >>> \'plone.analytics.head goes here\' in text\n+    False\n+\n+Set the analytics code through the controlpanel and verify it renders properly:\n+\n+    >>> from plone.registry.interfaces import IRegistry\n+    >>> from zope.component import getUtility\n+    >>> from plone.base.interfaces import ISiteSchema\n+    >>> registry = getUtility(IRegistry)\n+    >>> site_settings = registry.forInterface(ISiteSchema, prefix="plone")\n+    >>> site_settings.webstats_head_js = u"<script>window.title=\'Hello\'</script>"\n+    >>> analytics.webstats_head_js == site_settings.webstats_head_js\n+    True\n+    >>> text = manager.render()\n+    >>> \'plone.analytics.head goes here\' in text\n+    True\n+    >>> site_settings.webstats_head_js in text\n+    True\n+\n+Now enter some non-ascii text\n+\n+    >>> site_settings.webstats_head_js = u"<script>window.title=\'C\\xedsa\\u0159\'</script>"\n+    >>> text = manager.render()\n+    >>> site_settings.webstats_head_js in text\n+    True\ndiff --git a/plone/app/layout/analytics/view.py b/plone/app/layout/analytics/view.py\nindex c277714d..d2f8ad46 100644\n--- a/plone/app/layout/analytics/view.py\n+++ b/plone/app/layout/analytics/view.py\n@@ -29,3 +29,27 @@ def webstats_js(self):\n     def update(self):\n         """The viewlet manager _updateViewlets requires this method"""\n         pass\n+\n+\n+@implementer(IViewlet)\n+class AnalyticsHeadViewlet(BrowserView):\n+    render = ViewPageTemplateFile("view_head.pt")\n+\n+    def __init__(self, context, request, view, manager):\n+        super().__init__(context, request)\n+        self.__parent__ = view\n+        self.view = view\n+        self.manager = manager\n+\n+    @property\n+    def webstats_head_js(self):\n+        registry = getUtility(IRegistry)\n+        site_settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)\n+        try:\n+            return site_settings.webstats_head_js or ""\n+        except AttributeError:\n+            return ""\n+\n+    def update(self):\n+        """The viewlet manager _updateViewlets requires this method"""\n+        pass\ndiff --git a/plone/app/layout/analytics/view_head.pt b/plone/app/layout/analytics/view_head.pt\nnew file mode 100644\nindex 00000000..7e71b1ec\n--- /dev/null\n+++ b/plone/app/layout/analytics/view_head.pt\n@@ -0,0 +1,8 @@\n+<div tal:define="webstats_head_js view/webstats_head_js"\n+     tal:condition="webstats_head_js"\n+     tal:omit-tag="">\n+<!-- plone.analytics.head goes here-->\n+<span tal:replace="structure webstats_head_js">\n+  Here goes the webstats_head_js\n+</span>\n+</div>\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-26T16:34:20+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.layout/commit/be96cd27aa58c34164611ffda93a5ac9d30d9ea2

Prevent KeyError getting ISiteSchema when not all records exist yet.

We need to run an upgrade step to define the new `webstats_head_js` field, but it would be nice if the UI looks reasonable before this.
Various viewlets give:

KeyError: 'Interface `plone.base.interfaces.controlpanel.ISiteSchema` defines a field `webstats_head_js`, for which there is no record.'

Files changed:
M plone/app/layout/links/viewlets.py
M plone/app/layout/viewlets/content.py

b'diff --git a/plone/app/layout/links/viewlets.py b/plone/app/layout/links/viewlets.py\nindex 5d12762d..4be24c2d 100644\n--- a/plone/app/layout/links/viewlets.py\n+++ b/plone/app/layout/links/viewlets.py\n@@ -42,7 +42,11 @@ class FaviconViewlet(ViewletBase):\n \n     def init_favicon(self) -> NoReturn:\n         registry = getUtility(IRegistry)\n-        settings: ISiteSchema = registry.forInterface(ISiteSchema, prefix="plone")\n+        settings: ISiteSchema = registry.forInterface(\n+            ISiteSchema,\n+            prefix="plone",\n+            check=False,\n+        )\n         self.mimetype: str = getattr(\n             settings, "site_favicon_mimetype", "image/vnd.microsoft.icon"\n         )\ndiff --git a/plone/app/layout/viewlets/content.py b/plone/app/layout/viewlets/content.py\nindex 785c8c04..ef4b3fbf 100644\n--- a/plone/app/layout/viewlets/content.py\n+++ b/plone/app/layout/viewlets/content.py\n@@ -70,6 +70,7 @@ def show(self):\n         settings = registry.forInterface(\n             ISiteSchema,\n             prefix="plone",\n+            check=False,\n         )\n         return not self.anonymous or settings.display_publication_date_in_byline\n \n@@ -145,7 +146,7 @@ def pub_date(self):\n         """\n         # check if we are allowed to display publication date\n         registry = getUtility(IRegistry)\n-        settings = registry.forInterface(ISiteSchema, prefix="plone")\n+        settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)\n \n         if not settings.display_publication_date_in_byline:\n             return None\n@@ -281,7 +282,7 @@ def pub_date(self):\n         """\n         # check if we are allowed to display publication date\n         registry = getUtility(IRegistry)\n-        settings = registry.forInterface(ISiteSchema, prefix="plone")\n+        settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)\n \n         if not settings.display_publication_date_in_byline:\n             return None\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-26T16:34:20+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.layout/commit/9a0c1b6e8bfa49f945f6f470839a338ed3d21ea8

Improve news snippet.

Files changed:
M news/3931.feature

b"diff --git a/news/3931.feature b/news/3931.feature\nindex 11d20f5a..709da786 100644\n--- a/news/3931.feature\n+++ b/news/3931.feature\n@@ -1,7 +1,6 @@\n-3931.feature javascripts in head section\n-----------------------------------------\n-\n-- Add a field webstats_head_js to the Site controlpanel and render it's\n-  contents in the head section using IScripts viewlet manager.\n-  [jladage]\n+Add a field ``webstats_head_js`` to the Site controlpanel and render its\n+contents in the head section using ``IScripts`` viewlet manager.\n+See `issue 3931 <https://github.com/plone/Products.CMFPlone/issues/3931>`_:\n+some javascript needs to be loaded at the bottom of the page, and some in the head section.\n+[jladage]\n \n"

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-26T17:03:58+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.layout/commit/cdffe7cdb8025e6d29bc305fbc180e5729844a98

Let the AnalyticsHeadViewlet inherit from the AnalyticsViewlet so we have shorter code.

Files changed:
M plone/app/layout/analytics/tests/analytics.txt
M plone/app/layout/analytics/view.py
M plone/app/layout/analytics/view_head.pt

b'diff --git a/plone/app/layout/analytics/tests/analytics.txt b/plone/app/layout/analytics/tests/analytics.txt\nindex fe5c35d7..4358a4fd 100644\n--- a/plone/app/layout/analytics/tests/analytics.txt\n+++ b/plone/app/layout/analytics/tests/analytics.txt\n@@ -20,7 +20,7 @@ Now we can instantiate the manager.\n \n When no analytics (webstats_js) code is set up the viewlet will not be rendered:\n \n-    >>> analytics.webstats_js == u""\n+    >>> analytics.webstats_js == ""\n     True\n     >>> text = manager.render()\n     >>> \'id="plone-analytics"\' in text\n@@ -49,11 +49,9 @@ Now enter some non-ascii text\n     >>> site_settings.webstats_js in text\n     True\n \n-Now create a \n-    >>> Header = ViewletManager(\'left\', IScripts)\n-\n-Now we can instantiate the manager.\n+Now instantiate a viewlet manager for the header.\n \n+    >>> Header = ViewletManager(\'left\', IScripts)\n     >>> manager = Header(portal, request, view)\n     >>> manager.update()\n     >>> for viewlet in manager.viewlets:\n@@ -63,7 +61,7 @@ Now we can instantiate the manager.\n \n When no analytics (webstats_head_js) code is set up the viewlet will not be rendered:\n \n-    >>> analytics.webstats_head_js == u""\n+    >>> analytics.webstats_js == ""\n     True\n     >>> text = manager.render()\n     >>> \'plone.analytics.head goes here\' in text\n@@ -77,7 +75,7 @@ Set the analytics code through the controlpanel and verify it renders properly:\n     >>> registry = getUtility(IRegistry)\n     >>> site_settings = registry.forInterface(ISiteSchema, prefix="plone")\n     >>> site_settings.webstats_head_js = u"<script>window.title=\'Hello\'</script>"\n-    >>> analytics.webstats_head_js == site_settings.webstats_head_js\n+    >>> analytics.webstats_js == site_settings.webstats_head_js\n     True\n     >>> text = manager.render()\n     >>> \'plone.analytics.head goes here\' in text\ndiff --git a/plone/app/layout/analytics/view.py b/plone/app/layout/analytics/view.py\nindex d2f8ad46..0f33c6bd 100644\n--- a/plone/app/layout/analytics/view.py\n+++ b/plone/app/layout/analytics/view.py\n@@ -10,6 +10,7 @@\n @implementer(IViewlet)\n class AnalyticsViewlet(BrowserView):\n     render = ViewPageTemplateFile("view.pt")\n+    record_name = "webstats_js"\n \n     def __init__(self, context, request, view, manager):\n         super().__init__(context, request)\n@@ -21,10 +22,7 @@ def __init__(self, context, request, view, manager):\n     def webstats_js(self):\n         registry = getUtility(IRegistry)\n         site_settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)\n-        try:\n-            return site_settings.webstats_js or ""\n-        except AttributeError:\n-            return ""\n+        return getattr(site_settings, self.record_name, "")\n \n     def update(self):\n         """The viewlet manager _updateViewlets requires this method"""\n@@ -32,24 +30,6 @@ def update(self):\n \n \n @implementer(IViewlet)\n-class AnalyticsHeadViewlet(BrowserView):\n+class AnalyticsHeadViewlet(AnalyticsViewlet):\n     render = ViewPageTemplateFile("view_head.pt")\n-\n-    def __init__(self, context, request, view, manager):\n-        super().__init__(context, request)\n-        self.__parent__ = view\n-        self.view = view\n-        self.manager = manager\n-\n-    @property\n-    def webstats_head_js(self):\n-        registry = getUtility(IRegistry)\n-        site_settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)\n-        try:\n-            return site_settings.webstats_head_js or ""\n-        except AttributeError:\n-            return ""\n-\n-    def update(self):\n-        """The viewlet manager _updateViewlets requires this method"""\n-        pass\n+    record_name = "webstats_head_js"\ndiff --git a/plone/app/layout/analytics/view_head.pt b/plone/app/layout/analytics/view_head.pt\nindex 7e71b1ec..c51a58d1 100644\n--- a/plone/app/layout/analytics/view_head.pt\n+++ b/plone/app/layout/analytics/view_head.pt\n@@ -1,8 +1,9 @@\n-<div tal:define="webstats_head_js view/webstats_head_js"\n+<div tal:define="\n+       webstats_head_js view/webstats_js;\n+     "\n      tal:condition="webstats_head_js"\n-     tal:omit-tag="">\n-<!-- plone.analytics.head goes here-->\n-<span tal:replace="structure webstats_head_js">\n-  Here goes the webstats_head_js\n-</span>\n+     tal:omit-tag=""\n+>\n+  <!-- plone.analytics.head goes here -->\n+  <span tal:replace="structure webstats_head_js"></span>\n </div>\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-28T11:48:05+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.layout/commit/105bef7ff142d50a85c746cb6fbf0b96f1c5a777

zpretty

Files changed:
M plone/app/layout/viewlets/document_byline.pt

b'diff --git a/plone/app/layout/viewlets/document_byline.pt b/plone/app/layout/viewlets/document_byline.pt\nindex 1a4fdb98..6539d981 100644\n--- a/plone/app/layout/viewlets/document_byline.pt\n+++ b/plone/app/layout/viewlets/document_byline.pt\n@@ -1,23 +1,27 @@\n <section id="section-byline"\n-  tal:condition="view/show"\n-  i18n:domain="plone">\n+         tal:condition="view/show"\n+         i18n:domain="plone"\n+>\n   <tal:creators tal:define="\n                   creator_ids here/creators;\n                   navigation_root_url context/@@plone_portal_state/navigation_root_url;\n                 "\n-    tal:condition="python:creator_ids and view.show_about()">\n+                tal:condition="python:creator_ids and view.show_about()"\n+  >\n     <span class="label-by-author">\n       <tal:i18n i18n:translate="">by</tal:i18n>\n       <tal:for repeat="user_id creator_ids">\n         <tal:user define="\n-                  url_path python: view.get_url_path(user_id);\n-                  fullname python:view.get_fullname(user_id);\n-                ">\n+                    url_path python: view.get_url_path(user_id);\n+                    fullname python:view.get_fullname(user_id);\n+                  ">\n           <a class="badge rounded-pill bg-light text-dark fw-normal fs-6"\n-            href="${navigation_root_url}/${url_path}"\n-            tal:condition="url_path">${fullname}</a>\n+             href="${navigation_root_url}/${url_path}"\n+             tal:condition="url_path"\n+          >${fullname}</a>\n           <span class="badge rounded-pill bg-light text-dark fw-normal fs-6"\n-            tal:condition="not:url_path">${fullname}</span>\n+                tal:condition="not:url_path"\n+          >${fullname}</span>\n         </tal:user>\n       </tal:for>\n     &mdash;\n@@ -30,14 +34,16 @@\n                show_modification_date python:view.show_modification_date();\n              ">\n     <span class="documentPublished"\n-      tal:condition="published">\n+          tal:condition="published"\n+    >\n       <span i18n:translate="box_published">published</span>\n       <span tal:content="python:context.toLocalizedTime(published)">Published</span>\n       <tal:sep condition="show_modification_date">,</tal:sep>\n     </span>\n \n     <span class="documentModified"\n-      tal:condition="show_modification_date">\n+          tal:condition="show_modification_date"\n+    >\n       <span i18n:translate="box_last_modified">\n       last modified\n       </span>\n@@ -50,7 +56,8 @@\n   <tal:expired tal:condition="view/isExpired">\n     &mdash;\n     <span class="state-expired"\n-      i18n:translate="time_expired">expired</span>\n+          i18n:translate="time_expired"\n+    >expired</span>\n   </tal:expired>\n \n </section>\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-28T11:14:46Z
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/276c66ec0e80c7f9875dcdcb3dc72d4c445703c0

Use IHtmlHeadLinks viewlet provider to assure being the last script tag in the head section.

Files changed:
M plone/app/layout/analytics/configure.zcml

b'diff --git a/plone/app/layout/analytics/configure.zcml b/plone/app/layout/analytics/configure.zcml\nindex 20ff958a..4efb3be9 100644\n--- a/plone/app/layout/analytics/configure.zcml\n+++ b/plone/app/layout/analytics/configure.zcml\n@@ -5,7 +5,7 @@\n \n   <browser:viewlet\n       name="plone.analytics.head"\n-      manager="plone.app.layout.viewlets.interfaces.IScripts"\n+      manager="plone.app.layout.viewlets.interfaces.IHtmlHeadLinks"\n       class=".view.AnalyticsHeadViewlet"\n       permission="zope2.View"\n       />\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-28T11:22:32Z
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/4bd740e0a890702692ec842150cf5268d82a134c

Fix tests

Files changed:
M plone/app/layout/analytics/tests/analytics.txt

b"diff --git a/plone/app/layout/analytics/tests/analytics.txt b/plone/app/layout/analytics/tests/analytics.txt\nindex 4358a4fd..7fb79e10 100644\n--- a/plone/app/layout/analytics/tests/analytics.txt\n+++ b/plone/app/layout/analytics/tests/analytics.txt\n@@ -5,7 +5,7 @@ We need a view on the content.\n     >>> from zope.publisher.browser import BrowserView\n     >>> view = BrowserView(portal, request)\n \n-    >>> from plone.app.layout.viewlets.interfaces import IScripts, IPortalFooter\n+    >>> from plone.app.layout.viewlets.interfaces import IHtmlHeadLinks, IPortalFooter\n     >>> from Products.Five.viewlet.manager import ViewletManager\n     >>> Footer = ViewletManager('left', IPortalFooter)\n \n@@ -51,7 +51,7 @@ Now enter some non-ascii text\n \n Now instantiate a viewlet manager for the header.\n \n-    >>> Header = ViewletManager('left', IScripts)\n+    >>> Header = ViewletManager('left', IHtmlHeadLinks)\n     >>> manager = Header(portal, request, view)\n     >>> manager.update()\n     >>> for viewlet in manager.viewlets:\n"

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-28T13:15:24Z
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/f1fdfa9cbaef2689cbac0785f59ef96186a872e1

Update changelog entry to refer to correct viewlet manager.

Files changed:
M news/3931.feature

b'diff --git a/news/3931.feature b/news/3931.feature\nindex 709da786..d0d8beb5 100644\n--- a/news/3931.feature\n+++ b/news/3931.feature\n@@ -1,5 +1,5 @@\n Add a field ``webstats_head_js`` to the Site controlpanel and render its\n-contents in the head section using ``IScripts`` viewlet manager.\n+contents in the head section using ``IHtmlHeadLinks`` viewlet manager.\n See `issue 3931 <https://github.com/plone/Products.CMFPlone/issues/3931>`_:\n some javascript needs to be loaded at the bottom of the page, and some in the head section.\n [jladage]\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-28T13:25:02Z
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/677fccab1dd96758a60a468cfb8fb7d86d8db2e4

Fix tests

Files changed:
M plone/app/layout/analytics/tests/analytics.txt

b'diff --git a/plone/app/layout/analytics/tests/analytics.txt b/plone/app/layout/analytics/tests/analytics.txt\nindex 7fb79e10..0738d580 100644\n--- a/plone/app/layout/analytics/tests/analytics.txt\n+++ b/plone/app/layout/analytics/tests/analytics.txt\n@@ -75,8 +75,6 @@ Set the analytics code through the controlpanel and verify it renders properly:\n     >>> registry = getUtility(IRegistry)\n     >>> site_settings = registry.forInterface(ISiteSchema, prefix="plone")\n     >>> site_settings.webstats_head_js = u"<script>window.title=\'Hello\'</script>"\n-    >>> analytics.webstats_js == site_settings.webstats_head_js\n-    True\n     >>> text = manager.render()\n     >>> \'plone.analytics.head goes here\' in text\n     True\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-28T19:57:29Z
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/70283a21732c25f390d4aa651313218d78a978fc

Fix tests

Files changed:
M plone/app/layout/analytics/tests/analytics.txt

b'diff --git a/plone/app/layout/analytics/tests/analytics.txt b/plone/app/layout/analytics/tests/analytics.txt\nindex 0738d580..7fb79e10 100644\n--- a/plone/app/layout/analytics/tests/analytics.txt\n+++ b/plone/app/layout/analytics/tests/analytics.txt\n@@ -75,6 +75,8 @@ Set the analytics code through the controlpanel and verify it renders properly:\n     >>> registry = getUtility(IRegistry)\n     >>> site_settings = registry.forInterface(ISiteSchema, prefix="plone")\n     >>> site_settings.webstats_head_js = u"<script>window.title=\'Hello\'</script>"\n+    >>> analytics.webstats_js == site_settings.webstats_head_js\n+    True\n     >>> text = manager.render()\n     >>> \'plone.analytics.head goes here\' in text\n     True\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-28T20:04:53Z
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/63e1655977df317126a43cb51905afec10a2342f

Fix tests, hopefully ci likes it now.

Files changed:
M plone/app/layout/analytics/tests/analytics.txt

b'diff --git a/plone/app/layout/analytics/tests/analytics.txt b/plone/app/layout/analytics/tests/analytics.txt\nindex 7fb79e10..4ff7d2d5 100644\n--- a/plone/app/layout/analytics/tests/analytics.txt\n+++ b/plone/app/layout/analytics/tests/analytics.txt\n@@ -56,12 +56,12 @@ Now instantiate a viewlet manager for the header.\n     >>> manager.update()\n     >>> for viewlet in manager.viewlets:\n     ...     if viewlet.__name__ == "plone.analytics.head":\n-    ...         analytics = viewlet\n+    ...         analytics_head = viewlet\n     ...         break\n \n When no analytics (webstats_head_js) code is set up the viewlet will not be rendered:\n \n-    >>> analytics.webstats_js == ""\n+    >>> analytics_head.webstats_js == ""\n     True\n     >>> text = manager.render()\n     >>> \'plone.analytics.head goes here\' in text\n@@ -75,7 +75,7 @@ Set the analytics code through the controlpanel and verify it renders properly:\n     >>> registry = getUtility(IRegistry)\n     >>> site_settings = registry.forInterface(ISiteSchema, prefix="plone")\n     >>> site_settings.webstats_head_js = u"<script>window.title=\'Hello\'</script>"\n-    >>> analytics.webstats_js == site_settings.webstats_head_js\n+    >>> analytics_head.webstats_js == site_settings.webstats_head_js\n     True\n     >>> text = manager.render()\n     >>> \'plone.analytics.head goes here\' in text\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-30T14:04:51Z
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/a95f03dadb171004a74c621be236a77a308da072

Improve security by filtering all but script tags.

Files changed:
M news/3931.feature
M plone/app/layout/analytics/tests/analytics.txt
M plone/app/layout/analytics/view.py

b'diff --git a/news/3931.feature b/news/3931.feature\nindex d0d8beb5..a547c607 100644\n--- a/news/3931.feature\n+++ b/news/3931.feature\n@@ -2,5 +2,6 @@ Add a field ``webstats_head_js`` to the Site controlpanel and render its\n contents in the head section using ``IHtmlHeadLinks`` viewlet manager.\n See `issue 3931 <https://github.com/plone/Products.CMFPlone/issues/3931>`_:\n some javascript needs to be loaded at the bottom of the page, and some in the head section.\n+Improved security by rendering only <script>-tags, all other tags are filtered out.\n [jladage]\n \ndiff --git a/plone/app/layout/analytics/tests/analytics.txt b/plone/app/layout/analytics/tests/analytics.txt\nindex 4ff7d2d5..fb9ce43c 100644\n--- a/plone/app/layout/analytics/tests/analytics.txt\n+++ b/plone/app/layout/analytics/tests/analytics.txt\n@@ -46,7 +46,7 @@ Now enter some non-ascii text\n \n     >>> site_settings.webstats_js = u"<script>window.title=\'C\\xedsa\\u0159\'</script>"\n     >>> text = manager.render()\n-    >>> site_settings.webstats_js in text\n+    >>> "<script>window.title=\'C\xc3\xadsa\xc5\x99\'</script>" in text\n     True\n \n Now instantiate a viewlet manager for the header.\n@@ -83,9 +83,22 @@ Set the analytics code through the controlpanel and verify it renders properly:\n     >>> site_settings.webstats_head_js in text\n     True\n \n-Now enter some non-ascii text\n+If we add other tags than script tags, we only render the script tags.\n \n-    >>> site_settings.webstats_head_js = u"<script>window.title=\'C\\xedsa\\u0159\'</script>"\n+    >>> site_settings.webstats_head_js = u"<script>window.title=\'Hello\'</script><link rel=\'stylesheet\' src=\'teststyle.css\'/>"\n     >>> text = manager.render()\n+    >>> "<link rel=\'stylesheet\' src=\'teststyle.css\'/>" in text\n+    False\n     >>> site_settings.webstats_head_js in text\n+    False\n+    >>> "<script>window.title=\'Hello\'</script>" in text\n     True\n+\n+Now enter some non-ascii text\n+\n+    >>> site_settings.webstats_head_js = u"<link rel=\'stylesheet\' src=\'teststyle.css\'></link><script>window.title=\'C\\xedsa\\u0159\'</script>"\n+    >>> text = manager.render()\n+    >>> "<link rel=\'stylesheet\' src=\'teststyle.css\'>" in text\n+    False\n+    >>> "<script>window.title=\'C\xc3\xadsa\xc5\x99\'</script>" in text\n+    True\n\\ No newline at end of file\ndiff --git a/plone/app/layout/analytics/view.py b/plone/app/layout/analytics/view.py\nindex 0f33c6bd..2bba0f48 100644\n--- a/plone/app/layout/analytics/view.py\n+++ b/plone/app/layout/analytics/view.py\n@@ -5,7 +5,7 @@\n from zope.component import getUtility\n from zope.interface import implementer\n from zope.viewlet.interfaces import IViewlet\n-\n+import lxml.html\n \n @implementer(IViewlet)\n class AnalyticsViewlet(BrowserView):\n@@ -22,7 +22,13 @@ def __init__(self, context, request, view, manager):\n     def webstats_js(self):\n         registry = getUtility(IRegistry)\n         site_settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)\n-        return getattr(site_settings, self.record_name, "")\n+        stats = getattr(site_settings, self.record_name, "")\n+        if stats != "":\n+            html = lxml.html.fromstring(stats)\n+            if html.xpath("//script"):\n+                script_tags = [lxml.html.tostring(tag, encoding=\'unicode\') for tag in html.xpath("//script")]\n+                return "\\n".join(script_tags)\n+        return ""\n \n     def update(self):\n         """The viewlet manager _updateViewlets requires this method"""\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-30T14:16:44Z
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/89f8167b60b7956a604af089625eec68f96336a1

Black fixes

Files changed:
M plone/app/layout/analytics/view.py

b'diff --git a/plone/app/layout/analytics/view.py b/plone/app/layout/analytics/view.py\nindex 2bba0f48..e1d6ba8c 100644\n--- a/plone/app/layout/analytics/view.py\n+++ b/plone/app/layout/analytics/view.py\n@@ -7,6 +7,7 @@\n from zope.viewlet.interfaces import IViewlet\n import lxml.html\n \n+\n @implementer(IViewlet)\n class AnalyticsViewlet(BrowserView):\n     render = ViewPageTemplateFile("view.pt")\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-30T14:24:13Z
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/15858c3cdc94e0aa590935648320931d10d96bcf

Change import to see it that fixes the dependencies problem

Files changed:
M plone/app/layout/analytics/view.py

b'diff --git a/plone/app/layout/analytics/view.py b/plone/app/layout/analytics/view.py\nindex e1d6ba8c..53cf2bfc 100644\n--- a/plone/app/layout/analytics/view.py\n+++ b/plone/app/layout/analytics/view.py\n@@ -5,7 +5,7 @@\n from zope.component import getUtility\n from zope.interface import implementer\n from zope.viewlet.interfaces import IViewlet\n-import lxml.html\n+from lxml import html as lxmlhtml\n \n \n @implementer(IViewlet)\n@@ -25,9 +25,9 @@ def webstats_js(self):\n         site_settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)\n         stats = getattr(site_settings, self.record_name, "")\n         if stats != "":\n-            html = lxml.html.fromstring(stats)\n+            html = lxmlhtml.fromstring(stats)\n             if html.xpath("//script"):\n-                script_tags = [lxml.html.tostring(tag, encoding=\'unicode\') for tag in html.xpath("//script")]\n+                script_tags = [lxmlhtml.tostring(tag, encoding=\'unicode\') for tag in html.xpath("//script")]\n                 return "\\n".join(script_tags)\n         return ""\n \n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-30T14:33:40Z
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/222066ac8d4f9a519b2eaaa6948acc6fb52adba1

Black fixes

Files changed:
M plone/app/layout/analytics/view.py

b'diff --git a/plone/app/layout/analytics/view.py b/plone/app/layout/analytics/view.py\nindex 53cf2bfc..de7de13a 100644\n--- a/plone/app/layout/analytics/view.py\n+++ b/plone/app/layout/analytics/view.py\n@@ -1,3 +1,4 @@\n+from lxml import html as lxmlhtml\n from plone.base.interfaces import ISiteSchema\n from plone.registry.interfaces import IRegistry\n from Products.Five.browser import BrowserView\n@@ -5,7 +6,6 @@\n from zope.component import getUtility\n from zope.interface import implementer\n from zope.viewlet.interfaces import IViewlet\n-from lxml import html as lxmlhtml\n \n \n @implementer(IViewlet)\n@@ -27,7 +27,10 @@ def webstats_js(self):\n         if stats != "":\n             html = lxmlhtml.fromstring(stats)\n             if html.xpath("//script"):\n-                script_tags = [lxmlhtml.tostring(tag, encoding=\'unicode\') for tag in html.xpath("//script")]\n+                script_tags = [\n+                    lxmlhtml.tostring(tag, encoding="unicode")\n+                    for tag in html.xpath("//script")\n+                ]\n                 return "\\n".join(script_tags)\n         return ""\n \n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-30T14:36:01Z
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/6fa0c7d51a70d9a80ea802853054eb0f6b1b876b

Add lxml to install_requires

Files changed:
M setup.py

b'diff --git a/setup.py b/setup.py\nindex 75db0a4b..01d157ed 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -59,6 +59,7 @@\n         "Products.ZCatalog",\n         "setuptools",\n         "Zope",\n+        "lxml"\n     ],\n     extras_require=dict(\n         test=[\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-30T14:39:37Z
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/1bf6c5a328891f0b9c7c3c3bed2dc50b1d2b329f

Add trailing comma to list, just to make black happy.

Files changed:
M setup.py

b'diff --git a/setup.py b/setup.py\nindex 01d157ed..d29892ba 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -59,7 +59,7 @@\n         "Products.ZCatalog",\n         "setuptools",\n         "Zope",\n-        "lxml"\n+        "lxml",\n     ],\n     extras_require=dict(\n         test=[\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-30T17:13:21Z
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/7bbd28a41b60d656bceff0aff5741677b94fc024

Use try/except in case someone puts in anything other than &lt;script&gt;-tags.

Files changed:
M plone/app/layout/analytics/view.py

b'diff --git a/plone/app/layout/analytics/view.py b/plone/app/layout/analytics/view.py\nindex de7de13a..0871af31 100644\n--- a/plone/app/layout/analytics/view.py\n+++ b/plone/app/layout/analytics/view.py\n@@ -24,9 +24,13 @@ def webstats_js(self):\n         registry = getUtility(IRegistry)\n         site_settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)\n         stats = getattr(site_settings, self.record_name, "")\n+        html = ""\n         if stats != "":\n-            html = lxmlhtml.fromstring(stats)\n-            if html.xpath("//script"):\n+            try:\n+                html = lxmlhtml.fromstring(stats)\n+            except Exception:\n+                return ""\n+            if html and html.xpath("//script"):\n                 script_tags = [\n                     lxmlhtml.tostring(tag, encoding="unicode")\n                     for tag in html.xpath("//script")\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-03-30T17:50:19Z
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/71178e4213e1e7cd1e314870f35eae64f47965cc

Position script even before all other javascripts.
Now using IHtmlHead viewlet manager.

Files changed:
M plone/app/layout/analytics/configure.zcml
M plone/app/layout/analytics/tests/analytics.txt
M plone/app/layout/analytics/view.py

b'diff --git a/plone/app/layout/analytics/configure.zcml b/plone/app/layout/analytics/configure.zcml\nindex 4efb3be9..0edd28cd 100644\n--- a/plone/app/layout/analytics/configure.zcml\n+++ b/plone/app/layout/analytics/configure.zcml\n@@ -5,7 +5,7 @@\n \n   <browser:viewlet\n       name="plone.analytics.head"\n-      manager="plone.app.layout.viewlets.interfaces.IHtmlHeadLinks"\n+      manager="plone.app.layout.viewlets.interfaces.IHtmlHead"\n       class=".view.AnalyticsHeadViewlet"\n       permission="zope2.View"\n       />\ndiff --git a/plone/app/layout/analytics/tests/analytics.txt b/plone/app/layout/analytics/tests/analytics.txt\nindex fb9ce43c..fb72c017 100644\n--- a/plone/app/layout/analytics/tests/analytics.txt\n+++ b/plone/app/layout/analytics/tests/analytics.txt\n@@ -5,7 +5,7 @@ We need a view on the content.\n     >>> from zope.publisher.browser import BrowserView\n     >>> view = BrowserView(portal, request)\n \n-    >>> from plone.app.layout.viewlets.interfaces import IHtmlHeadLinks, IPortalFooter\n+    >>> from plone.app.layout.viewlets.interfaces import IHtmlHead, IPortalFooter\n     >>> from Products.Five.viewlet.manager import ViewletManager\n     >>> Footer = ViewletManager(\'left\', IPortalFooter)\n \n@@ -51,8 +51,8 @@ Now enter some non-ascii text\n \n Now instantiate a viewlet manager for the header.\n \n-    >>> Header = ViewletManager(\'left\', IHtmlHeadLinks)\n-    >>> manager = Header(portal, request, view)\n+    >>> Head = ViewletManager(\'left\', IHtmlHead)\n+    >>> manager = Head(portal, request, view)\n     >>> manager.update()\n     >>> for viewlet in manager.viewlets:\n     ...     if viewlet.__name__ == "plone.analytics.head":\n@@ -101,4 +101,11 @@ Now enter some non-ascii text\n     >>> "<link rel=\'stylesheet\' src=\'teststyle.css\'>" in text\n     False\n     >>> "<script>window.title=\'C\xc3\xadsa\xc5\x99\'</script>" in text\n-    True\n\\ No newline at end of file\n+    True\n+\n+Final check, if we have bogus content in here, will things break?\n+\n+    >>> site_settings.webstats_head_js = u"console.log(\'Missing script tag\')"\n+    >>> text = manager.render()\n+    >>> "console.log(\'Missing script tag\')" in text\n+    False\n\\ No newline at end of file\ndiff --git a/plone/app/layout/analytics/view.py b/plone/app/layout/analytics/view.py\nindex 0871af31..12ff26e1 100644\n--- a/plone/app/layout/analytics/view.py\n+++ b/plone/app/layout/analytics/view.py\n@@ -30,7 +30,7 @@ def webstats_js(self):\n                 html = lxmlhtml.fromstring(stats)\n             except Exception:\n                 return ""\n-            if html and html.xpath("//script"):\n+            if html != "" and html.xpath("//script"):\n                 script_tags = [\n                     lxmlhtml.tostring(tag, encoding="unicode")\n                     for tag in html.xpath("//script")\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-04-02T19:22:16+01:00
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/5880d2ed9fc58dbcd1220ecc95af5d11985e13f4

Instead of returning only script tags, it now filters base and title tags and renders up the remaining tags.

Files changed:
M plone/app/layout/analytics/tests/analytics.txt
M plone/app/layout/analytics/view.py

b'diff --git a/plone/app/layout/analytics/tests/analytics.txt b/plone/app/layout/analytics/tests/analytics.txt\nindex fb72c017..7a7c4dd0 100644\n--- a/plone/app/layout/analytics/tests/analytics.txt\n+++ b/plone/app/layout/analytics/tests/analytics.txt\n@@ -94,11 +94,17 @@ If we add other tags than script tags, we only render the script tags.\n     >>> "<script>window.title=\'Hello\'</script>" in text\n     True\n \n-Now enter some non-ascii text\n+Now enter some tags we don\'t want to render, like a <base> and <title> tag,\n+since they should occur only once and is set by Plone. <style>, <script> and\n+<link> tags are allowed.\n \n-    >>> site_settings.webstats_head_js = u"<link rel=\'stylesheet\' src=\'teststyle.css\'></link><script>window.title=\'C\\xedsa\\u0159\'</script>"\n+    >>> site_settings.webstats_head_js = u"<base href=\'some-url\' /><title>Get\'s removed</title><link rel=\'stylesheet\' src=\'teststyle.css\' /><script>window.title=\'C\\xedsa\\u0159\'</script>"\n     >>> text = manager.render()\n-    >>> "<link rel=\'stylesheet\' src=\'teststyle.css\'>" in text\n+    >>> \'<link rel="stylesheet" src="teststyle.css">\' in text\n+    True\n+    >>> "<base href=\'some-url\'>" in text\n+    False\n+    >>> "<title>Get\'s removed</title>" in text\n     False\n     >>> "<script>window.title=\'C\xc3\xadsa\xc5\x99\'</script>" in text\n     True\ndiff --git a/plone/app/layout/analytics/view.py b/plone/app/layout/analytics/view.py\nindex 12ff26e1..79b3ebf5 100644\n--- a/plone/app/layout/analytics/view.py\n+++ b/plone/app/layout/analytics/view.py\n@@ -7,6 +7,8 @@\n from zope.interface import implementer\n from zope.viewlet.interfaces import IViewlet\n \n+UNWANTED_TAGS = ["base", "title"]\n+\n \n @implementer(IViewlet)\n class AnalyticsViewlet(BrowserView):\n@@ -27,15 +29,17 @@ def webstats_js(self):\n         html = ""\n         if stats != "":\n             try:\n-                html = lxmlhtml.fromstring(stats)\n+                html = lxmlhtml.fragment_fromstring(stats, create_parent=\'div\')\n             except Exception:\n                 return ""\n-            if html != "" and html.xpath("//script"):\n-                script_tags = [\n-                    lxmlhtml.tostring(tag, encoding="unicode")\n-                    for tag in html.xpath("//script")\n-                ]\n-                return "\\n".join(script_tags)\n+            if html != "":\n+                for tag in UNWANTED_TAGS:\n+                    bad_tags = html.xpath(f"//{tag}")\n+                    if bad_tags:\n+                        for bad_tag in bad_tags:\n+                            bad_tag.drop_tree() \n+\n+                return \'\\n\'.join(lxmlhtml.tostring(x, encoding="unicode") for x in html.iterchildren())\n         return ""\n \n     def update(self):\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-04-02T23:14:32+01:00
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/fc9b432d6307c2c4b5f926417a362ed71568e702

Black and spelling fixes

Files changed:
M plone/app/layout/analytics/tests/analytics.txt
M plone/app/layout/analytics/view.py

b'diff --git a/plone/app/layout/analytics/tests/analytics.txt b/plone/app/layout/analytics/tests/analytics.txt\nindex 7a7c4dd0..08ddc088 100644\n--- a/plone/app/layout/analytics/tests/analytics.txt\n+++ b/plone/app/layout/analytics/tests/analytics.txt\n@@ -98,13 +98,13 @@ Now enter some tags we don\'t want to render, like a <base> and <title> tag,\n since they should occur only once and is set by Plone. <style>, <script> and\n <link> tags are allowed.\n \n-    >>> site_settings.webstats_head_js = u"<base href=\'some-url\' /><title>Get\'s removed</title><link rel=\'stylesheet\' src=\'teststyle.css\' /><script>window.title=\'C\\xedsa\\u0159\'</script>"\n+    >>> site_settings.webstats_head_js = u"<base href=\'some-url\' /><title>Gets removed</title><link rel=\'stylesheet\' src=\'teststyle.css\' /><script>window.title=\'C\\xedsa\\u0159\'</script>"\n     >>> text = manager.render()\n     >>> \'<link rel="stylesheet" src="teststyle.css">\' in text\n     True\n     >>> "<base href=\'some-url\'>" in text\n     False\n-    >>> "<title>Get\'s removed</title>" in text\n+    >>> "<title>Gets removed</title>" in text\n     False\n     >>> "<script>window.title=\'C\xc3\xadsa\xc5\x99\'</script>" in text\n     True\n@@ -114,4 +114,4 @@ Final check, if we have bogus content in here, will things break?\n     >>> site_settings.webstats_head_js = u"console.log(\'Missing script tag\')"\n     >>> text = manager.render()\n     >>> "console.log(\'Missing script tag\')" in text\n-    False\n\\ No newline at end of file\n+    False\ndiff --git a/plone/app/layout/analytics/view.py b/plone/app/layout/analytics/view.py\nindex 79b3ebf5..8bc57025 100644\n--- a/plone/app/layout/analytics/view.py\n+++ b/plone/app/layout/analytics/view.py\n@@ -7,6 +7,7 @@\n from zope.interface import implementer\n from zope.viewlet.interfaces import IViewlet\n \n+\n UNWANTED_TAGS = ["base", "title"]\n \n \n@@ -29,7 +30,7 @@ def webstats_js(self):\n         html = ""\n         if stats != "":\n             try:\n-                html = lxmlhtml.fragment_fromstring(stats, create_parent=\'div\')\n+                html = lxmlhtml.fragment_fromstring(stats, create_parent="div")\n             except Exception:\n                 return ""\n             if html != "":\n@@ -37,9 +38,12 @@ def webstats_js(self):\n                     bad_tags = html.xpath(f"//{tag}")\n                     if bad_tags:\n                         for bad_tag in bad_tags:\n-                            bad_tag.drop_tree() \n+                            bad_tag.drop_tree()\n \n-                return \'\\n\'.join(lxmlhtml.tostring(x, encoding="unicode") for x in html.iterchildren())\n+                return "\\n".join(\n+                    lxmlhtml.tostring(x, encoding="unicode")\n+                    for x in html.iterchildren()\n+                )\n         return ""\n \n     def update(self):\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-04-04T18:19:17+01:00
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/c240ea1b2585aee585a87d1bf24c5ce0866028a9

Update Changlog entry to reflect new changes.

Files changed:
M news/3931.feature

b'diff --git a/news/3931.feature b/news/3931.feature\nindex a547c607..078748e3 100644\n--- a/news/3931.feature\n+++ b/news/3931.feature\n@@ -2,6 +2,7 @@ Add a field ``webstats_head_js`` to the Site controlpanel and render its\n contents in the head section using ``IHtmlHeadLinks`` viewlet manager.\n See `issue 3931 <https://github.com/plone/Products.CMFPlone/issues/3931>`_:\n some javascript needs to be loaded at the bottom of the page, and some in the head section.\n-Improved security by rendering only <script>-tags, all other tags are filtered out.\n+Fool proofing by filering out <base>-tags, <title>-tags and rendering valid html for the\n+remaining tags.\n [jladage]\n \n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-04-04T18:43:14+01:00
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/82da26978b1bfc1a0317fbbf8d712b1a42b3b95a

Reduce number of xpath queries.

Files changed:
M plone/app/layout/analytics/view.py

b'diff --git a/plone/app/layout/analytics/view.py b/plone/app/layout/analytics/view.py\nindex 8bc57025..a5813f1d 100644\n--- a/plone/app/layout/analytics/view.py\n+++ b/plone/app/layout/analytics/view.py\n@@ -33,17 +33,16 @@ def webstats_js(self):\n                 html = lxmlhtml.fragment_fromstring(stats, create_parent="div")\n             except Exception:\n                 return ""\n-            if html != "":\n-                for tag in UNWANTED_TAGS:\n-                    bad_tags = html.xpath(f"//{tag}")\n-                    if bad_tags:\n-                        for bad_tag in bad_tags:\n-                            bad_tag.drop_tree()\n-\n-                return "\\n".join(\n-                    lxmlhtml.tostring(x, encoding="unicode")\n-                    for x in html.iterchildren()\n-                )\n+\n+            query = "| //".join(UNWANTED_TAGS)\n+            bad_tags = html.xpath(f"//{query}")\n+            if bad_tags:\n+                for bad_tag in bad_tags:\n+                    bad_tag.drop_tree()\n+            return "\\n".join(\n+                lxmlhtml.tostring(x, encoding="unicode")\n+                for x in html.iterchildren()\n+            )\n         return ""\n \n     def update(self):\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-04-04T18:49:01+01:00
Author: Jean-Paul Ladage (jladage) <j.ladage@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/a3f6c8a73bc1d4517bac3f80ec3a1088dc3c3238

Black code fixes

Files changed:
M plone/app/layout/analytics/view.py

b'diff --git a/plone/app/layout/analytics/view.py b/plone/app/layout/analytics/view.py\nindex a5813f1d..34e741b8 100644\n--- a/plone/app/layout/analytics/view.py\n+++ b/plone/app/layout/analytics/view.py\n@@ -40,8 +40,7 @@ def webstats_js(self):\n                 for bad_tag in bad_tags:\n                     bad_tag.drop_tree()\n             return "\\n".join(\n-                lxmlhtml.tostring(x, encoding="unicode")\n-                for x in html.iterchildren()\n+                lxmlhtml.tostring(x, encoding="unicode") for x in html.iterchildren()\n             )\n         return ""\n \n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-04-23T09:49:19+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.layout/commit/c060d884da38ff6e13ad42c57d059c7d46a6319b

Do not filter webstats code with lxml.

Nice idea, but it would be better in a validator so it is done once.
We have not done that until now, so there is no hurry, but I do want this merged for a Plone release this week.

Files changed:
M news/3931.feature
M plone/app/layout/analytics/tests/analytics.txt
M plone/app/layout/analytics/view.py
M setup.py

b'diff --git a/news/3931.feature b/news/3931.feature\nindex 078748e3..d0d8beb5 100644\n--- a/news/3931.feature\n+++ b/news/3931.feature\n@@ -2,7 +2,5 @@ Add a field ``webstats_head_js`` to the Site controlpanel and render its\n contents in the head section using ``IHtmlHeadLinks`` viewlet manager.\n See `issue 3931 <https://github.com/plone/Products.CMFPlone/issues/3931>`_:\n some javascript needs to be loaded at the bottom of the page, and some in the head section.\n-Fool proofing by filering out <base>-tags, <title>-tags and rendering valid html for the\n-remaining tags.\n [jladage]\n \ndiff --git a/plone/app/layout/analytics/tests/analytics.txt b/plone/app/layout/analytics/tests/analytics.txt\nindex 08ddc088..3fb5265d 100644\n--- a/plone/app/layout/analytics/tests/analytics.txt\n+++ b/plone/app/layout/analytics/tests/analytics.txt\n@@ -82,36 +82,3 @@ Set the analytics code through the controlpanel and verify it renders properly:\n     True\n     >>> site_settings.webstats_head_js in text\n     True\n-\n-If we add other tags than script tags, we only render the script tags.\n-\n-    >>> site_settings.webstats_head_js = u"<script>window.title=\'Hello\'</script><link rel=\'stylesheet\' src=\'teststyle.css\'/>"\n-    >>> text = manager.render()\n-    >>> "<link rel=\'stylesheet\' src=\'teststyle.css\'/>" in text\n-    False\n-    >>> site_settings.webstats_head_js in text\n-    False\n-    >>> "<script>window.title=\'Hello\'</script>" in text\n-    True\n-\n-Now enter some tags we don\'t want to render, like a <base> and <title> tag,\n-since they should occur only once and is set by Plone. <style>, <script> and\n-<link> tags are allowed.\n-\n-    >>> site_settings.webstats_head_js = u"<base href=\'some-url\' /><title>Gets removed</title><link rel=\'stylesheet\' src=\'teststyle.css\' /><script>window.title=\'C\\xedsa\\u0159\'</script>"\n-    >>> text = manager.render()\n-    >>> \'<link rel="stylesheet" src="teststyle.css">\' in text\n-    True\n-    >>> "<base href=\'some-url\'>" in text\n-    False\n-    >>> "<title>Gets removed</title>" in text\n-    False\n-    >>> "<script>window.title=\'C\xc3\xadsa\xc5\x99\'</script>" in text\n-    True\n-\n-Final check, if we have bogus content in here, will things break?\n-\n-    >>> site_settings.webstats_head_js = u"console.log(\'Missing script tag\')"\n-    >>> text = manager.render()\n-    >>> "console.log(\'Missing script tag\')" in text\n-    False\ndiff --git a/plone/app/layout/analytics/view.py b/plone/app/layout/analytics/view.py\nindex 34e741b8..f34ad967 100644\n--- a/plone/app/layout/analytics/view.py\n+++ b/plone/app/layout/analytics/view.py\n@@ -1,4 +1,3 @@\n-from lxml import html as lxmlhtml\n from plone.base.interfaces import ISiteSchema\n from plone.registry.interfaces import IRegistry\n from Products.Five.browser import BrowserView\n@@ -26,23 +25,7 @@ def __init__(self, context, request, view, manager):\n     def webstats_js(self):\n         registry = getUtility(IRegistry)\n         site_settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)\n-        stats = getattr(site_settings, self.record_name, "")\n-        html = ""\n-        if stats != "":\n-            try:\n-                html = lxmlhtml.fragment_fromstring(stats, create_parent="div")\n-            except Exception:\n-                return ""\n-\n-            query = "| //".join(UNWANTED_TAGS)\n-            bad_tags = html.xpath(f"//{query}")\n-            if bad_tags:\n-                for bad_tag in bad_tags:\n-                    bad_tag.drop_tree()\n-            return "\\n".join(\n-                lxmlhtml.tostring(x, encoding="unicode") for x in html.iterchildren()\n-            )\n-        return ""\n+        return getattr(site_settings, self.record_name, "")\n \n     def update(self):\n         """The viewlet manager _updateViewlets requires this method"""\ndiff --git a/setup.py b/setup.py\nindex d29892ba..75db0a4b 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -59,7 +59,6 @@\n         "Products.ZCatalog",\n         "setuptools",\n         "Zope",\n-        "lxml",\n     ],\n     extras_require=dict(\n         test=[\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-04-23T09:51:29+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.layout/commit/a1fe14a2163a4dd53626b40966fc0f35b53e559c

Merge remote-tracking branch 'origin/master' into 3931.feature

Files changed:
M .pre-commit-config.yaml

b'diff --git a/.pre-commit-config.yaml b/.pre-commit-config.yaml\nindex 2bc9db59..53b09c2c 100644\n--- a/.pre-commit-config.yaml\n+++ b/.pre-commit-config.yaml\n@@ -7,7 +7,7 @@ ci:\n \n repos:\n -   repo: https://github.com/asottile/pyupgrade\n-    rev: v3.15.0\n+    rev: v3.15.2\n     hooks:\n     -   id: pyupgrade\n         args: [--py38-plus]\n@@ -16,7 +16,7 @@ repos:\n     hooks:\n     -   id: isort\n -   repo: https://github.com/psf/black\n-    rev: 24.1.1\n+    rev: 24.3.0\n     hooks:\n     -   id: black\n -   repo: https://github.com/collective/zpretty\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2024-04-23T16:59:08+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.layout/commit/91585c725e79f0c66f1c37d19ab082817dc19905

Merge pull request #361 from plone/3931.feature

3931.feature allow javascript to be inserted in head-section or at bottom of page.

Files changed:
A news/3931.feature
A plone/app/layout/analytics/view_head.pt
M plone/app/layout/analytics/configure.zcml
M plone/app/layout/analytics/tests/analytics.txt
M plone/app/layout/analytics/view.py
M plone/app/layout/links/viewlets.py
M plone/app/layout/viewlets/content.py

b'diff --git a/news/3931.feature b/news/3931.feature\nnew file mode 100644\nindex 00000000..d0d8beb5\n--- /dev/null\n+++ b/news/3931.feature\n@@ -0,0 +1,6 @@\n+Add a field ``webstats_head_js`` to the Site controlpanel and render its\n+contents in the head section using ``IHtmlHeadLinks`` viewlet manager.\n+See `issue 3931 <https://github.com/plone/Products.CMFPlone/issues/3931>`_:\n+some javascript needs to be loaded at the bottom of the page, and some in the head section.\n+[jladage]\n+\ndiff --git a/plone/app/layout/analytics/configure.zcml b/plone/app/layout/analytics/configure.zcml\nindex dc599351..0edd28cd 100644\n--- a/plone/app/layout/analytics/configure.zcml\n+++ b/plone/app/layout/analytics/configure.zcml\n@@ -3,6 +3,13 @@\n     xmlns:browser="http://namespaces.zope.org/browser"\n     >\n \n+  <browser:viewlet\n+      name="plone.analytics.head"\n+      manager="plone.app.layout.viewlets.interfaces.IHtmlHead"\n+      class=".view.AnalyticsHeadViewlet"\n+      permission="zope2.View"\n+      />\n+\n   <browser:viewlet\n       name="plone.analytics"\n       manager="plone.app.layout.viewlets.interfaces.IPortalFooter"\ndiff --git a/plone/app/layout/analytics/tests/analytics.txt b/plone/app/layout/analytics/tests/analytics.txt\nindex 4826dda2..3fb5265d 100644\n--- a/plone/app/layout/analytics/tests/analytics.txt\n+++ b/plone/app/layout/analytics/tests/analytics.txt\n@@ -5,7 +5,7 @@ We need a view on the content.\n     >>> from zope.publisher.browser import BrowserView\n     >>> view = BrowserView(portal, request)\n \n-    >>> from plone.app.layout.viewlets.interfaces import IPortalFooter\n+    >>> from plone.app.layout.viewlets.interfaces import IHtmlHead, IPortalFooter\n     >>> from Products.Five.viewlet.manager import ViewletManager\n     >>> Footer = ViewletManager(\'left\', IPortalFooter)\n \n@@ -20,7 +20,7 @@ Now we can instantiate the manager.\n \n When no analytics (webstats_js) code is set up the viewlet will not be rendered:\n \n-    >>> analytics.webstats_js == u""\n+    >>> analytics.webstats_js == ""\n     True\n     >>> text = manager.render()\n     >>> \'id="plone-analytics"\' in text\n@@ -46,5 +46,39 @@ Now enter some non-ascii text\n \n     >>> site_settings.webstats_js = u"<script>window.title=\'C\\xedsa\\u0159\'</script>"\n     >>> text = manager.render()\n-    >>> site_settings.webstats_js in text\n+    >>> "<script>window.title=\'C\xc3\xadsa\xc5\x99\'</script>" in text\n+    True\n+\n+Now instantiate a viewlet manager for the header.\n+\n+    >>> Head = ViewletManager(\'left\', IHtmlHead)\n+    >>> manager = Head(portal, request, view)\n+    >>> manager.update()\n+    >>> for viewlet in manager.viewlets:\n+    ...     if viewlet.__name__ == "plone.analytics.head":\n+    ...         analytics_head = viewlet\n+    ...         break\n+\n+When no analytics (webstats_head_js) code is set up the viewlet will not be rendered:\n+\n+    >>> analytics_head.webstats_js == ""\n+    True\n+    >>> text = manager.render()\n+    >>> \'plone.analytics.head goes here\' in text\n+    False\n+\n+Set the analytics code through the controlpanel and verify it renders properly:\n+\n+    >>> from plone.registry.interfaces import IRegistry\n+    >>> from zope.component import getUtility\n+    >>> from plone.base.interfaces import ISiteSchema\n+    >>> registry = getUtility(IRegistry)\n+    >>> site_settings = registry.forInterface(ISiteSchema, prefix="plone")\n+    >>> site_settings.webstats_head_js = u"<script>window.title=\'Hello\'</script>"\n+    >>> analytics_head.webstats_js == site_settings.webstats_head_js\n+    True\n+    >>> text = manager.render()\n+    >>> \'plone.analytics.head goes here\' in text\n+    True\n+    >>> site_settings.webstats_head_js in text\n     True\ndiff --git a/plone/app/layout/analytics/view.py b/plone/app/layout/analytics/view.py\nindex c277714d..f34ad967 100644\n--- a/plone/app/layout/analytics/view.py\n+++ b/plone/app/layout/analytics/view.py\n@@ -7,9 +7,13 @@\n from zope.viewlet.interfaces import IViewlet\n \n \n+UNWANTED_TAGS = ["base", "title"]\n+\n+\n @implementer(IViewlet)\n class AnalyticsViewlet(BrowserView):\n     render = ViewPageTemplateFile("view.pt")\n+    record_name = "webstats_js"\n \n     def __init__(self, context, request, view, manager):\n         super().__init__(context, request)\n@@ -21,11 +25,14 @@ def __init__(self, context, request, view, manager):\n     def webstats_js(self):\n         registry = getUtility(IRegistry)\n         site_settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)\n-        try:\n-            return site_settings.webstats_js or ""\n-        except AttributeError:\n-            return ""\n+        return getattr(site_settings, self.record_name, "")\n \n     def update(self):\n         """The viewlet manager _updateViewlets requires this method"""\n         pass\n+\n+\n+@implementer(IViewlet)\n+class AnalyticsHeadViewlet(AnalyticsViewlet):\n+    render = ViewPageTemplateFile("view_head.pt")\n+    record_name = "webstats_head_js"\ndiff --git a/plone/app/layout/analytics/view_head.pt b/plone/app/layout/analytics/view_head.pt\nnew file mode 100644\nindex 00000000..c51a58d1\n--- /dev/null\n+++ b/plone/app/layout/analytics/view_head.pt\n@@ -0,0 +1,9 @@\n+<div tal:define="\n+       webstats_head_js view/webstats_js;\n+     "\n+     tal:condition="webstats_head_js"\n+     tal:omit-tag=""\n+>\n+  <!-- plone.analytics.head goes here -->\n+  <span tal:replace="structure webstats_head_js"></span>\n+</div>\ndiff --git a/plone/app/layout/links/viewlets.py b/plone/app/layout/links/viewlets.py\nindex 5d12762d..4be24c2d 100644\n--- a/plone/app/layout/links/viewlets.py\n+++ b/plone/app/layout/links/viewlets.py\n@@ -42,7 +42,11 @@ class FaviconViewlet(ViewletBase):\n \n     def init_favicon(self) -> NoReturn:\n         registry = getUtility(IRegistry)\n-        settings: ISiteSchema = registry.forInterface(ISiteSchema, prefix="plone")\n+        settings: ISiteSchema = registry.forInterface(\n+            ISiteSchema,\n+            prefix="plone",\n+            check=False,\n+        )\n         self.mimetype: str = getattr(\n             settings, "site_favicon_mimetype", "image/vnd.microsoft.icon"\n         )\ndiff --git a/plone/app/layout/viewlets/content.py b/plone/app/layout/viewlets/content.py\nindex 785c8c04..ef4b3fbf 100644\n--- a/plone/app/layout/viewlets/content.py\n+++ b/plone/app/layout/viewlets/content.py\n@@ -70,6 +70,7 @@ def show(self):\n         settings = registry.forInterface(\n             ISiteSchema,\n             prefix="plone",\n+            check=False,\n         )\n         return not self.anonymous or settings.display_publication_date_in_byline\n \n@@ -145,7 +146,7 @@ def pub_date(self):\n         """\n         # check if we are allowed to display publication date\n         registry = getUtility(IRegistry)\n-        settings = registry.forInterface(ISiteSchema, prefix="plone")\n+        settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)\n \n         if not settings.display_publication_date_in_byline:\n             return None\n@@ -281,7 +282,7 @@ def pub_date(self):\n         """\n         # check if we are allowed to display publication date\n         registry = getUtility(IRegistry)\n-        settings = registry.forInterface(ISiteSchema, prefix="plone")\n+        settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)\n \n         if not settings.display_publication_date_in_byline:\n             return None\n'

