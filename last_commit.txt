Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-03-25T07:39:22+01:00
Author: Timo Stollenwerk (tisto) <tisto@users.noreply.github.com>
Commit: https://github.com/plone/plone.restapi/commit/50cd0f09a2647bb442418e7097db4a70e53a3a34

Json Widget (#1102)

* Set widget name in jsonfield.

* Add changelog

* Pin plone.schema on Plone 4.3/5.1

Files changed:
A news/1089.feature
M buildout.cfg
M plone-4.3.x.cfg
M plone-5.0.x.cfg
M plone-5.1.x.cfg
M plone-5.2.x.cfg
M src/plone/restapi/tests/http-examples/translations_link_on_post.resp
M src/plone/restapi/tests/test_types.py
M src/plone/restapi/types/adapters.py

b'diff --git a/buildout.cfg b/buildout.cfg\nindex 72f333c15..3bac18570 100644\n--- a/buildout.cfg\n+++ b/buildout.cfg\n@@ -5,5 +5,8 @@ versions=versions\n [versions]\n plone.restapi =\n \n+plone.schema = 1.3.0\n+plone.dexterity = 2.9.8\n+\n # 3.0 drops python2 compatibility\n pyroma = 2.6.1\ndiff --git a/news/1089.feature b/news/1089.feature\nnew file mode 100644\nindex 000000000..8d2dae725\n--- /dev/null\n+++ b/news/1089.feature\n@@ -0,0 +1,2 @@\n+Adjust JSONField adapter to include widget name to use in serialization\n+[sneridagh]\n\\ No newline at end of file\ndiff --git a/plone-4.3.x.cfg b/plone-4.3.x.cfg\nindex a00b3456c..443a3f399 100644\n--- a/plone-4.3.x.cfg\n+++ b/plone-4.3.x.cfg\n@@ -30,4 +30,7 @@ pyrsistent = 0.15.7\n distlib = 0.3.1\n \n # plone.restapi specific pins\n-plone.restapi =\n\\ No newline at end of file\n+plone.restapi =\n+\n+# Improvements to the JSONField\n+plone.schema = 1.3.0\n\\ No newline at end of file\ndiff --git a/plone-5.0.x.cfg b/plone-5.0.x.cfg\nindex e69c4c556..59e1c9563 100644\n--- a/plone-5.0.x.cfg\n+++ b/plone-5.0.x.cfg\n@@ -11,3 +11,6 @@ pytz = 2017.3\n zope.interface = 4.1.0\n # Last pyrsistent version that is python 2 compatible:\n pyrsistent = 0.15.7\n+\n+# Improvements to the JSONField\n+plone.schema = 1.3.0\n\\ No newline at end of file\ndiff --git a/plone-5.1.x.cfg b/plone-5.1.x.cfg\nindex cb66511f3..9a1603541 100644\n--- a/plone-5.1.x.cfg\n+++ b/plone-5.1.x.cfg\n@@ -36,4 +36,6 @@ astunparse = 1.6.2\n \n # plone.restapi specific pins\n plone.restapi =\n-plone.schema = 1.2.1\n\\ No newline at end of file\n+\n+# Improvements to the JSONField\n+plone.schema = 1.3.0\n\\ No newline at end of file\ndiff --git a/plone-5.2.x.cfg b/plone-5.2.x.cfg\nindex b810a87db..b295494a7 100644\n--- a/plone-5.2.x.cfg\n+++ b/plone-5.2.x.cfg\n@@ -23,3 +23,7 @@ cryptography = 3.3.2\n \n # cffi 1.14.3 fails on apple m1\n cffi = 1.14.4\n+\n+# requirement for json widget tests to pass\n+plone.schema = 1.3.0\n+plone.dexterity = 2.9.8\n\\ No newline at end of file\ndiff --git a/src/plone/restapi/tests/http-examples/translations_link_on_post.resp b/src/plone/restapi/tests/http-examples/translations_link_on_post.resp\nindex 410f7574c..f2f7cf66e 100644\n--- a/src/plone/restapi/tests/http-examples/translations_link_on_post.resp\n+++ b/src/plone/restapi/tests/http-examples/translations_link_on_post.resp\n@@ -57,7 +57,7 @@ Location: http://localhost:55001/plone/de/mydocument\n     "title": "Deutsch"\n   }, \n   "previous_item": {\n-    "@id": "http://localhost:55001/plone/de/Assets", \n+    "@id": "http://localhost:55001/plone/de/assets", \n     "@type": "LIF", \n     "description": "", \n     "title": "Assets"\ndiff --git a/src/plone/restapi/tests/test_types.py b/src/plone/restapi/tests/test_types.py\nindex 89cc1dfd5..8d64a2f56 100644\n--- a/src/plone/restapi/tests/test_types.py\n+++ b/src/plone/restapi/tests/test_types.py\n@@ -11,6 +11,7 @@\n from plone.restapi.types.utils import get_jsonschema_for_portal_type\n from plone.restapi.types.utils import get_jsonschema_properties\n from plone.schema import Email\n+from plone.schema import JSONField\n from plone.supermodel import model\n from Products.CMFCore.utils import getToolByName\n from unittest import TestCase\n@@ -750,3 +751,22 @@ def test_datetime(self):\n             },\n             adapter.get_schema(),\n         )\n+\n+    def test_jsonfield(self):\n+        field = JSONField(\n+            title=u"My field", description=u"My great field", widget="my_widget_name"\n+        )\n+        adapter = getMultiAdapter(\n+            (field, self.portal, self.request), IJsonSchemaProvider\n+        )\n+\n+        self.assertEqual(\n+            {\n+                "type": "dict",\n+                "title": u"My field",\n+                "factory": "JSONField",\n+                "description": u"My great field",\n+                "widget": u"my_widget_name",\n+            },\n+            adapter.get_schema(),\n+        )\ndiff --git a/src/plone/restapi/types/adapters.py b/src/plone/restapi/types/adapters.py\nindex 1bbc91a50..7cba81c1e 100644\n--- a/src/plone/restapi/types/adapters.py\n+++ b/src/plone/restapi/types/adapters.py\n@@ -503,7 +503,7 @@ def get_type(self):\n         return "dict"\n \n     def get_widget(self):\n-        return "json"\n+        return self.field.widget or "json"\n \n     def get_factory(self):\n         return "JSONField"\n'

