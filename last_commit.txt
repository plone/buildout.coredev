Repository: plone.restapi


Branch: refs/heads/7.x.x
Date: 2023-09-03T22:20:38-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.restapi/commit/731be583b5256b845997cac197e6e8127c666580

Skip next/previous info for old versions if it can't be obtained (#1651) (#1681)

* Skip next/previous info for old versions if it can't be obtained

* changelog

* make it fully backwards compatible

Files changed:
A news/1651.bugfix
M src/plone/restapi/serializer/dxcontent.py
M src/plone/restapi/tests/test_services_history.py

b'diff --git a/news/1651.bugfix b/news/1651.bugfix\nnew file mode 100644\nindex 0000000000..d64b315b5c\n--- /dev/null\n+++ b/news/1651.bugfix\n@@ -0,0 +1 @@\n+Fix content serializer with an old version of an item that was renamed. @davisagli\ndiff --git a/src/plone/restapi/serializer/dxcontent.py b/src/plone/restapi/serializer/dxcontent.py\nindex c903fb88d9..a70c009d8e 100644\n--- a/src/plone/restapi/serializer/dxcontent.py\n+++ b/src/plone/restapi/serializer/dxcontent.py\n@@ -71,10 +71,15 @@ def __call__(self, version=None, include_items=True):\n         }\n \n         # Insert next/prev information\n-        nextprevious = NextPrevious(obj)\n-        result.update(\n-            {"previous_item": nextprevious.previous, "next_item": nextprevious.next}\n-        )\n+        try:\n+            nextprevious = NextPrevious(obj)\n+            result.update(\n+                {"previous_item": nextprevious.previous, "next_item": nextprevious.next}\n+            )\n+        except ValueError:\n+            # If we\'re serializing an old version that was renamed or moved,\n+            # then its id might not be found inside the current object\'s container.\n+            result.update({"previous_item": {}, "next_item": {}})\n \n         # Insert locking information\n         result.update({"lock": lock_info(obj)})\ndiff --git a/src/plone/restapi/tests/test_services_history.py b/src/plone/restapi/tests/test_services_history.py\nindex 325ba04c5e..3f4610f2dd 100644\n--- a/src/plone/restapi/tests/test_services_history.py\n+++ b/src/plone/restapi/tests/test_services_history.py\n@@ -121,6 +121,15 @@ def test_previous_version(self):\n         response = self.api_session.get(url)\n         self.assertEqual(response.json()["title"], "My Document")\n \n+    def test_previous_version_of_renamed_item(self):\n+        api.content.move(source=self.doc, id="renamed-doc")\n+        transaction.commit()\n+\n+        url = self.doc.absolute_url() + "/@history/0"\n+        response = self.api_session.get(url)\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(response.json()["id"], "doc_with_history")\n+\n     def test_no_sharing(self):\n         url = self.doc.absolute_url() + "/@history/0"\n         response = self.api_session.get(url)\n'

