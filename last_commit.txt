Repository: plone.outputfilters


Branch: refs/heads/master
Date: 2023-06-26T17:10:51+02:00
Author: Godefroid Chapelle (gotcha) <gotcha@bubblenet.be>
Commit: https://github.com/plone/plone.outputfilters/commit/e2043ba8ca2e66156e84122d464f50bb7c9a5e83

Query registry once

instead of querying it for each img tag.

Files changed:
A news/less_call_to_registry.internal
M plone/outputfilters/filters/picture_variants.py

b'diff --git a/news/less_call_to_registry.internal b/news/less_call_to_registry.internal\nnew file mode 100644\nindex 0000000..41bd799\n--- /dev/null\n+++ b/news/less_call_to_registry.internal\n@@ -0,0 +1,2 @@\n+Call registry once per filter rather than for each img tag.\n+[gotcha]\ndiff --git a/plone/outputfilters/filters/picture_variants.py b/plone/outputfilters/filters/picture_variants.py\nindex 2e39deb..8718bc7 100644\n--- a/plone/outputfilters/filters/picture_variants.py\n+++ b/plone/outputfilters/filters/picture_variants.py\n@@ -25,6 +25,7 @@ def __init__(self, context=None, request=None):\n         self.context = context\n         self.request = request\n         self.img2picturetag = Img2PictureTag()\n+        self.all_picture_variants = get_picture_variants()\n \n     def __call__(self, data):\n         soup = BeautifulSoup(safe_text(data), "html.parser")\n@@ -33,7 +34,9 @@ def __call__(self, data):\n             picture_variant_name = elem.attrs.get("data-picturevariant", "")\n             if not picture_variant_name:\n                 continue\n-            picture_variants_config = get_picture_variants().get(picture_variant_name)\n+            picture_variants_config = self.all_picture_variants.get(\n+                picture_variant_name\n+            )\n             if not picture_variants_config:\n                 logger.warning(\n                     "Could not find the given picture_variant_name {}, leave tag untouched!".format(\n'

