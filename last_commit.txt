Repository: plone.restapi


Branch: refs/heads/main
Date: 2024-03-02T17:06:23-08:00
Author: Roman (folix-01) <72063601+folix-01@users.noreply.github.com>
Commit: https://github.com/plone/plone.restapi/commit/6bdf7022eab5bb38eb1235eb752949ed38888d4d

Add the site timezone info to the @site endpoint (#1749)

* Add the site timezone info to @site endpoint

* Changelog

* Fix expected timezone

* Update 1749.feature

* Fix documentation results order

* Fix doc

* Fix doc

* Use the registry timezone as return value

* Change property name to plone.portal_timezone

* Change response values order

* Update news/1749.feature

---------

Co-authored-by: David Glick &lt;david@glicksoftware.com&gt;

Files changed:
A news/1749.feature
M src/plone/restapi/services/site/get.py
M src/plone/restapi/tests/http-examples/site_get.resp
M src/plone/restapi/tests/test_services_site.py

b'diff --git a/news/1749.feature b/news/1749.feature\nnew file mode 100644\nindex 0000000000..da20e9a3f3\n--- /dev/null\n+++ b/news/1749.feature\n@@ -0,0 +1 @@\n+Add the site timezone to the @site endpoint return result. @folix-01\ndiff --git a/src/plone/restapi/services/site/get.py b/src/plone/restapi/services/site/get.py\nindex 125c56621d..6c029c5675 100644\n--- a/src/plone/restapi/services/site/get.py\n+++ b/src/plone/restapi/services/site/get.py\n@@ -1,4 +1,8 @@\n # -*- coding: utf-8 -*-\n+from plone.app.event.base import FALLBACK_TIMEZONE\n+from plone.app.event.base import replacement_zones\n+from plone.event.utils import default_timezone as fallback_default_timezone\n+from plone.event.utils import validated_timezone\n from plone.registry.interfaces import IRegistry\n from plone.restapi.interfaces import IExpandableElement\n from plone.restapi.services import Service\n@@ -38,11 +42,31 @@ def __call__(self, expand=False):\n                 "plone.site_logo": site_settings.site_logo and getSiteLogo() or None,\n                 "plone.robots_txt": site_settings.robots_txt,\n                 "plone.allowed_sizes": image_settings.allowed_sizes,\n+                "plone.portal_timezone": self.plone_timezone(),\n             }\n         )\n \n         return result\n \n+    def plone_timezone(self):\n+        """Returns the portal timezone"""\n+\n+        reg_key = "plone.portal_timezone"\n+        registry = getUtility(IRegistry)\n+        portal_timezone = registry.get(reg_key, None)\n+\n+        # fallback to what plone.event is doing\n+        if not portal_timezone:\n+            portal_timezone = fallback_default_timezone()\n+\n+        # Change any ambiguous timezone abbreviations to their most common\n+        # non-ambigious timezone name.\n+        if portal_timezone in replacement_zones.keys():\n+            portal_timezone = replacement_zones[portal_timezone]\n+        portal_timezone = validated_timezone(portal_timezone, FALLBACK_TIMEZONE)\n+\n+        return portal_timezone\n+\n \n class SiteGet(Service):\n     def reply(self):\ndiff --git a/src/plone/restapi/tests/http-examples/site_get.resp b/src/plone/restapi/tests/http-examples/site_get.resp\nindex e5f274d3de..427a10eaaa 100644\n--- a/src/plone/restapi/tests/http-examples/site_get.resp\n+++ b/src/plone/restapi/tests/http-examples/site_get.resp\n@@ -16,6 +16,7 @@ Content-Type: application/json\n         "icon 32:32",\n         "listing 16:16"\n     ],\n+    "plone.portal_timezone": "UTC",\n     "plone.robots_txt": "Sitemap: {portal_url}/sitemap.xml.gz\\n\\n# Define access-restrictions for robots/spiders\\n# http://www.robotstxt.org/wc/norobots.html\\n\\n\\n\\n# By default we allow robots to access all areas of our site\\n# already accessible to anonymous users\\n\\nUser-agent: *\\nDisallow:\\n\\n\\n\\n# Add Googlebot-specific syntax extension to exclude forms\\n# that are repeated for each piece of content in the site\\n# the wildcard is only supported by Googlebot\\n# http://www.google.com/support/webmasters/bin/answer.py?answer=40367&ctx=sibling\\n\\nUser-Agent: Googlebot\\nDisallow: /*?\\nDisallow: /*atct_album_view$\\nDisallow: /*folder_factories$\\nDisallow: /*folder_summary_view$\\nDisallow: /*login_form$\\nDisallow: /*mail_password_form$\\nDisallow: /@@search\\nDisallow: /*search_rss$\\nDisallow: /*sendto_form$\\nDisallow: /*summary_view$\\nDisallow: /*thumbnail_view$\\nDisallow: /*view$\\n",\n     "plone.site_logo": null,\n     "plone.site_title": "Plone site"\ndiff --git a/src/plone/restapi/tests/test_services_site.py b/src/plone/restapi/tests/test_services_site.py\nindex 1bd9069eb5..dfeeaa2bc8 100644\n--- a/src/plone/restapi/tests/test_services_site.py\n+++ b/src/plone/restapi/tests/test_services_site.py\n@@ -36,3 +36,4 @@ def test_get_site(self):\n         self.assertIn("plone.site_logo", response.json())\n         self.assertIn("plone.robots_txt", response.json())\n         self.assertIn("plone.allowed_sizes", response.json())\n+        self.assertEqual(response.json()["plone.portal_timezone"], "UTC")\n'

