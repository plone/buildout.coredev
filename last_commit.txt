Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-02-04T09:16:06+01:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/25509c04f7d4ee487531bd471461fc730b72f9f8

Do not break if some custom code provides an alias for Products.Archeâ€¦ (#1057)

* Do not break if some custom code provides an alias for Products.Archetypes

Fixes #1004

* Add comments

Files changed:
A news/1004.bugfix
M src/plone/restapi/deserializer/configure.zcml
M src/plone/restapi/serializer/configure.zcml

b'diff --git a/news/1004.bugfix b/news/1004.bugfix\nnew file mode 100644\nindex 000000000..1a2b9db97\n--- /dev/null\n+++ b/news/1004.bugfix\n@@ -0,0 +1 @@\n+Do not break if some custom code provides an alias for Products.Archetypes\ndiff --git a/src/plone/restapi/deserializer/configure.zcml b/src/plone/restapi/deserializer/configure.zcml\nindex c91a26628..1aca6a602 100644\n--- a/src/plone/restapi/deserializer/configure.zcml\n+++ b/src/plone/restapi/deserializer/configure.zcml\n@@ -43,7 +43,12 @@\n     <adapter factory=".relationfield.RelationChoiceFieldDeserializer" />\n   </configure>\n \n-  <configure zcml:condition="installed Products.Archetypes">\n+  <!--\n+    We check for Products.Archetypes.atapi to avoid false positive\n+    due to code aliases in migration code,\n+    see https://github.com/plone/plone.restapi/pull/1004\n+  -->\n+  <configure zcml:condition="installed Products.Archetypes.atapi">\n     <adapter factory=".atcontent.DeserializeFromJson" />\n     <configure zcml:condition="installed plone.app.blob">\n         <adapter factory=".atfields.BlobFieldDeserializer" />\ndiff --git a/src/plone/restapi/serializer/configure.zcml b/src/plone/restapi/serializer/configure.zcml\nindex 778c173a8..ecac2e48a 100644\n--- a/src/plone/restapi/serializer/configure.zcml\n+++ b/src/plone/restapi/serializer/configure.zcml\n@@ -36,7 +36,12 @@\n     <subscriber factory=".blocks.ResolveUIDSerializerRoot"\n       provides="plone.restapi.interfaces.IBlockFieldSerializationTransformer"/>\n \n-    <configure zcml:condition="installed Products.Archetypes">\n+    <!--\n+      We check for Products.Archetypes.atapi to avoid false positive\n+      due to code aliases in migration code,\n+      see https://github.com/plone/plone.restapi/pull/1004\n+    -->\n+    <configure zcml:condition="installed Products.Archetypes.atapi">\n         <adapter factory=".atcontent.SerializeToJson" />\n         <adapter factory=".atcontent.SerializeFolderToJson" />\n         <configure zcml:condition="installed plone.app.blob">\n'

