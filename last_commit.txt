Repository: plone.restapi


Branch: refs/heads/master
Date: 2020-06-03T12:43:23+02:00
Author: Víctor Fernández de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/5ee077439dc5786940f16c910d9646e5c1772d79

PATCH (editing) in @user endpoint now is able to remove existing values using null (#955)

Files changed:
A news/946.bugfix
M src/plone/restapi/services/users/update.py
M src/plone/restapi/tests/test_services_users.py

b'diff --git a/news/946.bugfix b/news/946.bugfix\nnew file mode 100644\nindex 000000000..dc642ad61\n--- /dev/null\n+++ b/news/946.bugfix\n@@ -0,0 +1,2 @@\n+PATCH (editing) in @user endpoint now is able to remove existing values using null\n+[sneridagh]\ndiff --git a/src/plone/restapi/services/users/update.py b/src/plone/restapi/services/users/update.py\nindex 815909b99..8958a4685 100644\n--- a/src/plone/restapi/services/users/update.py\n+++ b/src/plone/restapi/services/users/update.py\n@@ -77,7 +77,7 @@ def reply(self):\n                     # no data on it, then we should not set it since it will fail\n                     if key == "portrait" and isinstance(value, dict):\n                         self.set_member_portrait(user, value)\n-                    user.setMemberProperties(mapping={key: value})\n+                    user.setMemberProperties(mapping={key: value}, force_empty=True)\n \n             roles = user_settings_to_update.get("roles", {})\n             if roles:\n@@ -108,7 +108,7 @@ def reply(self):\n                     # no data on it, then we should not set it since it will fail\n                     if key == "portrait" and isinstance(value, dict):\n                         self.set_member_portrait(user, value)\n-                    user.setMemberProperties(mapping={key: value})\n+                    user.setMemberProperties(mapping={key: value}, force_empty=True)\n \n         else:\n             if self._is_anonymous:\ndiff --git a/src/plone/restapi/tests/test_services_users.py b/src/plone/restapi/tests/test_services_users.py\nindex 85cdc2ee3..c37dfbae2 100644\n--- a/src/plone/restapi/tests/test_services_users.py\n+++ b/src/plone/restapi/tests/test_services_users.py\n@@ -414,6 +414,23 @@ def test_user_can_update_himself(self):\n         self.assertEqual("Noam A. Chomsky", noam.getProperty("fullname"))\n         self.assertEqual("avram.chomsky@plone.org", noam.getProperty("email"))\n \n+    def test_user_can_update_himself_remove_values(self):\n+        payload = {\n+            "fullname": "Noam A. Chomsky",\n+            "username": "noam",\n+            "email": "avram.chomsky@plone.org",\n+            "home_page": None,\n+        }\n+        self.api_session.auth = ("noam", "password")\n+        response = self.api_session.patch("/@users/noam", json=payload)\n+\n+        self.assertEqual(response.status_code, 204)\n+        transaction.commit()\n+\n+        noam = api.user.get(userid="noam")\n+\n+        self.assertEqual(None, noam.getProperty("home_page"))\n+\n     def test_update_roles(self):\n         self.assertNotIn("Contributor", api.user.get_roles(username="noam"))\n \n'

