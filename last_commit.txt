Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2024-09-29T15:29:01+02:00
Author: Mikel Larreategi (erral) <mlarreategi@codesyntax.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/bf2b53f12963d07ee893e63c45bf70a2a5785c0a

get the object to be translated correctly

Files changed:
A news/303.bugfix
M src/plone/app/multilingual/browser/javascript/babel_helper.js
M src/plone/app/multilingual/browser/translate.py

b'diff --git a/news/303.bugfix b/news/303.bugfix\nnew file mode 100644\nindex 000000000..ad85419a2\n--- /dev/null\n+++ b/news/303.bugfix\n@@ -0,0 +1,2 @@\n+Get the object to be translated correctly\n+[erral]\ndiff --git a/src/plone/app/multilingual/browser/javascript/babel_helper.js b/src/plone/app/multilingual/browser/javascript/babel_helper.js\nindex 331240322..48279d32a 100644\n--- a/src/plone/app/multilingual/browser/javascript/babel_helper.js\n+++ b/src/plone/app/multilingual/browser/javascript/babel_helper.js\n@@ -128,10 +128,16 @@\n                 original_field.children(\'.translator-widget\').click(function () {\n                     var field = $(value).attr("rel");\n                     // Fetch source of text to translate.\n+\n+                    // we use the current URL to get the context\'s UID\n+                    var url_parts = document.location.pathname.split(\'++addtranslation++\')\n+\n                     var jsondata = {\n                         \'field\': field,\n-                        \'lang_source\': langSource\n-                    };\n+                        \'lang_source\': langSource,\n+                        // we use the second part of the url_parts, the uid itself\n+                        \'context_uid\': url_parts[1]\n+                      };\n                     var targetelement = destination_field.find(\'textarea\');\n                     var tiny_editor = destination_field.find("textarea.mce_editable");\n                     if (!targetelement.length) {\ndiff --git a/src/plone/app/multilingual/browser/translate.py b/src/plone/app/multilingual/browser/translate.py\nindex cb702e41c..0c7938503 100644\n--- a/src/plone/app/multilingual/browser/translate.py\n+++ b/src/plone/app/multilingual/browser/translate.py\n@@ -5,6 +5,7 @@\n from plone.base.interfaces import ILanguage\n from plone.registry.interfaces import IRegistry\n from plone.uuid.interfaces import IUUID\n+from Products.CMFCore.utils import getToolByName\n from Products.Five import BrowserView\n from zope.component import getUtility\n \n@@ -57,7 +58,19 @@ def __call__(self):\n         ):\n             return _("Need a field")\n         else:\n-            manager = ITranslationManager(self.context)\n+            context_uid = self.request.form.get(\'context_uid\', None)\n+            if context_uid is None:\n+                # try with context if no translation uid is present\n+                manager = ITranslationManager(self.context)\n+            else:\n+                catalog = getToolByName(self.context, "portal_catalog")\n+                brains = catalog(UID=context_uid)\n+                if len(brains):\n+                    context = brains[0].getObject()\n+                    manager = ITranslationManager(context)\n+                else:\n+                    manager = ITranslationManager(self.context)\n+\n             registry = getUtility(IRegistry)\n             settings = registry.forInterface(\n                 IMultiLanguageExtraOptionsSchema, prefix="plone"\n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2024-09-29T15:36:30+02:00
Author: Mikel Larreategi (erral) <mlarreategi@codesyntax.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/218494031b57f5b3ba3740e4c4ede60075ae8c61

black

Files changed:
M src/plone/app/multilingual/browser/translate.py

b'diff --git a/src/plone/app/multilingual/browser/translate.py b/src/plone/app/multilingual/browser/translate.py\nindex 0c793850..ab244891 100644\n--- a/src/plone/app/multilingual/browser/translate.py\n+++ b/src/plone/app/multilingual/browser/translate.py\n@@ -58,7 +58,7 @@ def __call__(self):\n         ):\n             return _("Need a field")\n         else:\n-            context_uid = self.request.form.get(\'context_uid\', None)\n+            context_uid = self.request.form.get("context_uid", None)\n             if context_uid is None:\n                 # try with context if no translation uid is present\n                 manager = ITranslationManager(self.context)\n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2024-09-30T07:46:39+02:00
Author: Mikel Larreategi (erral) <mlarreategi@codesyntax.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/12c3985ad078005ffd50245b5d3076a222d8b087

use uuidToObject to get the object from UUID

Files changed:
M src/plone/app/multilingual/browser/translate.py

b'diff --git a/src/plone/app/multilingual/browser/translate.py b/src/plone/app/multilingual/browser/translate.py\nindex ab244891..e5348f3b 100644\n--- a/src/plone/app/multilingual/browser/translate.py\n+++ b/src/plone/app/multilingual/browser/translate.py\n@@ -2,10 +2,10 @@\n from plone.app.multilingual import _\n from plone.app.multilingual.interfaces import IMultiLanguageExtraOptionsSchema\n from plone.app.multilingual.interfaces import ITranslationManager\n+from plone.app.uuid.utils import uuidToObject\n from plone.base.interfaces import ILanguage\n from plone.registry.interfaces import IRegistry\n from plone.uuid.interfaces import IUUID\n-from Products.CMFCore.utils import getToolByName\n from Products.Five import BrowserView\n from zope.component import getUtility\n \n@@ -63,10 +63,8 @@ def __call__(self):\n                 # try with context if no translation uid is present\n                 manager = ITranslationManager(self.context)\n             else:\n-                catalog = getToolByName(self.context, "portal_catalog")\n-                brains = catalog(UID=context_uid)\n-                if len(brains):\n-                    context = brains[0].getObject()\n+                context = uuidToObject(context_uid)\n+                if context is not None:\n                     manager = ITranslationManager(context)\n                 else:\n                     manager = ITranslationManager(self.context)\n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2024-10-01T20:36:14-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/419309f8274eeecf9478f1fb51b57349a7f24bbd

Merge pull request #462 from plone/erral-issue-303

get the object to be translated correctly in Google Translate view

Files changed:
A news/303.bugfix
M src/plone/app/multilingual/browser/javascript/babel_helper.js
M src/plone/app/multilingual/browser/translate.py

b'diff --git a/news/303.bugfix b/news/303.bugfix\nnew file mode 100644\nindex 000000000..ad85419a2\n--- /dev/null\n+++ b/news/303.bugfix\n@@ -0,0 +1,2 @@\n+Get the object to be translated correctly\n+[erral]\ndiff --git a/src/plone/app/multilingual/browser/javascript/babel_helper.js b/src/plone/app/multilingual/browser/javascript/babel_helper.js\nindex 331240322..48279d32a 100644\n--- a/src/plone/app/multilingual/browser/javascript/babel_helper.js\n+++ b/src/plone/app/multilingual/browser/javascript/babel_helper.js\n@@ -128,10 +128,16 @@\n                 original_field.children(\'.translator-widget\').click(function () {\n                     var field = $(value).attr("rel");\n                     // Fetch source of text to translate.\n+\n+                    // we use the current URL to get the context\'s UID\n+                    var url_parts = document.location.pathname.split(\'++addtranslation++\')\n+\n                     var jsondata = {\n                         \'field\': field,\n-                        \'lang_source\': langSource\n-                    };\n+                        \'lang_source\': langSource,\n+                        // we use the second part of the url_parts, the uid itself\n+                        \'context_uid\': url_parts[1]\n+                      };\n                     var targetelement = destination_field.find(\'textarea\');\n                     var tiny_editor = destination_field.find("textarea.mce_editable");\n                     if (!targetelement.length) {\ndiff --git a/src/plone/app/multilingual/browser/translate.py b/src/plone/app/multilingual/browser/translate.py\nindex cb702e41c..e5348f3b0 100644\n--- a/src/plone/app/multilingual/browser/translate.py\n+++ b/src/plone/app/multilingual/browser/translate.py\n@@ -2,6 +2,7 @@\n from plone.app.multilingual import _\n from plone.app.multilingual.interfaces import IMultiLanguageExtraOptionsSchema\n from plone.app.multilingual.interfaces import ITranslationManager\n+from plone.app.uuid.utils import uuidToObject\n from plone.base.interfaces import ILanguage\n from plone.registry.interfaces import IRegistry\n from plone.uuid.interfaces import IUUID\n@@ -57,7 +58,17 @@ def __call__(self):\n         ):\n             return _("Need a field")\n         else:\n-            manager = ITranslationManager(self.context)\n+            context_uid = self.request.form.get("context_uid", None)\n+            if context_uid is None:\n+                # try with context if no translation uid is present\n+                manager = ITranslationManager(self.context)\n+            else:\n+                context = uuidToObject(context_uid)\n+                if context is not None:\n+                    manager = ITranslationManager(context)\n+                else:\n+                    manager = ITranslationManager(self.context)\n+\n             registry = getUtility(IRegistry)\n             settings = registry.forInterface(\n                 IMultiLanguageExtraOptionsSchema, prefix="plone"\n'

