Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2020-09-16T14:47:08+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.contenttypes/commit/5398640298e197e42834ecf98573e9090ffaba9a

Use plone.testing.zope instead of deprecated z2.

Files changed:
A news/3130.bugfix
M plone/app/contenttypes/testing.py
M plone/app/contenttypes/tests/test_behaviors_collection.py
M plone/app/contenttypes/tests/test_behaviors_leadimage.py
M plone/app/contenttypes/tests/test_behaviors_richtext.py
M plone/app/contenttypes/tests/test_behaviors_table_of_contents.py
M plone/app/contenttypes/tests/test_collection.py
M plone/app/contenttypes/tests/test_document.py
M plone/app/contenttypes/tests/test_event.py
M plone/app/contenttypes/tests/test_file.py
M plone/app/contenttypes/tests/test_folder.py
M plone/app/contenttypes/tests/test_image.py
M plone/app/contenttypes/tests/test_link.py
M plone/app/contenttypes/tests/test_migration.py
M plone/app/contenttypes/tests/test_migration_custom.py
M plone/app/contenttypes/tests/test_news_item.py
M plone/app/contenttypes/tests/test_security.py

b'diff --git a/news/3130.bugfix b/news/3130.bugfix\nnew file mode 100644\nindex 00000000..7f19ed94\n--- /dev/null\n+++ b/news/3130.bugfix\n@@ -0,0 +1,2 @@\n+Fix various deprecation warnings.\n+[maurits]\ndiff --git a/plone/app/contenttypes/testing.py b/plone/app/contenttypes/testing.py\nindex dc93f034..3e943ebb 100644\n--- a/plone/app/contenttypes/testing.py\n+++ b/plone/app/contenttypes/testing.py\n@@ -11,7 +11,7 @@\n from plone.app.testing import PloneSandboxLayer\n from plone.app.testing import SITE_OWNER_NAME\n from plone.app.testing import SITE_OWNER_PASSWORD\n-from plone.testing import z2\n+from plone.testing import zope\n from Products.CMFPlone.utils import get_installer\n from zope.interface import alsoProvides\n \n@@ -86,19 +86,19 @@ def setUpZope(self, app, configurationContext):\n \n         # prepare installing Products.ATContentTypes\n         self.loadZCML(package=Products.ATContentTypes)\n-        z2.installProduct(app, \'Products.Archetypes\')\n-        z2.installProduct(app, \'Products.ATContentTypes\')\n-        z2.installProduct(app, \'plone.app.blob\')\n+        zope.installProduct(app, \'Products.Archetypes\')\n+        zope.installProduct(app, \'Products.ATContentTypes\')\n+        zope.installProduct(app, \'plone.app.blob\')\n \n         # prepare installing plone.app.collection\n         try:\n             pkg_resources.get_distribution(\'plone.app.collection\')\n-            z2.installProduct(app, \'plone.app.collection\')\n+            zope.installProduct(app, \'plone.app.collection\')\n         except pkg_resources.DistributionNotFound:\n             pass\n \n         # prepare installing plone.app.contenttypes\n-        z2.installProduct(app, \'Products.DateRecurringIndex\')\n+        zope.installProduct(app, \'Products.DateRecurringIndex\')\n \n         import plone.app.contenttypes\n         self.loadZCML(package=plone.app.contenttypes)\n@@ -142,12 +142,12 @@ def tearDownZope(self, app):\n \n         try:\n             pkg_resources.get_distribution(\'plone.app.collection\')\n-            z2.uninstallProduct(app, \'plone.app.collection\')\n+            zope.uninstallProduct(app, \'plone.app.collection\')\n         except pkg_resources.DistributionNotFound:\n             pass\n-        z2.uninstallProduct(app, \'plone.app.blob\')\n-        z2.uninstallProduct(app, \'Products.ATContentTypes\')\n-        z2.uninstallProduct(app, \'Products.Archetypes\')\n+        zope.uninstallProduct(app, \'plone.app.blob\')\n+        zope.uninstallProduct(app, \'Products.ATContentTypes\')\n+        zope.uninstallProduct(app, \'Products.Archetypes\')\n \n \n PLONE_APP_CONTENTTYPES_FIXTURE = PloneAppContenttypes()\n@@ -163,7 +163,7 @@ def tearDownZope(self, app):\n PLONE_APP_CONTENTTYPES_ROBOT_TESTING = FunctionalTesting(\n     bases=(\n         PLONE_APP_CONTENTTYPES_ROBOT_FIXTURE,\n-        z2.ZSERVER_FIXTURE\n+        zope.WSGI_SERVER_FIXTURE\n     ),\n     name=\'PloneAppContenttypes:Robot\'\n )\ndiff --git a/plone/app/contenttypes/tests/test_behaviors_collection.py b/plone/app/contenttypes/tests/test_behaviors_collection.py\nindex 7b2377ba..247f0471 100644\n--- a/plone/app/contenttypes/tests/test_behaviors_collection.py\n+++ b/plone/app/contenttypes/tests/test_behaviors_collection.py\n@@ -6,7 +6,7 @@\n from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.app.testing import TEST_USER_ID\n from plone.dexterity.fti import DexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from zope.interface import alsoProvides\n \n import json\ndiff --git a/plone/app/contenttypes/tests/test_behaviors_leadimage.py b/plone/app/contenttypes/tests/test_behaviors_leadimage.py\nindex a42331db..2474024e 100644\n--- a/plone/app/contenttypes/tests/test_behaviors_leadimage.py\n+++ b/plone/app/contenttypes/tests/test_behaviors_leadimage.py\n@@ -6,7 +6,7 @@\n from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.app.testing import TEST_USER_ID\n from plone.dexterity.fti import DexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from zope.interface import alsoProvides\n \n import io\ndiff --git a/plone/app/contenttypes/tests/test_behaviors_richtext.py b/plone/app/contenttypes/tests/test_behaviors_richtext.py\nindex d61220e0..f7727986 100644\n--- a/plone/app/contenttypes/tests/test_behaviors_richtext.py\n+++ b/plone/app/contenttypes/tests/test_behaviors_richtext.py\n@@ -6,7 +6,7 @@\n from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.app.testing import TEST_USER_ID\n from plone.dexterity.fti import DexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from Products.CMFCore.utils import getToolByName\n \n import unittest\ndiff --git a/plone/app/contenttypes/tests/test_behaviors_table_of_contents.py b/plone/app/contenttypes/tests/test_behaviors_table_of_contents.py\nindex 4da0844b..3b729d9b 100644\n--- a/plone/app/contenttypes/tests/test_behaviors_table_of_contents.py\n+++ b/plone/app/contenttypes/tests/test_behaviors_table_of_contents.py\n@@ -6,7 +6,7 @@\n from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.app.testing import TEST_USER_ID\n from plone.dexterity.fti import DexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from zope.interface import alsoProvides\n \n import unittest\ndiff --git a/plone/app/contenttypes/tests/test_collection.py b/plone/app/contenttypes/tests/test_collection.py\nindex a4bafb35..08c95f33 100644\n--- a/plone/app/contenttypes/tests/test_collection.py\n+++ b/plone/app/contenttypes/tests/test_collection.py\n@@ -16,7 +16,7 @@\n from plone.app.testing import TEST_USER_NAME\n from plone.app.textfield.value import RichTextValue\n from plone.dexterity.interfaces import IDexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from transaction import commit\n from zope.component import createObject\n from zope.component import queryUtility\ndiff --git a/plone/app/contenttypes/tests/test_document.py b/plone/app/contenttypes/tests/test_document.py\nindex 81655a29..2127da11 100644\n--- a/plone/app/contenttypes/tests/test_document.py\n+++ b/plone/app/contenttypes/tests/test_document.py\n@@ -9,7 +9,7 @@\n from plone.app.textfield.value import RichTextValue\n from plone.app.z3cform.interfaces import IPloneFormLayer\n from plone.dexterity.interfaces import IDexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from zope.component import createObject\n from zope.component import queryUtility\n from zope.interface import alsoProvides\ndiff --git a/plone/app/contenttypes/tests/test_event.py b/plone/app/contenttypes/tests/test_event.py\nindex 40b53ed7..39a499e1 100644\n--- a/plone/app/contenttypes/tests/test_event.py\n+++ b/plone/app/contenttypes/tests/test_event.py\n@@ -9,7 +9,7 @@\n from plone.app.z3cform.interfaces import IPloneFormLayer\n from plone.dexterity.interfaces import IDexterityFTI\n from plone.event.interfaces import IEvent\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from zope.component import createObject\n from zope.component import queryUtility\n from zope.interface import alsoProvides\ndiff --git a/plone/app/contenttypes/tests/test_file.py b/plone/app/contenttypes/tests/test_file.py\nindex 022c0aa0..27c72fb7 100644\n--- a/plone/app/contenttypes/tests/test_file.py\n+++ b/plone/app/contenttypes/tests/test_file.py\n@@ -10,7 +10,7 @@\n from plone.app.z3cform.interfaces import IPloneFormLayer\n from plone.dexterity.interfaces import IDexterityFTI\n from plone.namedfile.file import NamedFile\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from zope.component import createObject\n from zope.component import queryUtility\n from zope.interface import alsoProvides\ndiff --git a/plone/app/contenttypes/tests/test_folder.py b/plone/app/contenttypes/tests/test_folder.py\nindex a883bead..9c3ea64f 100644\n--- a/plone/app/contenttypes/tests/test_folder.py\n+++ b/plone/app/contenttypes/tests/test_folder.py\n@@ -9,7 +9,7 @@\n from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.app.testing import TEST_USER_ID\n from plone.dexterity.interfaces import IDexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from zope.component import createObject\n from zope.component import queryUtility\n \ndiff --git a/plone/app/contenttypes/tests/test_image.py b/plone/app/contenttypes/tests/test_image.py\nindex bd948d3b..27b930b6 100644\n--- a/plone/app/contenttypes/tests/test_image.py\n+++ b/plone/app/contenttypes/tests/test_image.py\n@@ -8,7 +8,7 @@\n from plone.app.testing import TEST_USER_ID\n from plone.app.z3cform.interfaces import IPloneFormLayer\n from plone.dexterity.interfaces import IDexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from zope.component import createObject\n from zope.component import queryUtility\n from zope.interface import alsoProvides\ndiff --git a/plone/app/contenttypes/tests/test_link.py b/plone/app/contenttypes/tests/test_link.py\nindex 5f729ba2..1f956c9d 100644\n--- a/plone/app/contenttypes/tests/test_link.py\n+++ b/plone/app/contenttypes/tests/test_link.py\n@@ -12,7 +12,7 @@\n from plone.app.testing import TEST_USER_ID\n from plone.app.z3cform.interfaces import IPloneFormLayer\n from plone.dexterity.interfaces import IDexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from plone.uuid.interfaces import IUUID\n from Products.CMFCore.utils import getToolByName\n from zope.component import createObject\ndiff --git a/plone/app/contenttypes/tests/test_migration.py b/plone/app/contenttypes/tests/test_migration.py\nindex ac1000e9..c4eeebb8 100644\n--- a/plone/app/contenttypes/tests/test_migration.py\n+++ b/plone/app/contenttypes/tests/test_migration.py\n@@ -29,7 +29,7 @@\n     from plone.dexterity.interfaces import IDexterityFTI\n     from plone.event.interfaces import IEventAccessor\n     from plone.namedfile.file import NamedBlobImage\n-    from plone.testing.z2 import Browser\n+    from plone.testing.zope import Browser\n     from Products.CMFCore.utils import getToolByName\n     from Products.CMFPlone.utils import get_installer\n     from z3c.relationfield import RelationValue\n@@ -226,12 +226,12 @@ def test_patct_event_is_migrated(self):\n     def test_pae_atevent_is_migrated(self):\n         """Can we migrate a plone.app.event AT event?"""\n         from DateTime import DateTime\n-        from plone.testing import z2\n+        from plone.testing import zope\n         from plone.app.testing import applyProfile\n         from plone.app.contenttypes.migration.migration import migrate_events\n \n         # Enable plone.app.event.at\n-        z2.installProduct(self.layer[\'app\'], \'plone.app.event.at\')\n+        zope.installProduct(self.layer[\'app\'], \'plone.app.event.at\')\n         applyProfile(self.portal, \'plone.app.event.at:default\')\n \n         self.portal.invokeFactory(\'Event\', \'pae-at-event\')\ndiff --git a/plone/app/contenttypes/tests/test_migration_custom.py b/plone/app/contenttypes/tests/test_migration_custom.py\nindex f9b3a68f..b353a722 100644\n--- a/plone/app/contenttypes/tests/test_migration_custom.py\n+++ b/plone/app/contenttypes/tests/test_migration_custom.py\n@@ -17,7 +17,7 @@\n     from plone.app.testing import SITE_OWNER_NAME\n     from plone.app.testing import SITE_OWNER_PASSWORD\n     from plone.app.testing import TEST_USER_ID\n-    from plone.testing.z2 import Browser\n+    from plone.testing.zope import Browser\n     from Products.CMFCore.utils import getToolByName\n     from Products.CMFPlone.utils import safe_unicode\n \ndiff --git a/plone/app/contenttypes/tests/test_news_item.py b/plone/app/contenttypes/tests/test_news_item.py\nindex a2299aa3..3e140e16 100644\n--- a/plone/app/contenttypes/tests/test_news_item.py\n+++ b/plone/app/contenttypes/tests/test_news_item.py\n@@ -9,7 +9,7 @@\n from plone.app.textfield.value import RichTextValue\n from plone.app.z3cform.interfaces import IPloneFormLayer\n from plone.dexterity.interfaces import IDexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from Products.Five.browser import BrowserView as View\n from zope.component import createObject\n from zope.component import queryMultiAdapter\ndiff --git a/plone/app/contenttypes/tests/test_security.py b/plone/app/contenttypes/tests/test_security.py\nindex ce3a83de..5a2ef0b8 100644\n--- a/plone/app/contenttypes/tests/test_security.py\n+++ b/plone/app/contenttypes/tests/test_security.py\n@@ -6,7 +6,7 @@\n from plone.app.testing import setRoles\n from plone.app.testing import TEST_USER_ID\n from plone.app.testing import TEST_USER_NAME\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n \n import base64\n import os\n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2020-09-16T14:55:24+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.contenttypes/commit/5ccb136a7f5a50ac5c4f79c4b1cfbf51cb92da22

Fixed ResourceWarning: unclosed file, in tests.

Files changed:
M plone/app/contenttypes/tests/test_webdav.py

b'diff --git a/plone/app/contenttypes/tests/test_webdav.py b/plone/app/contenttypes/tests/test_webdav.py\nindex 6a19a0fd..78f166d2 100644\n--- a/plone/app/contenttypes/tests/test_webdav.py\n+++ b/plone/app/contenttypes/tests/test_webdav.py\n@@ -46,12 +46,13 @@ def setUp(self):\n     def test_image_put(self):\n         """Upload an image through webdav."""\n         filename = os.path.join(os.path.dirname(__file__), u\'image.jpg\')\n-        request = DAVTestRequest(environ={\n-            \'BODYFILE\': open(filename, \'rb\'),\n-            \'PATH_INFO\': \'/foo/bar/image.jpg\',\n-        })\n-        self.image.REQUEST = request\n-        self.image.PUT()\n+        with open(filename, \'rb\') as myfile:\n+            request = DAVTestRequest(environ={\n+                \'BODYFILE\': myfile,\n+                \'PATH_INFO\': \'/foo/bar/image.jpg\',\n+            })\n+            self.image.REQUEST = request\n+            self.image.PUT()\n         self.assertEqual(self.image.image.filename, u\'image.jpg\')\n         self.assertEqual(self.image.get_size(), 5131)\n         self.assertEqual(self.image.content_type(), \'image/jpeg\')\n@@ -59,12 +60,13 @@ def test_image_put(self):\n     def test_file_put(self):\n         """Upload a file through webdav."""\n         filename = os.path.join(os.path.dirname(__file__), u\'file.pdf\')\n-        request = DAVTestRequest(environ={\n-            \'BODYFILE\': open(filename, \'rb\'),\n-            \'PATH_INFO\': \'/foo/bar/file.pdf\',\n-        })\n-        self.file.REQUEST = request\n-        self.file.PUT()\n+        with open(filename, \'rb\') as myfile:\n+            request = DAVTestRequest(environ={\n+                \'BODYFILE\': myfile,\n+                \'PATH_INFO\': \'/foo/bar/file.pdf\',\n+            })\n+            self.file.REQUEST = request\n+            self.file.PUT()\n         self.assertEqual(self.file.file.filename, u\'file.pdf\')\n         self.assertEqual(self.file.get_size(), 8561)\n         self.assertEqual(self.file.content_type(), \'application/pdf\')\n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2020-09-16T15:11:07+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.contenttypes/commit/3a13def01e8ccb7beacc8973c80033acfdb555a0

Fixed FutureWarning: Possible set difference, in tests.

This is an a regular expression.

Easy example:

```
$ python3
&gt;&gt;&gt; import re
&gt;&gt;&gt; re.compile(r'[a-z0-9--]+').match('a-1')
__main__:1: FutureWarning: Possible set difference at position 7
&lt;re.Match object; span=(0, 3), match='a-1'&gt;
```

Problem is probably that the dash is sometimes used as to indicate a-to-z or 0-to-9,
and then used as itself, where I guess '--' is meant as an escaped version of '-'.
It works, but may fail in the future.

Better is:

```
&gt;&gt;&gt; re.compile(r'[a-z0-9\-]+').match('a-1')
&lt;re.Match object; span=(0, 3), match='a-1'&gt;
```

or actually even simpler:

```
&gt;&gt;&gt; re.compile(r'[a-z0-9-]+').match('a-1')
&lt;re.Match object; span=(0, 3), match='a-1'&gt;
```

Files changed:
M plone/app/contenttypes/tests/test_image.py

b'diff --git a/plone/app/contenttypes/tests/test_image.py b/plone/app/contenttypes/tests/test_image.py\nindex 27b930b6..52bbdf08 100644\n--- a/plone/app/contenttypes/tests/test_image.py\n+++ b/plone/app/contenttypes/tests/test_image.py\n@@ -124,7 +124,7 @@ def test_svg_image(self):\n         scale = self.image.restrictedTraverse(\'@@images\')\n         self.assertRegex(\n             scale.scale(\'image\', scale=\'large\').tag(),\n-            r\'<img src="http://nohost/plone/image/@@images/[a-z0-9--]*.svg" alt="My Image" title="My Image" height="[a-z0-9--]*" width="[a-z0-9--]*" />\',  # noqa: E501\n+            r\'<img src="http://nohost/plone/image/@@images/[a-z0-9\\-]*.svg" alt="My Image" title="My Image" height="[a-z0-9\\-]*" width="[a-z0-9\\-]*" />\',  # noqa: E501\n         )\n \n \n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2020-09-16T21:18:27+02:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.contenttypes/commit/e0266d899521dec89fff282e2ac7322c7e27459e

Merge pull request #571 from plone/maurits/fix-warnings

Fixed various deprecation warnings in tests

Files changed:
A news/3130.bugfix
M plone/app/contenttypes/testing.py
M plone/app/contenttypes/tests/test_behaviors_collection.py
M plone/app/contenttypes/tests/test_behaviors_leadimage.py
M plone/app/contenttypes/tests/test_behaviors_richtext.py
M plone/app/contenttypes/tests/test_behaviors_table_of_contents.py
M plone/app/contenttypes/tests/test_collection.py
M plone/app/contenttypes/tests/test_document.py
M plone/app/contenttypes/tests/test_event.py
M plone/app/contenttypes/tests/test_file.py
M plone/app/contenttypes/tests/test_folder.py
M plone/app/contenttypes/tests/test_image.py
M plone/app/contenttypes/tests/test_link.py
M plone/app/contenttypes/tests/test_migration.py
M plone/app/contenttypes/tests/test_migration_custom.py
M plone/app/contenttypes/tests/test_news_item.py
M plone/app/contenttypes/tests/test_security.py
M plone/app/contenttypes/tests/test_webdav.py

b'diff --git a/news/3130.bugfix b/news/3130.bugfix\nnew file mode 100644\nindex 00000000..7f19ed94\n--- /dev/null\n+++ b/news/3130.bugfix\n@@ -0,0 +1,2 @@\n+Fix various deprecation warnings.\n+[maurits]\ndiff --git a/plone/app/contenttypes/testing.py b/plone/app/contenttypes/testing.py\nindex dc93f034..3e943ebb 100644\n--- a/plone/app/contenttypes/testing.py\n+++ b/plone/app/contenttypes/testing.py\n@@ -11,7 +11,7 @@\n from plone.app.testing import PloneSandboxLayer\n from plone.app.testing import SITE_OWNER_NAME\n from plone.app.testing import SITE_OWNER_PASSWORD\n-from plone.testing import z2\n+from plone.testing import zope\n from Products.CMFPlone.utils import get_installer\n from zope.interface import alsoProvides\n \n@@ -86,19 +86,19 @@ def setUpZope(self, app, configurationContext):\n \n         # prepare installing Products.ATContentTypes\n         self.loadZCML(package=Products.ATContentTypes)\n-        z2.installProduct(app, \'Products.Archetypes\')\n-        z2.installProduct(app, \'Products.ATContentTypes\')\n-        z2.installProduct(app, \'plone.app.blob\')\n+        zope.installProduct(app, \'Products.Archetypes\')\n+        zope.installProduct(app, \'Products.ATContentTypes\')\n+        zope.installProduct(app, \'plone.app.blob\')\n \n         # prepare installing plone.app.collection\n         try:\n             pkg_resources.get_distribution(\'plone.app.collection\')\n-            z2.installProduct(app, \'plone.app.collection\')\n+            zope.installProduct(app, \'plone.app.collection\')\n         except pkg_resources.DistributionNotFound:\n             pass\n \n         # prepare installing plone.app.contenttypes\n-        z2.installProduct(app, \'Products.DateRecurringIndex\')\n+        zope.installProduct(app, \'Products.DateRecurringIndex\')\n \n         import plone.app.contenttypes\n         self.loadZCML(package=plone.app.contenttypes)\n@@ -142,12 +142,12 @@ def tearDownZope(self, app):\n \n         try:\n             pkg_resources.get_distribution(\'plone.app.collection\')\n-            z2.uninstallProduct(app, \'plone.app.collection\')\n+            zope.uninstallProduct(app, \'plone.app.collection\')\n         except pkg_resources.DistributionNotFound:\n             pass\n-        z2.uninstallProduct(app, \'plone.app.blob\')\n-        z2.uninstallProduct(app, \'Products.ATContentTypes\')\n-        z2.uninstallProduct(app, \'Products.Archetypes\')\n+        zope.uninstallProduct(app, \'plone.app.blob\')\n+        zope.uninstallProduct(app, \'Products.ATContentTypes\')\n+        zope.uninstallProduct(app, \'Products.Archetypes\')\n \n \n PLONE_APP_CONTENTTYPES_FIXTURE = PloneAppContenttypes()\n@@ -163,7 +163,7 @@ def tearDownZope(self, app):\n PLONE_APP_CONTENTTYPES_ROBOT_TESTING = FunctionalTesting(\n     bases=(\n         PLONE_APP_CONTENTTYPES_ROBOT_FIXTURE,\n-        z2.ZSERVER_FIXTURE\n+        zope.WSGI_SERVER_FIXTURE\n     ),\n     name=\'PloneAppContenttypes:Robot\'\n )\ndiff --git a/plone/app/contenttypes/tests/test_behaviors_collection.py b/plone/app/contenttypes/tests/test_behaviors_collection.py\nindex 7b2377ba..247f0471 100644\n--- a/plone/app/contenttypes/tests/test_behaviors_collection.py\n+++ b/plone/app/contenttypes/tests/test_behaviors_collection.py\n@@ -6,7 +6,7 @@\n from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.app.testing import TEST_USER_ID\n from plone.dexterity.fti import DexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from zope.interface import alsoProvides\n \n import json\ndiff --git a/plone/app/contenttypes/tests/test_behaviors_leadimage.py b/plone/app/contenttypes/tests/test_behaviors_leadimage.py\nindex a42331db..2474024e 100644\n--- a/plone/app/contenttypes/tests/test_behaviors_leadimage.py\n+++ b/plone/app/contenttypes/tests/test_behaviors_leadimage.py\n@@ -6,7 +6,7 @@\n from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.app.testing import TEST_USER_ID\n from plone.dexterity.fti import DexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from zope.interface import alsoProvides\n \n import io\ndiff --git a/plone/app/contenttypes/tests/test_behaviors_richtext.py b/plone/app/contenttypes/tests/test_behaviors_richtext.py\nindex d61220e0..f7727986 100644\n--- a/plone/app/contenttypes/tests/test_behaviors_richtext.py\n+++ b/plone/app/contenttypes/tests/test_behaviors_richtext.py\n@@ -6,7 +6,7 @@\n from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.app.testing import TEST_USER_ID\n from plone.dexterity.fti import DexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from Products.CMFCore.utils import getToolByName\n \n import unittest\ndiff --git a/plone/app/contenttypes/tests/test_behaviors_table_of_contents.py b/plone/app/contenttypes/tests/test_behaviors_table_of_contents.py\nindex 4da0844b..3b729d9b 100644\n--- a/plone/app/contenttypes/tests/test_behaviors_table_of_contents.py\n+++ b/plone/app/contenttypes/tests/test_behaviors_table_of_contents.py\n@@ -6,7 +6,7 @@\n from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.app.testing import TEST_USER_ID\n from plone.dexterity.fti import DexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from zope.interface import alsoProvides\n \n import unittest\ndiff --git a/plone/app/contenttypes/tests/test_collection.py b/plone/app/contenttypes/tests/test_collection.py\nindex a4bafb35..08c95f33 100644\n--- a/plone/app/contenttypes/tests/test_collection.py\n+++ b/plone/app/contenttypes/tests/test_collection.py\n@@ -16,7 +16,7 @@\n from plone.app.testing import TEST_USER_NAME\n from plone.app.textfield.value import RichTextValue\n from plone.dexterity.interfaces import IDexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from transaction import commit\n from zope.component import createObject\n from zope.component import queryUtility\ndiff --git a/plone/app/contenttypes/tests/test_document.py b/plone/app/contenttypes/tests/test_document.py\nindex 81655a29..2127da11 100644\n--- a/plone/app/contenttypes/tests/test_document.py\n+++ b/plone/app/contenttypes/tests/test_document.py\n@@ -9,7 +9,7 @@\n from plone.app.textfield.value import RichTextValue\n from plone.app.z3cform.interfaces import IPloneFormLayer\n from plone.dexterity.interfaces import IDexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from zope.component import createObject\n from zope.component import queryUtility\n from zope.interface import alsoProvides\ndiff --git a/plone/app/contenttypes/tests/test_event.py b/plone/app/contenttypes/tests/test_event.py\nindex 40b53ed7..39a499e1 100644\n--- a/plone/app/contenttypes/tests/test_event.py\n+++ b/plone/app/contenttypes/tests/test_event.py\n@@ -9,7 +9,7 @@\n from plone.app.z3cform.interfaces import IPloneFormLayer\n from plone.dexterity.interfaces import IDexterityFTI\n from plone.event.interfaces import IEvent\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from zope.component import createObject\n from zope.component import queryUtility\n from zope.interface import alsoProvides\ndiff --git a/plone/app/contenttypes/tests/test_file.py b/plone/app/contenttypes/tests/test_file.py\nindex 022c0aa0..27c72fb7 100644\n--- a/plone/app/contenttypes/tests/test_file.py\n+++ b/plone/app/contenttypes/tests/test_file.py\n@@ -10,7 +10,7 @@\n from plone.app.z3cform.interfaces import IPloneFormLayer\n from plone.dexterity.interfaces import IDexterityFTI\n from plone.namedfile.file import NamedFile\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from zope.component import createObject\n from zope.component import queryUtility\n from zope.interface import alsoProvides\ndiff --git a/plone/app/contenttypes/tests/test_folder.py b/plone/app/contenttypes/tests/test_folder.py\nindex a883bead..9c3ea64f 100644\n--- a/plone/app/contenttypes/tests/test_folder.py\n+++ b/plone/app/contenttypes/tests/test_folder.py\n@@ -9,7 +9,7 @@\n from plone.app.testing import SITE_OWNER_PASSWORD\n from plone.app.testing import TEST_USER_ID\n from plone.dexterity.interfaces import IDexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from zope.component import createObject\n from zope.component import queryUtility\n \ndiff --git a/plone/app/contenttypes/tests/test_image.py b/plone/app/contenttypes/tests/test_image.py\nindex bd948d3b..52bbdf08 100644\n--- a/plone/app/contenttypes/tests/test_image.py\n+++ b/plone/app/contenttypes/tests/test_image.py\n@@ -8,7 +8,7 @@\n from plone.app.testing import TEST_USER_ID\n from plone.app.z3cform.interfaces import IPloneFormLayer\n from plone.dexterity.interfaces import IDexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from zope.component import createObject\n from zope.component import queryUtility\n from zope.interface import alsoProvides\n@@ -124,7 +124,7 @@ def test_svg_image(self):\n         scale = self.image.restrictedTraverse(\'@@images\')\n         self.assertRegex(\n             scale.scale(\'image\', scale=\'large\').tag(),\n-            r\'<img src="http://nohost/plone/image/@@images/[a-z0-9--]*.svg" alt="My Image" title="My Image" height="[a-z0-9--]*" width="[a-z0-9--]*" />\',  # noqa: E501\n+            r\'<img src="http://nohost/plone/image/@@images/[a-z0-9\\-]*.svg" alt="My Image" title="My Image" height="[a-z0-9\\-]*" width="[a-z0-9\\-]*" />\',  # noqa: E501\n         )\n \n \ndiff --git a/plone/app/contenttypes/tests/test_link.py b/plone/app/contenttypes/tests/test_link.py\nindex 5f729ba2..1f956c9d 100644\n--- a/plone/app/contenttypes/tests/test_link.py\n+++ b/plone/app/contenttypes/tests/test_link.py\n@@ -12,7 +12,7 @@\n from plone.app.testing import TEST_USER_ID\n from plone.app.z3cform.interfaces import IPloneFormLayer\n from plone.dexterity.interfaces import IDexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from plone.uuid.interfaces import IUUID\n from Products.CMFCore.utils import getToolByName\n from zope.component import createObject\ndiff --git a/plone/app/contenttypes/tests/test_migration.py b/plone/app/contenttypes/tests/test_migration.py\nindex ac1000e9..c4eeebb8 100644\n--- a/plone/app/contenttypes/tests/test_migration.py\n+++ b/plone/app/contenttypes/tests/test_migration.py\n@@ -29,7 +29,7 @@\n     from plone.dexterity.interfaces import IDexterityFTI\n     from plone.event.interfaces import IEventAccessor\n     from plone.namedfile.file import NamedBlobImage\n-    from plone.testing.z2 import Browser\n+    from plone.testing.zope import Browser\n     from Products.CMFCore.utils import getToolByName\n     from Products.CMFPlone.utils import get_installer\n     from z3c.relationfield import RelationValue\n@@ -226,12 +226,12 @@ def test_patct_event_is_migrated(self):\n     def test_pae_atevent_is_migrated(self):\n         """Can we migrate a plone.app.event AT event?"""\n         from DateTime import DateTime\n-        from plone.testing import z2\n+        from plone.testing import zope\n         from plone.app.testing import applyProfile\n         from plone.app.contenttypes.migration.migration import migrate_events\n \n         # Enable plone.app.event.at\n-        z2.installProduct(self.layer[\'app\'], \'plone.app.event.at\')\n+        zope.installProduct(self.layer[\'app\'], \'plone.app.event.at\')\n         applyProfile(self.portal, \'plone.app.event.at:default\')\n \n         self.portal.invokeFactory(\'Event\', \'pae-at-event\')\ndiff --git a/plone/app/contenttypes/tests/test_migration_custom.py b/plone/app/contenttypes/tests/test_migration_custom.py\nindex f9b3a68f..b353a722 100644\n--- a/plone/app/contenttypes/tests/test_migration_custom.py\n+++ b/plone/app/contenttypes/tests/test_migration_custom.py\n@@ -17,7 +17,7 @@\n     from plone.app.testing import SITE_OWNER_NAME\n     from plone.app.testing import SITE_OWNER_PASSWORD\n     from plone.app.testing import TEST_USER_ID\n-    from plone.testing.z2 import Browser\n+    from plone.testing.zope import Browser\n     from Products.CMFCore.utils import getToolByName\n     from Products.CMFPlone.utils import safe_unicode\n \ndiff --git a/plone/app/contenttypes/tests/test_news_item.py b/plone/app/contenttypes/tests/test_news_item.py\nindex a2299aa3..3e140e16 100644\n--- a/plone/app/contenttypes/tests/test_news_item.py\n+++ b/plone/app/contenttypes/tests/test_news_item.py\n@@ -9,7 +9,7 @@\n from plone.app.textfield.value import RichTextValue\n from plone.app.z3cform.interfaces import IPloneFormLayer\n from plone.dexterity.interfaces import IDexterityFTI\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n from Products.Five.browser import BrowserView as View\n from zope.component import createObject\n from zope.component import queryMultiAdapter\ndiff --git a/plone/app/contenttypes/tests/test_security.py b/plone/app/contenttypes/tests/test_security.py\nindex ce3a83de..5a2ef0b8 100644\n--- a/plone/app/contenttypes/tests/test_security.py\n+++ b/plone/app/contenttypes/tests/test_security.py\n@@ -6,7 +6,7 @@\n from plone.app.testing import setRoles\n from plone.app.testing import TEST_USER_ID\n from plone.app.testing import TEST_USER_NAME\n-from plone.testing.z2 import Browser\n+from plone.testing.zope import Browser\n \n import base64\n import os\ndiff --git a/plone/app/contenttypes/tests/test_webdav.py b/plone/app/contenttypes/tests/test_webdav.py\nindex 6a19a0fd..78f166d2 100644\n--- a/plone/app/contenttypes/tests/test_webdav.py\n+++ b/plone/app/contenttypes/tests/test_webdav.py\n@@ -46,12 +46,13 @@ def setUp(self):\n     def test_image_put(self):\n         """Upload an image through webdav."""\n         filename = os.path.join(os.path.dirname(__file__), u\'image.jpg\')\n-        request = DAVTestRequest(environ={\n-            \'BODYFILE\': open(filename, \'rb\'),\n-            \'PATH_INFO\': \'/foo/bar/image.jpg\',\n-        })\n-        self.image.REQUEST = request\n-        self.image.PUT()\n+        with open(filename, \'rb\') as myfile:\n+            request = DAVTestRequest(environ={\n+                \'BODYFILE\': myfile,\n+                \'PATH_INFO\': \'/foo/bar/image.jpg\',\n+            })\n+            self.image.REQUEST = request\n+            self.image.PUT()\n         self.assertEqual(self.image.image.filename, u\'image.jpg\')\n         self.assertEqual(self.image.get_size(), 5131)\n         self.assertEqual(self.image.content_type(), \'image/jpeg\')\n@@ -59,12 +60,13 @@ def test_image_put(self):\n     def test_file_put(self):\n         """Upload a file through webdav."""\n         filename = os.path.join(os.path.dirname(__file__), u\'file.pdf\')\n-        request = DAVTestRequest(environ={\n-            \'BODYFILE\': open(filename, \'rb\'),\n-            \'PATH_INFO\': \'/foo/bar/file.pdf\',\n-        })\n-        self.file.REQUEST = request\n-        self.file.PUT()\n+        with open(filename, \'rb\') as myfile:\n+            request = DAVTestRequest(environ={\n+                \'BODYFILE\': myfile,\n+                \'PATH_INFO\': \'/foo/bar/file.pdf\',\n+            })\n+            self.file.REQUEST = request\n+            self.file.PUT()\n         self.assertEqual(self.file.file.filename, u\'file.pdf\')\n         self.assertEqual(self.file.get_size(), 8561)\n         self.assertEqual(self.file.content_type(), \'application/pdf\')\n'

