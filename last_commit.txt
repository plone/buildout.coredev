Repository: Products.CMFPlone


Branch: refs/heads/5.2.x
Date: 2023-03-30T15:21:51+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/ce7481b5856af792e6fe2061872cc07e426010e5

Fixed encoding issue on Python 3 for some mail servers.

This could result in missing characters in an email body.
See https://github.com/plone/Products.CMFPlone/issues/3754

Files changed:
A news/3754.bugfix
M Products/CMFPlone/RegistrationTool.py
M Products/CMFPlone/browser/contact_info.py
M Products/CMFPlone/browser/login/login_help.py
M Products/CMFPlone/tests/mails.txt

b'diff --git a/Products/CMFPlone/RegistrationTool.py b/Products/CMFPlone/RegistrationTool.py\nindex 63f39f6c5e..7232a73456 100644\n--- a/Products/CMFPlone/RegistrationTool.py\n+++ b/Products/CMFPlone/RegistrationTool.py\n@@ -8,7 +8,6 @@\n from AccessControl.SecurityManagement import setSecurityManager\n from Acquisition import aq_base\n from Acquisition import aq_chain\n-from email import message_from_string\n from hashlib import md5\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.interfaces import ISiteRoot\n@@ -34,6 +33,13 @@\n import re\n import six\n \n+try:\n+    # Products.MailHost has a patch to fix quoted-printable soft line breaks.\n+    # See https://github.com/zopefoundation/Products.MailHost/issues/35\n+    from Products.MailHost.MailHost import message_from_string\n+except ImportError:\n+    # If the patch is ever removed, we fall back to the standard library.\n+    from email import message_from_string\n \n # - remove \'1\', \'l\', and \'I\' to avoid confusion\n # - remove \'0\', \'O\', and \'Q\' to avoid confusion\ndiff --git a/Products/CMFPlone/browser/contact_info.py b/Products/CMFPlone/browser/contact_info.py\nindex 72eacdb566..0709568494 100644\n--- a/Products/CMFPlone/browser/contact_info.py\n+++ b/Products/CMFPlone/browser/contact_info.py\n@@ -6,7 +6,6 @@\n from Products.CMFPlone.interfaces.controlpanel import IMailSchema\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from Products.statusmessages.interfaces import IStatusMessage\n-from email.mime.text import MIMEText\n from plone.autoform.form import AutoExtensibleForm\n from plone.registry.interfaces import IRegistry\n from smtplib import SMTPException\n@@ -15,6 +14,16 @@\n from zope.component.hooks import getSite\n \n import logging\n+import six\n+\n+try:\n+    # Products.MailHost has a patch to fix quoted-printable soft line breaks.\n+    # See https://github.com/zopefoundation/Products.MailHost/issues/35\n+    from Products.MailHost.MailHost import message_from_string\n+except ImportError:\n+    # If the patch is ever removed, we fall back to the standard library.\n+    from email import message_from_string\n+\n \n log = logging.getLogger(__name__)\n \n@@ -68,7 +77,9 @@ def send_message(self, data):\n \n         data[\'url\'] = portal.absolute_url()\n         message = self.generate_mail(data, encoding)\n-        message = MIMEText(message, \'plain\', encoding)\n+        if six.PY3:\n+            message = message.decode(encoding)\n+        message = message_from_string(message)\n         message[\'Reply-To\'] = data[\'sender_from_address\']\n \n         try:\ndiff --git a/Products/CMFPlone/browser/login/login_help.py b/Products/CMFPlone/browser/login/login_help.py\nindex ddbb404841..39fd4aef71 100644\n--- a/Products/CMFPlone/browser/login/login_help.py\n+++ b/Products/CMFPlone/browser/login/login_help.py\n@@ -1,5 +1,4 @@\n # -*- coding: utf-8 -*-\n-from email import message_from_string\n from email.header import Header\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n@@ -24,6 +23,14 @@\n import logging\n import six\n \n+try:\n+    # Products.MailHost has a patch to fix quoted-printable soft line breaks.\n+    # See https://github.com/zopefoundation/Products.MailHost/issues/35\n+    from Products.MailHost.MailHost import message_from_string\n+except ImportError:\n+    # If the patch is ever removed, we fall back to the standard library.\n+    from email import message_from_string\n+\n \n SEND_USERNAME_TEMPLATE = _(u"mailtemplate_username_info", default=u"""From: {encoded_mail_sender}\n To: {email}\ndiff --git a/Products/CMFPlone/tests/mails.txt b/Products/CMFPlone/tests/mails.txt\nindex 756208fa87..97ecd62aca 100644\n--- a/Products/CMFPlone/tests/mails.txt\n+++ b/Products/CMFPlone/tests/mails.txt\n@@ -4,8 +4,10 @@ Mail related functional tests\n Some initial setup:\n \n   >>> from plone.testing.zope import Browser\n+  >>> import six\n   >>> app = layer[\'app\']\n   >>> browser = Browser(app)\n+  >>> browser.handleErrors = False\n \n \n Contact form\n@@ -58,12 +60,19 @@ We expect the headers to be properly header encoded (7-bit):\n   >>> b\'Subject: =?utf-8?q?Some_t=C3=A4st_subject=2E?=\' in msg\n   True\n \n-The output should be encoded in a reasonable manner (in this case\n-quoted-printable).  There may be some small differences in where\n-exactly the lines are cut off, depending on whether you use five.pt\n-(in Zope 2.13) or not, so we turn the message into one line first:\n+The output should be encoded in a reasonable manner, in this case quoted-printable.\n+On Python 3 there may be problems with quoted printable messages on some mail servers.\n+See https://github.com/zopefoundation/Products.MailHost/issues/35\n+When \'\\r\\n\' is used as line ending, all is well.\n+On Python 2 the line endings are plain \'\\n\', but there it is no problem.\n \n-  >>> msg.replace(b\'=\\n\', b\'\').replace(b\'\\n\', b\' \')\n+  >>> True if six.PY2 else msg.count(b\'\\r\\n\') > 0\n+  True\n+\n+There may be some small differences in where exactly the lines are cut off,\n+so we turn the message into one line first:\n+\n+  >>> msg.replace(b\'\\r\\n\', b\'\\n\').replace(b\'=\\n\', b\'\').replace(b\'\\n\', b\' \')\n   b\'...Another t=C3=A4st message...You are receiving this mail because T=C3=A4st user test@plone.test...is sending feedback about the site you administer at...\'\n \n We can also decode the string, though we should still be careful about\ndiff --git a/news/3754.bugfix b/news/3754.bugfix\nnew file mode 100644\nindex 0000000000..efbee7ec87\n--- /dev/null\n+++ b/news/3754.bugfix\n@@ -0,0 +1,3 @@\n+Fixed encoding issue on Python 3 for some mail servers.\n+This could result in missing characters in an email body.\n+[maurits]\n'

Repository: Products.CMFPlone


Branch: refs/heads/5.2.x
Date: 2023-03-30T23:49:13+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/59a872ed821b8d9c08ee50787f99d6d15f99c6de

Merge pull request #3759 from plone/maurits-message-from-string-mailhost-52

Fixed encoding issue on Python 3 for some mail servers. [5.2]

Files changed:
A news/3754.bugfix
M Products/CMFPlone/RegistrationTool.py
M Products/CMFPlone/browser/contact_info.py
M Products/CMFPlone/browser/login/login_help.py
M Products/CMFPlone/tests/mails.txt

b'diff --git a/Products/CMFPlone/RegistrationTool.py b/Products/CMFPlone/RegistrationTool.py\nindex 63f39f6c5e..7232a73456 100644\n--- a/Products/CMFPlone/RegistrationTool.py\n+++ b/Products/CMFPlone/RegistrationTool.py\n@@ -8,7 +8,6 @@\n from AccessControl.SecurityManagement import setSecurityManager\n from Acquisition import aq_base\n from Acquisition import aq_chain\n-from email import message_from_string\n from hashlib import md5\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.interfaces import ISiteRoot\n@@ -34,6 +33,13 @@\n import re\n import six\n \n+try:\n+    # Products.MailHost has a patch to fix quoted-printable soft line breaks.\n+    # See https://github.com/zopefoundation/Products.MailHost/issues/35\n+    from Products.MailHost.MailHost import message_from_string\n+except ImportError:\n+    # If the patch is ever removed, we fall back to the standard library.\n+    from email import message_from_string\n \n # - remove \'1\', \'l\', and \'I\' to avoid confusion\n # - remove \'0\', \'O\', and \'Q\' to avoid confusion\ndiff --git a/Products/CMFPlone/browser/contact_info.py b/Products/CMFPlone/browser/contact_info.py\nindex 72eacdb566..0709568494 100644\n--- a/Products/CMFPlone/browser/contact_info.py\n+++ b/Products/CMFPlone/browser/contact_info.py\n@@ -6,7 +6,6 @@\n from Products.CMFPlone.interfaces.controlpanel import IMailSchema\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from Products.statusmessages.interfaces import IStatusMessage\n-from email.mime.text import MIMEText\n from plone.autoform.form import AutoExtensibleForm\n from plone.registry.interfaces import IRegistry\n from smtplib import SMTPException\n@@ -15,6 +14,16 @@\n from zope.component.hooks import getSite\n \n import logging\n+import six\n+\n+try:\n+    # Products.MailHost has a patch to fix quoted-printable soft line breaks.\n+    # See https://github.com/zopefoundation/Products.MailHost/issues/35\n+    from Products.MailHost.MailHost import message_from_string\n+except ImportError:\n+    # If the patch is ever removed, we fall back to the standard library.\n+    from email import message_from_string\n+\n \n log = logging.getLogger(__name__)\n \n@@ -68,7 +77,9 @@ def send_message(self, data):\n \n         data[\'url\'] = portal.absolute_url()\n         message = self.generate_mail(data, encoding)\n-        message = MIMEText(message, \'plain\', encoding)\n+        if six.PY3:\n+            message = message.decode(encoding)\n+        message = message_from_string(message)\n         message[\'Reply-To\'] = data[\'sender_from_address\']\n \n         try:\ndiff --git a/Products/CMFPlone/browser/login/login_help.py b/Products/CMFPlone/browser/login/login_help.py\nindex ddbb404841..39fd4aef71 100644\n--- a/Products/CMFPlone/browser/login/login_help.py\n+++ b/Products/CMFPlone/browser/login/login_help.py\n@@ -1,5 +1,4 @@\n # -*- coding: utf-8 -*-\n-from email import message_from_string\n from email.header import Header\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n@@ -24,6 +23,14 @@\n import logging\n import six\n \n+try:\n+    # Products.MailHost has a patch to fix quoted-printable soft line breaks.\n+    # See https://github.com/zopefoundation/Products.MailHost/issues/35\n+    from Products.MailHost.MailHost import message_from_string\n+except ImportError:\n+    # If the patch is ever removed, we fall back to the standard library.\n+    from email import message_from_string\n+\n \n SEND_USERNAME_TEMPLATE = _(u"mailtemplate_username_info", default=u"""From: {encoded_mail_sender}\n To: {email}\ndiff --git a/Products/CMFPlone/tests/mails.txt b/Products/CMFPlone/tests/mails.txt\nindex 756208fa87..97ecd62aca 100644\n--- a/Products/CMFPlone/tests/mails.txt\n+++ b/Products/CMFPlone/tests/mails.txt\n@@ -4,8 +4,10 @@ Mail related functional tests\n Some initial setup:\n \n   >>> from plone.testing.zope import Browser\n+  >>> import six\n   >>> app = layer[\'app\']\n   >>> browser = Browser(app)\n+  >>> browser.handleErrors = False\n \n \n Contact form\n@@ -58,12 +60,19 @@ We expect the headers to be properly header encoded (7-bit):\n   >>> b\'Subject: =?utf-8?q?Some_t=C3=A4st_subject=2E?=\' in msg\n   True\n \n-The output should be encoded in a reasonable manner (in this case\n-quoted-printable).  There may be some small differences in where\n-exactly the lines are cut off, depending on whether you use five.pt\n-(in Zope 2.13) or not, so we turn the message into one line first:\n+The output should be encoded in a reasonable manner, in this case quoted-printable.\n+On Python 3 there may be problems with quoted printable messages on some mail servers.\n+See https://github.com/zopefoundation/Products.MailHost/issues/35\n+When \'\\r\\n\' is used as line ending, all is well.\n+On Python 2 the line endings are plain \'\\n\', but there it is no problem.\n \n-  >>> msg.replace(b\'=\\n\', b\'\').replace(b\'\\n\', b\' \')\n+  >>> True if six.PY2 else msg.count(b\'\\r\\n\') > 0\n+  True\n+\n+There may be some small differences in where exactly the lines are cut off,\n+so we turn the message into one line first:\n+\n+  >>> msg.replace(b\'\\r\\n\', b\'\\n\').replace(b\'=\\n\', b\'\').replace(b\'\\n\', b\' \')\n   b\'...Another t=C3=A4st message...You are receiving this mail because T=C3=A4st user test@plone.test...is sending feedback about the site you administer at...\'\n \n We can also decode the string, though we should still be careful about\ndiff --git a/news/3754.bugfix b/news/3754.bugfix\nnew file mode 100644\nindex 0000000000..efbee7ec87\n--- /dev/null\n+++ b/news/3754.bugfix\n@@ -0,0 +1,3 @@\n+Fixed encoding issue on Python 3 for some mail servers.\n+This could result in missing characters in an email body.\n+[maurits]\n'

