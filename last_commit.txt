Repository: plone.app.discussion


Branch: refs/heads/master
Date: 2021-01-22T16:37:12+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.discussion/commit/4d36d0b34237d1568df8c01ee5a49ff99a567961

Fix tests with Products.MailHost 4.11.

Fixes https://github.com/plone/plone.app.discussion/issues/174

Files changed:
A news/174.bugfix
M plone/app/discussion/tests/test_notifications.py

b'diff --git a/news/174.bugfix b/news/174.bugfix\nnew file mode 100644\nindex 00000000..bf9b438d\n--- /dev/null\n+++ b/news/174.bugfix\n@@ -0,0 +1,2 @@\n+Fix tests with Products.MailHost 4.11.\n+[maurits]\ndiff --git a/plone/app/discussion/tests/test_notifications.py b/plone/app/discussion/tests/test_notifications.py\nindex 9ed3492e..13f9f6d8 100644\n--- a/plone/app/discussion/tests/test_notifications.py\n+++ b/plone/app/discussion/tests/test_notifications.py\n@@ -67,23 +67,26 @@ def test_notify_user(self):\n         self.assertTrue(self.mailhost.messages[0])\n         msg = self.mailhost.messages[0]\n         msg = msg.decode("utf-8")\n-        self.assertTrue(\'To: john@plone.test\' in msg)\n-        self.assertTrue(\'From: portal@plone.test\' in msg)\n+        self.assertIn(\'To: john@plone.test\', msg)\n+        self.assertIn(\'From: portal@plone.test\', msg)\n         # We expect the headers to be properly header encoded (7-bit):\n-        self.assertTrue(\n-            \'Subject: =?utf-8?q?A_comment_has_been_posted=2E?=\\n\'\n-            in msg)\n+        self.assertIn(\n+            \'Subject: =?utf-8?q?A_comment_has_been_posted=2E?=\',\n+            msg)\n         # The output should be encoded in a reasonable manner\n-        # (in this case quoted-printable):\n-        self.assertTrue(\n-            \'A comment on "K=C3=B6lle Alaaf" has been posted here:\'\n-            in msg)\n-        self.assertTrue(\n-            \'http://nohost/plone/d=\\noc1/view#{0}\'.format(comment_id)\n-            in msg)\n-        self.assertTrue(\'Comment text\' in msg)\n-        self.assertFalse(\'Approve comment\' in msg)\n-        self.assertFalse(\'Delete comment\' in msg)\n+        # (in this case quoted-printable).\n+        # Depending on which Python version and which Products.MailHost version,\n+        # you may get lines separated by \'\\n\' or \'\\r\\n\' in here.\n+        msg = msg.replace(\'\\r\\n\', \'\\n\')\n+        self.assertIn(\n+            \'A comment on "K=C3=B6lle Alaaf" has been posted here:\',\n+            msg)\n+        self.assertIn(\n+            \'http://nohost/plone/d=\\noc1/view#{0}\'.format(comment_id),\n+            msg)\n+        self.assertIn(\'Comment text\', msg)\n+        self.assertNotIn(\'Approve comment\', msg)\n+        self.assertNotIn(\'Delete comment\', msg)\n \n     def test_do_not_notify_user_when_notification_is_disabled(self):\n         registry = queryUtility(IRegistry)\n@@ -213,7 +216,7 @@ def test_notify_moderator(self):\n         self.assertTrue(\'From: portal@plone.test\' in msg)\n         # We expect the headers to be properly header encoded (7-bit):\n         self.assertTrue(\n-            \'Subject: =?utf-8?q?A_comment_has_been_posted=2E?=\\n\'\n+            \'Subject: =?utf-8?q?A_comment_has_been_posted=2E?=\'\n             in msg)\n         # The output should be encoded in a reasonable manner\n         # (in this case quoted-printable):\n'

Repository: plone.app.discussion


Branch: refs/heads/master
Date: 2021-01-22T16:39:57+01:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.discussion/commit/e5568c32af78966ac9b3562d7cdc1c3ebe48f97c

Merge pull request #175 from plone/maurits/mailhost-411

Fix tests with Products.MailHost 4.11.

Files changed:
A news/174.bugfix
M plone/app/discussion/tests/test_notifications.py

b'diff --git a/news/174.bugfix b/news/174.bugfix\nnew file mode 100644\nindex 00000000..bf9b438d\n--- /dev/null\n+++ b/news/174.bugfix\n@@ -0,0 +1,2 @@\n+Fix tests with Products.MailHost 4.11.\n+[maurits]\ndiff --git a/plone/app/discussion/tests/test_notifications.py b/plone/app/discussion/tests/test_notifications.py\nindex 9ed3492e..13f9f6d8 100644\n--- a/plone/app/discussion/tests/test_notifications.py\n+++ b/plone/app/discussion/tests/test_notifications.py\n@@ -67,23 +67,26 @@ def test_notify_user(self):\n         self.assertTrue(self.mailhost.messages[0])\n         msg = self.mailhost.messages[0]\n         msg = msg.decode("utf-8")\n-        self.assertTrue(\'To: john@plone.test\' in msg)\n-        self.assertTrue(\'From: portal@plone.test\' in msg)\n+        self.assertIn(\'To: john@plone.test\', msg)\n+        self.assertIn(\'From: portal@plone.test\', msg)\n         # We expect the headers to be properly header encoded (7-bit):\n-        self.assertTrue(\n-            \'Subject: =?utf-8?q?A_comment_has_been_posted=2E?=\\n\'\n-            in msg)\n+        self.assertIn(\n+            \'Subject: =?utf-8?q?A_comment_has_been_posted=2E?=\',\n+            msg)\n         # The output should be encoded in a reasonable manner\n-        # (in this case quoted-printable):\n-        self.assertTrue(\n-            \'A comment on "K=C3=B6lle Alaaf" has been posted here:\'\n-            in msg)\n-        self.assertTrue(\n-            \'http://nohost/plone/d=\\noc1/view#{0}\'.format(comment_id)\n-            in msg)\n-        self.assertTrue(\'Comment text\' in msg)\n-        self.assertFalse(\'Approve comment\' in msg)\n-        self.assertFalse(\'Delete comment\' in msg)\n+        # (in this case quoted-printable).\n+        # Depending on which Python version and which Products.MailHost version,\n+        # you may get lines separated by \'\\n\' or \'\\r\\n\' in here.\n+        msg = msg.replace(\'\\r\\n\', \'\\n\')\n+        self.assertIn(\n+            \'A comment on "K=C3=B6lle Alaaf" has been posted here:\',\n+            msg)\n+        self.assertIn(\n+            \'http://nohost/plone/d=\\noc1/view#{0}\'.format(comment_id),\n+            msg)\n+        self.assertIn(\'Comment text\', msg)\n+        self.assertNotIn(\'Approve comment\', msg)\n+        self.assertNotIn(\'Delete comment\', msg)\n \n     def test_do_not_notify_user_when_notification_is_disabled(self):\n         registry = queryUtility(IRegistry)\n@@ -213,7 +216,7 @@ def test_notify_moderator(self):\n         self.assertTrue(\'From: portal@plone.test\' in msg)\n         # We expect the headers to be properly header encoded (7-bit):\n         self.assertTrue(\n-            \'Subject: =?utf-8?q?A_comment_has_been_posted=2E?=\\n\'\n+            \'Subject: =?utf-8?q?A_comment_has_been_posted=2E?=\'\n             in msg)\n         # The output should be encoded in a reasonable manner\n         # (in this case quoted-printable):\n'

