Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2021-09-24T14:58:19+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/3b049e1f978141d1d253d4ace639c4c1c9ac3345

Give dx site root of existing sites an UUID.

Files changed:
A news/258.bugfix
M .isort.cfg
M plone/app/upgrade/v60/alphas.py
M plone/app/upgrade/v60/configure.zcml

b'diff --git a/.isort.cfg b/.isort.cfg\nindex dd9f25db..58296a9d 100644\n--- a/.isort.cfg\n+++ b/.isort.cfg\n@@ -1,6 +1,5 @@\n [settings]\n+profile = black\n force_alphabetical_sort = True\n force_single_line = True\n lines_after_imports = 2\n-line_length = 200\n-not_skip = __init__.py\ndiff --git a/news/258.bugfix b/news/258.bugfix\nnew file mode 100644\nindex 00000000..54164117\n--- /dev/null\n+++ b/news/258.bugfix\n@@ -0,0 +1 @@\n+Add an UUID to existing, migrated site roots. [jensens]\n\\ No newline at end of file\ndiff --git a/plone/app/upgrade/v60/alphas.py b/plone/app/upgrade/v60/alphas.py\nindex 455a89d7..f35aad33 100644\n--- a/plone/app/upgrade/v60/alphas.py\n+++ b/plone/app/upgrade/v60/alphas.py\n@@ -1,8 +1,11 @@\n # -*- coding: utf-8 -*-\n from plone.app.upgrade.utils import loadMigrationProfile\n from plone.dexterity.fti import DexterityFTI\n+from plone.uuid.interfaces import ATTRIBUTE_NAME\n+from plone.uuid.interfaces import IUUIDGenerator\n from Products.CMFCore.utils import getToolByName\n from ZODB.broken import Broken\n+from zope.component import queryUtility\n from zope.component.hooks import getSite\n \n import logging\n@@ -97,3 +100,19 @@ def make_site_dx(context):\n \n     delattr(portal, "_objects")\n     portal._p_changed = True\n+\n+\n+def add_uuid_to_dxsiteroot(context):\n+    """Give the Plone Site an UUID."""\n+    portal = getSite()\n+    if getattr(portal, ATTRIBUTE_NAME, None):\n+        # we already have an UUID\n+        return\n+    generator = queryUtility(IUUIDGenerator)\n+    if generator is None:\n+        return\n+    uuid = generator()\n+    if not uuid:\n+        return\n+    setattr(portal, ATTRIBUTE_NAME, uuid)\n+    portal.reindexObject()\ndiff --git a/plone/app/upgrade/v60/configure.zcml b/plone/app/upgrade/v60/configure.zcml\nindex d7367b33..b1e64f4f 100644\n--- a/plone/app/upgrade/v60/configure.zcml\n+++ b/plone/app/upgrade/v60/configure.zcml\n@@ -41,11 +41,12 @@\n         profile="Products.CMFPlone:plone">\n \n        <gs:upgradeStep\n-           title="Miscellaneous"\n+           title="Fix UUID for DX Site Root"\n            description=""\n-           handler="..utils.null_upgrade_step"\n+           handler=".alphas.add_uuid_to_dxsiteroot"\n            />\n \n     </gs:upgradeSteps>\n \n+\n </configure>\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2021-09-27T11:56:34+02:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.upgrade/commit/8e1ec78d66affe2405584035a6b3ff37d98b6d5d

Merge pull request #258 from plone/fix-siteroot-uuid

Give DX Site Root of existing sites an UUID.

Files changed:
A news/258.bugfix
M .isort.cfg
M plone/app/upgrade/v60/alphas.py
M plone/app/upgrade/v60/configure.zcml

b'diff --git a/.isort.cfg b/.isort.cfg\nindex dd9f25db..58296a9d 100644\n--- a/.isort.cfg\n+++ b/.isort.cfg\n@@ -1,6 +1,5 @@\n [settings]\n+profile = black\n force_alphabetical_sort = True\n force_single_line = True\n lines_after_imports = 2\n-line_length = 200\n-not_skip = __init__.py\ndiff --git a/news/258.bugfix b/news/258.bugfix\nnew file mode 100644\nindex 00000000..54164117\n--- /dev/null\n+++ b/news/258.bugfix\n@@ -0,0 +1 @@\n+Add an UUID to existing, migrated site roots. [jensens]\n\\ No newline at end of file\ndiff --git a/plone/app/upgrade/v60/alphas.py b/plone/app/upgrade/v60/alphas.py\nindex 455a89d7..f35aad33 100644\n--- a/plone/app/upgrade/v60/alphas.py\n+++ b/plone/app/upgrade/v60/alphas.py\n@@ -1,8 +1,11 @@\n # -*- coding: utf-8 -*-\n from plone.app.upgrade.utils import loadMigrationProfile\n from plone.dexterity.fti import DexterityFTI\n+from plone.uuid.interfaces import ATTRIBUTE_NAME\n+from plone.uuid.interfaces import IUUIDGenerator\n from Products.CMFCore.utils import getToolByName\n from ZODB.broken import Broken\n+from zope.component import queryUtility\n from zope.component.hooks import getSite\n \n import logging\n@@ -97,3 +100,19 @@ def make_site_dx(context):\n \n     delattr(portal, "_objects")\n     portal._p_changed = True\n+\n+\n+def add_uuid_to_dxsiteroot(context):\n+    """Give the Plone Site an UUID."""\n+    portal = getSite()\n+    if getattr(portal, ATTRIBUTE_NAME, None):\n+        # we already have an UUID\n+        return\n+    generator = queryUtility(IUUIDGenerator)\n+    if generator is None:\n+        return\n+    uuid = generator()\n+    if not uuid:\n+        return\n+    setattr(portal, ATTRIBUTE_NAME, uuid)\n+    portal.reindexObject()\ndiff --git a/plone/app/upgrade/v60/configure.zcml b/plone/app/upgrade/v60/configure.zcml\nindex d7367b33..b1e64f4f 100644\n--- a/plone/app/upgrade/v60/configure.zcml\n+++ b/plone/app/upgrade/v60/configure.zcml\n@@ -41,11 +41,12 @@\n         profile="Products.CMFPlone:plone">\n \n        <gs:upgradeStep\n-           title="Miscellaneous"\n+           title="Fix UUID for DX Site Root"\n            description=""\n-           handler="..utils.null_upgrade_step"\n+           handler=".alphas.add_uuid_to_dxsiteroot"\n            />\n \n     </gs:upgradeSteps>\n \n+\n </configure>\n'

