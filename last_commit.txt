Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-03-13T07:53:25+01:00
Author: Tiberiu Ichim (tiberiuichim) <tiberiuichim@users.noreply.github.com>
Commit: https://github.com/plone/plone.restapi/commit/3b8468ea09c77a0744f27dd52a0f0313d4792ccc

Add GSM unsubscribe for test registered adapters (#1083)

* Add subscriber unsubscription

* Add changelog

Co-authored-by: Timo Stollenwerk &lt;stollenwerk@kitconcept.com&gt;

Files changed:
A news/1083.bugfix
M src/plone/restapi/tests/test_blocks_deserializer.py
M src/plone/restapi/tests/test_blocks_serializer.py

b'diff --git a/news/1083.bugfix b/news/1083.bugfix\nnew file mode 100644\nindex 000000000..0628e8cdb\n--- /dev/null\n+++ b/news/1083.bugfix\n@@ -0,0 +1 @@\n+Add GSM unsubscribe for test registered adapters in block transformer tests @tiberiuichim\ndiff --git a/src/plone/restapi/tests/test_blocks_deserializer.py b/src/plone/restapi/tests/test_blocks_deserializer.py\nindex b0ac5499f..9aae50e08 100644\n--- a/src/plone/restapi/tests/test_blocks_deserializer.py\n+++ b/src/plone/restapi/tests/test_blocks_deserializer.py\n@@ -8,6 +8,7 @@\n from plone.restapi.testing import PLONE_RESTAPI_DX_INTEGRATION_TESTING\n from plone.uuid.interfaces import IUUID\n from zope.component import adapter\n+from zope.component import getGlobalSiteManager\n from zope.component import getMultiAdapter\n from zope.component import provideSubscriptionAdapter\n from zope.component import queryUtility\n@@ -76,6 +77,13 @@ def __call__(self, value):\n         assert self.portal.doc1._handler_called is True\n         assert self.portal.doc1.blocks["123"]["value"] == u"changed: text"\n \n+        sm = getGlobalSiteManager()\n+        sm.adapters.unsubscribe(\n+            (IDexterityItem, IBrowserRequest),\n+            IBlockFieldDeserializationTransformer,\n+            TestAdapter,\n+        )\n+\n     def test_disabled_deserializer(self):\n         @implementer(IBlockFieldDeserializationTransformer)\n         @adapter(IBlocks, IBrowserRequest)\n@@ -105,6 +113,13 @@ def __call__(self, value):\n         assert not getattr(self.portal.doc1, "_handler_called", False)\n         assert self.portal.doc1.blocks["123"]["value"] == u"text"\n \n+        sm = getGlobalSiteManager()\n+        sm.adapters.unsubscribe(\n+            (IDexterityItem, IBrowserRequest),\n+            IBlockFieldDeserializationTransformer,\n+            TestAdapter,\n+        )\n+\n     def test_register_multiple_transform(self):\n         @implementer(IBlockFieldDeserializationTransformer)\n         @adapter(IBlocks, IBrowserRequest)\n@@ -156,6 +171,18 @@ def __call__(self, value):\n         self.assertTrue(self.portal.doc1._handler_called_b)\n         self.assertEqual(self.portal.doc1.blocks["123"]["value"], u"c")\n \n+        sm = getGlobalSiteManager()\n+        sm.adapters.unsubscribe(\n+            (IDexterityItem, IBrowserRequest),\n+            IBlockFieldDeserializationTransformer,\n+            TestAdapterA,\n+        )\n+        sm.adapters.unsubscribe(\n+            (IDexterityItem, IBrowserRequest),\n+            IBlockFieldDeserializationTransformer,\n+            TestAdapterB,\n+        )\n+\n     def test_blocks_html_cleanup(self):\n         self.deserialize(\n             blocks={\ndiff --git a/src/plone/restapi/tests/test_blocks_serializer.py b/src/plone/restapi/tests/test_blocks_serializer.py\nindex 9eb4ffa81..38222b98a 100644\n--- a/src/plone/restapi/tests/test_blocks_serializer.py\n+++ b/src/plone/restapi/tests/test_blocks_serializer.py\n@@ -10,6 +10,7 @@\n from plone.uuid.interfaces import IUUID\n from z3c.form.interfaces import IDataManager\n from zope.component import adapter\n+from zope.component import getGlobalSiteManager\n from zope.component import getMultiAdapter\n from zope.component import provideSubscriptionAdapter\n from zope.component import queryUtility\n@@ -92,6 +93,18 @@ def __call__(self, value):\n         )\n         self.assertEqual(value["123"]["value"], u"c")\n \n+        sm = getGlobalSiteManager()\n+        sm.adapters.unsubscribe(\n+            (IDexterityItem, IBrowserRequest),\n+            IBlockFieldSerializationTransformer,\n+            TestAdapterA,\n+        )\n+        sm.adapters.unsubscribe(\n+            (IDexterityItem, IBrowserRequest),\n+            IBlockFieldSerializationTransformer,\n+            TestAdapterB,\n+        )\n+\n     def test_disabled_serializer(self):\n         @implementer(IBlockFieldSerializationTransformer)\n         @adapter(IBlocks, IBrowserRequest)\n@@ -123,6 +136,13 @@ def __call__(self, value):\n         assert not getattr(self.portal.doc1, "_handler_called", False)\n         self.assertEqual(value["123"]["value"], u"text")\n \n+        sm = getGlobalSiteManager()\n+        sm.adapters.unsubscribe(\n+            (IDexterityItem, IBrowserRequest),\n+            IBlockFieldSerializationTransformer,\n+            TestAdapter,\n+        )\n+\n     def test_serialize_blocks_smart_href_array_volto_object_browser(self):\n         doc_uid = IUUID(self.portal.doc1)\n         value = self.serialize(\n'

