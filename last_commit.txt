Repository: plone.volto


Branch: refs/heads/main
Date: 2024-01-06T17:36:54-08:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/f05928ae0580110d133e405d4b58109b363293ba

Avoid acquiring blocks

Files changed:
M src/plone/volto/indexers.py
M src/plone/volto/tests/test_indexers.py

b'diff --git a/src/plone/volto/indexers.py b/src/plone/volto/indexers.py\nindex 8ee37aa9..de29b524 100644\n--- a/src/plone/volto/indexers.py\n+++ b/src/plone/volto/indexers.py\n@@ -39,6 +39,7 @@ def image_field_indexer(obj):\n @indexer(IDexterityContent)\n def block_types_indexer(obj):\n     """Indexer for all block types included in a page."""\n+    obj = aq_base(obj)\n     block_types = set()\n     for block in visit_blocks(obj, obj.blocks):\n         block_type = block.get("@type")\ndiff --git a/src/plone/volto/tests/test_indexers.py b/src/plone/volto/tests/test_indexers.py\nindex c004159e..b8456aac 100644\n--- a/src/plone/volto/tests/test_indexers.py\n+++ b/src/plone/volto/tests/test_indexers.py\n@@ -77,3 +77,15 @@ def test_nested_blocks(self):\n         self.portal.doc1.reindexObject(idxs=["block_types"])\n         brains = self.catalog(block_types="teaser")\n         self.assertEqual(len(brains), 1)\n+\n+    def test_block_types_not_acquired(self):\n+        """Ensure that block_types is not acquired"""\n+        blocks = {\n+            "1": {"@type": "image", "url": ""},\n+            "2": {"@type": "teaser", "styles": {"align": "left"}},\n+        }\n+        self.portal.doc1.blocks = blocks\n+        self.portal.doc1.reindexObject(idxs=["block_types"])\n+        self.portal.doc1.invokeFactory("Image", "image-1")\n+        brains = self.catalog(block_types="image")\n+        self.assertEqual(len(brains), 1)\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2024-01-06T17:38:16-08:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/5c8f809831179148578215534d99416ee969dbd5

changelog

Files changed:
A news/137.bugfix

b'diff --git a/news/137.bugfix b/news/137.bugfix\nnew file mode 100644\nindex 0000000..a7f5e23\n--- /dev/null\n+++ b/news/137.bugfix\n@@ -0,0 +1 @@\n+Avoid accidental acquisition in block_types indexer. @davisagli\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2024-01-06T17:43:11-08:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/78a6ff8d6e54aafd7f07e4bdade5fccfbd2a5f05

mention the block_types index in the readme

Files changed:
M README.rst

b'diff --git a/README.rst b/README.rst\nindex 06ab223..c78af32 100644\n--- a/README.rst\n+++ b/README.rst\n@@ -94,6 +94,19 @@ Volto Blocks Support\n plone.volto enables the new Volto Blocks editor on ``Document``, ``Language Root Folder`` and ``Site Root``.\n \n \n+Block Types Index\n+-----------------\n+\n+plone.volto adds a ``block_types`` index to the Plone catalog.\n+It can be used to query for items that use a particular type of block::\n+\n+  portal_catalog.searchResults(block_types="image")\n+\n+The ``block_types`` index was added in plone.volto 4.1.0.\n+By default it is only added for new Plone sites.\n+To add it to an existing site, run ``plone.volto.upgrades.add_block_types_index`` manually.\n+\n+\n Multilingual Support\n --------------------\n \n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2024-01-07T19:30:32-08:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/1248f658a615d111cc837d4af88089a9e3eeae67

sentence case for all headings

Files changed:
M README.rst

b'diff --git a/README.rst b/README.rst\nindex c78af32..ed52462 100644\n--- a/README.rst\n+++ b/README.rst\n@@ -55,7 +55,7 @@ You can still use 2.x in p.restapi 7.0.0 based installations but the transforms\n \n Volto only supports the latest plone.restapi branch, therefore it is recommended to always use the latest version in your Volto projects.\n \n-Plone 6 Architecture\n+Plone 6 architecture\n ====================\n \n Architectural Diagram of Plone 6::\n@@ -88,13 +88,13 @@ Features\n plone.volto provides the following features:\n \n \n-Volto Blocks Support\n+Volto blocks support\n --------------------\n \n plone.volto enables the new Volto Blocks editor on ``Document``, ``Language Root Folder`` and ``Site Root``.\n \n \n-Block Types Index\n+Block types index\n -----------------\n \n plone.volto adds a ``block_types`` index to the Plone catalog.\n@@ -107,7 +107,7 @@ By default it is only added for new Plone sites.\n To add it to an existing site, run ``plone.volto.upgrades.add_block_types_index`` manually.\n \n \n-Multilingual Support\n+Multilingual support\n --------------------\n \n plone.volto supports multilingual websites.\n@@ -115,7 +115,7 @@ Install PAM before installing this package and demo homepages will be created in\n Currently only support for EN/DE.\n \n \n-Volto Blocks for Plone Site Root\n+Volto blocks for Plone site root\n --------------------------------\n \n plone.volto contains a hack to make the Plone site Volto blocks-enabled with some demo content.\n@@ -141,7 +141,7 @@ corresponding Language Root Folders) is "draftJS" text block. ``plone.volto`` pr\n profile if you want to create Slate blocks: you need to use the ``default-homepage-slate``\n profile.\n \n-Document Content Type\n+Document content type\n ---------------------\n \n plone.volto disables the ``Richtext`` and ``Table of Contents`` behaviors for the ``Document`` content type.\n@@ -149,7 +149,7 @@ Rich Text functionality is provided by the new Volto Blocks editor.\n The ``Table of Contents`` functionality is provided by the ``Table of Contents Block`` in Volto.\n \n \n-CORS Profile\n+CORS profile\n ------------\n \n A quick helper for enable CORS for development config is also provided in the\n@@ -165,7 +165,7 @@ productions sites.\n It\'s planned that Volto will feature a development pass-through proxy to the backend in\n the future. It will be addressed in next sprints.\n \n-ZLog Patch\n+ZLog patch\n ----------\n \n p.restapi low level errors are routed through the ancient ZLog and are ``plone_error``\n@@ -174,7 +174,7 @@ using helpers like Sentry. This patch removes the UUID so the same error is cate\n all together. This is planned to be addressed in next sprints.\n \n \n-Patch for ``subject`` Field\n+Patch for ``subject`` field\n ---------------------------\n \n There are some problems of serialization on special characters derivated from how the\n@@ -183,7 +183,7 @@ addressed in order to make it work properly with Volto (and other systems that a\n Plone). This will be fixed in core in upcoming sprints.\n \n \n-Preview Image Behavior\n+Preview image behavior\n ----------------------\n \n The preview image behavior makes content types provide a ``preview_image`` field that can store a preview image that Volto views can pick up.\n@@ -208,7 +208,7 @@ The ``volto.preview_image`` behavior can be enabled in the generic setup XML def\n There is also another variation of the preview image behavior called ``volto.preview_image_link``.\n This one stores preview images using a relation to an Image content type, rather than in an image field. This might be preferable if many content items use the same preview image.\n \n-Navigation Title Behavior\n+Navigation title behavior\n -------------------------\n \n The navigation title makes content types provide a nav_title field that is used by Volto in the main navigation, the breadcrumbs and the navigation portlet.\n@@ -230,7 +230,7 @@ The "volto.navtitle behavior can be enabled in the generic setup XML definition\n    </object>\n \n \n-Head Title Behavior\n+Head title behavior\n -------------------\n \n The headtitle makes content types provide a headtitle field that can be used by Volto in teasers and alikes.\n@@ -252,7 +252,7 @@ The "volto.head_title" behavior can be enabled in the generic setup XML definiti\n    </object>\n \n \n-Image Scales\n+Image scales\n ------------\n \n This package introduces new Plone image scales in Plone and redefines a couple of\n@@ -273,7 +273,7 @@ existing ones. These are know to work well with Volto layout and grid system::\n sure your add-on\'s profiles are applied AFTER this one.**\n \n \n-Credits and History\n+Credits and history\n -------------------\n \n .. image:: https://kitconcept.com/logo.svg\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2024-01-07T19:32:58-08:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/c625502afbc0271feefbce8fb89dac7ac417577a

Apply suggestions from code review

Co-authored-by: Steve Piercy &lt;web@stevepiercy.com&gt;

Files changed:
M README.rst

b'diff --git a/README.rst b/README.rst\nindex ed52462..85a8fed 100644\n--- a/README.rst\n+++ b/README.rst\n@@ -98,11 +98,13 @@ Block types index\n -----------------\n \n plone.volto adds a ``block_types`` index to the Plone catalog.\n-It can be used to query for items that use a particular type of block::\n+It can be used to query for items that use a particular type of block.\n \n-  portal_catalog.searchResults(block_types="image")\n+.. code-block:: python\n \n-The ``block_types`` index was added in plone.volto 4.1.0.\n+    portal_catalog.searchResults(block_types="image")\n+\n+.. versionadded:: 4.1.0\n By default it is only added for new Plone sites.\n To add it to an existing site, run ``plone.volto.upgrades.add_block_types_index`` manually.\n \n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2024-01-07T19:35:05-08:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/409e5c7919eb98ad6f972cac2d90dd67e9164883

Update README.rst

Files changed:
M README.rst

b'diff --git a/README.rst b/README.rst\nindex 85a8fed..b7a17d0 100644\n--- a/README.rst\n+++ b/README.rst\n@@ -104,7 +104,7 @@ It can be used to query for items that use a particular type of block.\n \n     portal_catalog.searchResults(block_types="image")\n \n-.. versionadded:: 4.1.0\n+The ``block_types`` index was added in plone.volto 4.1.0.\n By default it is only added for new Plone sites.\n To add it to an existing site, run ``plone.volto.upgrades.add_block_types_index`` manually.\n \n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2024-01-07T19:41:33-08:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/782630238ae93db5a5f23c714f4dc176a42991e5

Update README.rst

Files changed:
M README.rst

b'diff --git a/README.rst b/README.rst\nindex b7a17d0..e51cfa4 100644\n--- a/README.rst\n+++ b/README.rst\n@@ -102,6 +102,8 @@ It can be used to query for items that use a particular type of block.\n \n .. code-block:: python\n \n+    from plone import api\n+    portal_catalog = api.portal.get_tool("portal_catalog")\n     portal_catalog.searchResults(block_types="image")\n \n The ``block_types`` index was added in plone.volto 4.1.0.\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2024-01-08T07:57:07-08:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/71847e3fbea0d57517f42ef13fe00cf62a75c6e8

Update news/137.bugfix

Co-authored-by: Steve Piercy &lt;web@stevepiercy.com&gt;

Files changed:
M news/137.bugfix

b'diff --git a/news/137.bugfix b/news/137.bugfix\nindex a7f5e23..88b5ed8 100644\n--- a/news/137.bugfix\n+++ b/news/137.bugfix\n@@ -1 +1 @@\n-Avoid accidental acquisition in block_types indexer. @davisagli\n+Avoid accidental acquisition in ``block_types`` indexer. @davisagli\n'

Repository: plone.volto


Branch: refs/heads/main
Date: 2024-01-08T22:01:29-08:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/2898395a51bafcded1d2cfed5d6170f7e4fe1021

Merge pull request #137 from plone/fix-block-types-aq

Avoid accidental acquisition in block_types indexer

Files changed:
A news/137.bugfix
M README.rst
M src/plone/volto/indexers.py
M src/plone/volto/tests/test_indexers.py

b'diff --git a/README.rst b/README.rst\nindex 06ab223f..e51cfa4d 100644\n--- a/README.rst\n+++ b/README.rst\n@@ -55,7 +55,7 @@ You can still use 2.x in p.restapi 7.0.0 based installations but the transforms\n \n Volto only supports the latest plone.restapi branch, therefore it is recommended to always use the latest version in your Volto projects.\n \n-Plone 6 Architecture\n+Plone 6 architecture\n ====================\n \n Architectural Diagram of Plone 6::\n@@ -88,13 +88,30 @@ Features\n plone.volto provides the following features:\n \n \n-Volto Blocks Support\n+Volto blocks support\n --------------------\n \n plone.volto enables the new Volto Blocks editor on ``Document``, ``Language Root Folder`` and ``Site Root``.\n \n \n-Multilingual Support\n+Block types index\n+-----------------\n+\n+plone.volto adds a ``block_types`` index to the Plone catalog.\n+It can be used to query for items that use a particular type of block.\n+\n+.. code-block:: python\n+\n+    from plone import api\n+    portal_catalog = api.portal.get_tool("portal_catalog")\n+    portal_catalog.searchResults(block_types="image")\n+\n+The ``block_types`` index was added in plone.volto 4.1.0.\n+By default it is only added for new Plone sites.\n+To add it to an existing site, run ``plone.volto.upgrades.add_block_types_index`` manually.\n+\n+\n+Multilingual support\n --------------------\n \n plone.volto supports multilingual websites.\n@@ -102,7 +119,7 @@ Install PAM before installing this package and demo homepages will be created in\n Currently only support for EN/DE.\n \n \n-Volto Blocks for Plone Site Root\n+Volto blocks for Plone site root\n --------------------------------\n \n plone.volto contains a hack to make the Plone site Volto blocks-enabled with some demo content.\n@@ -128,7 +145,7 @@ corresponding Language Root Folders) is "draftJS" text block. ``plone.volto`` pr\n profile if you want to create Slate blocks: you need to use the ``default-homepage-slate``\n profile.\n \n-Document Content Type\n+Document content type\n ---------------------\n \n plone.volto disables the ``Richtext`` and ``Table of Contents`` behaviors for the ``Document`` content type.\n@@ -136,7 +153,7 @@ Rich Text functionality is provided by the new Volto Blocks editor.\n The ``Table of Contents`` functionality is provided by the ``Table of Contents Block`` in Volto.\n \n \n-CORS Profile\n+CORS profile\n ------------\n \n A quick helper for enable CORS for development config is also provided in the\n@@ -152,7 +169,7 @@ productions sites.\n It\'s planned that Volto will feature a development pass-through proxy to the backend in\n the future. It will be addressed in next sprints.\n \n-ZLog Patch\n+ZLog patch\n ----------\n \n p.restapi low level errors are routed through the ancient ZLog and are ``plone_error``\n@@ -161,7 +178,7 @@ using helpers like Sentry. This patch removes the UUID so the same error is cate\n all together. This is planned to be addressed in next sprints.\n \n \n-Patch for ``subject`` Field\n+Patch for ``subject`` field\n ---------------------------\n \n There are some problems of serialization on special characters derivated from how the\n@@ -170,7 +187,7 @@ addressed in order to make it work properly with Volto (and other systems that a\n Plone). This will be fixed in core in upcoming sprints.\n \n \n-Preview Image Behavior\n+Preview image behavior\n ----------------------\n \n The preview image behavior makes content types provide a ``preview_image`` field that can store a preview image that Volto views can pick up.\n@@ -195,7 +212,7 @@ The ``volto.preview_image`` behavior can be enabled in the generic setup XML def\n There is also another variation of the preview image behavior called ``volto.preview_image_link``.\n This one stores preview images using a relation to an Image content type, rather than in an image field. This might be preferable if many content items use the same preview image.\n \n-Navigation Title Behavior\n+Navigation title behavior\n -------------------------\n \n The navigation title makes content types provide a nav_title field that is used by Volto in the main navigation, the breadcrumbs and the navigation portlet.\n@@ -217,7 +234,7 @@ The "volto.navtitle behavior can be enabled in the generic setup XML definition\n    </object>\n \n \n-Head Title Behavior\n+Head title behavior\n -------------------\n \n The headtitle makes content types provide a headtitle field that can be used by Volto in teasers and alikes.\n@@ -239,7 +256,7 @@ The "volto.head_title" behavior can be enabled in the generic setup XML definiti\n    </object>\n \n \n-Image Scales\n+Image scales\n ------------\n \n This package introduces new Plone image scales in Plone and redefines a couple of\n@@ -260,7 +277,7 @@ existing ones. These are know to work well with Volto layout and grid system::\n sure your add-on\'s profiles are applied AFTER this one.**\n \n \n-Credits and History\n+Credits and history\n -------------------\n \n .. image:: https://kitconcept.com/logo.svg\ndiff --git a/news/137.bugfix b/news/137.bugfix\nnew file mode 100644\nindex 00000000..88b5ed82\n--- /dev/null\n+++ b/news/137.bugfix\n@@ -0,0 +1 @@\n+Avoid accidental acquisition in ``block_types`` indexer. @davisagli\ndiff --git a/src/plone/volto/indexers.py b/src/plone/volto/indexers.py\nindex 8ee37aa9..de29b524 100644\n--- a/src/plone/volto/indexers.py\n+++ b/src/plone/volto/indexers.py\n@@ -39,6 +39,7 @@ def image_field_indexer(obj):\n @indexer(IDexterityContent)\n def block_types_indexer(obj):\n     """Indexer for all block types included in a page."""\n+    obj = aq_base(obj)\n     block_types = set()\n     for block in visit_blocks(obj, obj.blocks):\n         block_type = block.get("@type")\ndiff --git a/src/plone/volto/tests/test_indexers.py b/src/plone/volto/tests/test_indexers.py\nindex c004159e..b8456aac 100644\n--- a/src/plone/volto/tests/test_indexers.py\n+++ b/src/plone/volto/tests/test_indexers.py\n@@ -77,3 +77,15 @@ def test_nested_blocks(self):\n         self.portal.doc1.reindexObject(idxs=["block_types"])\n         brains = self.catalog(block_types="teaser")\n         self.assertEqual(len(brains), 1)\n+\n+    def test_block_types_not_acquired(self):\n+        """Ensure that block_types is not acquired"""\n+        blocks = {\n+            "1": {"@type": "image", "url": ""},\n+            "2": {"@type": "teaser", "styles": {"align": "left"}},\n+        }\n+        self.portal.doc1.blocks = blocks\n+        self.portal.doc1.reindexObject(idxs=["block_types"])\n+        self.portal.doc1.invokeFactory("Image", "image-1")\n+        brains = self.catalog(block_types="image")\n+        self.assertEqual(len(brains), 1)\n'

