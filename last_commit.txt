Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2020-09-16T23:56:57+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/d9acfad68f69d1e9efa3e7662baad4509a362a50

Added option clear-untrusted-proxy-headers, with default false.

See [waitress documentation](https://waitress.readthedocs.io/en/latest/arguments.html?highlight=clear_untrusted_proxy_headers).
Fixes a [deprecation warning](https://github.com/plone/plone.recipe.zope2instance/issues/142).
Note that waitress 2 will change the default to true, but it looks like we would need to add other options then.

Files changed:
A news/142.feature
M README.rst
M src/plone/recipe/zope2instance/recipe.py
M src/plone/recipe/zope2instance/wsgischema.xml

b'diff --git a/README.rst b/README.rst\nindex bb4a09d..1d82d08 100644\n--- a/README.rst\n+++ b/README.rst\n@@ -6,10 +6,10 @@ Introduction\n \n .. image:: http://img.shields.io/travis/plone/plone.recipe.zope2instance.svg\n    :target: https://travis-ci.org/plone/plone.recipe.zope2instance\n-   \n+\n .. image:: https://github.com/plone/plone.recipe.zope2instance/workflows/Test/badge.svg?branch=master\n    :target: https://github.com/plone/plone.recipe.zope2instance/actions?query=workflow%3ATest+branch%3Amaster\n-   \n+\n This recipe creates and configures a Zope instance in parts.\n (Despite its name it nowadays only works for Zope 4+.) It also\n installs a control script, which is like zopectl, in the bin/ directory.\n@@ -494,6 +494,17 @@ client-home\n   Sets the clienthome for the generated instance.\n   Defaults to ${buildout:directory}/var/<name of the section>.\n \n+clear-untrusted-proxy-headers\n+  This tells Waitress to remove any untrusted proxy headers\n+  ("Forwarded", "X-Forwarded-For", "X-Forwarded-By",\n+  "X-Forwarded-Host", "X-Forwarded-Port", "X-Forwarded-Proto").\n+  The default in waitress 1 is false, but waitress 2 changes this to true.\n+  We explicitly default to false.\n+  When you set it to true, you may need to set other ``wsgi.ini`` options like\n+  ``trusted_proxy_headers`` and ``trusted_proxy``.\n+  Setting those is not supported by the recipe yet.\n+  Used for WSGI only, not ZServer.\n+\n default-zpublisher-encoding\n   This controls what character set is used to encode unicode data that reaches\n   ZPublisher without any other specified encoding. This defaults to \'utf-8\'.\ndiff --git a/news/142.feature b/news/142.feature\nnew file mode 100644\nindex 0000000..71cb4df\n--- /dev/null\n+++ b/news/142.feature\n@@ -0,0 +1,4 @@\n+Added option ``clear-untrusted-proxy-headers``, with default false.\n+See `waitress documentation <https://waitress.readthedocs.io/en/latest/arguments.html?highlight=clear_untrusted_proxy_headers>`_.\n+Fixes a `deprecation warning <https://github.com/plone/plone.recipe.zope2instance/issues/142>`_.\n+[maurits]\ndiff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex 8c3e7b0..0751b1b 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -789,6 +789,8 @@ def build_wsgi_ini(self):\n         sentry_event_level = options.get(\'sentry_event_level\', \'ERROR\')\n         sentry_ignore = options.get(\'sentry_ignore\', \'\')\n \n+        clear_untrusted_proxy_headers = options.get(\'clear-untrusted-proxy-headers\', \'false\')\n+\n         pipeline.append(\'zope\')\n         pipeline = \'\\n    \'.join(pipeline)\n         wsgi_options = {\n@@ -797,6 +799,7 @@ def build_wsgi_ini(self):\n             \'accesslog_kwargs\': accesslog_kwargs,\n             \'accesslog_level\': accesslog_level,\n             \'accesslog_name\': accesslog_name,\n+            \'clear_untrusted_proxy_headers\': clear_untrusted_proxy_headers,\n             \'event_handlers\': event_handlers,\n             \'eventlog_args\': eventlog_args,\n             \'eventlog_handler\': eventlog_handler,\n@@ -1368,12 +1371,14 @@ def render_file_storage(self, file_storage, blob_storage,\n use = egg:plone.recipe.zope2instance#main\n %(fast-listen)slisten = %(http_address)s\n threads = %(threads)s\n+clear_untrusted_proxy_headers = %(clear_untrusted_proxy_headers)s\n """\n \n wsgi_server_main_templates[\'win32\'] = """\\\n use = egg:waitress#main\n host = %(listen_ip)s\n port = %(listen_port)s\n+clear_untrusted_proxy_headers = %(clear_untrusted_proxy_headers)s\n """\n \n wsgi_ini_template = """\\\ndiff --git a/src/plone/recipe/zope2instance/wsgischema.xml b/src/plone/recipe/zope2instance/wsgischema.xml\nindex 72da16c..368cd87 100644\n--- a/src/plone/recipe/zope2instance/wsgischema.xml\n+++ b/src/plone/recipe/zope2instance/wsgischema.xml\n@@ -33,17 +33,17 @@\n     <multikey name="mount-point" required="yes" attribute="mount_points"\n               datatype=".mount_point">\n       <description>\n-       The mount point is a slash-separated path to a \n-       \'Products.ZODBMountPoint.Mount.MountPoint\' instance in Zope. If \n-       such an instance exists, it can mount an object (the mounted \n+       The mount point is a slash-separated path to a\n+       \'Products.ZODBMountPoint.Mount.MountPoint\' instance in Zope. If\n+       such an instance exists, it can mount an object (the mounted\n        object) into Zope.\n        By default, the object will be mounted at the same path in Zope (i.e.\n        \'/foo/bar\' in the database will be mounted at \'/foo/bar\' in Zope).\n \n        The object can be mounted at a different point using the\n-       \'virtual_path:real_path\' syntax (e.g.  \'mount-point /foo/bar:/bar\' \n-       will mount the object at \'/bar\' in the database to \'/foo/bar\' in \n-       Zope). The name of the mount point (\'bar\') must be the same as \n+       \'virtual_path:real_path\' syntax (e.g.  \'mount-point /foo/bar:/bar\'\n+       will mount the object at \'/bar\' in the database to \'/foo/bar\' in\n+       Zope). The name of the mount point (\'bar\') must be the same as\n        the mounted object.\n \n        It is also possible to specify the root that should be used in the\n@@ -378,6 +378,17 @@\n      <metadefault>unset</metadefault>\n   </multikey>\n \n+  <key name="clear-untrusted-proxy-headers" datatype="boolean"\n+       default="on">\n+     <description>\n+     This tells Waitress to remove any untrusted proxy headers\n+     ("Forwarded", "X-Forwarded-For", "X-Forwarded-By",\n+     "X-Forwarded-Host", "X-Forwarded-Port", "X-Forwarded-Proto")\n+     not explicitly allowed by trusted_proxy_headers.\n+     </description>\n+     <metadefault>on</metadefault>\n+  </key>\n+\n   <key name="max-conflict-retries" datatype="integer" default="3"\n        attribute="max_conflict_retries">\n     <description>\n'

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2020-09-17T00:10:28+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/a38c1fc5049ecdcacd0f5b83d91ecf5b51f56602

Fixed flake8

Files changed:
M src/plone/recipe/zope2instance/recipe.py

b"diff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex 0751b1b..888ce45 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -789,7 +789,9 @@ def build_wsgi_ini(self):\n         sentry_event_level = options.get('sentry_event_level', 'ERROR')\n         sentry_ignore = options.get('sentry_ignore', '')\n \n-        clear_untrusted_proxy_headers = options.get('clear-untrusted-proxy-headers', 'false')\n+        clear_untrusted_proxy_headers = options.get(\n+            'clear-untrusted-proxy-headers', 'false'\n+        )\n \n         pipeline.append('zope')\n         pipeline = '\\n    '.join(pipeline)\n"

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2020-09-17T09:24:05+02:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/2c8a5c3547c54042811be83dddc6e27c31bc8f28

Merge pull request #154 from plone/maurits/issue-142-clear-untrusted-proxy-headers

Added option clear-untrusted-proxy-headers, with default false.

Files changed:
A news/142.feature
M README.rst
M src/plone/recipe/zope2instance/recipe.py
M src/plone/recipe/zope2instance/wsgischema.xml

b'diff --git a/README.rst b/README.rst\nindex bb4a09d..1d82d08 100644\n--- a/README.rst\n+++ b/README.rst\n@@ -6,10 +6,10 @@ Introduction\n \n .. image:: http://img.shields.io/travis/plone/plone.recipe.zope2instance.svg\n    :target: https://travis-ci.org/plone/plone.recipe.zope2instance\n-   \n+\n .. image:: https://github.com/plone/plone.recipe.zope2instance/workflows/Test/badge.svg?branch=master\n    :target: https://github.com/plone/plone.recipe.zope2instance/actions?query=workflow%3ATest+branch%3Amaster\n-   \n+\n This recipe creates and configures a Zope instance in parts.\n (Despite its name it nowadays only works for Zope 4+.) It also\n installs a control script, which is like zopectl, in the bin/ directory.\n@@ -494,6 +494,17 @@ client-home\n   Sets the clienthome for the generated instance.\n   Defaults to ${buildout:directory}/var/<name of the section>.\n \n+clear-untrusted-proxy-headers\n+  This tells Waitress to remove any untrusted proxy headers\n+  ("Forwarded", "X-Forwarded-For", "X-Forwarded-By",\n+  "X-Forwarded-Host", "X-Forwarded-Port", "X-Forwarded-Proto").\n+  The default in waitress 1 is false, but waitress 2 changes this to true.\n+  We explicitly default to false.\n+  When you set it to true, you may need to set other ``wsgi.ini`` options like\n+  ``trusted_proxy_headers`` and ``trusted_proxy``.\n+  Setting those is not supported by the recipe yet.\n+  Used for WSGI only, not ZServer.\n+\n default-zpublisher-encoding\n   This controls what character set is used to encode unicode data that reaches\n   ZPublisher without any other specified encoding. This defaults to \'utf-8\'.\ndiff --git a/news/142.feature b/news/142.feature\nnew file mode 100644\nindex 0000000..71cb4df\n--- /dev/null\n+++ b/news/142.feature\n@@ -0,0 +1,4 @@\n+Added option ``clear-untrusted-proxy-headers``, with default false.\n+See `waitress documentation <https://waitress.readthedocs.io/en/latest/arguments.html?highlight=clear_untrusted_proxy_headers>`_.\n+Fixes a `deprecation warning <https://github.com/plone/plone.recipe.zope2instance/issues/142>`_.\n+[maurits]\ndiff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex 8c3e7b0..888ce45 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -789,6 +789,10 @@ def build_wsgi_ini(self):\n         sentry_event_level = options.get(\'sentry_event_level\', \'ERROR\')\n         sentry_ignore = options.get(\'sentry_ignore\', \'\')\n \n+        clear_untrusted_proxy_headers = options.get(\n+            \'clear-untrusted-proxy-headers\', \'false\'\n+        )\n+\n         pipeline.append(\'zope\')\n         pipeline = \'\\n    \'.join(pipeline)\n         wsgi_options = {\n@@ -797,6 +801,7 @@ def build_wsgi_ini(self):\n             \'accesslog_kwargs\': accesslog_kwargs,\n             \'accesslog_level\': accesslog_level,\n             \'accesslog_name\': accesslog_name,\n+            \'clear_untrusted_proxy_headers\': clear_untrusted_proxy_headers,\n             \'event_handlers\': event_handlers,\n             \'eventlog_args\': eventlog_args,\n             \'eventlog_handler\': eventlog_handler,\n@@ -1368,12 +1373,14 @@ def render_file_storage(self, file_storage, blob_storage,\n use = egg:plone.recipe.zope2instance#main\n %(fast-listen)slisten = %(http_address)s\n threads = %(threads)s\n+clear_untrusted_proxy_headers = %(clear_untrusted_proxy_headers)s\n """\n \n wsgi_server_main_templates[\'win32\'] = """\\\n use = egg:waitress#main\n host = %(listen_ip)s\n port = %(listen_port)s\n+clear_untrusted_proxy_headers = %(clear_untrusted_proxy_headers)s\n """\n \n wsgi_ini_template = """\\\ndiff --git a/src/plone/recipe/zope2instance/wsgischema.xml b/src/plone/recipe/zope2instance/wsgischema.xml\nindex 72da16c..368cd87 100644\n--- a/src/plone/recipe/zope2instance/wsgischema.xml\n+++ b/src/plone/recipe/zope2instance/wsgischema.xml\n@@ -33,17 +33,17 @@\n     <multikey name="mount-point" required="yes" attribute="mount_points"\n               datatype=".mount_point">\n       <description>\n-       The mount point is a slash-separated path to a \n-       \'Products.ZODBMountPoint.Mount.MountPoint\' instance in Zope. If \n-       such an instance exists, it can mount an object (the mounted \n+       The mount point is a slash-separated path to a\n+       \'Products.ZODBMountPoint.Mount.MountPoint\' instance in Zope. If\n+       such an instance exists, it can mount an object (the mounted\n        object) into Zope.\n        By default, the object will be mounted at the same path in Zope (i.e.\n        \'/foo/bar\' in the database will be mounted at \'/foo/bar\' in Zope).\n \n        The object can be mounted at a different point using the\n-       \'virtual_path:real_path\' syntax (e.g.  \'mount-point /foo/bar:/bar\' \n-       will mount the object at \'/bar\' in the database to \'/foo/bar\' in \n-       Zope). The name of the mount point (\'bar\') must be the same as \n+       \'virtual_path:real_path\' syntax (e.g.  \'mount-point /foo/bar:/bar\'\n+       will mount the object at \'/bar\' in the database to \'/foo/bar\' in\n+       Zope). The name of the mount point (\'bar\') must be the same as\n        the mounted object.\n \n        It is also possible to specify the root that should be used in the\n@@ -378,6 +378,17 @@\n      <metadefault>unset</metadefault>\n   </multikey>\n \n+  <key name="clear-untrusted-proxy-headers" datatype="boolean"\n+       default="on">\n+     <description>\n+     This tells Waitress to remove any untrusted proxy headers\n+     ("Forwarded", "X-Forwarded-For", "X-Forwarded-By",\n+     "X-Forwarded-Host", "X-Forwarded-Port", "X-Forwarded-Proto")\n+     not explicitly allowed by trusted_proxy_headers.\n+     </description>\n+     <metadefault>on</metadefault>\n+  </key>\n+\n   <key name="max-conflict-retries" datatype="integer" default="3"\n        attribute="max_conflict_retries">\n     <description>\n'

