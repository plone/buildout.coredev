Repository: plone.testing


Branch: refs/heads/master
Date: 2024-06-17T13:52:16+02:00
Author: Godefroid Chapelle (gotcha) <gotcha@bubblenet.be>
Commit: https://github.com/plone/plone.testing/commit/0374059340e07e7f04878c2954d9938f2941f7a2

use BytesIO while setting up test Response

HTTPResponse uses bytes, not string

However, sys.stdout uses string

Files changed:
A news/fix_makeTestRequest.bugfix
M src/plone/testing/zope.py

b'diff --git a/news/fix_makeTestRequest.bugfix b/news/fix_makeTestRequest.bugfix\nnew file mode 100644\nindex 0000000..8432720\n--- /dev/null\n+++ b/news/fix_makeTestRequest.bugfix\n@@ -0,0 +1 @@\n+makeTestRequest: use BytesIO to set up the test Response. @gotcha\ndiff --git a/src/plone/testing/zope.py b/src/plone/testing/zope.py\nindex 52d9df4..2706879 100644\n--- a/src/plone/testing/zope.py\n+++ b/src/plone/testing/zope.py\n@@ -175,8 +175,8 @@ def setRoles(userFolder, userId, roles):\n \n def makeTestRequest(environ=None):\n     """Return an HTTPRequest object suitable for testing views."""\n+    from io import BytesIO\n     from sys import stdin\n-    from sys import stdout\n     from zope.publisher.browser import setDefaultSkin\n     from ZPublisher.HTTPRequest import HTTPRequest\n     from ZPublisher.HTTPResponse import HTTPResponse\n@@ -187,7 +187,7 @@ def makeTestRequest(environ=None):\n     environ.setdefault("SERVER_PORT", "80")\n     environ.setdefault("REQUEST_METHOD", "GET")\n \n-    resp = HTTPResponse(stdout=stdout)\n+    resp = HTTPResponse(stdout=BytesIO())\n     req = HTTPRequest(stdin, environ, resp)\n     req._steps = ["noobject"]  # Fake a published object.\n     req["ACTUAL_URL"] = req.get("URL")\n'

Repository: plone.testing


Branch: refs/heads/master
Date: 2024-06-18T00:42:19+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.testing/commit/23d09d2db7d53f50ec64b176f262a6a395c92b83

Merge pull request #94 from plone/fix_makeTestRequest

use BytesIO while setting up test Response

Files changed:
A news/fix_makeTestRequest.bugfix
M src/plone/testing/zope.py

b'diff --git a/news/fix_makeTestRequest.bugfix b/news/fix_makeTestRequest.bugfix\nnew file mode 100644\nindex 0000000..8432720\n--- /dev/null\n+++ b/news/fix_makeTestRequest.bugfix\n@@ -0,0 +1 @@\n+makeTestRequest: use BytesIO to set up the test Response. @gotcha\ndiff --git a/src/plone/testing/zope.py b/src/plone/testing/zope.py\nindex 52d9df4..2706879 100644\n--- a/src/plone/testing/zope.py\n+++ b/src/plone/testing/zope.py\n@@ -175,8 +175,8 @@ def setRoles(userFolder, userId, roles):\n \n def makeTestRequest(environ=None):\n     """Return an HTTPRequest object suitable for testing views."""\n+    from io import BytesIO\n     from sys import stdin\n-    from sys import stdout\n     from zope.publisher.browser import setDefaultSkin\n     from ZPublisher.HTTPRequest import HTTPRequest\n     from ZPublisher.HTTPResponse import HTTPResponse\n@@ -187,7 +187,7 @@ def makeTestRequest(environ=None):\n     environ.setdefault("SERVER_PORT", "80")\n     environ.setdefault("REQUEST_METHOD", "GET")\n \n-    resp = HTTPResponse(stdout=stdout)\n+    resp = HTTPResponse(stdout=BytesIO())\n     req = HTTPRequest(stdin, environ, resp)\n     req._steps = ["noobject"]  # Fake a published object.\n     req["ACTUAL_URL"] = req.get("URL")\n'

