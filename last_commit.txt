Repository: plone.restapi


Branch: refs/heads/main
Date: 2024-03-08T23:28:24+01:00
Author: Wesley Barroso Lopes (wesleybl) <wesleybl@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/4287932cefc9b4a6d901321b88c0b044330b2704

Use the mode parameter instead of direction when calling the scale method (#1758)

The direction parameter is deprecated. This avoids the warning:

DeprecationWarning: The 'direction' option is deprecated, use 'mode'
instead.

Also change value to scale.

Even though we get the warning in Plone 5.2, the tests fail when we use
mode. So we keep direction in Plone 5.2.

Files changed:
A news/1758.bugfix
M src/plone/restapi/__init__.py
M src/plone/restapi/imaging.py

b'diff --git a/news/1758.bugfix b/news/1758.bugfix\nnew file mode 100644\nindex 0000000000..21c323b2df\n--- /dev/null\n+++ b/news/1758.bugfix\n@@ -0,0 +1 @@\n+Use the ``mode`` parameter instead of ``direction`` when calling the ``scale`` method. Also change value to ``scale`. @wesleybl\ndiff --git a/src/plone/restapi/__init__.py b/src/plone/restapi/__init__.py\nindex 5d449ae90c..c2cd6a1bb3 100644\n--- a/src/plone/restapi/__init__.py\n+++ b/src/plone/restapi/__init__.py\n@@ -1,12 +1,14 @@\n from . import patches  # noqa: ignore=F401\n from AccessControl import allow_module\n from AccessControl.Permissions import add_user_folders\n+from importlib import import_module\n from plone.restapi.pas import plugin\n from Products.PluggableAuthService.PluggableAuthService import registerMultiPlugin\n from zope.i18nmessageid import MessageFactory\n \n import pkg_resources\n \n+\n try:\n     pkg_resources.get_distribution("plone.app.multilingual")\n     HAS_MULTILINGUAL = True\n@@ -19,6 +21,11 @@\n \n allow_module("json")\n \n+# BBB: Plone 5.2\n+HAS_PLONE_6 = getattr(\n+    import_module("Products.CMFPlone.factory"), "PLONE60MARKER", False\n+)\n+\n \n def initialize(context):\n     registerMultiPlugin(plugin.JWTAuthenticationPlugin.meta_type)\ndiff --git a/src/plone/restapi/imaging.py b/src/plone/restapi/imaging.py\nindex 087ee9f32a..984fc88fa8 100644\n--- a/src/plone/restapi/imaging.py\n+++ b/src/plone/restapi/imaging.py\n@@ -1,8 +1,17 @@\n+from plone.restapi import HAS_PLONE_6\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n from zope.globalrequest import getRequest\n \n \n+if HAS_PLONE_6:\n+    # In Plone 6.0+, we must use the mode parameter\n+    scale_parameter = {"mode": "scale"}\n+else:\n+    # BBB: In Plone 5.2, it is necessary to use the direction parameter.\n+    scale_parameter = {"direction": "thumbnail"}\n+\n+\n def get_scales(context, field, width, height):\n     """Get a dictionary of available scales for a particular image field,\n     with the actual dimensions (aspect ratio of the original image).\n@@ -51,9 +60,8 @@ def get_original_image_url(context, fieldname, width, height):\n     scale_flags = {}\n     if hasattr(images_view, "picture"):\n         scale_flags["pre"] = True\n-    scale = images_view.scale(\n-        fieldname, width=width, height=height, direction="thumbnail", **scale_flags\n-    )\n+    parameters = {**scale_flags, **scale_parameter}\n+    scale = images_view.scale(fieldname, width=width, height=height, **parameters)\n     if scale:\n         return scale.url\n     # Corrupt images may not have a scale.\n'

