Repository: plone.restapi


Branch: refs/heads/7.x.x
Date: 2022-04-30T07:05:09+02:00
Author: Fred van Dijk (fredvd) <fredvd@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/d36969a926afee4173e7fb19d1c8052aa5e0a921

Backport 1211 to 7.x.x (#1385)

* Make masking specific validation errors configurable in DX DeserializeFromJson

* Try to fix GHA test pulling in bleach 5.

* Also pin bleach for Plone 5.1/Python2.7 .  Plone 5.2.X has bleach Pinned through Zope 4.6 its versions.cfg where it is now included.

* Pin black to lower version, cherry-pick/example from 8e71637
pin click, clean up versions.cfg as in main branch
unpin plone.restapi as done on main branch

* fix awk invocation

* black 20.8b1

* Fix click pinning, Plone 5.2/Python2.7 runs fine again because of pinnings in Zope 5.  Move click and bleach to versions.cfg

Files changed:
A news/1211.feature
M .github/workflows/black.yml
M plone-4.3.x.cfg
M src/plone/restapi/deserializer/dxcontent.py
M src/plone/restapi/serializer/atcontent.py
M versions.cfg

b'diff --git a/.github/workflows/black.yml b/.github/workflows/black.yml\nindex 9b23c028b..7a82d7049 100644\n--- a/.github/workflows/black.yml\n+++ b/.github/workflows/black.yml\n@@ -26,9 +26,9 @@ jobs:\n           restore-keys: |\n             ${{ runner.os }}-pip-\n \n-      # install black\n+       # install black (extract version from versions.cfg)\n       - name: install black\n-        run: pip install black\n+        run: pip install click==$(awk \'/^click =/{print $NF}\' versions.cfg) black==$(awk \'/^black =/{print $NF}\' versions.cfg)\n \n       # run black\n       - name: run black\ndiff --git a/news/1211.feature b/news/1211.feature\nnew file mode 100644\nindex 000000000..68b1c7fb9\n--- /dev/null\n+++ b/news/1211.feature\n@@ -0,0 +1 @@\n+Make masking specific validation errors configurable in DX DeserializeFromJson. [fredvd] \n\\ No newline at end of file\ndiff --git a/plone-4.3.x.cfg b/plone-4.3.x.cfg\nindex 5d2d7136b..05921e751 100644\n--- a/plone-4.3.x.cfg\n+++ b/plone-4.3.x.cfg\n@@ -12,9 +12,6 @@ zope.interface = 4.1.0\n # Last pyrsistent version that is python 2 compatible:\n pyrsistent = 0.15.7\n \n-# Click 8.0.0 breaks in Python 2.7\n-Click = 7.1.2\n-\n # version 4 breaks in Python 2.7\n jsonschema = 3.2.0\n \ndiff --git a/src/plone/restapi/deserializer/dxcontent.py b/src/plone/restapi/deserializer/dxcontent.py\nindex d6822eaec..4f0610b2b 100644\n--- a/src/plone/restapi/deserializer/dxcontent.py\n+++ b/src/plone/restapi/deserializer/dxcontent.py\n@@ -36,7 +36,7 @@ def __init__(self, context, request):\n         self.modified = {}\n \n     def __call__(\n-        self, validate_all=False, data=None, create=False\n+        self, validate_all=False, data=None, create=False, mask_validation_errors=True\n     ):  # noqa: ignore=C901\n \n         if data is None:\n@@ -53,10 +53,11 @@ def __call__(\n                 errors.append({"error": error, "message": str(error)})\n \n         if errors:\n-            # Drop Python specific error classes in order to be able to better handle\n-            # errors on front-end\n-            for error in errors:\n-                error["error"] = "ValidationError"\n+            if mask_validation_errors:\n+                # Drop Python specific error classes in order to be able to better handle\n+                # errors on front-end\n+                for error in errors:\n+                    error["error"] = "ValidationError"\n             raise BadRequest(errors)\n \n         # We\'ll set the layout after the validation and even if there\ndiff --git a/src/plone/restapi/serializer/atcontent.py b/src/plone/restapi/serializer/atcontent.py\nindex 3cdaa9d88..4b09eb9fc 100644\n--- a/src/plone/restapi/serializer/atcontent.py\n+++ b/src/plone/restapi/serializer/atcontent.py\n@@ -71,9 +71,7 @@ def __call__(self, version=None, include_items=False):\n \n             name = field.getName()\n \n-            serializer = queryMultiAdapter(\n-                (field, obj, self.request), IFieldSerializer\n-            )\n+            serializer = queryMultiAdapter((field, obj, self.request), IFieldSerializer)\n             if serializer is not None:\n                 result[name] = serializer()\n \ndiff --git a/versions.cfg b/versions.cfg\nindex f498073f9..1b5cab13d 100644\n--- a/versions.cfg\n+++ b/versions.cfg\n@@ -2,6 +2,15 @@\n # Buildout\n setuptools =\n zc.buildout =\n+plone.restapi =\n+\n+# code analysis\n+black = 20.8b1\n+\n+# keep to these versions for Python2.7 compatibility \n+click = 7.1.2\n+bleach = 3.3.1\n+\n zc.recipe.egg = 2.0.3\n \n # fixes Getting distribution for \'configparser\'. assert newdist is not None  # newloc above is missing our dist?!\n@@ -10,9 +19,6 @@ configparser = 3.5.3\n # fixes Error: The requirement (\'Pygments>=2.5.1\') is not allowed by your [versions] constraint (2.2.0)\n Pygments = 2.5.1\n \n-# plone.recipe.varnish\n-plone.recipe.varnish = 1.3\n-\n # Code-analysis\n check-manifest = 0.41\n plone.recipe.codeanalysis = 3.0.1\n'

