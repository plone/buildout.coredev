Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2023-12-22T23:50:44+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/36039db3048934a71f30251572e1882cff585cd1

Remove Archetypes modifiers from portal_modifier early in Plone 6.0 alpha.

CMFEditions already tried to do this, but this might fail in a corner case.
See report at https://community.plone.org/t/upgrading-migrating-from-5-2-6-to-6-0-5-fails/17577
This new upgrade step basically uses the [code from the comment there](https://community.plone.org/t/upgrading-migrating-from-5-2-6-to-6-0-5-fails/17577/6?u=mauritsvanrees).

Files changed:
A news/6003.bugfix
M plone/app/upgrade/v60/alphas.py
M plone/app/upgrade/v60/configure.zcml

b'diff --git a/news/6003.bugfix b/news/6003.bugfix\nnew file mode 100644\nindex 00000000..e5946f6e\n--- /dev/null\n+++ b/news/6003.bugfix\n@@ -0,0 +1,3 @@\n+Remove Archetypes modifiers from portal_modifier early in Plone 6.0 alpha.\n+CMFEditions already tried to do this, but this might fail in a corner case.\n+[maurits]\ndiff --git a/plone/app/upgrade/v60/alphas.py b/plone/app/upgrade/v60/alphas.py\nindex badb5998..d376bb7b 100644\n--- a/plone/app/upgrade/v60/alphas.py\n+++ b/plone/app/upgrade/v60/alphas.py\n@@ -152,6 +152,34 @@ def index_siteroot(context):\n     portal.reindexObject()\n \n \n+def remove_broken_modifiers(context):\n+    """Remove Archetypes modifiers from portal_modifier.\n+\n+    For Plone 6 we have removed Archetypes support.\n+    This includes removing classes for four Archetypes modifiers.\n+    During normal usage you should not notice this.\n+    But it is still better to remove them.\n+\n+    In CMFEditions we have an upgrade step to remove them: removeBrokenModifiers.\n+    But there are reports of getting a TypeError when loading one of these modifiers\n+    when running this code, or before this code has had a chance to run.  See\n+    https://community.plone.org/t/upgrading-migrating-from-5-2-6-to-6-0-5-fails/17577\n+    So we delete them early on, especially before running fix_unicode_properties below\n+    which is where it went wrong in this report.\n+\n+    Note that the objects themselves are not really broken, but they contain an\n+    attribute \'_modifier\' that is broken and cannot be loaded.\n+    """\n+    tool = getToolByName(context, "portal_modifier", None)\n+    if tool is None:\n+        # Can\'t really happen, but this is upgrade code, so you never know.\n+        return\n+    for modifier_id in ("RetainATRefs", "NotRetainATRefs", "SkipBlobs", "CloneBlobs"):\n+        if modifier_id in tool:\n+            tool._delObject(modifier_id)\n+            logger.info("Removed outdated %s from portal_modifier.", modifier_id)\n+\n+\n def fix_unicode_properties(context):\n     """Fix unicode properties.\n \ndiff --git a/plone/app/upgrade/v60/configure.zcml b/plone/app/upgrade/v60/configure.zcml\nindex 145905af..01b3009f 100644\n--- a/plone/app/upgrade/v60/configure.zcml\n+++ b/plone/app/upgrade/v60/configure.zcml\n@@ -63,6 +63,11 @@\n         destination="6003"\n         profile="Products.CMFPlone:plone">\n \n+       <gs:upgradeStep\n+           title="Remove broken modifiers"\n+           handler=".alphas.remove_broken_modifiers"\n+           />\n+\n        <gs:upgradeStep\n            title="Fix unicode properties"\n            handler=".alphas.fix_unicode_properties"\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2024-01-03T11:39:45+01:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.upgrade/commit/c05e7c76cd7c9d09009f4276d6ca30be6c1e9f62

Merge pull request #320 from plone/maurits-remove_broken_modifiers

Remove Archetypes modifiers from portal_modifier early

Files changed:
A news/6003.bugfix
M plone/app/upgrade/v60/alphas.py
M plone/app/upgrade/v60/configure.zcml

b'diff --git a/news/6003.bugfix b/news/6003.bugfix\nnew file mode 100644\nindex 00000000..e5946f6e\n--- /dev/null\n+++ b/news/6003.bugfix\n@@ -0,0 +1,3 @@\n+Remove Archetypes modifiers from portal_modifier early in Plone 6.0 alpha.\n+CMFEditions already tried to do this, but this might fail in a corner case.\n+[maurits]\ndiff --git a/plone/app/upgrade/v60/alphas.py b/plone/app/upgrade/v60/alphas.py\nindex badb5998..d376bb7b 100644\n--- a/plone/app/upgrade/v60/alphas.py\n+++ b/plone/app/upgrade/v60/alphas.py\n@@ -152,6 +152,34 @@ def index_siteroot(context):\n     portal.reindexObject()\n \n \n+def remove_broken_modifiers(context):\n+    """Remove Archetypes modifiers from portal_modifier.\n+\n+    For Plone 6 we have removed Archetypes support.\n+    This includes removing classes for four Archetypes modifiers.\n+    During normal usage you should not notice this.\n+    But it is still better to remove them.\n+\n+    In CMFEditions we have an upgrade step to remove them: removeBrokenModifiers.\n+    But there are reports of getting a TypeError when loading one of these modifiers\n+    when running this code, or before this code has had a chance to run.  See\n+    https://community.plone.org/t/upgrading-migrating-from-5-2-6-to-6-0-5-fails/17577\n+    So we delete them early on, especially before running fix_unicode_properties below\n+    which is where it went wrong in this report.\n+\n+    Note that the objects themselves are not really broken, but they contain an\n+    attribute \'_modifier\' that is broken and cannot be loaded.\n+    """\n+    tool = getToolByName(context, "portal_modifier", None)\n+    if tool is None:\n+        # Can\'t really happen, but this is upgrade code, so you never know.\n+        return\n+    for modifier_id in ("RetainATRefs", "NotRetainATRefs", "SkipBlobs", "CloneBlobs"):\n+        if modifier_id in tool:\n+            tool._delObject(modifier_id)\n+            logger.info("Removed outdated %s from portal_modifier.", modifier_id)\n+\n+\n def fix_unicode_properties(context):\n     """Fix unicode properties.\n \ndiff --git a/plone/app/upgrade/v60/configure.zcml b/plone/app/upgrade/v60/configure.zcml\nindex 145905af..01b3009f 100644\n--- a/plone/app/upgrade/v60/configure.zcml\n+++ b/plone/app/upgrade/v60/configure.zcml\n@@ -63,6 +63,11 @@\n         destination="6003"\n         profile="Products.CMFPlone:plone">\n \n+       <gs:upgradeStep\n+           title="Remove broken modifiers"\n+           handler=".alphas.remove_broken_modifiers"\n+           />\n+\n        <gs:upgradeStep\n            title="Fix unicode properties"\n            handler=".alphas.fix_unicode_properties"\n'

