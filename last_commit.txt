Repository: plone.restapi


Branch: refs/heads/main
Date: 2023-11-04T07:13:09+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.restapi/commit/9f399ac12bd8e16fcf482533453d9e189ddf9e2a

Temporarily disable form memory limit checking for files and images. (#1729)

* Allow uploads up to 16 MB.

This fixes a regression due to a low Zope form memory limit of 1MB used since Plone 6.0.7.
You can use ``dos_protection`` settings in ``etc/zope.conf`` to change the limit.
See https://github.com/plone/Products.CMFPlone/issues/3848 and https://github.com/zopefoundation/Zope/pull/1142.

* Changed patch: temporarily disable form memory limit checking for files and images.

This seems a better way, then increasing the limit to 16MB.
See https://github.com/zopefoundation/Zope/pull/1180#issuecomment-1790638748

Files changed:
A news/3848.bugfix
A src/plone/restapi/patches.py
M src/plone/restapi/__init__.py
M src/plone/restapi/deserializer/__init__.py

b'diff --git a/news/3848.bugfix b/news/3848.bugfix\nnew file mode 100644\nindex 0000000000..d08ef02802\n--- /dev/null\n+++ b/news/3848.bugfix\n@@ -0,0 +1,4 @@\n+Temporarily disable form memory limit checking for files and images.\n+This fixes a regression due to a low Zope form memory limit of 1MB used since Plone 6.0.7.\n+See `CMFPlone issue 3848 <https://github.com/plone/Products.CMFPlone/issues/3848>`_ and `Zope PR 1142 <https://github.com/zopefoundation/Zope/pull/1142>`_.\n+@maurits\ndiff --git a/src/plone/restapi/__init__.py b/src/plone/restapi/__init__.py\nindex ba8cb16047..5d449ae90c 100644\n--- a/src/plone/restapi/__init__.py\n+++ b/src/plone/restapi/__init__.py\n@@ -1,3 +1,4 @@\n+from . import patches  # noqa: ignore=F401\n from AccessControl import allow_module\n from AccessControl.Permissions import add_user_folders\n from plone.restapi.pas import plugin\ndiff --git a/src/plone/restapi/deserializer/__init__.py b/src/plone/restapi/deserializer/__init__.py\nindex cb790cb704..a5112dae93 100644\n--- a/src/plone/restapi/deserializer/__init__.py\n+++ b/src/plone/restapi/deserializer/__init__.py\n@@ -4,6 +4,9 @@\n \n \n def json_body(request):\n+    # TODO We should not read the complete request BODY in memory.\n+    # Once we have fixed this, we can remove the temporary patches.py.\n+    # See there for background information.\n     try:\n         data = json.loads(request.get("BODY") or "{}")\n     except ValueError:\ndiff --git a/src/plone/restapi/patches.py b/src/plone/restapi/patches.py\nnew file mode 100644\nindex 0000000000..ddf3b27a24\n--- /dev/null\n+++ b/src/plone/restapi/patches.py\n@@ -0,0 +1,20 @@\n+# TEMPORARY patch for low form memory limit introduced in Zope 5.8.4.\n+# See https://github.com/plone/Products.CMFPlone/issues/3848\n+# and https://github.com/zopefoundation/Zope/pull/1180\n+# Should be removed once `plone.restapi.deserializer.json_body` no longer\n+# reads the complete request BODY in memory.\n+from ZPublisher.HTTPRequest import ZopeFieldStorage\n+\n+import logging\n+\n+\n+logger = logging.getLogger(__name__)\n+_attr = "VALUE_LIMIT"\n+_limit = getattr(ZopeFieldStorage, _attr, None)\n+if _limit:\n+    setattr(ZopeFieldStorage, _attr, None)\n+    logger.info(\n+        "PATCH: Disabled ZPublisher.HTTPRequest.ZopeFieldStorage.%s. "\n+        "This enables file uploads larger than 1MB.",\n+        _attr,\n+    )\n'

