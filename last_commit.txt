Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2024-06-15T13:59:22+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/f9b614e177c20242cc647dccafb89ee622e6e321

Plone upgrade page: show error when upgrade is needed but no upgrades are available.

Especially show a note when the `plone.app.upgrade` package is not available.

Files changed:
A news/3975.bugfix.1
M Products/CMFPlone/browser/admin.py
M Products/CMFPlone/browser/templates/plone-upgrade.pt

b'diff --git a/Products/CMFPlone/browser/admin.py b/Products/CMFPlone/browser/admin.py\nindex 6c96868982..11041acbcc 100644\n--- a/Products/CMFPlone/browser/admin.py\n+++ b/Products/CMFPlone/browser/admin.py\n@@ -1,6 +1,8 @@\n from AccessControl import getSecurityManager\n from AccessControl.Permissions import view as View\n from collections import OrderedDict\n+from importlib.metadata import distribution\n+from importlib.metadata import PackageNotFoundError\n from OFS.interfaces import IApplication\n from plone.base.interfaces import INonInstallable\n from plone.base.interfaces import IPloneSiteRoot\n@@ -35,14 +37,18 @@\n from ZPublisher.BaseRequest import DefaultPublishTraverse\n \n import logging\n-import pkg_resources\n \n \n try:\n-    pkg_resources.get_distribution("plone.volto")\n+    distribution("plone.volto")\n     HAS_VOLTO = True\n-except pkg_resources.DistributionNotFound:\n+except PackageNotFoundError:\n     HAS_VOLTO = False\n+try:\n+    distribution("plone.app.upgrade")\n+    HAS_UPGRADE = True\n+except PackageNotFoundError:\n+    HAS_UPGRADE = False\n LOGGER = logging.getLogger("Products.CMFPlone")\n \n \n@@ -313,6 +319,8 @@ def __call__(self):\n \n \n class Upgrade(BrowserView):\n+    has_upgrade = HAS_UPGRADE\n+\n     def upgrades(self):\n         pm = getattr(self.context, "portal_migration")\n         return pm.listUpgrades()\ndiff --git a/Products/CMFPlone/browser/templates/plone-upgrade.pt b/Products/CMFPlone/browser/templates/plone-upgrade.pt\nindex 9b9cdecc7d..9b57974ae9 100644\n--- a/Products/CMFPlone/browser/templates/plone-upgrade.pt\n+++ b/Products/CMFPlone/browser/templates/plone-upgrade.pt\n@@ -21,6 +21,7 @@\n \n <body id="plone-upgrade-screen"\n       tal:define="versions view/versions;\n+                  upgrades view/upgrades;\n                   report options/report|nothing;">\n \n     <div class="container admin mt-5 mb-5 p-4">\n@@ -101,7 +102,7 @@\n           </p>\n \n           <dl class="mb-4">\n-            <tal:block tal:repeat="upgrade_info view/upgrades">\n+            <tal:block tal:repeat="upgrade_info upgrades">\n \n                 <tal:single condition="python:not isinstance(upgrade_info, list)"\n                             define="info upgrade_info">\n@@ -144,9 +145,20 @@\n           </div>\n         </div>\n \n+        <p class="alert alert-danger p-2" tal:condition="not:upgrades">\n+          <span i18n:translate="msg_no_upgrades">\n+            No upgrade steps are available.\n+          </span>\n+          <strong tal:condition="not:view/has_upgrade"\n+                i18n:translate="msg_plone_app_upgrade_missing">\n+            The plone.app.upgrade package is missing.\n+          </strong>\n+        </p>\n+\n         <input type="hidden" name="form.submitted:boolean" value="True" />\n         <button type="submit"\n                 name="submit"\n+                tal:attributes="disabled python:\'disabled\' if not upgrades else \'\'"\n                 class="btn btn-primary"\n                 i18n:translate="" >Upgrade</button>\n     </form>\ndiff --git a/news/3975.bugfix.1 b/news/3975.bugfix.1\nnew file mode 100644\nindex 0000000000..e93d7ef4ab\n--- /dev/null\n+++ b/news/3975.bugfix.1\n@@ -0,0 +1,3 @@\n+Plone upgrade page: show error when upgrade is needed but no upgrades are available.\n+Especially show a note when the `plone.app.upgrade` package is not available.\n+[maurits]\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2024-06-15T13:59:22+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/4ce1211f818d90e383cbf74d0e37c7a30cf6e628

Plone upgrade page: show list of previously installed packages that are currently missing.

For example: `plone.app.discussion` may be missing in Plone 6.1, unless you explicitly add it, or depend on the `Plone` package.

Files changed:
A news/3975.bugfix.2
M Products/CMFPlone/browser/admin.py
M Products/CMFPlone/browser/templates/plone-upgrade.pt

b'diff --git a/Products/CMFPlone/browser/admin.py b/Products/CMFPlone/browser/admin.py\nindex 11041acbcc..e6273a812a 100644\n--- a/Products/CMFPlone/browser/admin.py\n+++ b/Products/CMFPlone/browser/admin.py\n@@ -1,6 +1,7 @@\n from AccessControl import getSecurityManager\n from AccessControl.Permissions import view as View\n from collections import OrderedDict\n+from functools import cached_property\n from importlib.metadata import distribution\n from importlib.metadata import PackageNotFoundError\n from OFS.interfaces import IApplication\n@@ -325,6 +326,37 @@ def upgrades(self):\n         pm = getattr(self.context, "portal_migration")\n         return pm.listUpgrades()\n \n+    @cached_property\n+    def missing_packages(self):\n+        """Get list of missing packages that were installed in GS.\n+\n+        Main use case:\n+\n+        * Create a Product.CMFPlone 6.0 site.\n+        * Upgrade the code to Products.CMFPlone 6.1.\n+        * Now the plone.app.discussion package is missing.\n+          This will give problems, because its GS profile was installed\n+          by default in 6.0.\n+\n+        Beware of false positives.  For example when upgrading from Plone 5.2,\n+        CMFFormController will be missing, but we have code in plone.app.upgrade\n+        to properly clean this up. So we should not bother the admin with this.\n+        """\n+        setup = getattr(self.context, "portal_setup")\n+        installed = sorted(\n+            set([x.split(":")[0] for x in setup._profile_upgrade_versions.keys()])\n+        )\n+        ignore = ["Products.CMFFormController"]\n+        missing = []\n+        for package in installed:\n+            if package in ignore:\n+                continue\n+            try:\n+                distribution(package)\n+            except PackageNotFoundError:\n+                missing.append(package)\n+        return missing\n+\n     def versions(self):\n         pm = getattr(self.context, "portal_migration")\n         result = {}\ndiff --git a/Products/CMFPlone/browser/templates/plone-upgrade.pt b/Products/CMFPlone/browser/templates/plone-upgrade.pt\nindex 9b57974ae9..8752241612 100644\n--- a/Products/CMFPlone/browser/templates/plone-upgrade.pt\n+++ b/Products/CMFPlone/browser/templates/plone-upgrade.pt\n@@ -46,6 +46,12 @@\n         </header>\n         <article class="row mb-4">\n           <div class="col-md-12 mb-3">\n+            <div class="alert alert-danger" tal:condition="view/missing_packages">\n+              <p><strong i18n:translate="msg_missing_packages">The following packages were previously installed, but are currently missing. This may be a problem.</strong></p>\n+              <ul>\n+                <li tal:repeat="package view/missing_packages">${package}</li>\n+              </ul>\n+            </div>\n             <p class="alert alert-success p-2" tal:condition="versions/equal">\n               <span i18n:translate="" tal:omit-tag="">Your site is up to date.</span>\n             </p>\ndiff --git a/news/3975.bugfix.2 b/news/3975.bugfix.2\nnew file mode 100644\nindex 0000000000..ffd645a7c0\n--- /dev/null\n+++ b/news/3975.bugfix.2\n@@ -0,0 +1,3 @@\n+Plone upgrade page: show list of previously installed packages that are currently missing.\n+For example: `plone.app.discussion` may be missing in Plone 6.1, unless you explicitly add it, or depend on the `Plone` package.\n+[maurits]\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2024-06-15T14:19:50+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/c666a7260d79e3a871040ab3067f27d23ba7efea

Add tests for plone-upgrade page methods: upgrades and missing_packages.

Files changed:
M Products/CMFPlone/tests/testMigrationTool.py

b'diff --git a/Products/CMFPlone/tests/testMigrationTool.py b/Products/CMFPlone/tests/testMigrationTool.py\nindex 342a0856d5..e9a820f3d4 100644\n--- a/Products/CMFPlone/tests/testMigrationTool.py\n+++ b/Products/CMFPlone/tests/testMigrationTool.py\n@@ -260,3 +260,27 @@ def test_plone_addonlist_upgrade_all(self):\n         self.assertEqual(cmfeditions_version, getversion(cmfeditions_id))\n         self.assertEqual(discussion_version, getversion(discussion_id))\n         self.assertEqual(querystring_version, getversion(querystring_id))\n+\n+\n+class TestPloneUpgradePage(PloneTestCase.PloneTestCase):\n+    def afterSetUp(self):\n+        self.migration = getToolByName(self.portal, "portal_migration")\n+        self.setup = getToolByName(self.portal, "portal_setup")\n+\n+    def test_upgrades(self):\n+        self.setRoles(["Manager"])\n+        view = self.portal.restrictedTraverse("@@plone-upgrade")\n+        self.assertEqual(view.upgrades(), [])\n+        self.setup.setLastVersionForProfile(_DEFAULT_PROFILE, START_PROFILE)\n+        self.assertGreater(len(view.upgrades()), 0)\n+\n+    def test_missing_packages(self):\n+        self.setRoles(["Manager"])\n+        view = self.portal.restrictedTraverse("@@plone-upgrade")\n+        self.assertEqual(view.missing_packages, [])\n+\n+        # Fake a missing package that was installed.\n+        self.setup.setLastVersionForProfile("my.dummy.package:default", 1)\n+        # Delete the cached property.\n+        del view.missing_packages\n+        self.assertEqual(view.missing_packages, ["my.dummy.package"])\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2024-06-16T09:42:51+02:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/def5a9a5be58aa73235b97b4155e933d6c53cc45

Merge branch 'master' into maurits-plone-app-upgrade-missing

Files changed:
A news/3968.bugfix
M Products/CMFPlone/RegistrationTool.py
M Products/CMFPlone/browser/author.py
M Products/CMFPlone/browser/templates/author.pt
M Products/CMFPlone/tests/testEmailLogin.py

b'diff --git a/Products/CMFPlone/RegistrationTool.py b/Products/CMFPlone/RegistrationTool.py\nindex b3a1931cea..905fc35b6c 100644\n--- a/Products/CMFPlone/RegistrationTool.py\n+++ b/Products/CMFPlone/RegistrationTool.py\n@@ -107,7 +107,7 @@ class RegistrationTool(PloneBaseTool, BaseTool):\n     plone_tool = 1\n     md5key = None\n     _v_md5base = None\n-    default_member_id_pattern = r"^\\w[\\w\\.\\-@]+\\w$"\n+    default_member_id_pattern = r"^\\w[\\w\\.\\-@+]+\\w$"\n     _ALLOWED_MEMBER_ID_PATTERN = re.compile(default_member_id_pattern)\n \n     def __init__(self):\ndiff --git a/Products/CMFPlone/browser/author.py b/Products/CMFPlone/browser/author.py\nindex ed13dd4e98..644099ea71 100644\n--- a/Products/CMFPlone/browser/author.py\n+++ b/Products/CMFPlone/browser/author.py\n@@ -20,6 +20,7 @@\n from zope.component import getUtility\n from zope.interface import implementer\n from zope.publisher.interfaces import IPublishTraverse\n+from ZTUtils import make_query\n \n import logging\n \n@@ -137,6 +138,9 @@ def publishTraverse(self, request, name):\n         self.username = name\n         return self\n \n+    def makeQuery(self, **kw):\n+        return make_query(**kw)\n+\n     @property\n     def is_anonymous(self):\n         return self.portal_state.anonymous()\ndiff --git a/Products/CMFPlone/browser/templates/author.pt b/Products/CMFPlone/browser/templates/author.pt\nindex 19cd4b0d6e..d60cd86555 100644\n--- a/Products/CMFPlone/browser/templates/author.pt\n+++ b/Products/CMFPlone/browser/templates/author.pt\n@@ -218,9 +218,8 @@\n                           </div>\n \n                           <p>\n-                          <a href=""\n-                             tal:attributes="href string:$here_url/search?Creator=${username}&amp;sort_on=created&amp;sort_order=reverse"\n-                             i18n:translate="go_to_search_author_content">\n+                          <a href="${here_url}/search?${python:view.makeQuery(Creator=username, sort_on=\'created\', sort_order=\'reverse\')}"\n+                             i18n:translate="go_to_search_author_content">                       \n                               All content created by\n                               <span i18n:name="user" tal:omit-tag="" tal:content="python:authorinfo[\'fullname\'] or username"/>&hellip;\n                           </a>\ndiff --git a/Products/CMFPlone/tests/testEmailLogin.py b/Products/CMFPlone/tests/testEmailLogin.py\nindex 87dc5ecaf3..3179e27507 100644\n--- a/Products/CMFPlone/tests/testEmailLogin.py\n+++ b/Products/CMFPlone/tests/testEmailLogin.py\n@@ -79,12 +79,9 @@ def testEmailMemberIdsAllowed(self):\n         # Strange, but valid as id:\n         self.assertTrue(pattern.match("no.address@example"))\n         self.assertTrue(registration.isMemberIdAllowed("no.address@example"))\n-        # http://dev.plone.org/ticket/11616 mentions some non-standard\n-        # email addresses.\n-        # A plus sign in the id gives problems in some parts of the\n-        # UI, so we do not allow it.\n-        self.assertFalse(pattern.match("user+test@example.org"))\n-        self.assertFalse(registration.isMemberIdAllowed("user+test@example.org"))\n+        # testing if it breaks anything (according to https://github.com/plone/Products.CMFPlone/issues/3968)\n+        self.assertTrue(pattern.match("user+test@example.org")) \n+        self.assertTrue(registration.isMemberIdAllowed("user+test@example.org"))\n         # An apostrophe also sounds like a bad idea to use in an id,\n         # though this is a valid email address:\n         self.assertFalse(pattern.match("o\'hara@example.org"))\ndiff --git a/news/3968.bugfix b/news/3968.bugfix\nnew file mode 100644\nindex 0000000000..c81fb575d7\n--- /dev/null\n+++ b/news/3968.bugfix\n@@ -0,0 +1,2 @@\n+Fixed RegistrationTool to take user email with `__+__@abc.com`.\n+[@rohnsha0]\n\\ No newline at end of file\n'

Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2024-06-16T10:52:04+02:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/Products.CMFPlone/commit/f4c9514b3919f2c22af2e7055de654052125690d

Merge pull request #3977 from plone/maurits-plone-app-upgrade-missing

Plone upgrade page: show missing packages

Files changed:
A news/3975.bugfix.1
A news/3975.bugfix.2
M Products/CMFPlone/browser/admin.py
M Products/CMFPlone/browser/templates/plone-upgrade.pt
M Products/CMFPlone/tests/testMigrationTool.py

b'diff --git a/Products/CMFPlone/browser/admin.py b/Products/CMFPlone/browser/admin.py\nindex 6c96868982..e6273a812a 100644\n--- a/Products/CMFPlone/browser/admin.py\n+++ b/Products/CMFPlone/browser/admin.py\n@@ -1,6 +1,9 @@\n from AccessControl import getSecurityManager\n from AccessControl.Permissions import view as View\n from collections import OrderedDict\n+from functools import cached_property\n+from importlib.metadata import distribution\n+from importlib.metadata import PackageNotFoundError\n from OFS.interfaces import IApplication\n from plone.base.interfaces import INonInstallable\n from plone.base.interfaces import IPloneSiteRoot\n@@ -35,14 +38,18 @@\n from ZPublisher.BaseRequest import DefaultPublishTraverse\n \n import logging\n-import pkg_resources\n \n \n try:\n-    pkg_resources.get_distribution("plone.volto")\n+    distribution("plone.volto")\n     HAS_VOLTO = True\n-except pkg_resources.DistributionNotFound:\n+except PackageNotFoundError:\n     HAS_VOLTO = False\n+try:\n+    distribution("plone.app.upgrade")\n+    HAS_UPGRADE = True\n+except PackageNotFoundError:\n+    HAS_UPGRADE = False\n LOGGER = logging.getLogger("Products.CMFPlone")\n \n \n@@ -313,10 +320,43 @@ def __call__(self):\n \n \n class Upgrade(BrowserView):\n+    has_upgrade = HAS_UPGRADE\n+\n     def upgrades(self):\n         pm = getattr(self.context, "portal_migration")\n         return pm.listUpgrades()\n \n+    @cached_property\n+    def missing_packages(self):\n+        """Get list of missing packages that were installed in GS.\n+\n+        Main use case:\n+\n+        * Create a Product.CMFPlone 6.0 site.\n+        * Upgrade the code to Products.CMFPlone 6.1.\n+        * Now the plone.app.discussion package is missing.\n+          This will give problems, because its GS profile was installed\n+          by default in 6.0.\n+\n+        Beware of false positives.  For example when upgrading from Plone 5.2,\n+        CMFFormController will be missing, but we have code in plone.app.upgrade\n+        to properly clean this up. So we should not bother the admin with this.\n+        """\n+        setup = getattr(self.context, "portal_setup")\n+        installed = sorted(\n+            set([x.split(":")[0] for x in setup._profile_upgrade_versions.keys()])\n+        )\n+        ignore = ["Products.CMFFormController"]\n+        missing = []\n+        for package in installed:\n+            if package in ignore:\n+                continue\n+            try:\n+                distribution(package)\n+            except PackageNotFoundError:\n+                missing.append(package)\n+        return missing\n+\n     def versions(self):\n         pm = getattr(self.context, "portal_migration")\n         result = {}\ndiff --git a/Products/CMFPlone/browser/templates/plone-upgrade.pt b/Products/CMFPlone/browser/templates/plone-upgrade.pt\nindex 9b9cdecc7d..8752241612 100644\n--- a/Products/CMFPlone/browser/templates/plone-upgrade.pt\n+++ b/Products/CMFPlone/browser/templates/plone-upgrade.pt\n@@ -21,6 +21,7 @@\n \n <body id="plone-upgrade-screen"\n       tal:define="versions view/versions;\n+                  upgrades view/upgrades;\n                   report options/report|nothing;">\n \n     <div class="container admin mt-5 mb-5 p-4">\n@@ -45,6 +46,12 @@\n         </header>\n         <article class="row mb-4">\n           <div class="col-md-12 mb-3">\n+            <div class="alert alert-danger" tal:condition="view/missing_packages">\n+              <p><strong i18n:translate="msg_missing_packages">The following packages were previously installed, but are currently missing. This may be a problem.</strong></p>\n+              <ul>\n+                <li tal:repeat="package view/missing_packages">${package}</li>\n+              </ul>\n+            </div>\n             <p class="alert alert-success p-2" tal:condition="versions/equal">\n               <span i18n:translate="" tal:omit-tag="">Your site is up to date.</span>\n             </p>\n@@ -101,7 +108,7 @@\n           </p>\n \n           <dl class="mb-4">\n-            <tal:block tal:repeat="upgrade_info view/upgrades">\n+            <tal:block tal:repeat="upgrade_info upgrades">\n \n                 <tal:single condition="python:not isinstance(upgrade_info, list)"\n                             define="info upgrade_info">\n@@ -144,9 +151,20 @@\n           </div>\n         </div>\n \n+        <p class="alert alert-danger p-2" tal:condition="not:upgrades">\n+          <span i18n:translate="msg_no_upgrades">\n+            No upgrade steps are available.\n+          </span>\n+          <strong tal:condition="not:view/has_upgrade"\n+                i18n:translate="msg_plone_app_upgrade_missing">\n+            The plone.app.upgrade package is missing.\n+          </strong>\n+        </p>\n+\n         <input type="hidden" name="form.submitted:boolean" value="True" />\n         <button type="submit"\n                 name="submit"\n+                tal:attributes="disabled python:\'disabled\' if not upgrades else \'\'"\n                 class="btn btn-primary"\n                 i18n:translate="" >Upgrade</button>\n     </form>\ndiff --git a/Products/CMFPlone/tests/testMigrationTool.py b/Products/CMFPlone/tests/testMigrationTool.py\nindex 342a0856d5..e9a820f3d4 100644\n--- a/Products/CMFPlone/tests/testMigrationTool.py\n+++ b/Products/CMFPlone/tests/testMigrationTool.py\n@@ -260,3 +260,27 @@ def test_plone_addonlist_upgrade_all(self):\n         self.assertEqual(cmfeditions_version, getversion(cmfeditions_id))\n         self.assertEqual(discussion_version, getversion(discussion_id))\n         self.assertEqual(querystring_version, getversion(querystring_id))\n+\n+\n+class TestPloneUpgradePage(PloneTestCase.PloneTestCase):\n+    def afterSetUp(self):\n+        self.migration = getToolByName(self.portal, "portal_migration")\n+        self.setup = getToolByName(self.portal, "portal_setup")\n+\n+    def test_upgrades(self):\n+        self.setRoles(["Manager"])\n+        view = self.portal.restrictedTraverse("@@plone-upgrade")\n+        self.assertEqual(view.upgrades(), [])\n+        self.setup.setLastVersionForProfile(_DEFAULT_PROFILE, START_PROFILE)\n+        self.assertGreater(len(view.upgrades()), 0)\n+\n+    def test_missing_packages(self):\n+        self.setRoles(["Manager"])\n+        view = self.portal.restrictedTraverse("@@plone-upgrade")\n+        self.assertEqual(view.missing_packages, [])\n+\n+        # Fake a missing package that was installed.\n+        self.setup.setLastVersionForProfile("my.dummy.package:default", 1)\n+        # Delete the cached property.\n+        del view.missing_packages\n+        self.assertEqual(view.missing_packages, ["my.dummy.package"])\ndiff --git a/news/3975.bugfix.1 b/news/3975.bugfix.1\nnew file mode 100644\nindex 0000000000..e93d7ef4ab\n--- /dev/null\n+++ b/news/3975.bugfix.1\n@@ -0,0 +1,3 @@\n+Plone upgrade page: show error when upgrade is needed but no upgrades are available.\n+Especially show a note when the `plone.app.upgrade` package is not available.\n+[maurits]\ndiff --git a/news/3975.bugfix.2 b/news/3975.bugfix.2\nnew file mode 100644\nindex 0000000000..ffd645a7c0\n--- /dev/null\n+++ b/news/3975.bugfix.2\n@@ -0,0 +1,3 @@\n+Plone upgrade page: show list of previously installed packages that are currently missing.\n+For example: `plone.app.discussion` may be missing in Plone 6.1, unless you explicitly add it, or depend on the `Plone` package.\n+[maurits]\n'

