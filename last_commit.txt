Repository: Products.CMFPlone


Branch: refs/heads/5.2.x
Date: 2020-06-12T22:06:25+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/9254e40a9f1ccb36661d3bd62fd6c42191fbb807

Only add custom.css bundle when custom css is set in the theming control panel.

Files changed:
M Products/CMFPlone/resources/browser/styles.py
M news/3086.feature

b'diff --git a/Products/CMFPlone/resources/browser/styles.py b/Products/CMFPlone/resources/browser/styles.py\nindex 081af3248e..7e4c9e815a 100644\n--- a/Products/CMFPlone/resources/browser/styles.py\n+++ b/Products/CMFPlone/resources/browser/styles.py\n@@ -85,10 +85,17 @@ def get_data(self, bundle, result):\n                 })\n \n     @property\n-    def custom_css_timestamp(self):\n+    def _theme_settings(self):\n         registry = getUtility(IRegistry)\n-        theme_settings = registry.forInterface(IThemeSettings, False)\n-        return theme_settings.custom_css_timestamp\n+        return registry.forInterface(IThemeSettings, False)\n+\n+    @property\n+    def custom_css(self):\n+        return self._theme_settings.custom_css\n+\n+    @property\n+    def custom_css_timestamp(self):\n+        return self._theme_settings.custom_css_timestamp\n \n     def styles(self):\n         """\n@@ -154,16 +161,17 @@ def styles(self):\n             result.append(data)\n \n         # custom.css\n-        custom_css = {\n-            \'rel\': \'stylesheet\',\n-            \'conditionalcomment\': \'\',\n-            \'src\': "{0}/custom.css?timestamp={1}".format(\n-                self.site_url,\n-                self.custom_css_timestamp,\n-            ),\n-            \'bundle\': \'custom-css\'\n-        }\n-        result.append(custom_css)\n+        if self.custom_css:\n+            custom_css = {\n+                \'rel\': \'stylesheet\',\n+                \'conditionalcomment\': \'\',\n+                \'src\': "{0}/custom.css?timestamp={1}".format(\n+                    self.site_url,\n+                    self.custom_css_timestamp,\n+                ),\n+                \'bundle\': \'custom-css\'\n+            }\n+            result.append(custom_css)\n         return result\n \n \ndiff --git a/news/3086.feature b/news/3086.feature\nindex 92bc65cd66..e3668f60b6 100644\n--- a/news/3086.feature\n+++ b/news/3086.feature\n@@ -1,2 +1,3 @@\n Insert virtual custom.css bundle into the header after diazo bundle.\n+Only add this when custom css is set in the theming control panel.\n [MrTango]\n'

Repository: Products.CMFPlone


Branch: refs/heads/5.2.x
Date: 2020-06-14T11:57:21+02:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/4b5509703c78179b940451cc1f8833fedb5ca64c

Merge pull request #3118 from plone/maurits/3117-custom-css-only-when-there

Only add custom.css bundle when it is set in the theming control panel [5.2]

Files changed:
M Products/CMFPlone/resources/browser/styles.py
M news/3086.feature

b'diff --git a/Products/CMFPlone/resources/browser/styles.py b/Products/CMFPlone/resources/browser/styles.py\nindex 081af3248e..7e4c9e815a 100644\n--- a/Products/CMFPlone/resources/browser/styles.py\n+++ b/Products/CMFPlone/resources/browser/styles.py\n@@ -85,10 +85,17 @@ def get_data(self, bundle, result):\n                 })\n \n     @property\n-    def custom_css_timestamp(self):\n+    def _theme_settings(self):\n         registry = getUtility(IRegistry)\n-        theme_settings = registry.forInterface(IThemeSettings, False)\n-        return theme_settings.custom_css_timestamp\n+        return registry.forInterface(IThemeSettings, False)\n+\n+    @property\n+    def custom_css(self):\n+        return self._theme_settings.custom_css\n+\n+    @property\n+    def custom_css_timestamp(self):\n+        return self._theme_settings.custom_css_timestamp\n \n     def styles(self):\n         """\n@@ -154,16 +161,17 @@ def styles(self):\n             result.append(data)\n \n         # custom.css\n-        custom_css = {\n-            \'rel\': \'stylesheet\',\n-            \'conditionalcomment\': \'\',\n-            \'src\': "{0}/custom.css?timestamp={1}".format(\n-                self.site_url,\n-                self.custom_css_timestamp,\n-            ),\n-            \'bundle\': \'custom-css\'\n-        }\n-        result.append(custom_css)\n+        if self.custom_css:\n+            custom_css = {\n+                \'rel\': \'stylesheet\',\n+                \'conditionalcomment\': \'\',\n+                \'src\': "{0}/custom.css?timestamp={1}".format(\n+                    self.site_url,\n+                    self.custom_css_timestamp,\n+                ),\n+                \'bundle\': \'custom-css\'\n+            }\n+            result.append(custom_css)\n         return result\n \n \ndiff --git a/news/3086.feature b/news/3086.feature\nindex 92bc65cd66..e3668f60b6 100644\n--- a/news/3086.feature\n+++ b/news/3086.feature\n@@ -1,2 +1,3 @@\n Insert virtual custom.css bundle into the header after diazo bundle.\n+Only add this when custom css is set in the theming control panel.\n [MrTango]\n'

