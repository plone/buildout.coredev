Repository: plone.app.versioningbehavior


Branch: refs/heads/master
Date: 2020-04-24T22:24:07+03:00
Author: Asko Soukka (datakurre) <asko.soukka@iki.fi>
Commit: https://github.com/plone/plone.app.versioningbehavior/commit/d7edb45910812a0d7d1bd9e0e7c20d70b9879172

Change to use filecmp.cmp(shallow=False) instead comparing blobs line by line

Files changed:
M plone/app/versioningbehavior/modifiers.py

b'diff --git a/plone/app/versioningbehavior/modifiers.py b/plone/app/versioningbehavior/modifiers.py\nindex 4b76369..7313b58 100644\n--- a/plone/app/versioningbehavior/modifiers.py\n+++ b/plone/app/versioningbehavior/modifiers.py\n@@ -20,6 +20,7 @@\n from zope.interface import implementer\n from zope.schema import getFields\n \n+import filecmp\n import os\n import six\n \n@@ -140,20 +141,16 @@ def getReferencedAttributes(self, obj):\n                         if prior_blob is not None:\n                             prior_file = prior_blob.open()\n \n-                            # Check for file size differences\n-                            if (os.fstat(prior_file.fileno()).st_size ==\n-                                    os.fstat(blob_file.fileno()).st_size):\n-                                # Files are the same size, compare line by line\n-                                for line, prior_line in six.moves.zip(\n-                                        blob_file, prior_file):\n-                                    if line != prior_line:\n-                                        break\n-                                else:\n-                                    # The files are the same, save a reference\n-                                    # to the prior versions blob on this\n-                                    # version\n-                                    file_data[dotted_name] = prior_blob._blob\n-                                    save_new = False\n+                            # Check for file differences\n+                            if filecmp.cmp(prior_file.name, blob_file.name,\n+                                           shallow=False):\n+                                # The files are the same, save a reference\n+                                # to the prior versions blob on this\n+                                # version\n+                                file_data[dotted_name] = prior_blob._blob\n+                                save_new = False\n+\n+                            prior_file.close()\n \n                     if save_new:\n                         new_blob = file_data[dotted_name] = Blob()\n@@ -164,6 +161,8 @@ def getReferencedAttributes(self, obj):\n                         finally:\n                             blob_file.close()\n                             new_blob_file.close()\n+                    else:\n+                        blob_file.close()\n \n         return file_data\n \n'

Repository: plone.app.versioningbehavior


Branch: refs/heads/master
Date: 2020-04-26T22:36:47+03:00
Author: Asko Soukka (datakurre) <asko.soukka@iki.fi>
Commit: https://github.com/plone/plone.app.versioningbehavior/commit/5503532bc7c16450edfb3292696bfdeefb3444aa

Add changelog

Files changed:
A news/50.feature

b"diff --git a/news/50.feature b/news/50.feature\nnew file mode 100644\nindex 0000000..ce798ad\n--- /dev/null\n+++ b/news/50.feature\n@@ -0,0 +1 @@\n+Change to use Python's built-in `filecmp.cmp(shallow=False)` to compare blobs for differences instead of the old method of comparing them line by line. [datakurre]\n"

Repository: plone.app.versioningbehavior


Branch: refs/heads/master
Date: 2020-04-27T01:00:21+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.versioningbehavior/commit/c11cbafd712635ebb33d7c71e9248909850425a9

Merge pull request #50 from plone/datakurre-filecmp

Change to use filecmp.cmp(shallow=False) instead comparing blobs line by line

Files changed:
A news/50.feature
M plone/app/versioningbehavior/modifiers.py

b"diff --git a/news/50.feature b/news/50.feature\nnew file mode 100644\nindex 0000000..ce798ad\n--- /dev/null\n+++ b/news/50.feature\n@@ -0,0 +1 @@\n+Change to use Python's built-in `filecmp.cmp(shallow=False)` to compare blobs for differences instead of the old method of comparing them line by line. [datakurre]\ndiff --git a/plone/app/versioningbehavior/modifiers.py b/plone/app/versioningbehavior/modifiers.py\nindex 4b76369..7313b58 100644\n--- a/plone/app/versioningbehavior/modifiers.py\n+++ b/plone/app/versioningbehavior/modifiers.py\n@@ -20,6 +20,7 @@\n from zope.interface import implementer\n from zope.schema import getFields\n \n+import filecmp\n import os\n import six\n \n@@ -140,20 +141,16 @@ def getReferencedAttributes(self, obj):\n                         if prior_blob is not None:\n                             prior_file = prior_blob.open()\n \n-                            # Check for file size differences\n-                            if (os.fstat(prior_file.fileno()).st_size ==\n-                                    os.fstat(blob_file.fileno()).st_size):\n-                                # Files are the same size, compare line by line\n-                                for line, prior_line in six.moves.zip(\n-                                        blob_file, prior_file):\n-                                    if line != prior_line:\n-                                        break\n-                                else:\n-                                    # The files are the same, save a reference\n-                                    # to the prior versions blob on this\n-                                    # version\n-                                    file_data[dotted_name] = prior_blob._blob\n-                                    save_new = False\n+                            # Check for file differences\n+                            if filecmp.cmp(prior_file.name, blob_file.name,\n+                                           shallow=False):\n+                                # The files are the same, save a reference\n+                                # to the prior versions blob on this\n+                                # version\n+                                file_data[dotted_name] = prior_blob._blob\n+                                save_new = False\n+\n+                            prior_file.close()\n \n                     if save_new:\n                         new_blob = file_data[dotted_name] = Blob()\n@@ -164,6 +161,8 @@ def getReferencedAttributes(self, obj):\n                         finally:\n                             blob_file.close()\n                             new_blob_file.close()\n+                    else:\n+                        blob_file.close()\n \n         return file_data\n \n"

