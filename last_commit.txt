Repository: plone.restapi


Branch: refs/heads/master
Date: 2021-01-26T16:54:28+01:00
Author: Víctor Fernández de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/1f139772638c6989166aad3c5db19b5cf778bd59

Fix @id attribute to has the expansions query on them when no fullobj… (#1053)

* Fix @id attribute to has the expansions query on them when no fullobjects call is made

* Fix tests

Files changed:
A news/837.bugfix
M src/plone/restapi/serializer/atcontent.py
M src/plone/restapi/serializer/dxcontent.py
M src/plone/restapi/tests/http-examples/content_get_folder.resp
M src/plone/restapi/tests/test_expansion.py

b'diff --git a/news/837.bugfix b/news/837.bugfix\nnew file mode 100644\nindex 000000000..c5a942b74\n--- /dev/null\n+++ b/news/837.bugfix\n@@ -0,0 +1,2 @@\n+- Fix ``@id`` when content query has no ``fullbojects``\n+  [sneridagh]\ndiff --git a/src/plone/restapi/serializer/atcontent.py b/src/plone/restapi/serializer/atcontent.py\nindex 9b35700e0..f44edd07e 100644\n--- a/src/plone/restapi/serializer/atcontent.py\n+++ b/src/plone/restapi/serializer/atcontent.py\n@@ -111,8 +111,6 @@ def __call__(self, version=None, include_items=True):\n \n             batch = HypermediaBatch(self.request, brains)\n \n-            if not self.request.form.get("fullobjects"):\n-                result["@id"] = batch.canonical_url\n             result["items_total"] = batch.items_total\n             if batch.links:\n                 result["batching"] = batch.links\ndiff --git a/src/plone/restapi/serializer/dxcontent.py b/src/plone/restapi/serializer/dxcontent.py\nindex 4be61e43c..6bf467806 100644\n--- a/src/plone/restapi/serializer/dxcontent.py\n+++ b/src/plone/restapi/serializer/dxcontent.py\n@@ -154,8 +154,6 @@ def __call__(self, version=None, include_items=True):\n \n             batch = HypermediaBatch(self.request, brains)\n \n-            if "fullobjects" not in self.request.form:\n-                result["@id"] = batch.canonical_url\n             result["items_total"] = batch.items_total\n             if batch.links:\n                 result["batching"] = batch.links\ndiff --git a/src/plone/restapi/tests/http-examples/content_get_folder.resp b/src/plone/restapi/tests/http-examples/content_get_folder.resp\nindex 33a6ddd47..199236412 100644\n--- a/src/plone/restapi/tests/http-examples/content_get_folder.resp\n+++ b/src/plone/restapi/tests/http-examples/content_get_folder.resp\n@@ -22,7 +22,7 @@ Content-Type: application/json\n       "@id": "http://localhost:55001/plone/folder/@workflow"\n     }\n   }, \n-  "@id": "http://localhost:55001/plone/folder?metadata_fields=UID&metadata_fields=Creator", \n+  "@id": "http://localhost:55001/plone/folder", \n   "@type": "Folder", \n   "UID": "SomeUUID000000000000000000000002", \n   "allow_discussion": false, \ndiff --git a/src/plone/restapi/tests/test_expansion.py b/src/plone/restapi/tests/test_expansion.py\nindex 6464860d2..6926d533c 100644\n--- a/src/plone/restapi/tests/test_expansion.py\n+++ b/src/plone/restapi/tests/test_expansion.py\n@@ -372,6 +372,9 @@ def setUp(self):\n         self.en_content = createContentInContainer(\n             self.portal["en"], "Document", title=u"Test document"\n         )\n+        self.en_folder = createContentInContainer(\n+            self.portal["en"], "Folder", title=u"Test folder"\n+        )\n         self.es_content = createContentInContainer(\n             self.portal["es"], "Document", title=u"Test document"\n         )\n@@ -398,3 +401,11 @@ def test_translations_expanded(self):\n         self.assertIn(\n             translation_dict, response.json()["@components"]["translations"]["items"]\n         )\n+\n+    def test_expansions_no_fullobjects_do_not_modify_id(self):\n+        response = self.api_session.get(\n+            "/en/test-folder", params={"expand": "translations"}\n+        )\n+\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(response.json()["@id"], self.en_folder.absolute_url())\n'

