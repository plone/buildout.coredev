Repository: plone.restapi


Branch: refs/heads/7.x.x
Date: 2022-04-27T18:33:33+02:00
Author: Gauthier Bastien (gbastien) <gauthier.bastien@imio.be>
Commit: https://github.com/plone/plone.restapi/commit/d5fc46587d26d842d2881e07316fa6498e7e58f4

Prevent to create an empty AT content.
See #1386

Files changed:
A news/1386.bugfix
M src/plone/restapi/deserializer/atcontent.py
M src/plone/restapi/tests/test_atcontent_deserializer.py

b'diff --git a/news/1386.bugfix b/news/1386.bugfix\nnew file mode 100644\nindex 000000000..0ff9bacb6\n--- /dev/null\n+++ b/news/1386.bugfix\n@@ -0,0 +1,2 @@\n+Prevent to create an empty AT content.\n+[gbastien]\ndiff --git a/src/plone/restapi/deserializer/atcontent.py b/src/plone/restapi/deserializer/atcontent.py\nindex 9c34ad46b..182922228 100644\n--- a/src/plone/restapi/deserializer/atcontent.py\n+++ b/src/plone/restapi/deserializer/atcontent.py\n@@ -52,7 +52,7 @@ def __call__(self, validate_all=False, data=None, create=False):\n                 mutator(value, **kwargs)\n                 modified = True\n \n-        if modified:\n+        if create or modified:\n             errors = self.validate()\n             if not validate_all:\n                 errors = {f: e for f, e in errors.items() if f in data}\ndiff --git a/src/plone/restapi/tests/test_atcontent_deserializer.py b/src/plone/restapi/tests/test_atcontent_deserializer.py\nindex 49970e44a..fdb972235 100644\n--- a/src/plone/restapi/tests/test_atcontent_deserializer.py\n+++ b/src/plone/restapi/tests/test_atcontent_deserializer.py\n@@ -160,6 +160,14 @@ def test_set_layout(self):\n         self.deserialize(body=\'{"layout": "my_new_layout"}\')\n         self.assertEqual("my_new_layout", self.doc1.getLayout())\n \n+    def test_validation_done_when_create(self):\n+        self.doc1.setTitle("")\n+        self.assertEqual(self.deserialize(body=\'{}\'), self.doc1)\n+        with self.assertRaises(BadRequest) as cm:\n+            self.deserialize(body=\'\', create=True, validate_all=True)\n+        self.assertEqual("Title is required, please correct.",\n+                         cm.exception.args[0][1]["message"])\n+\n \n class TestValidationRequest(unittest.TestCase):\n \n'

Repository: plone.restapi


Branch: refs/heads/7.x.x
Date: 2022-04-27T21:44:00+02:00
Author: Gauthier Bastien (gbastien) <gauthier.bastien@imio.be>
Commit: https://github.com/plone/plone.restapi/commit/48f12cae7d53356ce2237be34100a5a18d862a06

Try to fix tests

Files changed:
M versions.cfg

b'diff --git a/versions.cfg b/versions.cfg\nindex f498073f9..07252ee8d 100644\n--- a/versions.cfg\n+++ b/versions.cfg\n@@ -51,3 +51,6 @@ pyroma = 2.6.1\n \n # cffi 1.14.3 fails on apple m1\n cffi = 1.14.4\n+\n+# latest version compatible with Python 2\n+bleach = 3.3.1 \n'

Repository: plone.restapi


Branch: refs/heads/7.x.x
Date: 2022-04-27T21:59:48+02:00
Author: Gauthier Bastien (gbastien) <gauthier.bastien@imio.be>
Commit: https://github.com/plone/plone.restapi/commit/0b5af847f69469c3f0b79b559fdbb8c3d4b0cae8

Just test that a BadRequest is raised

Files changed:
M src/plone/restapi/tests/test_atcontent_deserializer.py

b'diff --git a/src/plone/restapi/tests/test_atcontent_deserializer.py b/src/plone/restapi/tests/test_atcontent_deserializer.py\nindex fdb972235..a67e9c5fb 100644\n--- a/src/plone/restapi/tests/test_atcontent_deserializer.py\n+++ b/src/plone/restapi/tests/test_atcontent_deserializer.py\n@@ -163,10 +163,8 @@ def test_set_layout(self):\n     def test_validation_done_when_create(self):\n         self.doc1.setTitle("")\n         self.assertEqual(self.deserialize(body=\'{}\'), self.doc1)\n-        with self.assertRaises(BadRequest) as cm:\n-            self.deserialize(body=\'\', create=True, validate_all=True)\n-        self.assertEqual("Title is required, please correct.",\n-                         cm.exception.args[0][1]["message"])\n+        self.assertRaises(\n+            BadRequest, self.deserialize(body=\'\', create=True, validate_all=True))\n \n \n class TestValidationRequest(unittest.TestCase):\n'

Repository: plone.restapi


Branch: refs/heads/7.x.x
Date: 2022-04-27T22:00:47+02:00
Author: Gauthier Bastien (gbastien) <gauthier.bastien@imio.be>
Commit: https://github.com/plone/plone.restapi/commit/060f4d6e01beaf1134edecddf347392765797164

Fixed test

Files changed:
M src/plone/restapi/tests/test_atcontent_deserializer.py

b'diff --git a/src/plone/restapi/tests/test_atcontent_deserializer.py b/src/plone/restapi/tests/test_atcontent_deserializer.py\nindex a67e9c5fb..26fa93161 100644\n--- a/src/plone/restapi/tests/test_atcontent_deserializer.py\n+++ b/src/plone/restapi/tests/test_atcontent_deserializer.py\n@@ -164,7 +164,7 @@ def test_validation_done_when_create(self):\n         self.doc1.setTitle("")\n         self.assertEqual(self.deserialize(body=\'{}\'), self.doc1)\n         self.assertRaises(\n-            BadRequest, self.deserialize(body=\'\', create=True, validate_all=True))\n+            BadRequest, self.deserialize, body=\'\', create=True, validate_all=True)\n \n \n class TestValidationRequest(unittest.TestCase):\n'

Repository: plone.restapi


Branch: refs/heads/7.x.x
Date: 2022-04-30T15:57:33+02:00
Author: Fred van Dijk (fredvd) <fredvd@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/3fa05c268c6eb96b730beef85cb392cc8ae740b7

Backport 1211 to 7.x.x (#1385)

* Make masking specific validation errors configurable in DX DeserializeFromJson

* Try to fix GHA test pulling in bleach 5.

* Also pin bleach for Plone 5.1/Python2.7 .  Plone 5.2.X has bleach Pinned through Zope 4.6 its versions.cfg where it is now included.

* Pin black to lower version, cherry-pick/example from 8e71637
pin click, clean up versions.cfg as in main branch
unpin plone.restapi as done on main branch

* fix awk invocation

* black 20.8b1

* Fix click pinning, Plone 5.2/Python2.7 runs fine again because of pinnings in Zope 5.  Move click and bleach to versions.cfg

Files changed:
A news/1211.feature
M .github/workflows/black.yml
M plone-4.3.x.cfg
M src/plone/restapi/deserializer/dxcontent.py
M src/plone/restapi/serializer/atcontent.py
M versions.cfg

b'diff --git a/.github/workflows/black.yml b/.github/workflows/black.yml\nindex 9b23c028b..7a82d7049 100644\n--- a/.github/workflows/black.yml\n+++ b/.github/workflows/black.yml\n@@ -26,9 +26,9 @@ jobs:\n           restore-keys: |\n             ${{ runner.os }}-pip-\n \n-      # install black\n+       # install black (extract version from versions.cfg)\n       - name: install black\n-        run: pip install black\n+        run: pip install click==$(awk \'/^click =/{print $NF}\' versions.cfg) black==$(awk \'/^black =/{print $NF}\' versions.cfg)\n \n       # run black\n       - name: run black\ndiff --git a/news/1211.feature b/news/1211.feature\nnew file mode 100644\nindex 000000000..68b1c7fb9\n--- /dev/null\n+++ b/news/1211.feature\n@@ -0,0 +1 @@\n+Make masking specific validation errors configurable in DX DeserializeFromJson. [fredvd] \n\\ No newline at end of file\ndiff --git a/plone-4.3.x.cfg b/plone-4.3.x.cfg\nindex 5d2d7136b..05921e751 100644\n--- a/plone-4.3.x.cfg\n+++ b/plone-4.3.x.cfg\n@@ -12,9 +12,6 @@ zope.interface = 4.1.0\n # Last pyrsistent version that is python 2 compatible:\n pyrsistent = 0.15.7\n \n-# Click 8.0.0 breaks in Python 2.7\n-Click = 7.1.2\n-\n # version 4 breaks in Python 2.7\n jsonschema = 3.2.0\n \ndiff --git a/src/plone/restapi/deserializer/dxcontent.py b/src/plone/restapi/deserializer/dxcontent.py\nindex d6822eaec..4f0610b2b 100644\n--- a/src/plone/restapi/deserializer/dxcontent.py\n+++ b/src/plone/restapi/deserializer/dxcontent.py\n@@ -36,7 +36,7 @@ def __init__(self, context, request):\n         self.modified = {}\n \n     def __call__(\n-        self, validate_all=False, data=None, create=False\n+        self, validate_all=False, data=None, create=False, mask_validation_errors=True\n     ):  # noqa: ignore=C901\n \n         if data is None:\n@@ -53,10 +53,11 @@ def __call__(\n                 errors.append({"error": error, "message": str(error)})\n \n         if errors:\n-            # Drop Python specific error classes in order to be able to better handle\n-            # errors on front-end\n-            for error in errors:\n-                error["error"] = "ValidationError"\n+            if mask_validation_errors:\n+                # Drop Python specific error classes in order to be able to better handle\n+                # errors on front-end\n+                for error in errors:\n+                    error["error"] = "ValidationError"\n             raise BadRequest(errors)\n \n         # We\'ll set the layout after the validation and even if there\ndiff --git a/src/plone/restapi/serializer/atcontent.py b/src/plone/restapi/serializer/atcontent.py\nindex 3cdaa9d88..4b09eb9fc 100644\n--- a/src/plone/restapi/serializer/atcontent.py\n+++ b/src/plone/restapi/serializer/atcontent.py\n@@ -71,9 +71,7 @@ def __call__(self, version=None, include_items=False):\n \n             name = field.getName()\n \n-            serializer = queryMultiAdapter(\n-                (field, obj, self.request), IFieldSerializer\n-            )\n+            serializer = queryMultiAdapter((field, obj, self.request), IFieldSerializer)\n             if serializer is not None:\n                 result[name] = serializer()\n \ndiff --git a/versions.cfg b/versions.cfg\nindex 07252ee8d..104f34066 100644\n--- a/versions.cfg\n+++ b/versions.cfg\n@@ -2,6 +2,15 @@\n # Buildout\n setuptools =\n zc.buildout =\n+plone.restapi =\n+\n+# code analysis\n+black = 20.8b1\n+\n+# keep to these versions for Python2.7 compatibility \n+click = 7.1.2\n+bleach = 3.3.1\n+\n zc.recipe.egg = 2.0.3\n \n # fixes Getting distribution for \'configparser\'. assert newdist is not None  # newloc above is missing our dist?!\n@@ -10,9 +19,6 @@ configparser = 3.5.3\n # fixes Error: The requirement (\'Pygments>=2.5.1\') is not allowed by your [versions] constraint (2.2.0)\n Pygments = 2.5.1\n \n-# plone.recipe.varnish\n-plone.recipe.varnish = 1.3\n-\n # Code-analysis\n check-manifest = 0.41\n plone.recipe.codeanalysis = 3.0.1\n'

Repository: plone.restapi


Branch: refs/heads/7.x.x
Date: 2022-04-30T15:59:43+02:00
Author: Gauthier Bastien (gbastien) <gauthier.bastien@imio.be>
Commit: https://github.com/plone/plone.restapi/commit/1eec583e52b8b0fd31d30a0ecae7aeb388c1959c

black

Files changed:
M src/plone/restapi/tests/test_atcontent_deserializer.py

b'diff --git a/src/plone/restapi/tests/test_atcontent_deserializer.py b/src/plone/restapi/tests/test_atcontent_deserializer.py\nindex 26fa93161..11b18d5f8 100644\n--- a/src/plone/restapi/tests/test_atcontent_deserializer.py\n+++ b/src/plone/restapi/tests/test_atcontent_deserializer.py\n@@ -162,9 +162,10 @@ def test_set_layout(self):\n \n     def test_validation_done_when_create(self):\n         self.doc1.setTitle("")\n-        self.assertEqual(self.deserialize(body=\'{}\'), self.doc1)\n+        self.assertEqual(self.deserialize(body="{}"), self.doc1)\n         self.assertRaises(\n-            BadRequest, self.deserialize, body=\'\', create=True, validate_all=True)\n+            BadRequest, self.deserialize, body="", create=True, validate_all=True\n+        )\n \n \n class TestValidationRequest(unittest.TestCase):\n'

Repository: plone.restapi


Branch: refs/heads/7.x.x
Date: 2022-05-03T17:22:03+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.restapi/commit/b6bd8820d3479fd2f0b8d5b222d9c52f58babe41

Merge pull request #1387 from plone/issue1386_prevent_creating_empty_at_content

Prevent to create an empty AT content.

Files changed:
A news/1386.bugfix
M src/plone/restapi/deserializer/atcontent.py
M src/plone/restapi/tests/test_atcontent_deserializer.py
M versions.cfg

b'diff --git a/news/1386.bugfix b/news/1386.bugfix\nnew file mode 100644\nindex 000000000..0ff9bacb6\n--- /dev/null\n+++ b/news/1386.bugfix\n@@ -0,0 +1,2 @@\n+Prevent to create an empty AT content.\n+[gbastien]\ndiff --git a/src/plone/restapi/deserializer/atcontent.py b/src/plone/restapi/deserializer/atcontent.py\nindex 9c34ad46b..182922228 100644\n--- a/src/plone/restapi/deserializer/atcontent.py\n+++ b/src/plone/restapi/deserializer/atcontent.py\n@@ -52,7 +52,7 @@ def __call__(self, validate_all=False, data=None, create=False):\n                 mutator(value, **kwargs)\n                 modified = True\n \n-        if modified:\n+        if create or modified:\n             errors = self.validate()\n             if not validate_all:\n                 errors = {f: e for f, e in errors.items() if f in data}\ndiff --git a/src/plone/restapi/tests/test_atcontent_deserializer.py b/src/plone/restapi/tests/test_atcontent_deserializer.py\nindex 49970e44a..11b18d5f8 100644\n--- a/src/plone/restapi/tests/test_atcontent_deserializer.py\n+++ b/src/plone/restapi/tests/test_atcontent_deserializer.py\n@@ -160,6 +160,13 @@ def test_set_layout(self):\n         self.deserialize(body=\'{"layout": "my_new_layout"}\')\n         self.assertEqual("my_new_layout", self.doc1.getLayout())\n \n+    def test_validation_done_when_create(self):\n+        self.doc1.setTitle("")\n+        self.assertEqual(self.deserialize(body="{}"), self.doc1)\n+        self.assertRaises(\n+            BadRequest, self.deserialize, body="", create=True, validate_all=True\n+        )\n+\n \n class TestValidationRequest(unittest.TestCase):\n \ndiff --git a/versions.cfg b/versions.cfg\nindex 1b5cab13d..104f34066 100644\n--- a/versions.cfg\n+++ b/versions.cfg\n@@ -57,3 +57,6 @@ pyroma = 2.6.1\n \n # cffi 1.14.3 fails on apple m1\n cffi = 1.14.4\n+\n+# latest version compatible with Python 2\n+bleach = 3.3.1 \n'

