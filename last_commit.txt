Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2024-03-26T16:39:23+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/216036bf67ec9053518078577d5fe8bf83def8c1

Add upgrade to add registry record ``webstats_head_js`` to ``ISiteSchema``.

This is part of https://github.com/plone/Products.CMFPlone/issues/3931.

Files changed:
A news/3931.bugfix
A plone/app/upgrade/v60/profiles/to_isiteschema/registry.xml
M plone/app/upgrade/v60/configure.zcml
M plone/app/upgrade/v60/profiles.zcml
M plone/app/upgrade/v61/configure.zcml

b'diff --git a/news/3931.bugfix b/news/3931.bugfix\nnew file mode 100644\nindex 00000000..4bd60dbc\n--- /dev/null\n+++ b/news/3931.bugfix\n@@ -0,0 +1,3 @@\n+Add upgrade to add registry record ``webstats_head_js`` to ``ISiteSchema``.\n+[maurits]\n+\ndiff --git a/plone/app/upgrade/v60/configure.zcml b/plone/app/upgrade/v60/configure.zcml\nindex 3d27a0a0..742e591d 100644\n--- a/plone/app/upgrade/v60/configure.zcml\n+++ b/plone/app/upgrade/v60/configure.zcml\n@@ -371,10 +371,10 @@\n         >\n         <!-- Plone 6.0.11 -->\n \n-        <gs:upgradeStep\n-            title="Miscellaneous"\n-            handler="..utils.null_upgrade_step"\n-            />\n+        <gs:upgradeDepends\n+          title="Run to_isiteschema upgrade profile."\n+          import_profile="plone.app.upgrade.v60:to_isiteschema"\n+          />\n \n     </gs:upgradeSteps>\n \ndiff --git a/plone/app/upgrade/v60/profiles.zcml b/plone/app/upgrade/v60/profiles.zcml\nindex 0518bc7d..bd614947 100644\n--- a/plone/app/upgrade/v60/profiles.zcml\n+++ b/plone/app/upgrade/v60/profiles.zcml\n@@ -62,4 +62,13 @@\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \n+  <!-- to_isiteschema needs to be applied in Plone 6.0.11 and 6.1.0a3. -->\n+  <genericsetup:registerProfile\n+      name="to_isiteschema"\n+      title="Reregister ISiteSchema to get new webstats_head_js record"\n+      directory="profiles/to_isiteschema"\n+      for="plone.base.interfaces.IMigratingPloneSiteRoot"\n+      provides="Products.GenericSetup.interfaces.EXTENSION"\n+      />\n+\n </configure>\ndiff --git a/plone/app/upgrade/v60/profiles/to_isiteschema/registry.xml b/plone/app/upgrade/v60/profiles/to_isiteschema/registry.xml\nnew file mode 100644\nindex 00000000..5f6ee08b\n--- /dev/null\n+++ b/plone/app/upgrade/v60/profiles/to_isiteschema/registry.xml\n@@ -0,0 +1,5 @@\n+<?xml version="1.0"?>\n+<registry>\n+    <records interface="Products.CMFPlone.interfaces.ISiteSchema"\n+           prefix="plone" />\n+</registry>\ndiff --git a/plone/app/upgrade/v61/configure.zcml b/plone/app/upgrade/v61/configure.zcml\nindex efa0ff02..0403dd8c 100644\n--- a/plone/app/upgrade/v61/configure.zcml\n+++ b/plone/app/upgrade/v61/configure.zcml\n@@ -34,10 +34,11 @@\n       destination="6102"\n       >\n     <!-- Plone 6.1.0a3 -->\n-    <gs:upgradeStep\n-        title="Miscellaneous"\n-        handler="..utils.null_upgrade_step"\n-        />\n+    <!-- We reuse an upgrade step from v60 -->\n+    <gs:upgradeDepends\n+      title="Run to_isiteschema upgrade profile."\n+      import_profile="plone.app.upgrade.v60:to_isiteschema"\n+      />\n   </gs:upgradeSteps>\n \n </configure>\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2024-04-23T09:54:16+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/eaaa75e5456d86d150e7aab9ed2ba92f2135fc5c

Merge remote-tracking branch 'origin/master' into 3931.feature

Files changed:
A news/324.feature
A plone/app/upgrade/v61/alpha.py
M plone/app/upgrade/utils.py
M plone/app/upgrade/v52/final.py
M plone/app/upgrade/v60/tests.py
M plone/app/upgrade/v61/configure.zcml

b'diff --git a/news/324.feature b/news/324.feature\nnew file mode 100644\nindex 00000000..ce16b8b7\n--- /dev/null\n+++ b/news/324.feature\n@@ -0,0 +1,2 @@\n+Add upgrade step for enable TinyMCE Plugin accordion\n+[1letter]\ndiff --git a/plone/app/upgrade/utils.py b/plone/app/upgrade/utils.py\nindex 3423991e..d03487f6 100644\n--- a/plone/app/upgrade/utils.py\n+++ b/plone/app/upgrade/utils.py\n@@ -1,10 +1,10 @@\n from Acquisition import aq_base\n from Missing import MV\n+from plone.base.utils import base_hasattr\n from plone.base.utils import get_installer\n from plone.indexer.interfaces import IIndexableObject\n from Products.CMFCore.DirectoryView import _dirreg\n from Products.CMFCore.utils import getToolByName\n-from plone.base.utils import base_hasattr\n from Products.GenericSetup.interfaces import ISetupTool\n from Products.GenericSetup.registry import _export_step_registry\n from Products.GenericSetup.registry import _import_step_registry\ndiff --git a/plone/app/upgrade/v52/final.py b/plone/app/upgrade/v52/final.py\nindex 1b46a0c3..0513f2d9 100644\n--- a/plone/app/upgrade/v52/final.py\n+++ b/plone/app/upgrade/v52/final.py\n@@ -1,12 +1,12 @@\n from AccessControl.Permissions import view\n from plone.app.upgrade.utils import loadMigrationProfile\n+from plone.base.utils import base_hasattr\n from plone.base.utils import get_installer\n from plone.registry import field\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.interfaces import IMarkupSchema\n from Products.CMFPlone.interfaces import ISiteSchema\n-from plone.base.utils import base_hasattr\n from Products.CMFPlone.utils import safe_unicode\n from zope.component import getUtility\n \ndiff --git a/plone/app/upgrade/v60/tests.py b/plone/app/upgrade/v60/tests.py\nindex ba15a3dd..75149e4c 100644\n--- a/plone/app/upgrade/v60/tests.py\n+++ b/plone/app/upgrade/v60/tests.py\n@@ -1,8 +1,8 @@\n from plone.app.testing import PLONE_INTEGRATION_TESTING\n+from plone.dexterity.interfaces import IDexterityFTI\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from zope.component import getUtility\n-from plone.dexterity.interfaces import IDexterityFTI\n \n import unittest\n \ndiff --git a/plone/app/upgrade/v61/alpha.py b/plone/app/upgrade/v61/alpha.py\nnew file mode 100644\nindex 00000000..ab70cac4\n--- /dev/null\n+++ b/plone/app/upgrade/v61/alpha.py\n@@ -0,0 +1,47 @@\n+from plone.base.interfaces.controlpanel import IFilterSchema\n+from plone.base.interfaces.controlpanel import ITinyMCEPluginSchema\n+from plone.registry.interfaces import IRegistry\n+from zope.component import getUtility\n+\n+\n+def add_feature_tinymce_accordion_plugin(context):\n+    # add accordion plugin to tinymce plugins\n+    # it\'s not enabled per default in the registry\n+\n+    registry = getUtility(IRegistry)\n+\n+    # save the old values temporarily\n+    plugins_record = registry.records.get("plone.plugins")\n+    valid_tags_record = registry.records.get("plone.valid_tags")\n+    custom_attributes_record = registry.records.get("plone.custom_attributes")\n+\n+    old_value_plugins = plugins_record.value\n+    old_value_valid_tags = valid_tags_record.value\n+    old_value_custom_attributes = custom_attributes_record.value\n+\n+    # delete the old registry record, it holds the wrong vocabulary of the old schema\n+    del registry.records["plone.plugins"]\n+    del registry.records["plone.valid_tags"]\n+    del registry.records["plone.custom_attributes"]\n+\n+    # re-register the schema in the registry\n+    registry.registerInterface(ITinyMCEPluginSchema, prefix="plone")\n+    registry.registerInterface(IFilterSchema, prefix="plone")\n+\n+    # add the old value for plugin\n+    plugins_record = registry.records.get("plone.plugins")\n+    plugins_record.value = old_value_plugins\n+\n+    # add the old value for valid_tags\n+    valid_tags_record = registry.records.get("plone.valid_tags")\n+    for val in old_value_valid_tags:\n+        if val in valid_tags_record.value:\n+            continue\n+        valid_tags_record.value.append(val)\n+\n+    # add the old value for custom_attributes\n+    custom_attributes_record = registry.records.get("plone.custom_attributes")\n+    for val in old_value_custom_attributes:\n+        if val in custom_attributes_record.value:\n+            continue\n+        custom_attributes_record.value.append(val)\ndiff --git a/plone/app/upgrade/v61/configure.zcml b/plone/app/upgrade/v61/configure.zcml\nindex 0403dd8c..a91d9d17 100644\n--- a/plone/app/upgrade/v61/configure.zcml\n+++ b/plone/app/upgrade/v61/configure.zcml\n@@ -34,6 +34,11 @@\n       destination="6102"\n       >\n     <!-- Plone 6.1.0a3 -->\n+    <gs:upgradeStep\n+        title="Add Feature to TinyMCE Editor"\n+        description="add accordion plugin to tinymce editor"\n+        handler=".alpha.add_feature_tinymce_accordion_plugin"\n+        />\n     <!-- We reuse an upgrade step from v60 -->\n     <gs:upgradeDepends\n       title="Run to_isiteschema upgrade profile."\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2024-04-23T09:54:38+02:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.upgrade/commit/7caacae4f579b90d7543433488a015c0df7b8586

Merge pull request #323 from plone/3931.feature

Add upgrade to add registry record ``webstats_head_js`` to ``ISiteSchema``

Files changed:
A news/3931.bugfix
A plone/app/upgrade/v60/profiles/to_isiteschema/registry.xml
M plone/app/upgrade/v60/configure.zcml
M plone/app/upgrade/v60/profiles.zcml
M plone/app/upgrade/v61/configure.zcml

b'diff --git a/news/3931.bugfix b/news/3931.bugfix\nnew file mode 100644\nindex 00000000..4bd60dbc\n--- /dev/null\n+++ b/news/3931.bugfix\n@@ -0,0 +1,3 @@\n+Add upgrade to add registry record ``webstats_head_js`` to ``ISiteSchema``.\n+[maurits]\n+\ndiff --git a/plone/app/upgrade/v60/configure.zcml b/plone/app/upgrade/v60/configure.zcml\nindex 3d27a0a0..742e591d 100644\n--- a/plone/app/upgrade/v60/configure.zcml\n+++ b/plone/app/upgrade/v60/configure.zcml\n@@ -371,10 +371,10 @@\n         >\n         <!-- Plone 6.0.11 -->\n \n-        <gs:upgradeStep\n-            title="Miscellaneous"\n-            handler="..utils.null_upgrade_step"\n-            />\n+        <gs:upgradeDepends\n+          title="Run to_isiteschema upgrade profile."\n+          import_profile="plone.app.upgrade.v60:to_isiteschema"\n+          />\n \n     </gs:upgradeSteps>\n \ndiff --git a/plone/app/upgrade/v60/profiles.zcml b/plone/app/upgrade/v60/profiles.zcml\nindex 0518bc7d..bd614947 100644\n--- a/plone/app/upgrade/v60/profiles.zcml\n+++ b/plone/app/upgrade/v60/profiles.zcml\n@@ -62,4 +62,13 @@\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \n+  <!-- to_isiteschema needs to be applied in Plone 6.0.11 and 6.1.0a3. -->\n+  <genericsetup:registerProfile\n+      name="to_isiteschema"\n+      title="Reregister ISiteSchema to get new webstats_head_js record"\n+      directory="profiles/to_isiteschema"\n+      for="plone.base.interfaces.IMigratingPloneSiteRoot"\n+      provides="Products.GenericSetup.interfaces.EXTENSION"\n+      />\n+\n </configure>\ndiff --git a/plone/app/upgrade/v60/profiles/to_isiteschema/registry.xml b/plone/app/upgrade/v60/profiles/to_isiteschema/registry.xml\nnew file mode 100644\nindex 00000000..5f6ee08b\n--- /dev/null\n+++ b/plone/app/upgrade/v60/profiles/to_isiteschema/registry.xml\n@@ -0,0 +1,5 @@\n+<?xml version="1.0"?>\n+<registry>\n+    <records interface="Products.CMFPlone.interfaces.ISiteSchema"\n+           prefix="plone" />\n+</registry>\ndiff --git a/plone/app/upgrade/v61/configure.zcml b/plone/app/upgrade/v61/configure.zcml\nindex d52ba4d8..a91d9d17 100644\n--- a/plone/app/upgrade/v61/configure.zcml\n+++ b/plone/app/upgrade/v61/configure.zcml\n@@ -39,7 +39,11 @@\n         description="add accordion plugin to tinymce editor"\n         handler=".alpha.add_feature_tinymce_accordion_plugin"\n         />\n-        \n+    <!-- We reuse an upgrade step from v60 -->\n+    <gs:upgradeDepends\n+      title="Run to_isiteschema upgrade profile."\n+      import_profile="plone.app.upgrade.v60:to_isiteschema"\n+      />\n   </gs:upgradeSteps>\n \n </configure>\n'

