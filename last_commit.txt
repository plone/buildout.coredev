Repository: plone.app.multilingual


Branch: refs/heads/7.x
Date: 2023-07-27T14:28:32+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.multilingual/commit/78cdb19b038b2979af482a8d9d7531a975948373

Fix setting Indonesian language cookie on site root.

Must be id, not id-id.
See https://github.com/plone/plone.app.multilingual/issues/304

Also, use `ILanguageUtility.setLanguageCookie` instead of setting a cookie ourselves.

Files changed:
A news/304.bugfix
M src/plone/app/multilingual/browser/switcher.py
M src/plone/app/multilingual/tests/test_switcher.py

b'diff --git a/news/304.bugfix b/news/304.bugfix\nnew file mode 100644\nindex 000000000..1c7b509e6\n--- /dev/null\n+++ b/news/304.bugfix\n@@ -0,0 +1,2 @@\n+Fix setting Indonesian language cookie on site root: must be ``id``, not ``id-id``.\n+[maurits]\ndiff --git a/src/plone/app/multilingual/browser/switcher.py b/src/plone/app/multilingual/browser/switcher.py\nindex 3820bd320..6d815502b 100644\n--- a/src/plone/app/multilingual/browser/switcher.py\n+++ b/src/plone/app/multilingual/browser/switcher.py\n@@ -1,6 +1,8 @@\n from Acquisition import aq_inner\n+from plone.i18n.interfaces import ILanguageUtility\n from Products.CMFCore.utils import getToolByName\n from Products.Five import BrowserView\n+from zope.component import getUtility\n \n \n class LanguageSwitcher(BrowserView):\n@@ -26,8 +28,10 @@ def __call__(self):\n \n         # We need to set the language cookie on the first response or it will\n         # be set on the frontpage itself, making it uncachable\n-        langCookie = self.request.cookies.get("I18N_LANGUAGE")\n-        if not langCookie or langCookie != target:\n-            self.request.response.setCookie("I18N_LANGUAGE", target, path="/")\n+        # In case of Indonesian, we need to use \'id\', not \'id-id\'.\n+        target = "id" if target == "id-id" else target\n+        tool = getUtility(ILanguageUtility)\n+        # setLanguageCookie calls getLanguageCookie, and only sets a cookie when needed.\n+        tool.setLanguageCookie(target, request=self.request)\n \n         self.request.response.redirect(url, status=302)\ndiff --git a/src/plone/app/multilingual/tests/test_switcher.py b/src/plone/app/multilingual/tests/test_switcher.py\nindex 14a8ac6db..b145f5ba9 100644\n--- a/src/plone/app/multilingual/tests/test_switcher.py\n+++ b/src/plone/app/multilingual/tests/test_switcher.py\n@@ -34,12 +34,14 @@ def setUp(self):\n     def test_switcher_redirects_to_default_english(self):\n         self.browser.open(self.portal_url)\n         self.assertEqual(self.browser.url, self.portal_url + "/en")\n+        self.assertEqual(self.browser.cookies["I18N_LANGUAGE"], "en")\n \n     def test_switcher_redirects_to_default_indonesian(self):\n         self.language_tool.setDefaultLanguage("id")\n         transaction.commit()\n         self.browser.open(self.portal_url)\n         self.assertEqual(self.browser.url, self.portal_url + "/id-id")\n+        self.assertEqual(self.browser.cookies["I18N_LANGUAGE"], "id")\n \n     def test_switcher_redirects_to_preferred_catalan(self):\n         # Tell Plone that we prefer Catalan.\n@@ -48,6 +50,7 @@ def test_switcher_redirects_to_preferred_catalan(self):\n         self.browser.open(self.portal_url)\n         # We get redirected to our preferred language root folder.\n         self.assertEqual(self.browser.url, self.portal_url + "/ca")\n+        self.assertEqual(self.browser.cookies["I18N_LANGUAGE"], "ca")\n \n     def test_switcher_redirects_to_preferred_indonesian(self):\n         # Tell Plone that we prefer Indonesian.\n@@ -56,3 +59,4 @@ def test_switcher_redirects_to_preferred_indonesian(self):\n         self.browser.open(self.portal_url)\n         # We get redirected to our preferred language root folder.\n         self.assertEqual(self.browser.url, self.portal_url + "/id-id")\n+        self.assertEqual(self.browser.cookies["I18N_LANGUAGE"], "id")\n'

Repository: plone.app.multilingual


Branch: refs/heads/7.x
Date: 2023-08-11T12:44:33+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.multilingual/commit/05ea121d77aa8c586352ee02459b569fd541d480

Merge pull request #429 from plone/maurits-indonesian-cookie-7x

Fix setting Indonesian language cookie on site root. [7.x]

Files changed:
A news/304.bugfix
M src/plone/app/multilingual/browser/switcher.py
M src/plone/app/multilingual/tests/test_switcher.py

b'diff --git a/news/304.bugfix b/news/304.bugfix\nnew file mode 100644\nindex 000000000..1c7b509e6\n--- /dev/null\n+++ b/news/304.bugfix\n@@ -0,0 +1,2 @@\n+Fix setting Indonesian language cookie on site root: must be ``id``, not ``id-id``.\n+[maurits]\ndiff --git a/src/plone/app/multilingual/browser/switcher.py b/src/plone/app/multilingual/browser/switcher.py\nindex 3820bd320..6d815502b 100644\n--- a/src/plone/app/multilingual/browser/switcher.py\n+++ b/src/plone/app/multilingual/browser/switcher.py\n@@ -1,6 +1,8 @@\n from Acquisition import aq_inner\n+from plone.i18n.interfaces import ILanguageUtility\n from Products.CMFCore.utils import getToolByName\n from Products.Five import BrowserView\n+from zope.component import getUtility\n \n \n class LanguageSwitcher(BrowserView):\n@@ -26,8 +28,10 @@ def __call__(self):\n \n         # We need to set the language cookie on the first response or it will\n         # be set on the frontpage itself, making it uncachable\n-        langCookie = self.request.cookies.get("I18N_LANGUAGE")\n-        if not langCookie or langCookie != target:\n-            self.request.response.setCookie("I18N_LANGUAGE", target, path="/")\n+        # In case of Indonesian, we need to use \'id\', not \'id-id\'.\n+        target = "id" if target == "id-id" else target\n+        tool = getUtility(ILanguageUtility)\n+        # setLanguageCookie calls getLanguageCookie, and only sets a cookie when needed.\n+        tool.setLanguageCookie(target, request=self.request)\n \n         self.request.response.redirect(url, status=302)\ndiff --git a/src/plone/app/multilingual/tests/test_switcher.py b/src/plone/app/multilingual/tests/test_switcher.py\nindex 14a8ac6db..b145f5ba9 100644\n--- a/src/plone/app/multilingual/tests/test_switcher.py\n+++ b/src/plone/app/multilingual/tests/test_switcher.py\n@@ -34,12 +34,14 @@ def setUp(self):\n     def test_switcher_redirects_to_default_english(self):\n         self.browser.open(self.portal_url)\n         self.assertEqual(self.browser.url, self.portal_url + "/en")\n+        self.assertEqual(self.browser.cookies["I18N_LANGUAGE"], "en")\n \n     def test_switcher_redirects_to_default_indonesian(self):\n         self.language_tool.setDefaultLanguage("id")\n         transaction.commit()\n         self.browser.open(self.portal_url)\n         self.assertEqual(self.browser.url, self.portal_url + "/id-id")\n+        self.assertEqual(self.browser.cookies["I18N_LANGUAGE"], "id")\n \n     def test_switcher_redirects_to_preferred_catalan(self):\n         # Tell Plone that we prefer Catalan.\n@@ -48,6 +50,7 @@ def test_switcher_redirects_to_preferred_catalan(self):\n         self.browser.open(self.portal_url)\n         # We get redirected to our preferred language root folder.\n         self.assertEqual(self.browser.url, self.portal_url + "/ca")\n+        self.assertEqual(self.browser.cookies["I18N_LANGUAGE"], "ca")\n \n     def test_switcher_redirects_to_preferred_indonesian(self):\n         # Tell Plone that we prefer Indonesian.\n@@ -56,3 +59,4 @@ def test_switcher_redirects_to_preferred_indonesian(self):\n         self.browser.open(self.portal_url)\n         # We get redirected to our preferred language root folder.\n         self.assertEqual(self.browser.url, self.portal_url + "/id-id")\n+        self.assertEqual(self.browser.cookies["I18N_LANGUAGE"], "id")\n'

