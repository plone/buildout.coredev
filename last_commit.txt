Repository: Products.CMFPlone


Branch: refs/heads/5.2.x
Date: 2020-09-09T09:51:40+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/f3f4aa119cd07af2a55f83f806b597cb2ceb6c3c

No longer doubly undo a response Content-Type change when combining bundles.

Files changed:
A news/1924.bugfix
M Products/CMFPlone/resources/exportimport/bundles.py

b"diff --git a/Products/CMFPlone/resources/exportimport/bundles.py b/Products/CMFPlone/resources/exportimport/bundles.py\nindex 9396b1c16d..1f3ca986b0 100644\n--- a/Products/CMFPlone/resources/exportimport/bundles.py\n+++ b/Products/CMFPlone/resources/exportimport/bundles.py\n@@ -2,7 +2,6 @@\n from ..browser.combine import combine_bundles\n from plone.registry.interfaces import IRegistry\n from zope.component import queryUtility\n-from zope.globalrequest import getRequest\n \n \n def combine(context):\n@@ -27,23 +26,9 @@ def combine(context):\n     if not found:\n         return\n \n-    # Calling combine_bundles will have as side effect that the\n-    # Content-Type header of the response is set to application/javascript,\n-    # which we do not want.  So we reset it to the original at the end.\n+    # Calling combine_bundles used to have as side effect that the\n+    # Content-Type header of the response was set to application/javascript,\n+    # which we do not want.  But that was fixed already in Plone 5.1b2.\n+    # See https://github.com/plone/Products.CMFPlone/pull/1924\n     site = context.getSite()\n-    request = getattr(site, 'REQUEST', getRequest())\n-    # In tests the request can easily be None.\n-    if request is not None:\n-        orig_header = request.response.getHeader('Content-Type')\n     combine_bundles(site)\n-    if request is None:\n-        # we are done\n-        return\n-    new_header = request.response.getHeader('Content-Type')\n-    if new_header == orig_header:\n-        return\n-    if orig_header is None:\n-        # Setting it to None would result in the string 'None'.\n-        # So pick a saner one.\n-        orig_header = 'text/html'\n-    request.response.setHeader('Content-Type', orig_header)\ndiff --git a/news/1924.bugfix b/news/1924.bugfix\nnew file mode 100644\nindex 0000000000..2e529f9963\n--- /dev/null\n+++ b/news/1924.bugfix\n@@ -0,0 +1,2 @@\n+No longer doubly undo a response Content-Type change when combining bundles.\n+[maurits]\n"

Repository: Products.CMFPlone


Branch: refs/heads/5.2.x
Date: 2020-09-09T12:18:10+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/d6feb72010a0a8eb1d1a65218778cbe298fb292f

Merge pull request #3170 from plone/maurits/combine-bundles-undo-content-type-52

No longer doubly undo Content-Type change when combining bundles

Files changed:
A news/1924.bugfix
M Products/CMFPlone/resources/exportimport/bundles.py

b"diff --git a/Products/CMFPlone/resources/exportimport/bundles.py b/Products/CMFPlone/resources/exportimport/bundles.py\nindex 9396b1c16d..1f3ca986b0 100644\n--- a/Products/CMFPlone/resources/exportimport/bundles.py\n+++ b/Products/CMFPlone/resources/exportimport/bundles.py\n@@ -2,7 +2,6 @@\n from ..browser.combine import combine_bundles\n from plone.registry.interfaces import IRegistry\n from zope.component import queryUtility\n-from zope.globalrequest import getRequest\n \n \n def combine(context):\n@@ -27,23 +26,9 @@ def combine(context):\n     if not found:\n         return\n \n-    # Calling combine_bundles will have as side effect that the\n-    # Content-Type header of the response is set to application/javascript,\n-    # which we do not want.  So we reset it to the original at the end.\n+    # Calling combine_bundles used to have as side effect that the\n+    # Content-Type header of the response was set to application/javascript,\n+    # which we do not want.  But that was fixed already in Plone 5.1b2.\n+    # See https://github.com/plone/Products.CMFPlone/pull/1924\n     site = context.getSite()\n-    request = getattr(site, 'REQUEST', getRequest())\n-    # In tests the request can easily be None.\n-    if request is not None:\n-        orig_header = request.response.getHeader('Content-Type')\n     combine_bundles(site)\n-    if request is None:\n-        # we are done\n-        return\n-    new_header = request.response.getHeader('Content-Type')\n-    if new_header == orig_header:\n-        return\n-    if orig_header is None:\n-        # Setting it to None would result in the string 'None'.\n-        # So pick a saner one.\n-        orig_header = 'text/html'\n-    request.response.setHeader('Content-Type', orig_header)\ndiff --git a/news/1924.bugfix b/news/1924.bugfix\nnew file mode 100644\nindex 0000000000..2e529f9963\n--- /dev/null\n+++ b/news/1924.bugfix\n@@ -0,0 +1,2 @@\n+No longer doubly undo a response Content-Type change when combining bundles.\n+[maurits]\n"

