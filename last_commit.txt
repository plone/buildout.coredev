Repository: plone.restapi


Branch: refs/heads/main
Date: 2024-01-13T17:54:09-08:00
Author: Wesley Barroso Lopes (wesleybl) <wesleybl@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/799f5acd09687c837436fa0c19d1612e41089c36

Translate validation error messages in the deserializer (#1743)

* Translate validation error messages in the deserializer

* Update translations

* Try to fix build error

* different fix

* another fix

* pin sphinxcontrib-htmlhelp

* more pins

---------

Co-authored-by: David Glick &lt;david@glicksoftware.com&gt;

Files changed:
A news/1742.feature
M requirements-docs.txt
M src/plone/restapi/deserializer/dxcontent.py
M src/plone/restapi/locales/de/LC_MESSAGES/plone.restapi.po
M src/plone/restapi/locales/es/LC_MESSAGES/plone.restapi.po
M src/plone/restapi/locales/fr/LC_MESSAGES/plone.restapi.po
M src/plone/restapi/locales/plone.restapi.pot
M src/plone/restapi/locales/pt_BR/LC_MESSAGES/plone.restapi.po
M src/plone/restapi/tests/test_dxcontent_deserializer.py

b'diff --git a/news/1742.feature b/news/1742.feature\nnew file mode 100644\nindex 0000000000..72bf2781b4\n--- /dev/null\n+++ b/news/1742.feature\n@@ -0,0 +1 @@\n+Translate validation error messages in the deserializer. @wesleybl\ndiff --git a/requirements-docs.txt b/requirements-docs.txt\nindex dbff148650..a522f65309 100644\n--- a/requirements-docs.txt\n+++ b/requirements-docs.txt\n@@ -1,5 +1,10 @@\n docutils<0.17,>=0.15  # sphinx-book-theme 0.2.0 has requirement docutils<0.17,>=0.15\n Sphinx<5,>=3  # sphinx-book-theme 0.3.3 has requirement sphinx<5,>=3\n+sphinxcontrib-applehelp==1.0.4  # newer versions require sphinx 5\n+sphinxcontrib-devhelp==1.0.2   # newer versions require sphinx 5\n+sphinxcontrib-htmlhelp==2.0.1  # newer versions require sphinx 5\n+sphinxcontrib-qthelp==1.0.3  # newer versions require sphinx 5\n+sphinxcontrib-serializinghtml==1.1.5  # newer versions require sphinx 5\n jsx-lexer\n lesscpy\n linkify-it-py\ndiff --git a/src/plone/restapi/deserializer/dxcontent.py b/src/plone/restapi/deserializer/dxcontent.py\nindex 88258ab044..dd6bac1851 100644\n--- a/src/plone/restapi/deserializer/dxcontent.py\n+++ b/src/plone/restapi/deserializer/dxcontent.py\n@@ -3,6 +3,7 @@\n from plone.autoform.interfaces import WRITE_PERMISSIONS_KEY\n from plone.dexterity.interfaces import IDexterityContent\n from plone.dexterity.utils import iterSchemata\n+from plone.restapi import _\n from plone.restapi.deserializer import json_body\n from plone.restapi.interfaces import IDeserializeFromJson\n from plone.restapi.interfaces import IFieldDeserializer\n@@ -14,6 +15,7 @@\n from zope.component import queryMultiAdapter\n from zope.component import queryUtility\n from zope.event import notify\n+from zope.i18n import translate\n from zope.interface import implementer\n from zope.interface import Interface\n from zope.lifecycleevent import Attributes\n@@ -49,7 +51,7 @@ def __call__(\n                 (self.context, self.request, None, schema, None), IManagerValidator\n             )\n             for error in validator.validate(field_data):\n-                errors.append({"error": error, "message": str(error)})\n+                errors.append({"error": error, "message": error.args[0]})\n \n         if errors:\n             if mask_validation_errors:\n@@ -57,6 +59,8 @@ def __call__(\n                 # errors on front-end\n                 for error in errors:\n                     error["error"] = "ValidationError"\n+            for error in errors:\n+                error["message"] = translate(error["message"], context=self.request)\n             raise BadRequest(errors)\n \n         # We\'ll set the layout after the validation and even if there\n@@ -109,11 +113,10 @@ def get_schema_data(self, data, validate_all, create=False):\n                             errors.append(\n                                 {\n                                     "field": field.__name__,\n-                                    "message": (\n-                                        "{} is a required field.".format(\n-                                            field.__name__\n-                                        ),\n-                                        "Setting it to null is not allowed.",\n+                                    "message": _(\n+                                        "${field_name} is a required field."\n+                                        " Setting it to null is not allowed.",\n+                                        mapping={"field_name": field.__name__},\n                                     ),\n                                 }\n                             )\ndiff --git a/src/plone/restapi/locales/de/LC_MESSAGES/plone.restapi.po b/src/plone/restapi/locales/de/LC_MESSAGES/plone.restapi.po\nindex 0a4c1ec545..2d78df1696 100644\n--- a/src/plone/restapi/locales/de/LC_MESSAGES/plone.restapi.po\n+++ b/src/plone/restapi/locales/de/LC_MESSAGES/plone.restapi.po\n@@ -1,7 +1,7 @@\n msgid ""\n msgstr ""\n "Project-Id-Version: PACKAGE VERSION\\n"\n-"POT-Creation-Date: 2023-09-25 20:32+0000\\n"\n+"POT-Creation-Date: 2023-12-22 19:57+0000\\n"\n "PO-Revision-Date: YEAR-MO-DA HO:MI +ZONE\\n"\n "Last-Translator: Timo Stollenwerk <tisto@plone.org>\\n"\n "Language-Team: German <DE@li.org>\\n"\n@@ -14,6 +14,10 @@ msgstr ""\n "Preferred-Encodings: utf-8 latin1\\n"\n "Domain: plone.restapi\\n"\n \n+#: plone/restapi/deserializer/dxcontent.py:116\n+msgid "${field_name} is a required field. Setting it to null is not allowed."\n+msgstr ""\n+\n #: plone/restapi/services/email_send/post.py:88\n msgid "${sender_fullname} via ${portal_title}"\n msgstr "${sender_fullname} via ${portal_title}"\ndiff --git a/src/plone/restapi/locales/es/LC_MESSAGES/plone.restapi.po b/src/plone/restapi/locales/es/LC_MESSAGES/plone.restapi.po\nindex 6510309a30..c9acdf7e22 100644\n--- a/src/plone/restapi/locales/es/LC_MESSAGES/plone.restapi.po\n+++ b/src/plone/restapi/locales/es/LC_MESSAGES/plone.restapi.po\n@@ -4,7 +4,7 @@\n msgid ""\n msgstr ""\n "Project-Id-Version: Plone\\n"\n-"POT-Creation-Date: 2023-09-25 20:32+0000\\n"\n+"POT-Creation-Date: 2023-12-22 19:57+0000\\n"\n "PO-Revision-Date: 2023-08-23 21:19-0400\\n"\n "Last-Translator: Leonardo J. Caballero G. <leonardocaballero@gmail.com>\\n"\n "Language-Team: ES <LL@li.org>\\n"\n@@ -20,6 +20,10 @@ msgstr ""\n "X-Generator: Poedit 3.3.2\\n"\n "X-Is-Fallback-For: es-ar es-bo es-cl es-co es-cr es-do es-ec es-es es-sv es-gt es-hn es-mx es-ni es-pa es-py es-pe es-pr es-us es-uy es-ve\\n"\n \n+#: plone/restapi/deserializer/dxcontent.py:116\n+msgid "${field_name} is a required field. Setting it to null is not allowed."\n+msgstr ""\n+\n #: plone/restapi/services/email_send/post.py:88\n msgid "${sender_fullname} via ${portal_title}"\n msgstr "${sender_fullname} v\xc3\xada ${portal_title}"\ndiff --git a/src/plone/restapi/locales/fr/LC_MESSAGES/plone.restapi.po b/src/plone/restapi/locales/fr/LC_MESSAGES/plone.restapi.po\nindex 9d25934588..3570cdfa24 100644\n--- a/src/plone/restapi/locales/fr/LC_MESSAGES/plone.restapi.po\n+++ b/src/plone/restapi/locales/fr/LC_MESSAGES/plone.restapi.po\n@@ -1,7 +1,7 @@\n msgid ""\n msgstr ""\n "Project-Id-Version: PACKAGE VERSION\\n"\n-"POT-Creation-Date: 2023-09-25 20:32+0000\\n"\n+"POT-Creation-Date: 2023-12-22 19:57+0000\\n"\n "PO-Revision-Date: YEAR-MO-DA HO:MI +ZONE\\n"\n "Last-Translator: Julien Chandelle <jchandelle@affinitic.be>\\n"\n "Language-Team: French <FR@li.org>\\n"\n@@ -14,6 +14,10 @@ msgstr ""\n "Preferred-Encodings: utf-8 latin1\\n"\n "Domain: plone.restapi\\n"\n \n+#: plone/restapi/deserializer/dxcontent.py:116\n+msgid "${field_name} is a required field. Setting it to null is not allowed."\n+msgstr ""\n+\n #: plone/restapi/services/email_send/post.py:88\n msgid "${sender_fullname} via ${portal_title}"\n msgstr "${sender_fullname} via ${portal_title}"\ndiff --git a/src/plone/restapi/locales/plone.restapi.pot b/src/plone/restapi/locales/plone.restapi.pot\nindex d1d2abf57a..8b6c3c59c3 100644\n--- a/src/plone/restapi/locales/plone.restapi.pot\n+++ b/src/plone/restapi/locales/plone.restapi.pot\n@@ -4,7 +4,7 @@\n msgid ""\n msgstr ""\n "Project-Id-Version: PACKAGE VERSION\\n"\n-"POT-Creation-Date: 2023-09-25 20:32+0000\\n"\n+"POT-Creation-Date: 2023-12-22 19:57+0000\\n"\n "PO-Revision-Date: YEAR-MO-DA HO:MI +ZONE\\n"\n "Last-Translator: FULL NAME <EMAIL@ADDRESS>\\n"\n "Language-Team: LANGUAGE <LL@li.org>\\n"\n@@ -17,6 +17,10 @@ msgstr ""\n "Preferred-Encodings: utf-8 latin1\\n"\n "Domain: plone.restapi\\n"\n \n+#: plone/restapi/deserializer/dxcontent.py:116\n+msgid "${field_name} is a required field. Setting it to null is not allowed."\n+msgstr ""\n+\n #: plone/restapi/services/email_send/post.py:88\n msgid "${sender_fullname} via ${portal_title}"\n msgstr ""\ndiff --git a/src/plone/restapi/locales/pt_BR/LC_MESSAGES/plone.restapi.po b/src/plone/restapi/locales/pt_BR/LC_MESSAGES/plone.restapi.po\nindex dd921dca1f..8027d92919 100644\n--- a/src/plone/restapi/locales/pt_BR/LC_MESSAGES/plone.restapi.po\n+++ b/src/plone/restapi/locales/pt_BR/LC_MESSAGES/plone.restapi.po\n@@ -1,7 +1,7 @@\n msgid ""\n msgstr ""\n "Project-Id-Version: plone.restapi\\n"\n-"POT-Creation-Date: 2023-09-25 20:32+0000\\n"\n+"POT-Creation-Date: 2023-12-22 19:57+0000\\n"\n "PO-Revision-Date: YEAR-MO-DA HO:MI +ZONE\\n"\n "Last-Translator: Wesley Barroso Lopes\\n"\n "Language-Team: \\n"\n@@ -14,6 +14,10 @@ msgstr ""\n "Preferred-Encodings: utf-8 latin1\\n"\n "Domain: plone.restapi\\n"\n \n+#: plone/restapi/deserializer/dxcontent.py:116\n+msgid "${field_name} is a required field. Setting it to null is not allowed."\n+msgstr "${field_name} \xc3\xa9 um campo obrigat\xc3\xb3rio. N\xc3\xa3o \xc3\xa9 permitido defini-lo como nulo."\n+\n #: plone/restapi/services/email_send/post.py:88\n msgid "${sender_fullname} via ${portal_title}"\n msgstr ""\ndiff --git a/src/plone/restapi/tests/test_dxcontent_deserializer.py b/src/plone/restapi/tests/test_dxcontent_deserializer.py\nindex e9cc6fdf14..ddeb4ef767 100644\n--- a/src/plone/restapi/tests/test_dxcontent_deserializer.py\n+++ b/src/plone/restapi/tests/test_dxcontent_deserializer.py\n@@ -195,10 +195,7 @@ def test_deserializer_sets_missing_value_on_required_field(self):\n             "valid value", self.portal.doc1.test_missing_value_required_field\n         )\n         self.assertEqual(\n-            (\n-                "test_missing_value_required_field is a required field.",\n-                "Setting it to null is not allowed.",\n-            ),\n+            "test_missing_value_required_field is a required field. Setting it to null is not allowed.",\n             cm.exception.args[0][0]["message"],\n         )\n         self.assertEqual(\n'

