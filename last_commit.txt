Repository: plone.app.multilingual


Branch: refs/heads/5.6.x
Date: 2021-10-08T02:08:57+02:00
Author: mamico (mamico) <mauro.amico@gmail.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/c351818764ddc9ad481557c30cfccc369c9a34fb

Disable CSRF protection during the setting of TG attribute. #375 backport

Files changed:
M src/plone/app/multilingual/manager.py
M src/plone/app/multilingual/subscriber.py

b"diff --git a/src/plone/app/multilingual/manager.py b/src/plone/app/multilingual/manager.py\nindex 8981e66b..0a3a2f21 100644\n--- a/src/plone/app/multilingual/manager.py\n+++ b/src/plone/app/multilingual/manager.py\n@@ -12,12 +12,15 @@\n from plone.app.multilingual.interfaces import NOTG\n from plone.app.multilingual.itg import addAttributeTG\n from plone.app.uuid.utils import uuidToObject\n+from plone.protect.interfaces import IDisableCSRFProtection\n from plone.uuid.handlers import addAttributeUUID\n from plone.uuid.interfaces import IUUID\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.interfaces import ILanguage\n from zope.component.hooks import getSite\n from zope.event import notify\n+from zope.globalrequest import getRequest\n+from zope.interface import alsoProvides\n from zope.interface import implementer\n \n \n@@ -43,7 +46,7 @@ def get_id(self, context):\n         # We must ensure that this case can't happen, any object translatable\n         # will have an UUID (in any case we can be at the portal factory!)\n         except KeyError:\n-            context._v_safe_write = True\n+            alsoProvides(getRequest(), IDisableCSRFProtection)\n             addAttributeUUID(context, None)\n             context.reindexObject(idxs=['UID'])\n             context_id = IUUID(context)\n@@ -57,8 +60,9 @@ def get_tg(self, context):\n         try:\n             context_id = ITG(context)\n         # We must ensure that this case can't happen, any object translatable\n-        # will have an UUID (in any case we can be at the portal factory!)\n+        # will have an TG (in any case we can be at the portal factory!)\n         except TypeError:\n+            alsoProvides(getRequest(), IDisableCSRFProtection)\n             addAttributeTG(context, None)\n             context.reindexObject(idxs=['TranslationGroup'])\n             context_id = ITG(context)\ndiff --git a/src/plone/app/multilingual/subscriber.py b/src/plone/app/multilingual/subscriber.py\nindex 6069fb7b..42816ad6 100644\n--- a/src/plone/app/multilingual/subscriber.py\n+++ b/src/plone/app/multilingual/subscriber.py\n@@ -5,9 +5,11 @@\n from plone.app.multilingual.interfaces import ILanguageIndependentFolder\n from plone.app.multilingual.interfaces import IMutableTG\n from plone.app.multilingual.interfaces import IPloneAppMultilingualInstalled\n+from plone.app.multilingual.interfaces import ITG\n from plone.app.multilingual.interfaces import ITranslatable\n from plone.app.multilingual.interfaces import ITranslationManager\n from plone.app.multilingual.interfaces import LANGUAGE_INDEPENDENT\n+from plone.app.multilingual.itg import addAttributeTG\n from plone.dexterity.interfaces import IDexterityContent\n from plone.uuid.interfaces import IUUID\n from Products.CMFCore.interfaces import IFolderish\n@@ -116,6 +118,9 @@ def set_recursive_language(ob, language):\n \n     elif ILanguage(ob).get_language() != language:\n         ILanguage(ob).set_language(language)\n+        if ITG(ob, None) is None:\n+            addAttributeTG(ob, None)\n+            ob.reindexObject(idxs=['TranslationGroup'])\n         ITranslationManager(ob).update()\n         reindex_object(ob)\n \n"

