Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2023-05-24T01:08:36+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/c09ada99e5ef2420af4e46c90110bf8bc172f2a5

Fix TinyMCE problem: Tools and View do not show up in menubar.

The menubar contained "toolsview" instead.
Fixes https://github.com/plone/Products.CMFPlone/issues/3785

Files changed:
A news/3785.bugfix
M plone/app/upgrade/v60/configure.zcml
M plone/app/upgrade/v60/final.py

b'diff --git a/news/3785.bugfix b/news/3785.bugfix\nnew file mode 100644\nindex 00000000..1a814b73\n--- /dev/null\n+++ b/news/3785.bugfix\n@@ -0,0 +1,3 @@\n+Fix TinyMCE problem: Tools and View do not show up in menubar.\n+The menubar contained "toolsview" instead.\n+[maurits]\ndiff --git a/plone/app/upgrade/v60/configure.zcml b/plone/app/upgrade/v60/configure.zcml\nindex 7bc330f6..c7b3b277 100644\n--- a/plone/app/upgrade/v60/configure.zcml\n+++ b/plone/app/upgrade/v60/configure.zcml\n@@ -283,8 +283,8 @@\n         <!-- Plone 6.0.5 -->\n \n         <gs:upgradeStep\n-            title="Miscellaneous"\n-            handler="..utils.null_upgrade_step"\n+            title="Fix TinyMCE menubar"\n+            handler=".final.fix_tinymce_menubar"\n             />\n \n     </gs:upgradeSteps>\ndiff --git a/plone/app/upgrade/v60/final.py b/plone/app/upgrade/v60/final.py\nindex d2d449e3..df51c04b 100644\n--- a/plone/app/upgrade/v60/final.py\n+++ b/plone/app/upgrade/v60/final.py\n@@ -1,5 +1,7 @@\n from AccessControl.Permission import Permission\n from plone.base.utils import get_installer\n+from plone.registry.interfaces import IRegistry\n+from zope.component import getUtility\n from zope.component.hooks import getSite\n \n import logging\n@@ -117,3 +119,22 @@ def fix_iterate_profiles(context):\n     else:\n         # Now seems a good time to run any upgrade steps.\n         installer.upgrade_product(product)\n+\n+\n+def fix_tinymce_menubar(context):\n+    """Fix menubar with \'toolsview\' instead of \'tools\' and \'view\'.\n+\n+    See https://github.com/plone/Products.CMFPlone/issues/3785\n+    """\n+    registry = getUtility(IRegistry)\n+    record = registry.records.get("plone.menubar")\n+    if record is None:\n+        return\n+    value = record.value\n+    if "toolsview" not in value:\n+        return\n+    index = value.index("toolsview")\n+    value.pop(index)\n+    value.insert(index, "view")\n+    value.insert(index, "tools")\n+    record.value = value\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2023-05-24T09:06:50+02:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.upgrade/commit/790090c07718a8c70fac2a3142277eb6f786f158

Merge pull request #316 from plone/maurits-tinymce-menubar-issue-3785

Fix TinyMCE problem: Tools and View do not show up in menubar.

Files changed:
A news/3785.bugfix
M plone/app/upgrade/v60/configure.zcml
M plone/app/upgrade/v60/final.py

b'diff --git a/news/3785.bugfix b/news/3785.bugfix\nnew file mode 100644\nindex 00000000..1a814b73\n--- /dev/null\n+++ b/news/3785.bugfix\n@@ -0,0 +1,3 @@\n+Fix TinyMCE problem: Tools and View do not show up in menubar.\n+The menubar contained "toolsview" instead.\n+[maurits]\ndiff --git a/plone/app/upgrade/v60/configure.zcml b/plone/app/upgrade/v60/configure.zcml\nindex 7bc330f6..c7b3b277 100644\n--- a/plone/app/upgrade/v60/configure.zcml\n+++ b/plone/app/upgrade/v60/configure.zcml\n@@ -283,8 +283,8 @@\n         <!-- Plone 6.0.5 -->\n \n         <gs:upgradeStep\n-            title="Miscellaneous"\n-            handler="..utils.null_upgrade_step"\n+            title="Fix TinyMCE menubar"\n+            handler=".final.fix_tinymce_menubar"\n             />\n \n     </gs:upgradeSteps>\ndiff --git a/plone/app/upgrade/v60/final.py b/plone/app/upgrade/v60/final.py\nindex d2d449e3..df51c04b 100644\n--- a/plone/app/upgrade/v60/final.py\n+++ b/plone/app/upgrade/v60/final.py\n@@ -1,5 +1,7 @@\n from AccessControl.Permission import Permission\n from plone.base.utils import get_installer\n+from plone.registry.interfaces import IRegistry\n+from zope.component import getUtility\n from zope.component.hooks import getSite\n \n import logging\n@@ -117,3 +119,22 @@ def fix_iterate_profiles(context):\n     else:\n         # Now seems a good time to run any upgrade steps.\n         installer.upgrade_product(product)\n+\n+\n+def fix_tinymce_menubar(context):\n+    """Fix menubar with \'toolsview\' instead of \'tools\' and \'view\'.\n+\n+    See https://github.com/plone/Products.CMFPlone/issues/3785\n+    """\n+    registry = getUtility(IRegistry)\n+    record = registry.records.get("plone.menubar")\n+    if record is None:\n+        return\n+    value = record.value\n+    if "toolsview" not in value:\n+        return\n+    index = value.index("toolsview")\n+    value.pop(index)\n+    value.insert(index, "view")\n+    value.insert(index, "tools")\n+    record.value = value\n'

