Repository: Products.CMFPlone


Branch: refs/heads/6.0.x
Date: 2024-10-17T07:56:22-07:00
Author: Peter Mathis (petschki) <petschki@users.noreply.github.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/90d3b81468a332c3356b1538c3ed7d6b9515ae5f

Respect new "strict parsing" of `emails.utils.getaddresses` [6.0] (#4033)

* Respect new strict parsing of `email.utils.getaddresses`

* changenote

* cleanup address and check early for empty value

Files changed:
A news/4020.bugfix
M Products/CMFPlone/PloneTool.py
M Products/CMFPlone/tests/testPloneTool.py

b'diff --git a/Products/CMFPlone/PloneTool.py b/Products/CMFPlone/PloneTool.py\nindex 886d93ff63..f32e42125c 100644\n--- a/Products/CMFPlone/PloneTool.py\n+++ b/Products/CMFPlone/PloneTool.py\n@@ -137,6 +137,12 @@ def validateSingleNormalizedEmailAddress(self, address):\n         if not isinstance(address, str):\n             return False\n \n+        address = address.strip()\n+\n+        # address can be empty if getaddresses has parsing errors (returns [("", "")])\n+        if address == "":\n+            return False\n+\n         sub = EMAIL_CUTOFF_RE.match(address)\n         if sub is not None:\n             # Address contains two newlines (possible spammer relay attack)\ndiff --git a/Products/CMFPlone/tests/testPloneTool.py b/Products/CMFPlone/tests/testPloneTool.py\nindex 712dbb04aa..d5b20d2beb 100644\n--- a/Products/CMFPlone/tests/testPloneTool.py\n+++ b/Products/CMFPlone/tests/testPloneTool.py\n@@ -74,7 +74,6 @@ def testvalidateEmailAddresses(self):\n         validInputs = (\n             "user@example.org",\n             "user@example.org,\\n user2@example.org",\n-            "user@example.org\\n user2@example.org",  # omitting comma is ok\n             "USER@EXAMPLE.ORG,\\n User2@Example.Org",\n         )\n         invalidInputs = (\ndiff --git a/news/4020.bugfix b/news/4020.bugfix\nnew file mode 100644\nindex 0000000000..e9cc73c207\n--- /dev/null\n+++ b/news/4020.bugfix\n@@ -0,0 +1,2 @@\n+Update for strict parsing in `email.utils.getaddresses` newest versions.\n+[petschki]\n'

