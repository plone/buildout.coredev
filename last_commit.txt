Repository: plone.dexterity


Branch: refs/heads/master
Date: 2021-07-27T17:46:20+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.dexterity/commit/5ead342f0e43992b8faa48c7da46e776a6441872

Fix export/import of content in Python 3.

Fixes https://github.com/plone/plone.dexterity/issues/124

Also fixes the tests in combination with newest `Products.GenericSetup` 2.1.2.
In fact, with this fix they now fail with earlier versions.

Files changed:
A news/124.bugfix
M plone/dexterity/exportimport.py

b"diff --git a/news/124.bugfix b/news/124.bugfix\nnew file mode 100644\nindex 0000000..f2cff33\n--- /dev/null\n+++ b/news/124.bugfix\n@@ -0,0 +1,4 @@\n+Fix export/import of content in Python 3.\n+Fixes `issue 124 <https://github.com/plone/plone.dexterity/issues/124>`_.\n+Also fixes the tests in combination with newest ``Products.GenericSetup`` 2.1.2.\n+[maurits]\ndiff --git a/plone/dexterity/exportimport.py b/plone/dexterity/exportimport.py\nindex 949c0b1..591f825 100644\n--- a/plone/dexterity/exportimport.py\n+++ b/plone/dexterity/exportimport.py\n@@ -9,10 +9,13 @@\n from Products.GenericSetup.interfaces import IFilesystemExporter\n from Products.GenericSetup.interfaces import IFilesystemImporter\n from Products.GenericSetup.utils import _getDottedName\n+from six import BytesIO\n from six import StringIO\n from zope.component import queryAdapter\n from zope.interface import implementer\n \n+import six\n+\n \n @implementer(IFilesystemExporter, IFilesystemImporter)\n class DexterityContentExporterImporter(FolderishExporterImporter):\n@@ -92,7 +95,7 @@ def import_(self, import_context, subdir, root=False):\n \n         data = import_context.readDataFile('.data', subdir)\n         if data is not None:\n-            request = FauxDAVRequest(BODY=data, BODYFILE=StringIO(data))\n+            request = FauxDAVRequest(BODY=data, BODYFILE=BytesIO(data))\n             response = FauxDAVResponse()\n             context.PUT(request, response)\n \n@@ -104,6 +107,9 @@ def import_(self, import_context, subdir, root=False):\n         if not preserve:\n             preserve = []\n         else:\n+            # Make sure ``preserve`` is a native string\n+            if six.PY3 and not isinstance(preserve, str):\n+                preserve = preserve.decode('utf-8')\n             preserve = _globtest(preserve, prior)\n \n         preserve.extend([x[0] for x in must_preserve])\n@@ -117,6 +123,8 @@ def import_(self, import_context, subdir, root=False):\n             return\n \n         dialect = 'excel'\n+        if six.PY3 and not isinstance(objects, str):\n+            objects = objects.decode('utf-8')\n         stream = StringIO(objects)\n \n         rowiter = reader(stream, dialect)\n"

Repository: plone.dexterity


Branch: refs/heads/master
Date: 2021-07-27T20:18:01+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.dexterity/commit/0bf7da77b6bf04883aeff8103749213ce15dc299

Let exportimport tests pass with GenericSetup 2.1.1 and earlier as well.

Files changed:
M plone/dexterity/tests/test_exportimport.py

b"diff --git a/plone/dexterity/tests/test_exportimport.py b/plone/dexterity/tests/test_exportimport.py\nindex 2715da1..0194037 100644\n--- a/plone/dexterity/tests/test_exportimport.py\n+++ b/plone/dexterity/tests/test_exportimport.py\n@@ -38,7 +38,7 @@ def PUT(self, request, response):\n         item = DummyItem('test')\n \n         import_context = DummyImportContext(None)\n-        import_context._files['.data'] = 'title: Foo'\n+        import_context._files['.data'] = b'title: Foo'\n         importer = DexterityContentExporterImporter(item)\n         importer.import_(import_context, None, root=True)\n \n"

Repository: plone.dexterity


Branch: refs/heads/master
Date: 2021-07-28T08:47:56+02:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.dexterity/commit/e61ff6b0e30df2147e21946f3a1de318a78a2684

Merge pull request #152 from plone/maurits/issue-124-exportimport

Fix export/import of content in Python 3.

Files changed:
A news/124.bugfix
M plone/dexterity/exportimport.py
M plone/dexterity/tests/test_exportimport.py

b"diff --git a/news/124.bugfix b/news/124.bugfix\nnew file mode 100644\nindex 0000000..f2cff33\n--- /dev/null\n+++ b/news/124.bugfix\n@@ -0,0 +1,4 @@\n+Fix export/import of content in Python 3.\n+Fixes `issue 124 <https://github.com/plone/plone.dexterity/issues/124>`_.\n+Also fixes the tests in combination with newest ``Products.GenericSetup`` 2.1.2.\n+[maurits]\ndiff --git a/plone/dexterity/exportimport.py b/plone/dexterity/exportimport.py\nindex 949c0b1..591f825 100644\n--- a/plone/dexterity/exportimport.py\n+++ b/plone/dexterity/exportimport.py\n@@ -9,10 +9,13 @@\n from Products.GenericSetup.interfaces import IFilesystemExporter\n from Products.GenericSetup.interfaces import IFilesystemImporter\n from Products.GenericSetup.utils import _getDottedName\n+from six import BytesIO\n from six import StringIO\n from zope.component import queryAdapter\n from zope.interface import implementer\n \n+import six\n+\n \n @implementer(IFilesystemExporter, IFilesystemImporter)\n class DexterityContentExporterImporter(FolderishExporterImporter):\n@@ -92,7 +95,7 @@ def import_(self, import_context, subdir, root=False):\n \n         data = import_context.readDataFile('.data', subdir)\n         if data is not None:\n-            request = FauxDAVRequest(BODY=data, BODYFILE=StringIO(data))\n+            request = FauxDAVRequest(BODY=data, BODYFILE=BytesIO(data))\n             response = FauxDAVResponse()\n             context.PUT(request, response)\n \n@@ -104,6 +107,9 @@ def import_(self, import_context, subdir, root=False):\n         if not preserve:\n             preserve = []\n         else:\n+            # Make sure ``preserve`` is a native string\n+            if six.PY3 and not isinstance(preserve, str):\n+                preserve = preserve.decode('utf-8')\n             preserve = _globtest(preserve, prior)\n \n         preserve.extend([x[0] for x in must_preserve])\n@@ -117,6 +123,8 @@ def import_(self, import_context, subdir, root=False):\n             return\n \n         dialect = 'excel'\n+        if six.PY3 and not isinstance(objects, str):\n+            objects = objects.decode('utf-8')\n         stream = StringIO(objects)\n \n         rowiter = reader(stream, dialect)\ndiff --git a/plone/dexterity/tests/test_exportimport.py b/plone/dexterity/tests/test_exportimport.py\nindex 2715da1..0194037 100644\n--- a/plone/dexterity/tests/test_exportimport.py\n+++ b/plone/dexterity/tests/test_exportimport.py\n@@ -38,7 +38,7 @@ def PUT(self, request, response):\n         item = DummyItem('test')\n \n         import_context = DummyImportContext(None)\n-        import_context._files['.data'] = 'title: Foo'\n+        import_context._files['.data'] = b'title: Foo'\n         importer = DexterityContentExporterImporter(item)\n         importer.import_(import_context, None, root=True)\n \n"

