Repository: plone.restapi


Branch: refs/heads/7.x.x
Date: 2021-05-25T23:28:52+02:00
Author: Wesley Barroso Lopes (wesleybl) <wesleybl@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/76491078916875097bfc8587db4507f48e9e6728

Fix intermittent failures in test_batching (#1127) (#1138)

The default ordering of Plone is by relevance. Therefore, it is not
guaranteed that all searches without sort_on, have the same order.

Listings of contents of folders and collections with batch don't accept
sort_on. In such cases, without sort_on it is not possible to force a
different order of relevance.

Because of this, this test had intermittent failures.

This fixes jobs like:

https://github.com/plone/plone.restapi/runs/2577842538#step:11:65

Files changed:
M src/plone/restapi/tests/test_batching.py

b'diff --git a/src/plone/restapi/tests/test_batching.py b/src/plone/restapi/tests/test_batching.py\nindex 6251fdfef..d235f546d 100644\n--- a/src/plone/restapi/tests/test_batching.py\n+++ b/src/plone/restapi/tests/test_batching.py\n@@ -102,7 +102,9 @@ def test_contains_batching_links(self):\n \n     def test_contains_correct_batch_of_items(self):\n         # Fetch the second page of the batch\n-        response = self.api_session.get("/folder/@search?b_start=2&b_size=2")\n+        response = self.api_session.get(\n+            "/folder/@search?sort_on=path&b_start=2&b_size=2"\n+        )\n \n         # Response should contain second batch of items\n         self.assertEqual(\n@@ -172,9 +174,10 @@ def test_contains_correct_batch_of_items(self):\n         response = self.api_session.get("/collection?b_start=2&b_size=2")\n \n         # Response should contain second batch of items\n-        self.assertEqual(\n-            [u"/plone/folder/doc-2", u"/plone/folder/doc-3"],\n-            result_paths(response.json()),\n+        _result_paths = result_paths(response.json())\n+        self.assertEqual(2, len(_result_paths))\n+        self.assertTrue(\n+            all(path.startswith(u"/plone/folder/doc-") for path in _result_paths)\n         )\n \n     def test_total_item_count_is_correct(self):\n@@ -232,9 +235,10 @@ def test_contains_correct_batch_of_items(self):\n         response = self.api_session.get("/folder?b_start=2&b_size=2")\n \n         # Response should contain second batch of items\n-        self.assertEqual(\n-            [u"/plone/folder/doc-3", u"/plone/folder/doc-4"],\n-            result_paths(response.json()),\n+        _result_paths = result_paths(response.json())\n+        self.assertEqual(2, len(_result_paths))\n+        self.assertTrue(\n+            all(path.startswith(u"/plone/folder/doc-") for path in _result_paths)\n         )\n \n     def test_total_item_count_is_correct(self):\n@@ -308,9 +312,9 @@ def test_contains_correct_batch_of_items(self):\n         response = self.api_session.get("/?b_start=2&b_size=2")\n \n         # Response should contain second batch of items\n-        self.assertEqual(\n-            [u"/plone/doc-3", u"/plone/doc-4"], result_paths(response.json())\n-        )\n+        _result_paths = result_paths(response.json())\n+        self.assertEqual(2, len(_result_paths))\n+        self.assertTrue(all(path.startswith(u"/plone/doc-") for path in _result_paths))\n \n     def test_total_item_count_is_correct(self):\n         # Fetch the second page of the batch\n'

