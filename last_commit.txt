Repository: plone.volto


Branch: refs/heads/main
Date: 2024-04-24T17:12:00+02:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/plone.volto/commit/a2a1a5f1189337f4ed8738cba5255ffa2f024f9a

Import IPloneSiteRoot from plone.base (#147)

* Import IPloneSiteRoot from plone.base

* changelog

* update more imports

Files changed:
A news/147.bugfix
A src/plone/volto/bbb.py
M src/plone/volto/browser/breadcrumbs.py
M src/plone/volto/browser/migrate_to_volto.py
M src/plone/volto/browser/navigation.py
M src/plone/volto/configure.zcml
M src/plone/volto/setuphandlers.py
M src/plone/volto/tests/test_migrate_to_volto.py
M src/plone/volto/tests/test_setup.py
M src/plone/volto/transforms.py

b'diff --git a/news/147.bugfix b/news/147.bugfix\nnew file mode 100644\nindex 0000000..e0285d2\n--- /dev/null\n+++ b/news/147.bugfix\n@@ -0,0 +1 @@\n+Avoid a deprecated import warnings in Plone 6. @davisagli\ndiff --git a/src/plone/volto/bbb.py b/src/plone/volto/bbb.py\nnew file mode 100644\nindex 0000000..906d6de\n--- /dev/null\n+++ b/src/plone/volto/bbb.py\n@@ -0,0 +1,11 @@\n+# flake8: noqa\n+\n+try:\n+    from plone.base.interfaces import IPloneSiteRoot\n+except ImportError:\n+    from Products.CMFPlone.interfaces import IPloneSiteRoot\n+\n+try:\n+    from plone.base.utils import get_installer\n+except ImportError:\n+    from Products.CMFPlone.utils import get_installer\ndiff --git a/src/plone/volto/browser/breadcrumbs.py b/src/plone/volto/browser/breadcrumbs.py\nindex b9c3b75..bdb1574 100644\n--- a/src/plone/volto/browser/breadcrumbs.py\n+++ b/src/plone/volto/browser/breadcrumbs.py\n@@ -6,13 +6,19 @@\n from Products.CMFPlone import utils\n from Products.CMFPlone.browser.interfaces import INavigationBreadcrumbs\n from Products.CMFPlone.browser.navigation import get_view_url\n-from Products.CMFPlone.defaultpage import check_default_page_via_view\n-from Products.CMFPlone.interfaces import IHideFromBreadcrumbs\n from Products.Five import BrowserView\n from zope.component import getMultiAdapter\n from zope.interface import implementer\n \n \n+try:\n+    from plone.base.defaultpage import check_default_page_via_view\n+    from plone.base.interfaces import IHideFromBreadcrumbs\n+except ImportError:\n+    from Products.CMFPlone.defaultpage import check_default_page_via_view\n+    from Products.CMFPlone.interfaces import IHideFromBreadcrumbs\n+\n+\n @implementer(INavigationBreadcrumbs)\n class PhysicalNavigationBreadcrumbs(BrowserView):\n     def breadcrumbs(self):\ndiff --git a/src/plone/volto/browser/migrate_to_volto.py b/src/plone/volto/browser/migrate_to_volto.py\nindex 8eba43b..d5c58b9 100644\n--- a/src/plone/volto/browser/migrate_to_volto.py\n+++ b/src/plone/volto/browser/migrate_to_volto.py\n@@ -8,12 +8,12 @@\n from plone.app.redirector.interfaces import IRedirectionStorage\n from plone.app.textfield.value import RichTextValue\n from plone.dexterity.interfaces import IDexterityFTI\n+from plone.volto.bbb import get_installer\n from plone.volto.browser.migrate_richtext import get_blocks_from_richtext\n from plone.volto.browser.migrate_richtext import migrate_richtext_to_blocks\n from Products.BTreeFolder2.BTreeFolder2 import BTreeFolder2Base\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.relationhelper import restore_relations\n-from Products.CMFPlone.utils import get_installer\n from Products.Five import BrowserView\n from uuid import uuid4\n from zope.component import getUtility\ndiff --git a/src/plone/volto/browser/navigation.py b/src/plone/volto/browser/navigation.py\nindex f2b01d6..5c86929 100644\n--- a/src/plone/volto/browser/navigation.py\n+++ b/src/plone/volto/browser/navigation.py\n@@ -8,13 +8,18 @@\n from Products.CMFPlone.browser.interfaces import INavigationTabs\n from Products.CMFPlone.browser.navigation import get_id\n from Products.CMFPlone.browser.navigation import get_view_url\n-from Products.CMFPlone.interfaces import INavigationSchema\n from Products.Five import BrowserView\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n from zope.interface import implementer\n \n \n+try:\n+    from plone.base.interfaces import INavigationSchema\n+except ImportError:\n+    from Products.CMFPlone.interfaces import INavigationSchema\n+\n+\n @implementer(INavigationTabs)\n class CatalogNavigationTabs(BrowserView):\n     def _getNavQuery(self):\ndiff --git a/src/plone/volto/configure.zcml b/src/plone/volto/configure.zcml\nindex 8de14e0..750c602 100644\n--- a/src/plone/volto/configure.zcml\n+++ b/src/plone/volto/configure.zcml\n@@ -22,14 +22,14 @@\n \n   <browser:page\n       name="blocksuuidfixer"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for=".bbb.IPloneSiteRoot"\n       class=".blocksuuidfixer.DuplicatedBlocksUUIDFixer"\n       permission="cmf.ManagePortal"\n       />\n \n   <browser:page\n       name="volto_settings"\n-      for="Products.CMFPlone.interfaces.IPloneSiteRoot"\n+      for=".bbb.IPloneSiteRoot"\n       class=".controlpanel.VoltoSettingsControlPanel"\n       permission="cmf.ManagePortal"\n       />\ndiff --git a/src/plone/volto/setuphandlers.py b/src/plone/volto/setuphandlers.py\nindex 3aa3072..eac653d 100644\n--- a/src/plone/volto/setuphandlers.py\n+++ b/src/plone/volto/setuphandlers.py\n@@ -2,12 +2,12 @@\n from importlib import import_module\n from plone import api\n from plone.dexterity.interfaces import IDexterityFTI\n+from plone.volto.bbb import get_installer\n from plone.volto.default_homepage.default import default_home\n from plone.volto.default_homepage.demo import demo_home_page\n from plone.volto.default_homepage.lrf import default_lrf_home\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.interfaces import INonInstallable\n-from Products.CMFPlone.utils import get_installer\n from zope.component import queryUtility\n from zope.interface import implementer\n \ndiff --git a/src/plone/volto/tests/test_migrate_to_volto.py b/src/plone/volto/tests/test_migrate_to_volto.py\nindex 0fe7fe5..e07cf77 100644\n--- a/src/plone/volto/tests/test_migrate_to_volto.py\n+++ b/src/plone/volto/tests/test_migrate_to_volto.py\n@@ -3,12 +3,12 @@\n from plone.app.testing import setRoles\n from plone.app.testing import TEST_USER_ID\n from plone.app.textfield.value import RichTextValue\n+from plone.volto.bbb import get_installer\n from plone.volto.content import FolderishDocument\n from plone.volto.content import FolderishEvent\n from plone.volto.content import FolderishNewsItem\n from plone.volto.testing import PLONE_6\n from plone.volto.testing import PLONE_VOLTO_MIGRATION_FUNCTIONAL_TESTING\n-from Products.CMFPlone.utils import get_installer\n \n import json\n import responses\ndiff --git a/src/plone/volto/tests/test_setup.py b/src/plone/volto/tests/test_setup.py\nindex 8c4aede..718ef96 100644\n--- a/src/plone/volto/tests/test_setup.py\n+++ b/src/plone/volto/tests/test_setup.py\n@@ -2,16 +2,9 @@\n """Setup tests for this package."""\n from importlib import import_module\n from plone import api\n+from plone.volto.bbb import get_installer\n from plone.volto.testing import PLONE_VOLTO_CORE_INTEGRATION_TESTING  # noqa\n \n-\n-try:\n-    from Products.CMFPlone.utils import get_installer\n-except ImportError:  # Plone < 5.1\n-    HAS_INSTALLER = False\n-else:\n-    HAS_INSTALLER = True\n-\n import unittest\n \n \n@@ -26,17 +19,11 @@ class TestSetup(unittest.TestCase):\n     def setUp(self):\n         """Custom shared utility setup for tests."""\n         self.portal = self.layer["portal"]\n-        if HAS_INSTALLER:\n-            self.installer = get_installer(self.portal)\n-        else:\n-            self.installer = api.portal.get_tool("portal_quickinstaller")\n+        self.installer = get_installer(self.portal)\n \n     def test_product_installed(self):\n         """Test if plone.volto is installed."""\n-        if HAS_INSTALLER:\n-            self.assertTrue(self.installer.is_product_installed("plone.volto"))\n-        else:\n-            self.assertTrue(self.installer.isProductInstalled("plone.volto"))\n+        self.assertTrue(self.installer.is_product_installed("plone.volto"))\n \n     def test_browserlayer(self):\n         """Test that IPloneVoltoCoreLayer is registered."""\n@@ -70,19 +57,12 @@ class TestUninstall(unittest.TestCase):\n \n     def setUp(self):\n         self.portal = self.layer["portal"]\n-        if HAS_INSTALLER:\n-            self.installer = get_installer(self.portal)\n-            self.installer.uninstall_product("plone.volto")\n-        else:\n-            self.installer = api.portal.get_tool("portal_quickinstaller")\n-            self.installer.uninstallProducts(["plone.volto"])\n+        self.installer = get_installer(self.portal)\n+        self.installer.uninstall_product("plone.volto")\n \n     def test_product_uninstalled(self):\n         """Test if plone.volto is cleanly uninstalled."""\n-        if HAS_INSTALLER:\n-            self.assertFalse(self.installer.is_product_installed("plone.volto"))\n-        else:\n-            self.assertFalse(self.installer.isProductInstalled("plone.volto"))\n+        self.assertFalse(self.installer.is_product_installed("plone.volto"))\n \n     def test_browserlayer_removed(self):\n         """Test that IPloneVoltoCoreLayer is removed."""\ndiff --git a/src/plone/volto/transforms.py b/src/plone/volto/transforms.py\nindex 1635520..ef6def5 100644\n--- a/src/plone/volto/transforms.py\n+++ b/src/plone/volto/transforms.py\n@@ -4,7 +4,7 @@\n from plone.restapi.interfaces import IBlockFieldSerializationTransformer\n from plone.restapi.interfaces import IBlockVisitor\n from plone.restapi.serializer.blocks import ResolveUIDSerializerBase\n-from Products.CMFPlone.interfaces import IPloneSiteRoot\n+from plone.volto.bbb import IPloneSiteRoot\n from zope.component import adapter\n from zope.component import subscribers\n from zope.interface import implementer\n'

