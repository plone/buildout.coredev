Repository: plone.app.caching


Branch: refs/heads/master
Date: 2024-09-12T01:18:47+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.caching/commit/0dbafff29f3a07d7a7f3cac6aa5d2125ba376469

Add uninstall profile.

Part of https://github.com/plone/plone.app.caching/issues/139

Files changed:
A news/139.breaking.1
A plone/app/caching/profiles/uninstall/controlpanel.xml
A plone/app/caching/profiles/uninstall/registry/basesettings.xml
A plone/app/caching/profiles/uninstall/registry/moderate.xml
A plone/app/caching/profiles/uninstall/registry/strong.xml
A plone/app/caching/profiles/uninstall/registry/terse.xml
A plone/app/caching/profiles/uninstall/registry/weak.xml
M plone/app/caching/profiles.zcml
M plone/app/caching/setuphandlers.py

b'diff --git a/news/139.breaking.1 b/news/139.breaking.1\nnew file mode 100644\nindex 0000000..6620cb3\n--- /dev/null\n+++ b/news/139.breaking.1\n@@ -0,0 +1,2 @@\n+Add uninstall profile.\n+[maurits]\ndiff --git a/plone/app/caching/profiles.zcml b/plone/app/caching/profiles.zcml\nindex 433c313..0fec2d6 100644\n--- a/plone/app/caching/profiles.zcml\n+++ b/plone/app/caching/profiles.zcml\n@@ -4,6 +4,11 @@\n     i18n_domain="plone"\n     >\n \n+  <utility\n+      factory=".setuphandlers.NonInstallable"\n+      name="plone.app.caching"\n+      />\n+\n   <genericsetup:registerProfile\n       name="default"\n       title="HTTP caching support"\n@@ -12,6 +17,13 @@\n       directory="profiles/default"\n       />\n \n+  <genericsetup:registerProfile\n+      name="uninstall"\n+      title="Uninstall HTTP caching support"\n+      provides="Products.GenericSetup.interfaces.EXTENSION"\n+      directory="profiles/uninstall"\n+      />\n+\n   <genericsetup:registerProfile\n       name="v2"\n       title="Upgrade plone.app.caching to v2 with terse caching"\ndiff --git a/plone/app/caching/profiles/uninstall/controlpanel.xml b/plone/app/caching/profiles/uninstall/controlpanel.xml\nnew file mode 100644\nindex 0000000..f211dea\n--- /dev/null\n+++ b/plone/app/caching/profiles/uninstall/controlpanel.xml\n@@ -0,0 +1,11 @@\n+<?xml version="1.0" encoding="utf-8"?>\n+<object xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n+        name="portal_controlpanel"\n+        i18n:domain="plone"\n+>\n+\n+  <configlet action_id="plone.app.caching"\n+             remove="true"\n+  />\n+\n+</object>\ndiff --git a/plone/app/caching/profiles/uninstall/registry/basesettings.xml b/plone/app/caching/profiles/uninstall/registry/basesettings.xml\nnew file mode 100644\nindex 0000000..9ed1d41\n--- /dev/null\n+++ b/plone/app/caching/profiles/uninstall/registry/basesettings.xml\n@@ -0,0 +1,17 @@\n+<?xml version="1.0" encoding="utf-8"?>\n+<registry>\n+\n+  <records interface="plone.caching.interfaces.ICacheSettings"\n+           remove="true"\n+  />\n+  <records interface="plone.cachepurging.interfaces.ICachePurgingSettings"\n+           remove="true"\n+  />\n+  <records interface="plone.app.caching.interfaces.IPloneCacheSettings"\n+           remove="true"\n+  />\n+  <record name="plone.caching.operations.chain.operations"\n+          remove="true"\n+  />\n+\n+</registry>\ndiff --git a/plone/app/caching/profiles/uninstall/registry/moderate.xml b/plone/app/caching/profiles/uninstall/registry/moderate.xml\nnew file mode 100644\nindex 0000000..4c9a752\n--- /dev/null\n+++ b/plone/app/caching/profiles/uninstall/registry/moderate.xml\n@@ -0,0 +1,21 @@\n+<?xml version="1.0" encoding="utf-8"?>\n+<registry>\n+  <record name="plone.app.caching.moderateCaching.smaxage"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.moderateCaching.etags"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.moderateCaching.lastModified"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.moderateCaching.ramCache"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.moderateCaching.vary"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.moderateCaching.anonOnly"\n+          remove="true"\n+  />\n+</registry>\ndiff --git a/plone/app/caching/profiles/uninstall/registry/strong.xml b/plone/app/caching/profiles/uninstall/registry/strong.xml\nnew file mode 100644\nindex 0000000..20e9d13\n--- /dev/null\n+++ b/plone/app/caching/profiles/uninstall/registry/strong.xml\n@@ -0,0 +1,24 @@\n+<?xml version="1.0" encoding="utf-8"?>\n+<registry>\n+  <record name="plone.app.caching.strongCaching.maxage"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.strongCaching.smaxage"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.strongCaching.etags"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.strongCaching.lastModified"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.strongCaching.ramCache"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.strongCaching.vary"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.strongCaching.anonOnly"\n+          remove="true"\n+  />\n+</registry>\ndiff --git a/plone/app/caching/profiles/uninstall/registry/terse.xml b/plone/app/caching/profiles/uninstall/registry/terse.xml\nnew file mode 100644\nindex 0000000..05a9c17\n--- /dev/null\n+++ b/plone/app/caching/profiles/uninstall/registry/terse.xml\n@@ -0,0 +1,24 @@\n+<?xml version="1.0" encoding="utf-8"?>\n+<registry>\n+  <record name="plone.app.caching.terseCaching.maxage"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.terseCaching.smaxage"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.terseCaching.etags"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.terseCaching.lastModified"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.terseCaching.ramCache"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.terseCaching.vary"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.terseCaching.anonOnly"\n+          remove="true"\n+  />\n+</registry>\ndiff --git a/plone/app/caching/profiles/uninstall/registry/weak.xml b/plone/app/caching/profiles/uninstall/registry/weak.xml\nnew file mode 100644\nindex 0000000..19c702e\n--- /dev/null\n+++ b/plone/app/caching/profiles/uninstall/registry/weak.xml\n@@ -0,0 +1,18 @@\n+<?xml version="1.0" encoding="utf-8"?>\n+<registry>\n+  <record name="plone.app.caching.weakCaching.etags"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.weakCaching.lastModified"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.weakCaching.ramCache"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.weakCaching.vary"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.weakCaching.anonOnly"\n+          remove="true"\n+  />\n+</registry>\ndiff --git a/plone/app/caching/setuphandlers.py b/plone/app/caching/setuphandlers.py\nindex 6029e58..ef2240c 100644\n--- a/plone/app/caching/setuphandlers.py\n+++ b/plone/app/caching/setuphandlers.py\n@@ -1,4 +1,16 @@\n+from plone.base.interfaces import INonInstallable\n from Products.CMFCore.utils import getToolByName\n+from zope.interface import implementer\n+\n+\n+@implementer(INonInstallable)\n+class NonInstallable:\n+\n+    def getNonInstallableProfiles(self):\n+        return [\n+            "plone.app.caching:uninstall",\n+            "plone.app.caching:v2",\n+        ]\n \n \n def enableExplicitMode():\n'

Repository: plone.app.caching


Branch: refs/heads/master
Date: 2024-09-12T01:18:47+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.caching/commit/399b64bedfef23ed0cc124c86c352bd661ad1e92

Replace plone.app.caching import step with a post handler.

Removed the `plone.app.caching.txt` Generic Setup flag file that was needed by the import step.

This is part of https://github.com/plone/plone.app.caching/issues/139

Files changed:
A news/139.breaking.2
M plone/app/caching/profiles.zcml
M plone/app/caching/setuphandlers.py
D plone/app/caching/profiles/default/plone.app.caching.txt

b'diff --git a/news/139.breaking.2 b/news/139.breaking.2\nnew file mode 100644\nindex 0000000..8512aab\n--- /dev/null\n+++ b/news/139.breaking.2\n@@ -0,0 +1,3 @@\n+Replace `plone.app.caching` import step with a post handler.\n+Removed the `plone.app.caching.txt` Generic Setup flag file that was needed by the import step.\n+[maurits]\ndiff --git a/plone/app/caching/profiles.zcml b/plone/app/caching/profiles.zcml\nindex 0fec2d6..2b718c7 100644\n--- a/plone/app/caching/profiles.zcml\n+++ b/plone/app/caching/profiles.zcml\n@@ -15,6 +15,7 @@\n       description="Installs plone.app.caching"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       directory="profiles/default"\n+      post_handler=".setuphandlers.importVarious"\n       />\n \n   <genericsetup:registerProfile\n@@ -32,13 +33,6 @@\n       directory="profiles/default"\n       />\n \n-  <genericsetup:importStep\n-      name="plone.app.caching"\n-      title="Plone caching - additional installation steps"\n-      description="Imperative configuration for plone.app.caching"\n-      handler=".setuphandlers.importVarious"\n-      />\n-\n   <genericsetup:upgradeSteps\n       profile="plone.app.caching:default"\n       source="1"\ndiff --git a/plone/app/caching/profiles/default/plone.app.caching.txt b/plone/app/caching/profiles/default/plone.app.caching.txt\ndeleted file mode 100644\nindex ba69cfc..0000000\n--- a/plone/app/caching/profiles/default/plone.app.caching.txt\n+++ /dev/null\n@@ -1 +0,0 @@\n-# marker file\n\\ No newline at end of file\ndiff --git a/plone/app/caching/setuphandlers.py b/plone/app/caching/setuphandlers.py\nindex ef2240c..0f78557 100644\n--- a/plone/app/caching/setuphandlers.py\n+++ b/plone/app/caching/setuphandlers.py\n@@ -25,9 +25,6 @@ def enableExplicitMode():\n \n \n def importVarious(context):\n-    if not context.readDataFile("plone.app.caching.txt"):\n-        return\n-\n     site = context.getSite()\n \n     error_log = getToolByName(site, "error_log")\n'

Repository: plone.app.caching


Branch: refs/heads/master
Date: 2024-09-12T01:25:24+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.caching/commit/f9cf730e50016038ed869e658049729e665b7e34

Renamed importVarious to post_handler.

The previous code gave an error:

```
...
  File ".../plone/app/caching/setuphandlers.py", line 28, in importVarious
    site = context.getSite()
AttributeError: 'RequestContainer' object has no attribute 'getSite'
```

The code needed more changes when going from import step to post handler.

Since it can no longer be used as import step, anyone using this will need to change their code, so it feels safe to rename the function without leaving a backwards compatibility layer.
The import step was meant for internal use only anyway.

Files changed:
M plone/app/caching/profiles.zcml
M plone/app/caching/setuphandlers.py

b'diff --git a/plone/app/caching/profiles.zcml b/plone/app/caching/profiles.zcml\nindex 2b718c7..39ea531 100644\n--- a/plone/app/caching/profiles.zcml\n+++ b/plone/app/caching/profiles.zcml\n@@ -15,7 +15,7 @@\n       description="Installs plone.app.caching"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       directory="profiles/default"\n-      post_handler=".setuphandlers.importVarious"\n+      post_handler=".setuphandlers.post_handler"\n       />\n \n   <genericsetup:registerProfile\ndiff --git a/plone/app/caching/setuphandlers.py b/plone/app/caching/setuphandlers.py\nindex 0f78557..d758937 100644\n--- a/plone/app/caching/setuphandlers.py\n+++ b/plone/app/caching/setuphandlers.py\n@@ -24,10 +24,8 @@ def enableExplicitMode():\n         registry.explicit = True\n \n \n-def importVarious(context):\n-    site = context.getSite()\n-\n-    error_log = getToolByName(site, "error_log")\n+def post_handler(context):\n+    error_log = getToolByName(context, "error_log")\n \n     properties = error_log.getProperties()\n     ignored = properties.get("ignored_exceptions", ())\n'

Repository: plone.app.caching


Branch: refs/heads/master
Date: 2024-09-12T10:11:18+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.caching/commit/c5165d44e973c53682f0e5864c1f4423f16091fd

Merge pull request #142 from plone/maurits-uninstall-profile

Add uninstall profile

Files changed:
A news/139.breaking.1
A news/139.breaking.2
A plone/app/caching/profiles/uninstall/controlpanel.xml
A plone/app/caching/profiles/uninstall/registry/basesettings.xml
A plone/app/caching/profiles/uninstall/registry/moderate.xml
A plone/app/caching/profiles/uninstall/registry/strong.xml
A plone/app/caching/profiles/uninstall/registry/terse.xml
A plone/app/caching/profiles/uninstall/registry/weak.xml
M plone/app/caching/profiles.zcml
M plone/app/caching/setuphandlers.py
D plone/app/caching/profiles/default/plone.app.caching.txt

b'diff --git a/news/139.breaking.1 b/news/139.breaking.1\nnew file mode 100644\nindex 0000000..6620cb3\n--- /dev/null\n+++ b/news/139.breaking.1\n@@ -0,0 +1,2 @@\n+Add uninstall profile.\n+[maurits]\ndiff --git a/news/139.breaking.2 b/news/139.breaking.2\nnew file mode 100644\nindex 0000000..8512aab\n--- /dev/null\n+++ b/news/139.breaking.2\n@@ -0,0 +1,3 @@\n+Replace `plone.app.caching` import step with a post handler.\n+Removed the `plone.app.caching.txt` Generic Setup flag file that was needed by the import step.\n+[maurits]\ndiff --git a/plone/app/caching/profiles.zcml b/plone/app/caching/profiles.zcml\nindex 433c313..39ea531 100644\n--- a/plone/app/caching/profiles.zcml\n+++ b/plone/app/caching/profiles.zcml\n@@ -4,12 +4,25 @@\n     i18n_domain="plone"\n     >\n \n+  <utility\n+      factory=".setuphandlers.NonInstallable"\n+      name="plone.app.caching"\n+      />\n+\n   <genericsetup:registerProfile\n       name="default"\n       title="HTTP caching support"\n       description="Installs plone.app.caching"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       directory="profiles/default"\n+      post_handler=".setuphandlers.post_handler"\n+      />\n+\n+  <genericsetup:registerProfile\n+      name="uninstall"\n+      title="Uninstall HTTP caching support"\n+      provides="Products.GenericSetup.interfaces.EXTENSION"\n+      directory="profiles/uninstall"\n       />\n \n   <genericsetup:registerProfile\n@@ -20,13 +33,6 @@\n       directory="profiles/default"\n       />\n \n-  <genericsetup:importStep\n-      name="plone.app.caching"\n-      title="Plone caching - additional installation steps"\n-      description="Imperative configuration for plone.app.caching"\n-      handler=".setuphandlers.importVarious"\n-      />\n-\n   <genericsetup:upgradeSteps\n       profile="plone.app.caching:default"\n       source="1"\ndiff --git a/plone/app/caching/profiles/default/plone.app.caching.txt b/plone/app/caching/profiles/default/plone.app.caching.txt\ndeleted file mode 100644\nindex ba69cfc..0000000\n--- a/plone/app/caching/profiles/default/plone.app.caching.txt\n+++ /dev/null\n@@ -1 +0,0 @@\n-# marker file\n\\ No newline at end of file\ndiff --git a/plone/app/caching/profiles/uninstall/controlpanel.xml b/plone/app/caching/profiles/uninstall/controlpanel.xml\nnew file mode 100644\nindex 0000000..f211dea\n--- /dev/null\n+++ b/plone/app/caching/profiles/uninstall/controlpanel.xml\n@@ -0,0 +1,11 @@\n+<?xml version="1.0" encoding="utf-8"?>\n+<object xmlns:i18n="http://xml.zope.org/namespaces/i18n"\n+        name="portal_controlpanel"\n+        i18n:domain="plone"\n+>\n+\n+  <configlet action_id="plone.app.caching"\n+             remove="true"\n+  />\n+\n+</object>\ndiff --git a/plone/app/caching/profiles/uninstall/registry/basesettings.xml b/plone/app/caching/profiles/uninstall/registry/basesettings.xml\nnew file mode 100644\nindex 0000000..9ed1d41\n--- /dev/null\n+++ b/plone/app/caching/profiles/uninstall/registry/basesettings.xml\n@@ -0,0 +1,17 @@\n+<?xml version="1.0" encoding="utf-8"?>\n+<registry>\n+\n+  <records interface="plone.caching.interfaces.ICacheSettings"\n+           remove="true"\n+  />\n+  <records interface="plone.cachepurging.interfaces.ICachePurgingSettings"\n+           remove="true"\n+  />\n+  <records interface="plone.app.caching.interfaces.IPloneCacheSettings"\n+           remove="true"\n+  />\n+  <record name="plone.caching.operations.chain.operations"\n+          remove="true"\n+  />\n+\n+</registry>\ndiff --git a/plone/app/caching/profiles/uninstall/registry/moderate.xml b/plone/app/caching/profiles/uninstall/registry/moderate.xml\nnew file mode 100644\nindex 0000000..4c9a752\n--- /dev/null\n+++ b/plone/app/caching/profiles/uninstall/registry/moderate.xml\n@@ -0,0 +1,21 @@\n+<?xml version="1.0" encoding="utf-8"?>\n+<registry>\n+  <record name="plone.app.caching.moderateCaching.smaxage"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.moderateCaching.etags"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.moderateCaching.lastModified"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.moderateCaching.ramCache"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.moderateCaching.vary"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.moderateCaching.anonOnly"\n+          remove="true"\n+  />\n+</registry>\ndiff --git a/plone/app/caching/profiles/uninstall/registry/strong.xml b/plone/app/caching/profiles/uninstall/registry/strong.xml\nnew file mode 100644\nindex 0000000..20e9d13\n--- /dev/null\n+++ b/plone/app/caching/profiles/uninstall/registry/strong.xml\n@@ -0,0 +1,24 @@\n+<?xml version="1.0" encoding="utf-8"?>\n+<registry>\n+  <record name="plone.app.caching.strongCaching.maxage"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.strongCaching.smaxage"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.strongCaching.etags"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.strongCaching.lastModified"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.strongCaching.ramCache"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.strongCaching.vary"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.strongCaching.anonOnly"\n+          remove="true"\n+  />\n+</registry>\ndiff --git a/plone/app/caching/profiles/uninstall/registry/terse.xml b/plone/app/caching/profiles/uninstall/registry/terse.xml\nnew file mode 100644\nindex 0000000..05a9c17\n--- /dev/null\n+++ b/plone/app/caching/profiles/uninstall/registry/terse.xml\n@@ -0,0 +1,24 @@\n+<?xml version="1.0" encoding="utf-8"?>\n+<registry>\n+  <record name="plone.app.caching.terseCaching.maxage"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.terseCaching.smaxage"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.terseCaching.etags"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.terseCaching.lastModified"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.terseCaching.ramCache"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.terseCaching.vary"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.terseCaching.anonOnly"\n+          remove="true"\n+  />\n+</registry>\ndiff --git a/plone/app/caching/profiles/uninstall/registry/weak.xml b/plone/app/caching/profiles/uninstall/registry/weak.xml\nnew file mode 100644\nindex 0000000..19c702e\n--- /dev/null\n+++ b/plone/app/caching/profiles/uninstall/registry/weak.xml\n@@ -0,0 +1,18 @@\n+<?xml version="1.0" encoding="utf-8"?>\n+<registry>\n+  <record name="plone.app.caching.weakCaching.etags"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.weakCaching.lastModified"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.weakCaching.ramCache"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.weakCaching.vary"\n+          remove="true"\n+  />\n+  <record name="plone.app.caching.weakCaching.anonOnly"\n+          remove="true"\n+  />\n+</registry>\ndiff --git a/plone/app/caching/setuphandlers.py b/plone/app/caching/setuphandlers.py\nindex 6029e58..d758937 100644\n--- a/plone/app/caching/setuphandlers.py\n+++ b/plone/app/caching/setuphandlers.py\n@@ -1,4 +1,16 @@\n+from plone.base.interfaces import INonInstallable\n from Products.CMFCore.utils import getToolByName\n+from zope.interface import implementer\n+\n+\n+@implementer(INonInstallable)\n+class NonInstallable:\n+\n+    def getNonInstallableProfiles(self):\n+        return [\n+            "plone.app.caching:uninstall",\n+            "plone.app.caching:v2",\n+        ]\n \n \n def enableExplicitMode():\n@@ -12,13 +24,8 @@ def enableExplicitMode():\n         registry.explicit = True\n \n \n-def importVarious(context):\n-    if not context.readDataFile("plone.app.caching.txt"):\n-        return\n-\n-    site = context.getSite()\n-\n-    error_log = getToolByName(site, "error_log")\n+def post_handler(context):\n+    error_log = getToolByName(context, "error_log")\n \n     properties = error_log.getProperties()\n     ignored = properties.get("ignored_exceptions", ())\n'

