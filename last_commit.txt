Repository: plone.app.theming


Branch: refs/heads/master
Date: 2024-05-02T08:34:10+02:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.app.theming/commit/ebaa95f526e99685a437dd48fdc45e6591eedcf1

When calling the html serializer pass an encoding (#239)

Fixes #238

Files changed:
A news/238.bugfix
M src/plone/app/theming/tests/test_transform.py
M src/plone/app/theming/transform.py

b'diff --git a/news/238.bugfix b/news/238.bugfix\nnew file mode 100644\nindex 00000000..c90b2a4b\n--- /dev/null\n+++ b/news/238.bugfix\n@@ -0,0 +1 @@\n+Fix an issue with unicode characters happening with lxml 5 [ale-rt]\ndiff --git a/src/plone/app/theming/tests/test_transform.py b/src/plone/app/theming/tests/test_transform.py\nindex ddb57c9d..faafa34c 100644\n--- a/src/plone/app/theming/tests/test_transform.py\n+++ b/src/plone/app/theming/tests/test_transform.py\n@@ -1,11 +1,13 @@\n from App.config import getConfiguration\n from diazo.compiler import compile_theme\n+from html import unescape\n from lxml import etree\n from os import environ\n from plone.app.testing import setRoles\n from plone.app.testing import TEST_USER_ID\n from plone.app.theming.interfaces import IThemeSettings\n from plone.app.theming.testing import THEMING_FUNCTIONAL_TESTING\n+from plone.app.theming.testing import THEMING_INTEGRATION_TESTING\n from plone.app.theming.transform import ThemeTransform\n from plone.app.theming.utils import applyTheme\n from plone.app.theming.utils import getTheme\n@@ -25,7 +27,30 @@\n import unittest\n \n \n-class TestCase(unittest.TestCase):\n+class IntegrationTestCase(unittest.TestCase):\n+\n+    layer = THEMING_INTEGRATION_TESTING\n+\n+    def test_transform_parseTree_with_unicode(self):\n+        request = self.layer["request"]\n+        request.response.setHeader("Content-Type", "text/html; charset=utf-8")\n+        transform = ThemeTransform(None, request)\n+        snippet = "\\n".join(\n+            (\n+                "<!DOCTYPE html>",\n+                "<html>",\n+                "<body>",\n+                "<div>\xc3\xa0</div>",\n+                "</body>",\n+                "</html>",\n+            )\n+        )\n+        parsed = transform.parseTree([snippet.encode()])\n+        serialized = unescape(parsed.serialize().decode())\n+        self.assertEqual(snippet, serialized)\n+\n+\n+class FunctionalTestCase(unittest.TestCase):\n     layer = THEMING_FUNCTIONAL_TESTING\n \n     def setUp(self):\ndiff --git a/src/plone/app/theming/transform.py b/src/plone/app/theming/transform.py\nindex eb388d5c..3f74c015 100644\n--- a/src/plone/app/theming/transform.py\n+++ b/src/plone/app/theming/transform.py\n@@ -13,6 +13,7 @@\n from zope.component import adapter\n from zope.interface import implementer\n from zope.interface import Interface\n+from ZPublisher.HTTPRequest import default_encoding\n \n import logging\n \n@@ -120,7 +121,9 @@ def parseTree(self, result):\n             return None\n \n         try:\n-            return getHTMLSerializer(result, pretty_print=False)\n+            return getHTMLSerializer(\n+                result, pretty_print=False, encoding=default_encoding\n+            )\n         except (AttributeError, TypeError, etree.ParseError):\n             return None\n \n'

