Repository: Products.CMFPlone


Branch: refs/heads/5.2.x
Date: 2020-06-11T22:31:37+02:00
Author: MrTango (MrTango) <md@derico.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/b19a595d72dcbb6673bc99a50824f9a7af6d5cf7

Add custom.css resource after diazo bundle

Files changed:
A news/3086.feature
M Products/CMFPlone/resources/browser/styles.py

b'diff --git a/Products/CMFPlone/resources/browser/styles.py b/Products/CMFPlone/resources/browser/styles.py\nindex 2c34ceed0e..081af3248e 100644\n--- a/Products/CMFPlone/resources/browser/styles.py\n+++ b/Products/CMFPlone/resources/browser/styles.py\n@@ -1,9 +1,12 @@\n # -*- coding: utf-8 -*-\n from plone.app.layout.viewlets.common import ViewletBase\n+from plone.app.theming.interfaces import IThemeSettings\n+from plone.registry.interfaces import IRegistry\n from Products.CMFPlone.resources.browser.cook import cookWhenChangingSettings\n from Products.CMFPlone.resources.browser.resource import ResourceBase\n from Products.CMFPlone.utils import get_top_request\n from six.moves.urllib import parse\n+from zope.component import getUtility\n \n \n class StylesBase(ResourceBase):\n@@ -81,6 +84,12 @@ def get_data(self, bundle, result):\n                     \'src\': css_location\n                 })\n \n+    @property\n+    def custom_css_timestamp(self):\n+        registry = getUtility(IRegistry)\n+        theme_settings = registry.forInterface(IThemeSettings, False)\n+        return theme_settings.custom_css_timestamp\n+\n     def styles(self):\n         """\n         Get all the styles\n@@ -143,6 +152,18 @@ def styles(self):\n                     \'bundle\': \'diazo\'}\n \n             result.append(data)\n+\n+        # custom.css\n+        custom_css = {\n+            \'rel\': \'stylesheet\',\n+            \'conditionalcomment\': \'\',\n+            \'src\': "{0}/custom.css?timestamp={1}".format(\n+                self.site_url,\n+                self.custom_css_timestamp,\n+            ),\n+            \'bundle\': \'custom-css\'\n+        }\n+        result.append(custom_css)\n         return result\n \n \ndiff --git a/news/3086.feature b/news/3086.feature\nnew file mode 100644\nindex 0000000000..92bc65cd66\n--- /dev/null\n+++ b/news/3086.feature\n@@ -0,0 +1,2 @@\n+Insert virtual custom.css bundle into the header after diazo bundle.\n+[MrTango]\n'

Repository: Products.CMFPlone


Branch: refs/heads/5.2.x
Date: 2020-06-12T10:07:16+02:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/5f51fd1dc1398c3467a575342d123b8353266039

Merge pull request #3117 from plone/maurits/custom-css-cherry-pick-52

Add custom.css resource after diazo bundle [5.2]

Files changed:
A news/3086.feature
M Products/CMFPlone/resources/browser/styles.py

b'diff --git a/Products/CMFPlone/resources/browser/styles.py b/Products/CMFPlone/resources/browser/styles.py\nindex 2c34ceed0e..081af3248e 100644\n--- a/Products/CMFPlone/resources/browser/styles.py\n+++ b/Products/CMFPlone/resources/browser/styles.py\n@@ -1,9 +1,12 @@\n # -*- coding: utf-8 -*-\n from plone.app.layout.viewlets.common import ViewletBase\n+from plone.app.theming.interfaces import IThemeSettings\n+from plone.registry.interfaces import IRegistry\n from Products.CMFPlone.resources.browser.cook import cookWhenChangingSettings\n from Products.CMFPlone.resources.browser.resource import ResourceBase\n from Products.CMFPlone.utils import get_top_request\n from six.moves.urllib import parse\n+from zope.component import getUtility\n \n \n class StylesBase(ResourceBase):\n@@ -81,6 +84,12 @@ def get_data(self, bundle, result):\n                     \'src\': css_location\n                 })\n \n+    @property\n+    def custom_css_timestamp(self):\n+        registry = getUtility(IRegistry)\n+        theme_settings = registry.forInterface(IThemeSettings, False)\n+        return theme_settings.custom_css_timestamp\n+\n     def styles(self):\n         """\n         Get all the styles\n@@ -143,6 +152,18 @@ def styles(self):\n                     \'bundle\': \'diazo\'}\n \n             result.append(data)\n+\n+        # custom.css\n+        custom_css = {\n+            \'rel\': \'stylesheet\',\n+            \'conditionalcomment\': \'\',\n+            \'src\': "{0}/custom.css?timestamp={1}".format(\n+                self.site_url,\n+                self.custom_css_timestamp,\n+            ),\n+            \'bundle\': \'custom-css\'\n+        }\n+        result.append(custom_css)\n         return result\n \n \ndiff --git a/news/3086.feature b/news/3086.feature\nnew file mode 100644\nindex 0000000000..92bc65cd66\n--- /dev/null\n+++ b/news/3086.feature\n@@ -0,0 +1,2 @@\n+Insert virtual custom.css bundle into the header after diazo bundle.\n+[MrTango]\n'

