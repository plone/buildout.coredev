Repository: Products.PortalTransforms


Branch: refs/heads/master
Date: 2022-10-18T15:22:06+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.PortalTransforms/commit/a41fe8371e6481b4ce2fd90f2c6e8b4f196c62aa

Tests: fixed incompatibility with lxml 3.9+ on Linux.

This gives slightly different output.
I feared this indicated a cross site scripting problem, but this is not the case.
See https://github.com/plone/buildout.coredev/pull/818

Files changed:
A news/818.bugfix
M Products/PortalTransforms/tests/test_xss.py

b'diff --git a/Products/PortalTransforms/tests/test_xss.py b/Products/PortalTransforms/tests/test_xss.py\nindex d673696..48747f1 100644\n--- a/Products/PortalTransforms/tests/test_xss.py\n+++ b/Products/PortalTransforms/tests/test_xss.py\n@@ -24,10 +24,14 @@ def setUp(self):\n     def tearDown(self):\n         self.settings.custom_attributes.remove(\'style\')\n \n-    def doTest(self, data_in, data_out):  # noqa\n+    def doConvert(self, data_in):\n         html = self.pt.convertTo(\n             \'text/x-html-safe\', data_in, mimetype="text/html")\n-        self.assertEqual(data_out, html.getData())\n+        return html.getData()\n+\n+    def doTest(self, data_in, data_out):\n+        result = self.doConvert(data_in)\n+        self.assertEqual(data_out, result)\n \n     def test_1(self):\n         data_in = """<html><body><img src="javascript:Alert(\'XSS\');" /></body></html>"""  # noqa\n@@ -163,8 +167,13 @@ def test_24(self):\n \n     def test_25(self):\n         data_in = """<![<a href="javascript:alert(\'1\');">click me</a>"""\n-        data_out = \'click me\'\n-        self.doTest(data_in, data_out)\n+        # Conversion used to result in \'click me\'.\n+        # With lxml 3.9+, on Linux (not Mac), the result is different:\n+        # \'&lt;![<a>click me</a>\'\n+        # The important point is that the javascript is not included.\n+        result = self.doConvert(data_in)\n+        self.assertNotIn("javascript", result)\n+        self.assertNotIn("alert", result)\n \n     def test_26(self):\n         data_in = """<a style="width: expression/**/(alert(\'xss\'))">click me</a>"""  # noqa\n@@ -213,8 +222,13 @@ def test_34(self):\n \n     def test_35(self):\n         data_in = r"""<![CDATA[><script>alert(1);</script>]]>"""\n-        data_out = \']]&gt;\'\n-        self.doTest(data_in, data_out)\n+        # Conversion used to result in \']]&gt;\'.\n+        # With lxml 3.9+, on Linux (not Mac), the result is different:\n+        # \'&lt;![CDATA[&gt;]]&gt;\'\n+        # The important point is that the javascript is not included.\n+        result = self.doConvert(data_in)\n+        self.assertNotIn("script", result)\n+        self.assertNotIn("alert", result)\n \n     def test_36(self):\n         data_in = r"""Normal text&mdash;whew."""\ndiff --git a/news/818.bugfix b/news/818.bugfix\nnew file mode 100644\nindex 0000000..8bc845d\n--- /dev/null\n+++ b/news/818.bugfix\n@@ -0,0 +1,3 @@\n+Tests: fixed incompatibility with lxml 3.9+ on Linux.\n+This gives slightly different output.\n+[maurits]\n'

Repository: Products.PortalTransforms


Branch: refs/heads/master
Date: 2022-10-23T12:06:02-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/Products.PortalTransforms/commit/f9bc179d53b19aa71d7f224a2171849ffc2f9a5a

Merge pull request #47 from plone/maurits-fix-xss-tests-lxml-390

Tests: fixed incompatibility with lxml 3.9+ on Linux.

Files changed:
A news/818.bugfix
M Products/PortalTransforms/tests/test_xss.py

b'diff --git a/Products/PortalTransforms/tests/test_xss.py b/Products/PortalTransforms/tests/test_xss.py\nindex d673696..48747f1 100644\n--- a/Products/PortalTransforms/tests/test_xss.py\n+++ b/Products/PortalTransforms/tests/test_xss.py\n@@ -24,10 +24,14 @@ def setUp(self):\n     def tearDown(self):\n         self.settings.custom_attributes.remove(\'style\')\n \n-    def doTest(self, data_in, data_out):  # noqa\n+    def doConvert(self, data_in):\n         html = self.pt.convertTo(\n             \'text/x-html-safe\', data_in, mimetype="text/html")\n-        self.assertEqual(data_out, html.getData())\n+        return html.getData()\n+\n+    def doTest(self, data_in, data_out):\n+        result = self.doConvert(data_in)\n+        self.assertEqual(data_out, result)\n \n     def test_1(self):\n         data_in = """<html><body><img src="javascript:Alert(\'XSS\');" /></body></html>"""  # noqa\n@@ -163,8 +167,13 @@ def test_24(self):\n \n     def test_25(self):\n         data_in = """<![<a href="javascript:alert(\'1\');">click me</a>"""\n-        data_out = \'click me\'\n-        self.doTest(data_in, data_out)\n+        # Conversion used to result in \'click me\'.\n+        # With lxml 3.9+, on Linux (not Mac), the result is different:\n+        # \'&lt;![<a>click me</a>\'\n+        # The important point is that the javascript is not included.\n+        result = self.doConvert(data_in)\n+        self.assertNotIn("javascript", result)\n+        self.assertNotIn("alert", result)\n \n     def test_26(self):\n         data_in = """<a style="width: expression/**/(alert(\'xss\'))">click me</a>"""  # noqa\n@@ -213,8 +222,13 @@ def test_34(self):\n \n     def test_35(self):\n         data_in = r"""<![CDATA[><script>alert(1);</script>]]>"""\n-        data_out = \']]&gt;\'\n-        self.doTest(data_in, data_out)\n+        # Conversion used to result in \']]&gt;\'.\n+        # With lxml 3.9+, on Linux (not Mac), the result is different:\n+        # \'&lt;![CDATA[&gt;]]&gt;\'\n+        # The important point is that the javascript is not included.\n+        result = self.doConvert(data_in)\n+        self.assertNotIn("script", result)\n+        self.assertNotIn("alert", result)\n \n     def test_36(self):\n         data_in = r"""Normal text&mdash;whew."""\ndiff --git a/news/818.bugfix b/news/818.bugfix\nnew file mode 100644\nindex 0000000..8bc845d\n--- /dev/null\n+++ b/news/818.bugfix\n@@ -0,0 +1,3 @@\n+Tests: fixed incompatibility with lxml 3.9+ on Linux.\n+This gives slightly different output.\n+[maurits]\n'

