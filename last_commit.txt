Repository: plone.app.theming


Branch: refs/heads/master
Date: 2020-04-23T21:43:10+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.theming/commit/60360b326054bf774e4120abde2271f12547c4ba

Fix error on Py 3 with nonascii subrequest.

The subrequest would succeed, but the non-ascii would be ugly.
Added a test for this.
With a French example, we expect "Actualités" but get "ActualitÃ©s".
Or with a Greek example we expect "Αρχική Σελίδα" but get "Î\x91Ï\x81Ï\x87Î¹ÎºÎ® Î£ÎµÎ»Î¯Î´Î±".
(This may or may not be readable in this commit message...)

Fixes https://github.com/plone/Products.CMFPlone/issues/3068
and https://github.com/plone/plone.app.theming/issues/162

This partially undoes https://github.com/plone/plone.app.theming/pull/146
and is basically the same as this fix from 2011:
https://github.com/plone/plone.app.theming/commit/1298857e0ec8c4846807fc6b2504b686f5384918
That fix was still there, but only executed on Python 2.  Now also Python 3.

Files changed:
A news/162.bugfix
A src/plone/app/theming/tests/french.html
A src/plone/app/theming/tests/nonascii.html
A src/plone/app/theming/tests/nonascii.xml
M src/plone/app/theming/tests/test_transform.py
M src/plone/app/theming/utils.py

b'diff --git a/news/162.bugfix b/news/162.bugfix\nnew file mode 100644\nindex 0000000..8c6b4e1\n--- /dev/null\n+++ b/news/162.bugfix\n@@ -0,0 +1,4 @@\n+Fix error on Python 3 with nonascii subrequest.\n+The subrequest would succeed, but the non-ascii would be ugly.\n+Fixes `issue 3069 <https://github.com/plone/Products.CMFPlone/issues/3068>`_ and `issue 162 <https://github.com/plone/plone.app.theming/issues/162>`_.\n+[maurits]\ndiff --git a/src/plone/app/theming/tests/french.html b/src/plone/app/theming/tests/french.html\nnew file mode 100644\nindex 0000000..4a9fe72\n--- /dev/null\n+++ b/src/plone/app/theming/tests/french.html\n@@ -0,0 +1,9 @@\n+<html>\n+<head>\n+    <!-- With a charset, the error in test_include_non_ascii does not happen. -->\n+    <!-- <meta charset="utf-8"/> -->\n+    <title>Title</title>\n+</head>\n+<body>\n+    <div id="content">Actualit\xc3\xa9s</div>\n+</body>\ndiff --git a/src/plone/app/theming/tests/nonascii.html b/src/plone/app/theming/tests/nonascii.html\nnew file mode 100644\nindex 0000000..7fd3771\n--- /dev/null\n+++ b/src/plone/app/theming/tests/nonascii.html\n@@ -0,0 +1,7 @@\n+<html>\n+<head>\n+    <title>Title</title>\n+</head>\n+<body>\n+    <div id="content">(placeholder)</div>\n+</body>\ndiff --git a/src/plone/app/theming/tests/nonascii.xml b/src/plone/app/theming/tests/nonascii.xml\nnew file mode 100644\nindex 0000000..b441d32\n--- /dev/null\n+++ b/src/plone/app/theming/tests/nonascii.xml\n@@ -0,0 +1,8 @@\n+<?xml version="1.0" encoding="UTF-8"?>\n+<rules xmlns="http://namespaces.plone.org/diazo" xmlns:css="http://namespaces.plone.org/diazo/css">\n+\n+    <theme href="python://plone.app.theming.tests/french.html" />\n+\n+    <replace content=\'//*[@id="content"]/text()\' css:theme-children=\'#content\' href="/french" />\n+\n+</rules>\ndiff --git a/src/plone/app/theming/tests/test_transform.py b/src/plone/app/theming/tests/test_transform.py\nindex 9ded05f..94c6b1c 100644\n--- a/src/plone/app/theming/tests/test_transform.py\n+++ b/src/plone/app/theming/tests/test_transform.py\n@@ -23,6 +23,7 @@\n \n import os.path\n import re\n+import six\n import transaction\n import unittest\n \n@@ -813,6 +814,44 @@ def test_includes(self):\n         self.assertTrue(\'<div id="alpha">Number one</div>\' in browser.contents)\n         self.assertTrue(\'<div id="beta">Number one</div>\' in browser.contents)\n \n+    def test_include_non_ascii(self):\n+        # A Diazo theme with non-ascii subrequest can show characters wrong with Python 3.\n+        # See https://github.com/plone/Products.CMFPlone/issues/3068\n+        # These are the same French characters:\n+        # \'Actualit\xc3\xa9s\'\n+        # b\'Actualit\\xc3\\xa9s\'\n+        # u\'Actualit\\xe9s\'\n+        # \'Actualit&#195;&#169;s\'\n+\n+        app = self.layer[\'app\']\n+        portal = self.layer[\'portal\']\n+\n+        setRoles(portal, TEST_USER_ID, (\'Manager\',))\n+\n+        # Create some test content in the portal root\n+        here = os.path.split(__file__)[0]\n+        with open(os.path.join(here, \'french.html\')) as french:\n+            portal.manage_addDTMLMethod(\'french\', file=french)\n+\n+        # Set up transformation\n+        self.settings.rules = u\'python://plone.app.theming/tests/nonascii.xml\'\n+        self.settings.enabled = True\n+\n+        transaction.commit()\n+\n+        browser = Browser(app)\n+\n+        # At the root if the site, we should pick up \'one\' for alpha (absolute\n+        # path, relative to site root) and \'two\' for beta (relative path,\n+        # relative to current directory)\n+\n+        browser.open(portal.absolute_url())\n+        # browser.contents is always string.  On Py 2 this means bytes, on Py 3 text.\n+        if six.PY2:\n+            self.assertIn(b\'<div id="content">Actualit\\xc3\\xa9s</div>\', browser.contents)\n+        else:\n+            self.assertIn(u\'<div id="content">Actualit\\xe9s</div>\', browser.contents)\n+\n     def test_css_js_includes(self):\n \n         app = self.layer[\'app\']\ndiff --git a/src/plone/app/theming/utils.py b/src/plone/app/theming/utils.py\nindex 360894f..a038bd1 100644\n--- a/src/plone/app/theming/utils.py\n+++ b/src/plone/app/theming/utils.py\n@@ -149,8 +149,10 @@ def resolve(self, system_url, public_id, context):\n             # e.g. charset=utf-8\n             encoding = encoding.split(\'=\', 1)[1].strip()\n         result = result.decode(encoding)\n-        if six.PY2:\n-            result = result.encode(\'ascii\', \'xmlcharrefreplace\')\n+        # Note: at first the xmlcharrefreplace was only done on Python 2,\n+        # but Python 3 needs it as well.\n+        # See https://github.com/plone/Products.CMFPlone/issues/3068\n+        result = result.encode(\'ascii\', \'xmlcharrefreplace\')\n \n         if content_type in (\'text/javascript\', \'application/x-javascript\'):\n             result = \'\'.join([\n'

Repository: plone.app.theming


Branch: refs/heads/master
Date: 2020-04-24T01:22:33+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.theming/commit/3e39206179da811d1cc14952e6eb00c364987d01

On Python 3 we only need the xmlcharrefreplace for text/html.

The test_css_js_includes test fails otherwise.

Files changed:
M src/plone/app/theming/utils.py

b"diff --git a/src/plone/app/theming/utils.py b/src/plone/app/theming/utils.py\nindex a038bd1..f10fe4c 100644\n--- a/src/plone/app/theming/utils.py\n+++ b/src/plone/app/theming/utils.py\n@@ -149,10 +149,11 @@ def resolve(self, system_url, public_id, context):\n             # e.g. charset=utf-8\n             encoding = encoding.split('=', 1)[1].strip()\n         result = result.decode(encoding)\n-        # Note: at first the xmlcharrefreplace was only done on Python 2,\n-        # but Python 3 needs it as well.\n-        # See https://github.com/plone/Products.CMFPlone/issues/3068\n-        result = result.encode('ascii', 'xmlcharrefreplace')\n+        if six.PY2 or content_type == 'text/html':\n+            # Note: at first the xmlcharrefreplace was only done on Python 2,\n+            # but Python 3 needs it as well, but only for html.\n+            # See https://github.com/plone/Products.CMFPlone/issues/3068\n+            result = result.encode('ascii', 'xmlcharrefreplace')\n \n         if content_type in ('text/javascript', 'application/x-javascript'):\n             result = ''.join([\n"

Repository: plone.app.theming


Branch: refs/heads/master
Date: 2020-04-24T01:29:32+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.theming/commit/6501a145cba81adad9fd6bf33f018304f8d37ce8

Fix non ascii test on Py 3.

This is an existing test that I overlooked.
That it fails actually illustrates the problem.
We expected 'N\xc3\xbamero' which works fine on Py 2 because it is bytes.
But on Py 3 it is text, which makes it wrongly encoded.

Files changed:
M src/plone/app/theming/tests/test_transform.py

b"diff --git a/src/plone/app/theming/tests/test_transform.py b/src/plone/app/theming/tests/test_transform.py\nindex 94c6b1c..0917677 100644\n--- a/src/plone/app/theming/tests/test_transform.py\n+++ b/src/plone/app/theming/tests/test_transform.py\n@@ -886,9 +886,12 @@ def test_non_ascii_includes(self):\n         browser = Browser(app)\n         browser.open(portal.absolute_url())\n \n-        self.assertTrue(\n-            '''<div>N\\xc3\\xbamero uno</div>'''\n-            in browser.contents)\n+        # browser.contents is always string.  On Py 2 this means bytes, on Py 3 text.\n+        if six.PY2:\n+            self.assertIn(b'<div>N\\xc3\\xbamero uno</div>', browser.contents)\n+        else:\n+            self.assertIn(u'<div>N\\xfamero uno</div>', browser.contents)\n+\n \n     def test_theme_enabled_query_string_debug_switch(self):\n         app = self.layer['app']\n"

Repository: plone.app.theming


Branch: refs/heads/master
Date: 2020-04-24T15:32:11+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.theming/commit/fee6c147b2d4c3730eb8bd0baebdee8187bd9511

Tests: open french.html in binary mode.

Maybe this fixes an error on Python 3 on Jenkins that I do not have locally:

```
'ascii' codec can't decode byte 0xc3 in position 203: ordinal not in range(128)

  File "/srv/python3.7/lib/python3.7/unittest/case.py", line 59, in testPartExecutor
    yield
  File "/srv/python3.7/lib/python3.7/unittest/case.py", line 628, in run
    testMethod()
  File "/home/jenkins/workspace/pull-request-5.2-3.7/src/plone.app.theming/src/plone/app/theming/tests/test_transform.py", line 834, in test_include_non_ascii
    portal.manage_addDTMLMethod('french', file=french)
  File "/home/jenkins/workspace/pull-request-5.2-3.7/src/Zope/src/OFS/DTMLMethod.py", line 486, in addDTMLMethod
    data = safe_file_data(file)
  File "/home/jenkins/workspace/pull-request-5.2-3.7/src/Zope/src/OFS/DTMLMethod.py", line 455, in safe_file_data
    data = data.read()
  File "/home/jenkins/shiningpanda/jobs/b8b8f6c7/virtualenvs/0dd3bfc1/lib/python3.7/encodings/ascii.py", line 26, in decode
    return codecs.ascii_decode(input, self.errors)[0]
```

Files changed:
M src/plone/app/theming/tests/test_transform.py

b'diff --git a/src/plone/app/theming/tests/test_transform.py b/src/plone/app/theming/tests/test_transform.py\nindex 0917677..92330a7 100644\n--- a/src/plone/app/theming/tests/test_transform.py\n+++ b/src/plone/app/theming/tests/test_transform.py\n@@ -830,7 +830,7 @@ def test_include_non_ascii(self):\n \n         # Create some test content in the portal root\n         here = os.path.split(__file__)[0]\n-        with open(os.path.join(here, \'french.html\')) as french:\n+        with open(os.path.join(here, \'french.html\'), "rb") as french:\n             portal.manage_addDTMLMethod(\'french\', file=french)\n \n         # Set up transformation\n'

Repository: plone.app.theming


Branch: refs/heads/master
Date: 2020-05-04T16:04:05+02:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.app.theming/commit/7d0534306184953cf1e58458a0c7f830a46e6174

Merge pull request #180 from plone/maurits/subrequest-non-ascii

Fix error on Py 3 with nonascii subrequest.

Files changed:
A news/162.bugfix
A src/plone/app/theming/tests/french.html
A src/plone/app/theming/tests/nonascii.html
A src/plone/app/theming/tests/nonascii.xml
M src/plone/app/theming/tests/test_transform.py
M src/plone/app/theming/utils.py

b'diff --git a/news/162.bugfix b/news/162.bugfix\nnew file mode 100644\nindex 0000000..8c6b4e1\n--- /dev/null\n+++ b/news/162.bugfix\n@@ -0,0 +1,4 @@\n+Fix error on Python 3 with nonascii subrequest.\n+The subrequest would succeed, but the non-ascii would be ugly.\n+Fixes `issue 3069 <https://github.com/plone/Products.CMFPlone/issues/3068>`_ and `issue 162 <https://github.com/plone/plone.app.theming/issues/162>`_.\n+[maurits]\ndiff --git a/src/plone/app/theming/tests/french.html b/src/plone/app/theming/tests/french.html\nnew file mode 100644\nindex 0000000..4a9fe72\n--- /dev/null\n+++ b/src/plone/app/theming/tests/french.html\n@@ -0,0 +1,9 @@\n+<html>\n+<head>\n+    <!-- With a charset, the error in test_include_non_ascii does not happen. -->\n+    <!-- <meta charset="utf-8"/> -->\n+    <title>Title</title>\n+</head>\n+<body>\n+    <div id="content">Actualit\xc3\xa9s</div>\n+</body>\ndiff --git a/src/plone/app/theming/tests/nonascii.html b/src/plone/app/theming/tests/nonascii.html\nnew file mode 100644\nindex 0000000..7fd3771\n--- /dev/null\n+++ b/src/plone/app/theming/tests/nonascii.html\n@@ -0,0 +1,7 @@\n+<html>\n+<head>\n+    <title>Title</title>\n+</head>\n+<body>\n+    <div id="content">(placeholder)</div>\n+</body>\ndiff --git a/src/plone/app/theming/tests/nonascii.xml b/src/plone/app/theming/tests/nonascii.xml\nnew file mode 100644\nindex 0000000..b441d32\n--- /dev/null\n+++ b/src/plone/app/theming/tests/nonascii.xml\n@@ -0,0 +1,8 @@\n+<?xml version="1.0" encoding="UTF-8"?>\n+<rules xmlns="http://namespaces.plone.org/diazo" xmlns:css="http://namespaces.plone.org/diazo/css">\n+\n+    <theme href="python://plone.app.theming.tests/french.html" />\n+\n+    <replace content=\'//*[@id="content"]/text()\' css:theme-children=\'#content\' href="/french" />\n+\n+</rules>\ndiff --git a/src/plone/app/theming/tests/test_transform.py b/src/plone/app/theming/tests/test_transform.py\nindex 9ded05f..92330a7 100644\n--- a/src/plone/app/theming/tests/test_transform.py\n+++ b/src/plone/app/theming/tests/test_transform.py\n@@ -23,6 +23,7 @@\n \n import os.path\n import re\n+import six\n import transaction\n import unittest\n \n@@ -813,6 +814,44 @@ def test_includes(self):\n         self.assertTrue(\'<div id="alpha">Number one</div>\' in browser.contents)\n         self.assertTrue(\'<div id="beta">Number one</div>\' in browser.contents)\n \n+    def test_include_non_ascii(self):\n+        # A Diazo theme with non-ascii subrequest can show characters wrong with Python 3.\n+        # See https://github.com/plone/Products.CMFPlone/issues/3068\n+        # These are the same French characters:\n+        # \'Actualit\xc3\xa9s\'\n+        # b\'Actualit\\xc3\\xa9s\'\n+        # u\'Actualit\\xe9s\'\n+        # \'Actualit&#195;&#169;s\'\n+\n+        app = self.layer[\'app\']\n+        portal = self.layer[\'portal\']\n+\n+        setRoles(portal, TEST_USER_ID, (\'Manager\',))\n+\n+        # Create some test content in the portal root\n+        here = os.path.split(__file__)[0]\n+        with open(os.path.join(here, \'french.html\'), "rb") as french:\n+            portal.manage_addDTMLMethod(\'french\', file=french)\n+\n+        # Set up transformation\n+        self.settings.rules = u\'python://plone.app.theming/tests/nonascii.xml\'\n+        self.settings.enabled = True\n+\n+        transaction.commit()\n+\n+        browser = Browser(app)\n+\n+        # At the root if the site, we should pick up \'one\' for alpha (absolute\n+        # path, relative to site root) and \'two\' for beta (relative path,\n+        # relative to current directory)\n+\n+        browser.open(portal.absolute_url())\n+        # browser.contents is always string.  On Py 2 this means bytes, on Py 3 text.\n+        if six.PY2:\n+            self.assertIn(b\'<div id="content">Actualit\\xc3\\xa9s</div>\', browser.contents)\n+        else:\n+            self.assertIn(u\'<div id="content">Actualit\\xe9s</div>\', browser.contents)\n+\n     def test_css_js_includes(self):\n \n         app = self.layer[\'app\']\n@@ -847,9 +886,12 @@ def test_non_ascii_includes(self):\n         browser = Browser(app)\n         browser.open(portal.absolute_url())\n \n-        self.assertTrue(\n-            \'\'\'<div>N\\xc3\\xbamero uno</div>\'\'\'\n-            in browser.contents)\n+        # browser.contents is always string.  On Py 2 this means bytes, on Py 3 text.\n+        if six.PY2:\n+            self.assertIn(b\'<div>N\\xc3\\xbamero uno</div>\', browser.contents)\n+        else:\n+            self.assertIn(u\'<div>N\\xfamero uno</div>\', browser.contents)\n+\n \n     def test_theme_enabled_query_string_debug_switch(self):\n         app = self.layer[\'app\']\ndiff --git a/src/plone/app/theming/utils.py b/src/plone/app/theming/utils.py\nindex 360894f..f10fe4c 100644\n--- a/src/plone/app/theming/utils.py\n+++ b/src/plone/app/theming/utils.py\n@@ -149,7 +149,10 @@ def resolve(self, system_url, public_id, context):\n             # e.g. charset=utf-8\n             encoding = encoding.split(\'=\', 1)[1].strip()\n         result = result.decode(encoding)\n-        if six.PY2:\n+        if six.PY2 or content_type == \'text/html\':\n+            # Note: at first the xmlcharrefreplace was only done on Python 2,\n+            # but Python 3 needs it as well, but only for html.\n+            # See https://github.com/plone/Products.CMFPlone/issues/3068\n             result = result.encode(\'ascii\', \'xmlcharrefreplace\')\n \n         if content_type in (\'text/javascript\', \'application/x-javascript\'):\n'

