Repository: plone.restapi


Branch: refs/heads/7.x.x
Date: 2021-05-26T20:26:04+02:00
Author: Wesley Barroso Lopes (wesleybl) <wesleybl@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/597d10d9983c1fff6024b2f36f352d10e291cb81

Patch Plone 4.3's _install_profile_info method to list the default (#1027)

profile of plone.restapi in the first position.

Plone 4.3 considers that the first profile, after ordering all profiles
in alphabetical order, is the profile to be installed when installing
the product. Since plone.restapi has the profile blocks, it is
installed, instead of the default profile. This patch puts the default
profile in the first position, so that it is the installed profile.

Files changed:
A news/895.bugfix
A src/plone/restapi/patch.py
M setup.py
M src/plone/restapi/__init__.py
M src/plone/restapi/tests/test_setup.py

b'diff --git a/news/895.bugfix b/news/895.bugfix\nnew file mode 100644\nindex 000000000..bdeec44b6\n--- /dev/null\n+++ b/news/895.bugfix\n@@ -0,0 +1,4 @@\n+Fix error in Plone 4.3 that installed the blocks profile  when installing the package,\n+instead of the default profile.\n+Fix `#895 <https://github.com/plone/plone.restapi/issues/895>`\n+  [wesleybl]\ndiff --git a/setup.py b/setup.py\nindex 176f0e7ef..7fdf88ed2 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -87,6 +87,7 @@ def read(filename):\n         "plone.behavior>=1.1",  # adds name to behavior directive\n         "plone.rest >= 1.0a6",  # json renderer moved to plone.restapi\n         "plone.schema >= 1.2.1",  # new/fixed json field\n+        "Products.CMFPlone",\n         "PyJWT",\n         "pytz",\n     ],\ndiff --git a/src/plone/restapi/__init__.py b/src/plone/restapi/__init__.py\nindex 0872fac9c..d43e3ba99 100644\n--- a/src/plone/restapi/__init__.py\n+++ b/src/plone/restapi/__init__.py\n@@ -2,9 +2,11 @@\n from AccessControl import allow_module\n from AccessControl.Permissions import add_user_folders\n from plone.restapi.pas import plugin\n+from Products.CMFPlone.utils import getFSVersionTuple\n from Products.PluggableAuthService.PluggableAuthService import registerMultiPlugin\n from zope.i18nmessageid import MessageFactory\n \n+\n import pkg_resources\n \n \n@@ -33,6 +35,14 @@\n else:\n     HAS_AT = True\n \n+PLONE4 = getFSVersionTuple()[0] == 4\n+\n+# BBB: Fix install profile in Plone 4\n+if PLONE4:\n+    from plone.restapi.patch import apply_patch\n+\n+    apply_patch()\n+\n \n def initialize(context):\n     registerMultiPlugin(plugin.JWTAuthenticationPlugin.meta_type)\ndiff --git a/src/plone/restapi/patch.py b/src/plone/restapi/patch.py\nnew file mode 100644\nindex 000000000..be841bf84\n--- /dev/null\n+++ b/src/plone/restapi/patch.py\n@@ -0,0 +1,31 @@\n+# -*- coding: utf-8 -*-\n+\n+from Products.CMFQuickInstallerTool.QuickInstallerTool import QuickInstallerTool\n+\n+_original_QuickInstallerTool_install_profile_info = (\n+    QuickInstallerTool._install_profile_info\n+)\n+\n+\n+def _install_profile_info(self, productname):\n+    install_profile_info = _original_QuickInstallerTool_install_profile_info(\n+        self, productname\n+    )\n+    if productname == "plone.restapi" and install_profile_info:\n+        default_profile = u"plone.restapi:default"\n+        first_profile = install_profile_info[0]["id"]\n+        if default_profile != first_profile:\n+            install_profile_info[0], install_profile_info[1] = (\n+                install_profile_info[1],\n+                install_profile_info[0],\n+            )\n+    return install_profile_info\n+\n+\n+def apply_patch():\n+    # BBB: In Plone 4, the profile that runs when installing a product is the first in\n+    # the list of profiles, ordered alphabetically. Since plone.restapi has profile\n+    # blocks, it comes before the default and that is why it is what is listed for\n+    # installing of plone.restapi. This patch changes the order, of the profiles blocks\n+    # and default, so that the default is the installed profile.\n+    QuickInstallerTool._install_profile_info = _install_profile_info\ndiff --git a/src/plone/restapi/tests/test_setup.py b/src/plone/restapi/tests/test_setup.py\nindex f3037996a..c6377bfd9 100644\n--- a/src/plone/restapi/tests/test_setup.py\n+++ b/src/plone/restapi/tests/test_setup.py\n@@ -38,6 +38,20 @@ def test_product_is_installed(self):\n             ]\n         self.assertTrue(installed, "package appears not to have been installed")\n \n+    def test_install_profile(self):\n+        """Checks if the install profile is the default profile."""\n+        if HAS_INSTALLER:\n+            qi = get_installer(self.portal)\n+            install_profile_id = qi.get_install_profile(PROJECT_NAME)["id"]\n+        else:\n+            qi_tool = api.portal.get_tool("portal_quickinstaller")\n+            install_profile_id = qi_tool.getInstallProfile(PROJECT_NAME)["id"]\n+        self.assertEqual(\n+            install_profile_id,\n+            "plone.restapi:default",\n+            "The install profile must be plone.restapi:default",\n+        )\n+\n \n class TestUninstall(unittest.TestCase):\n \n'

