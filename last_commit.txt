Repository: plone.folder


Branch: refs/heads/master
Date: 2018-10-13T16:47:43-04:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.folder/commit/8a61dc6e87399446d36011cc97f1a5452b3195ab

Fix KeyError when removing object that is not referenced in ordering annotation

Co-authored-by: Wildcard Corp. &lt;corporate@wildcardcorp.com&gt;

Files changed:
M CHANGES.rst
M src/plone/folder/default.py
M src/plone/folder/tests/test_ordersupport.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 2ddc6c9..b996ed2 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -18,7 +18,9 @@ New features:\n \n Bug fixes:\n \n-- *add item here*\n+- Fix KeyError when removing object that is not referenced\n+  in ordering annotation\n+  [vangheem]\n \n \n 2.0.1 (2018-09-23)\ndiff --git a/src/plone/folder/default.py b/src/plone/folder/default.py\nindex 266498d..768911b 100644\n--- a/src/plone/folder/default.py\n+++ b/src/plone/folder/default.py\n@@ -34,8 +34,11 @@ def notifyRemoved(self, obj_id):\n         """ see interfaces.py """\n         order = self._order()\n         pos = self._pos()\n-        idx = pos[obj_id]\n-        del order[idx]\n+        try:\n+            idx = pos[obj_id]\n+            del order[idx]\n+        except KeyError:\n+            pass\n         # we now need to rebuild pos since the ids have shifted\n         pos.clear()\n         for count, obj_id in enumerate(order):\ndiff --git a/src/plone/folder/tests/test_ordersupport.py b/src/plone/folder/tests/test_ordersupport.py\nindex 3459260..0808e1b 100644\n--- a/src/plone/folder/tests/test_ordersupport.py\n+++ b/src/plone/folder/tests/test_ordersupport.py\n@@ -344,3 +344,20 @@ def testIgnoreNonObjects(self):\n         self.assertEqual(self.folder.getObjectPosition(\'bar\'), 0)\n         self.assertEqual(self.folder.getObjectPosition(\'foo\'), 1)\n         self.assertEqual(self.folder.getObjectPosition(\'baz\'), 2)\n+\n+    def testNotifyRemoved(self):\n+        ordering = self.folder.getOrdering()\n+        self.assertEqual(\n+            ordering.idsInOrder(),\n+            [\'foo\', \'bar\', \'baz\']\n+        )\n+\n+        # make sure notifyRemoved with non-existent id does not throw error\n+        ordering.notifyRemoved(\'foobar\')\n+\n+        # normal\n+        ordering.notifyRemoved(\'foo\')\n+        self.assertEqual(\n+            ordering.idsInOrder(),\n+            [\'bar\', \'baz\']\n+        )\n'

Repository: plone.folder


Branch: refs/heads/master
Date: 2018-10-14T11:20:05+02:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.folder/commit/b59b8dd4d9077e76c4af6cc11937cef3e2b127fc

Merge pull request #13 from plone/master-fix-keyerror

master: Fix KeyError when removing object that is not referenced in ordering annotation

Files changed:
M CHANGES.rst
M src/plone/folder/default.py
M src/plone/folder/tests/test_ordersupport.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 2ddc6c9..b996ed2 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -18,7 +18,9 @@ New features:\n \n Bug fixes:\n \n-- *add item here*\n+- Fix KeyError when removing object that is not referenced\n+  in ordering annotation\n+  [vangheem]\n \n \n 2.0.1 (2018-09-23)\ndiff --git a/src/plone/folder/default.py b/src/plone/folder/default.py\nindex 266498d..768911b 100644\n--- a/src/plone/folder/default.py\n+++ b/src/plone/folder/default.py\n@@ -34,8 +34,11 @@ def notifyRemoved(self, obj_id):\n         """ see interfaces.py """\n         order = self._order()\n         pos = self._pos()\n-        idx = pos[obj_id]\n-        del order[idx]\n+        try:\n+            idx = pos[obj_id]\n+            del order[idx]\n+        except KeyError:\n+            pass\n         # we now need to rebuild pos since the ids have shifted\n         pos.clear()\n         for count, obj_id in enumerate(order):\ndiff --git a/src/plone/folder/tests/test_ordersupport.py b/src/plone/folder/tests/test_ordersupport.py\nindex 3459260..0808e1b 100644\n--- a/src/plone/folder/tests/test_ordersupport.py\n+++ b/src/plone/folder/tests/test_ordersupport.py\n@@ -344,3 +344,20 @@ def testIgnoreNonObjects(self):\n         self.assertEqual(self.folder.getObjectPosition(\'bar\'), 0)\n         self.assertEqual(self.folder.getObjectPosition(\'foo\'), 1)\n         self.assertEqual(self.folder.getObjectPosition(\'baz\'), 2)\n+\n+    def testNotifyRemoved(self):\n+        ordering = self.folder.getOrdering()\n+        self.assertEqual(\n+            ordering.idsInOrder(),\n+            [\'foo\', \'bar\', \'baz\']\n+        )\n+\n+        # make sure notifyRemoved with non-existent id does not throw error\n+        ordering.notifyRemoved(\'foobar\')\n+\n+        # normal\n+        ordering.notifyRemoved(\'foo\')\n+        self.assertEqual(\n+            ordering.idsInOrder(),\n+            [\'bar\', \'baz\']\n+        )\n'

