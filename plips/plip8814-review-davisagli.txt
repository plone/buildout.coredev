PLIP 8814: Replace SecureMailHost with a standard Zope mailhost
===============================================================

PLIP ticket: http://dev.plone.org/plone/ticket/8814

Review #1 by David Glick (dglick@gmail.com, davisagli on irc)

The PLIP was reviewed on Mac OS X 10.5.7 using python 2.6 and Firefox 3.5.2.


Review steps
------------

- Run buildout using the plip8814-replace-securemailhost.cfg file.

- Run all tests (bin/alltests).

- Visual review of the code changes in Products.CMFPlone,
  plone.app.contentrules, plone.app.upgrade, and Zope2's MailHost.

- Run upgrade from a Plone 2.5 Data.fs to test the upgrade step.

- Tested mail settings configlet and sendto form through the web.

- Looked at an add-on product that uses mail functionality (eCards)
  to check compatibility with the changes.


Notes and observations
----------------------

- The changes all look sane.

- There are some test failures (AttributeError: reindexObjectSecurity)
  in CMFPlone but this is due to an unrelated
  CMFCore change that happened since this PLIP's CMFPlone branch was
  created, and could be fixed by merging r29034 from the main 4.0 branch.
  Otherwise the only test failures are the related CMFDefault failure and
  unrelated kss.core error which are documented in the PLIP notes.

- It's a shame that we'll still have to depend on SecureMailHost for
  getting the old settings during an upgrade...but at least this
  dependency will be in plone.app.upgrade rather than Plone proper.
  I don't see any easy way to avoid the dependency.

- The upgrade step needs to also update the GenericSetup toolset registry
  so that it doesn't reference the old dotted path; otherwise SMH remains
  a runtime dependency of importing GS profiles.

- Minor bug in the Zope MailHost: the ZMI settings page shows the string
  'None' for the username and password if their value is None, rather than
  an empty string.

- Trying to send an e-mail (via the sendto form) in my site that had been
  upgraded from a Plone 2.5 Data.fs resulted
  in confusing behavior: A 'Mail sent.' portal status message was shown on
  the default error message page.  Traceback as follows:

{{{
Traceback (innermost last):

    * Module ZPublisher.Publish, line 135, in publish
    * Module Zope2.App.startup, line 276, in commit
    * Module transaction._manager, line 93, in commit
    * Module transaction._transaction, line 322, in commit
    * Module transaction._transaction, line 424, in _commitResources
    * Module zope.sendmail.delivery, line 93, in tpc_finish
    * Module Products.MailHost.mailer, line 58, in send

RuntimeError: TLS is not available but TLS is required
}}}

- Trying to send an e-mail via the sendto form in a freshly created Plone
  site did not give the TLS error, but did give the following portal status
  message: "Unable to send mail: Message missing SMTP Header 'From'" ...oh,
  never mind, that's just because I forgot to configure the mailhost settings.

- eCards was actually already using the standard 'send' method of the mailhost,
  but to make sure the deprecation warning works I temporarily changed it to
  secureSend, and saw the warning as expected.

- To be more specific about the main documentation change needed, uses
  of the secureSend method of the mailhost should be changed to send.
  (They will continue to work as is, but with a deprecation warning.)
  The method signature is also slightly different.  Documentation on how
  to migrate alternate mailhosts is also needed.

Conclusion
----------

Overall this is a solid implementation that takes the needed backwards-
compatibility concerns into account.  Hopefully the prerequisite Zope
changes can make it into Zope 2.12 so that this PLIP can be merged.

FWT vote: +1, assuming the associated Zope changes happen, the TLS traceback
is resolved, and the upgrade step is fixed to also update the toolset registry.
